<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PHN Field Collab</title>

<link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet"/>
<script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>

<link href="https://cdn.jsdelivr.net/npm/@mapbox/mapbox-gl-draw@1.4.3/dist/mapbox-gl-draw.css" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/@mapbox/mapbox-gl-draw@1.4.3/dist/mapbox-gl-draw.js"></script>

<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/exifr@7.1.3/dist/full.umd.js"></script>
<script src="https://cdn.jsdelivr.net/npm/yjs@13.6.18/dist/yjs.js"></script>
<script src="https://cdn.jsdelivr.net/npm/y-webrtc@10.6.3/dist/y-webrtc.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
:root{--bg:#f8fafc;--line:#e5e7eb;--text:#0f172a;--muted:#64748b;--accent:#2563eb;--panel:#ffffff}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Noto Sans CJK JP","Noto Sans",sans-serif;color:var(--text)}
#topbar{display:flex;gap:.5rem;align-items:center;padding:.6rem .75rem;border-bottom:1px solid var(--line);background:var(--bg);position:relative;z-index:6;flex-wrap:wrap}
#brand{font-weight:700}
#subbrand{font-size:.9rem;color:#475569;display:flex;gap:.35rem;align-items:center}
#subbrand a{color:#0ea5e9;text-decoration:none}
#subbrand a:hover{text-decoration:underline}
.btn{padding:.5rem .75rem;border:1px solid var(--line);border-radius:.6rem;background:#fff;cursor:pointer;font-size:.95rem}
.btn.active{border-color:var(--accent);box-shadow:0 0 0 2px rgba(37,99,235,.15) inset}
.btn:disabled{opacity:.5;cursor:not-allowed}
.badge{font-size:.82rem;padding:.2rem .55rem;border:1px solid var(--line);border-radius:999px;background:#fff}
.sep{width:1px;height:28px;background:var(--line);margin:0 .25rem}
.muted{color:var(--muted);font-size:.9rem}
#layout{position:relative;height:calc(100% - 64px)}
#map{position:absolute;inset:0 340px 0 0}
#side{position:absolute;right:0;top:0;bottom:0;width:340px;background:var(--panel);border-left:1px solid var(--line);display:flex;flex-direction:column;z-index:4}
#side .head{padding:.6rem .75rem;border-bottom:1px solid var(--line);display:flex;gap:.5rem;align-items:center;justify-content:space-between}
#list{overflow:auto;padding:.5rem}
.group{border:1px solid var(--line);border-radius:.6rem;margin-bottom:.5rem}
.group .ghead{display:flex;align-items:center;justify-content:space-between;padding:.45rem .6rem;background:#f9fafb;border-bottom:1px solid var(--line)}
.group .gitems{padding:.35rem;min-height:16px}
.item{display:flex;align-items:center;gap:.4rem;padding:.35rem;border-radius:.5rem}
.item:hover{background:#f3f4f6}
.item .name{flex:1;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.item .eye{cursor:pointer}
.item[draggable="true"]{cursor:grab}
.hidden{opacity:.5}
#err{display:none;position:fixed;left:12px;top:76px;background:#fee2e2;color:#7f1d1d;border:1px solid #fecaca;border-radius:.5rem;padding:.5rem .75rem;z-index:10}
#help{position:fixed;left:12px;bottom:12px;background:#fff;border:1px solid var(--line);border-radius:.75rem;padding:.6rem .75rem;font-size:.9rem;color:var(--muted);z-index:6;background:rgba(255,255,255,.92);backdrop-filter:saturate(1.1) blur(2px)}
.pin{transform:translateY(-2px)}
.photo-thumb{width:64px;height:64px;object-fit:cover;border-radius:.4rem;border:1px solid var(--line);box-shadow:0 1px 2px rgba(0,0,0,.06)}
#photo-input{display:none}
#modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:20}
#modal img{max-width:90vw;max-height:90vh;border-radius:.5rem;background:#000}

/* HTMLラベル */
.mlabel{
  font-weight:700; font-size:15px; color:#111; white-space:nowrap; pointer-events:none;
  text-shadow:0 0 2px #fff,0 0 2px #fff,0 0 2px #fff,0 0 2px #fff;
  transform: translateY(-2px);
}

/* スタイルダイアログ */
#style-dialog{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:50}
#style-card{background:#fff;border-radius:.8rem;border:1px solid var(--line);padding:14px 16px;width:320px;box-shadow:0 12px 36px rgba(0,0,0,.25)}
#style-card h3{margin:0 0 8px 0;font-size:16px}
.form-row{display:flex;align-items:center;justify-content:space-between;margin:8px 0}
.form-row input[type="color"]{width:48px;height:32px;border:none;background:transparent}
#val-num{min-width:38px;text-align:right;color:#0f172a}
.dialog-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}

/* ハザードパネル */
#hazard-panel{
  position:absolute;left:10px;top:70px;width:280px;background:#fff;border:1px solid var(--line);border-radius:.8rem;z-index:6;
  box-shadow:0 4px 24px rgba(0,0,0,.08);
}
#hazard-header{background:#f1f5f9;padding:8px 10px;cursor:pointer;font-weight:700;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between}
#hazard-body{padding:10px}
#hazard-body label{display:flex;align-items:center;gap:8px;margin:6px 0}
#hazard-body img{max-width:100%;margin-top:6px;border:1px solid #ccc;border-radius:.35rem}

@media (max-width:1100px){
  #map{right:0}
  #side{position:static;width:100%;height:300px;border-left:none;border-top:1px solid var(--line)}
  #layout{height:calc(100% - 64px - 300px)}
  #hazard-panel{top:60px;left:10px;width:70%}
}
</style>
</head>
<body>
<div id="topbar">
  <div style="display:flex;flex-direction:column;gap:2px">
    <span id="brand">PHN Field Collab</span>
    <span id="subbrand">
      保健師活動支援マップ：開発者
      <svg width="14" height="14" viewBox="0 0 1200 1227" aria-hidden="true" style="margin-top:-1px">
        <path d="M714 519l275-319h-130L653 453 478 200H200l300 435L200 1027h130l219-254 194 254h279L714 519zm-96 111l-25-34-242-339h104l195 274 25 34 258 361H1037L618 630z"/>
      </svg>
      <a href="https://x.com/GISPHN" target="_blank" rel="noopener">GISPHN</a>
    </span>
  </div>
  <span class="sep"></span>
  <button class="btn" id="bm-osm">OSM</button>
  <button class="btn" id="bm-gsi-std">地理院 標準</button>
  <button class="btn" id="bm-gsi-photo">地理院 写真</button>
  <button class="btn" id="btn-export">エクスポート</button>
  <button class="btn" id="btn-screenshot">スクショ</button>
  <div style="margin-left:auto;display:flex;gap:.5rem;align-items:center">
    <span class="badge" id="role-badge">閲覧専用</span>
    <span class="badge" id="room-pill">room: -</span>
  </div>
</div>

<div id="layout">
  <div id="map"></div>
  <aside id="side">
    <div class="head"><strong>レイヤ一覧</strong></div>
    <div id="list"></div>
  </aside>
</div>

<!-- ハザードマップパネル -->
<div id="hazard-panel">
  <div id="hazard-header">ハザードマップ <span id="hazard-fold">▼</span></div>
  <div id="hazard-body">
    <label><input type="checkbox" id="chk-flood">洪水浸水想定区域</label>
    <label><input type="checkbox" id="chk-dosha">土砂災害警戒区域</label>
    <label>透明度 <input type="range" id="hazard-opacity" min="0" max="1" step="0.05" value="0.6"></label>
    <div><strong>凡例（洪水）</strong><br><img src="https://disaportal.gsi.go.jp/maps/_images/l2_flood_l.png"></div>
    <div><strong>凡例（土砂）</strong><br><img src="https://disaportal.gsi.go.jp/maps/_images/05_dosha.png"></div>
  </div>
</div>

<div id="help">①部屋作成 → ②地図選択 → ③ピン/ライン/ポリゴン/円/写真 → ④リンク配布 → ⑤エクスポート / スクショ</div>
<div id="err"></div>
<div id="modal" onclick="this.style.display='none'"><img id="modal-img"/></div>

<!-- スタイル編集ダイアログ -->
<div id="style-dialog">
  <div id="style-card">
    <h3>スタイル変更</h3>
    <div class="form-row">
      <label>色</label>
      <input type="color" id="inp-color"/>
    </div>
    <div class="form-row">
      <label id="val-label">幅(px)</label>
      <input type="range" id="inp-range" min="1" max="80" value="50"/>
      <span id="val-num">50</span>
    </div>
    <div class="dialog-actions">
      <button class="btn" id="btn-style-apply">適用</button>
      <button class="btn" id="btn-style-cancel">キャンセル</button>
    </div>
  </div>
</div>

<script>
// ====== ここから JavaScript ======
const $=id=>document.getElementById(id);
function errShow(msg){$('err').style.display='block';$('err').textContent=msg;setTimeout(()=>{$('err').style.display='none'},4000);}
function nowId(){return 'f_'+Math.random().toString(36).substr(2,9);}
function featsArr(){return Array.from(ydoc.getMap('feats').values());}
function addF(f){ydoc.getMap('feats').set(f.id,f);}
function updF(id,fn){const m=ydoc.getMap('feats');const f=m.get(id);if(!f)return;fn(f);m.set(id,f);}
function delF(id){ydoc.getMap('feats').delete(id);}

// === Yjs 初期化 ===
const ydoc=new Y.Doc();
const roomName=(new URL(location)).searchParams.get('room')||'demo';
const provider=new WebrtcProvider(roomName,ydoc);
const ymap=ydoc.getMap('feats');

// === MapLibre 初期化 ===
const map=new maplibregl.Map({
  container:'map',
  style:{version:8,sources:{},layers:[]},
  center:[135.79,34.51],zoom:8,
  preserveDrawingBuffer:true,
  attributionControl:false
});

// === Attribution ===
map.addControl(new maplibregl.AttributionControl({
  customAttribution:'<a target="_blank" href="https://maps.gsi.go.jp/development/ichiran.html">地理院タイル</a> | <a target="_blank" href="https://www.openstreetmap.org/copyright">© OpenStreetMap contributors</a>'
}),'bottom-right');

// === 縮尺・方角・現在地 ===
map.addControl(new maplibregl.NavigationControl({showCompass:true,visualizePitch:true,showZoom:true}),'top-right');
map.addControl(new maplibregl.ScaleControl({maxWidth:150,unit:'metric'}),'top-right');
class LocateControl {
  onAdd(map){
    this._map=map;
    this._container=document.createElement('div');
    this._container.className='maplibregl-ctrl maplibregl-ctrl-group';
    const btn=document.createElement('button');
    btn.type='button'; btn.title='現在地を表示'; btn.innerHTML='📍';
    btn.onclick=()=>{
      if(!navigator.geolocation){ alert('位置情報が利用できません'); return; }
      navigator.geolocation.getCurrentPosition(p=>{
        const ll=[p.coords.longitude,p.coords.latitude];
        map.flyTo({center:ll,zoom:15});
        if(this._marker) this._marker.remove();
        this._marker=new maplibregl.Marker({color:'#2563eb'}).setLngLat(ll).addTo(map);
      });
    };
    this._container.appendChild(btn);
    return this._container;
  }
  onRemove(){ this._container.remove(); this._map=null; }
}
map.addControl(new LocateControl(),'top-right');

// === ハザードソース ===
function ensureHazardSources(){
  if(!map.getSource('flood')){
    map.addSource('flood',{type:'raster',
      tiles:['https://disaportaldata.gsi.go.jp/raster/01_flood_l2_shinsuishin_data/{z}/{x}/{y}.png'],
      tileSize:256});
    map.addLayer({id:'flood',type:'raster',source:'flood',paint:{'raster-opacity':0.6},layout:{visibility:'none'}});
  }
  if(!map.getSource('dosha0')){
    ['05_dosekiryukeikaikuiki','05_kyukeishakeikaikuiki','05_jisuberikeikaikuiki'].forEach((urlPart,i)=>{
      const id='dosha'+i;
      map.addSource(id,{type:'raster',
        tiles:[`https://disaportaldata.gsi.go.jp/raster/${urlPart}/{z}/{x}/{y}.png`],
        tileSize:256});
      map.addLayer({id,type:'raster',source:id,paint:{'raster-opacity':0.6},layout:{visibility:'none'}});
    });
  }
}
map.on('load',()=>{ ensureHazardSources(); });

// === ハザードUI ===
$('chk-flood').addEventListener('change',e=>{
  if(!map.getLayer('flood')) ensureHazardSources();
  map.setLayoutProperty('flood','visibility', e.target.checked?'visible':'none');
});
$('chk-dosha').addEventListener('change',e=>{
  ['dosha0','dosha1','dosha2'].forEach(id=>{
    if(!map.getLayer(id)) ensureHazardSources();
    if(map.getLayer(id)) map.setLayoutProperty(id,'visibility', e.target.checked?'visible':'none');
  });
});
$('hazard-opacity').addEventListener('input',e=>{
  const o=parseFloat(e.target.value);
  if(map.getLayer('flood')) map.setPaintProperty('flood','raster-opacity',o);
  ['dosha0','dosha1','dosha2'].forEach(id=>{
    if(map.getLayer(id)) map.setPaintProperty(id,'raster-opacity',o);
  });
});
$('hazard-header').addEventListener('click',()=>{
  const b=$('hazard-body');
  b.style.display=(b.style.display==='none')?'block':'none';
});
// === 描画・データ管理 ===
map.on('load',()=>{
  map.addSource('geom-src',{type:'geojson',data:{type:'FeatureCollection',features:[]}});
  map.addLayer({id:'line-layer',type:'line',source:'geom-src',
    paint:{'line-color':['get','styleColor'],'line-width':['get','styleWidth']}});
  map.addLayer({id:'poly-layer',type:'fill',source:'geom-src',
    paint:{'fill-color':['get','styleColor'],'fill-opacity':0.4}});
  map.addLayer({id:'poly-outline',type:'line',source:'geom-src',
    paint:{'line-color':['get','styleColor'],'line-width':2}});
});

// === マーカー・ラベル管理 ===
let markers={},labelMarkers={};
function clearMarkers(){Object.values(markers).forEach(m=>m.remove());markers={};Object.values(labelMarkers).forEach(m=>m.remove());labelMarkers={};}
function addPinMarker(f){
  const el=document.createElement('div');
  el.innerHTML='📍';
  el.style.fontSize=(f.properties.styleSize||50)+'px';
  el.style.color=f.properties.styleColor||'#d00';
  const m=new maplibregl.Marker({element:el}).setLngLat(f.geometry.coordinates).addTo(map);
  markers[f.id]=m;
}
function addPhotoMarker(f){
  const img=document.createElement('img'); img.src=f.properties.thumb; img.className='photo-thumb';
  img.onclick=()=>{ $('modal-img').src=f.properties.url; $('modal').style.display='flex'; };
  const m=new maplibregl.Marker({element:img}).setLngLat(f.geometry.coordinates).addTo(map);
  markers[f.id]=m;
}
function addLabelMarker(id,coord,text){
  const el=document.createElement('div'); el.className='mlabel'; el.textContent=text;
  const m=new maplibregl.Marker({element:el}).setLngLat(coord).addTo(map);
  labelMarkers[id]=m;
}
function labelCoordFor(f){
  if(f.geometry.type==='Point') return f.geometry.coordinates;
  if(f.geometry.type==='LineString') return f.geometry.coordinates[Math.floor(f.geometry.coordinates.length/2)];
  if(f.geometry.type==='Polygon') return f.geometry.coordinates[0][0];
  return null;
}

// === レンダリング ===
function renderAll(){
  const feats=featsArr();
  clearMarkers(); ensureGeomLayers();
  const geoFeats=[];
  feats.forEach(f=>{
    if(f.properties?.visible===false) return;
    if(f.properties?.kind==='pin') addPinMarker(f);
    else if(f.properties?.kind==='photo') addPhotoMarker(f);
    else geoFeats.push(f);
    if(f.properties?.label){
      const p=labelCoordFor(f);
      if(p) addLabelMarker('lbl_'+f.id,p,f.properties.label);
    }
  });
  if(map.getSource('geom-src')) map.getSource('geom-src').setData({type:'FeatureCollection',features:geoFeats});
  rebuildSidebar();
}

// === サイドバー再構築 ===
function rebuildSidebar(){
  const list=$('list'); list.innerHTML='';
  featsArr().forEach(f=>{
    const item=document.createElement('div'); item.className='item';
    const eye=document.createElement('span'); eye.className='eye'; eye.textContent=f.properties.visible===false?'🙈':'👁';
    eye.onclick=()=>{updF(f.id,n=>{n.properties.visible=!n.properties.visible}); renderAll();};
    const name=document.createElement('span'); name.className='name'; name.textContent=f.properties.label||f.properties.kind;
    const paint=document.createElement('span'); paint.textContent='🎨'; paint.style.cursor='pointer';
    paint.onclick=()=>openStyleDialogForItem(f);
    item.appendChild(eye); item.appendChild(name); item.appendChild(paint);
    list.appendChild(item);
  });
}

// === スタイルダイアログ ===
let styleTarget=null;
function openStyleDialogForItem(f){
  styleTarget={ids:[f.id]};
  $('inp-color').value=f.properties.styleColor||'#000000';
  const isPin=(f.properties.kind==='pin');
  $('val-label').textContent=isPin?'大きさ(px)':'線幅(px)';
  $('inp-range').min=1; $('inp-range').max=isPin?80:30;
  $('inp-range').value=isPin?(f.properties.styleSize||50):(f.properties.styleWidth||3);
  $('val-num').textContent=$('inp-range').value;
  $('style-dialog').style.display='flex';
}
$('inp-range').addEventListener('input',()=>{ $('val-num').textContent=$('inp-range').value; });
$('btn-style-cancel').onclick=()=>{ $('style-dialog').style.display='none'; styleTarget=null; };
$('btn-style-apply').onclick=()=>{
  if(!styleTarget) return;
  const color=$('inp-color').value; const val=Number($('inp-range').value);
  styleTarget.ids.forEach(id=>{
    updF(id,n=>{
      n.properties.styleColor=color;
      if(n.properties.kind==='pin') n.properties.styleSize=val;
      else n.properties.styleWidth=val;
    });
  });
  $('style-dialog').style.display='none'; styleTarget=null; renderAll();
};

// === Draw 設定 ===
const draw=new MapboxDraw({displayControlsDefault:false});
map.addControl(draw);
map.on('draw.create',(e)=>{
  const f=e.features[0]; if(!f) return;
  if(f.geometry.type==='Point'){ draw.delete(f.id); return; }
  const label=prompt('ラベルを入力（任意）')||'';
  const kind=(f.geometry.type==='LineString'?'line':'polygon');
  const feat={type:'Feature',id:nowId(),geometry:f.geometry,
    properties:{kind,label,visible:true,
      styleColor:(kind==='line')?'#2563eb':'#22c55e',
      styleWidth:3}};
  draw.delete(f.id); addF(feat); renderAll();
});

// === エクスポート ===
$('btn-export').onclick=()=>{
  const zip=new JSZip();
  const feats=featsArr();
  const pointFeats=feats.filter(f=>f.properties.kind==='pin');
  const lineFeats=feats.filter(f=>f.properties.kind==='line');
  const polyFeats=feats.filter(f=>f.properties.kind==='polygon'||f.properties.kind==='circle');
  // GeoJSON
  zip.file('points.geojson',JSON.stringify({type:'FeatureCollection',features:pointFeats},null,2));
  zip.file('lines.geojson',JSON.stringify({type:'FeatureCollection',features:lineFeats},null,2));
  zip.file('polygons.geojson',JSON.stringify({type:'FeatureCollection',features:polyFeats},null,2));
  zip.generateAsync({type:'blob'}).then(content=>{
    const a=document.createElement('a'); a.href=URL.createObjectURL(content); a.download='export.zip'; a.click();
  });
};

// === スクショ ===
$('btn-screenshot').onclick=async()=>{
  const canvas=await html2canvas(document.body,{backgroundColor:'#fff',scale:2,useCORS:true});
  const link=document.createElement('a');
  link.href=canvas.toDataURL('image/png');
  link.download='screenshot.png';
  link.click();
};

// === リアルタイム同期 ===
ymap.observe(()=>{ renderAll(); });

})();
</script>
</body>
</html>
