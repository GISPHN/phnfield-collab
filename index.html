<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PHN Field Collab â€“ ã‚µãƒ¼ãƒä¸è¦ã‚³ãƒ©ãƒœåœ°å›³</title>

<!-- MapLibre -->
<link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet"/>
<script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>

<!-- Mapbox GL Drawï¼ˆMapLibreå¯¾å¿œã®æç”»UIï¼‰ -->
<link href="https://cdn.jsdelivr.net/npm/@mapbox/mapbox-gl-draw@1.4.3/dist/mapbox-gl-draw.css" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/@mapbox/mapbox-gl-draw@1.4.3/dist/mapbox-gl-draw.js"></script>

<!-- Turfï¼ˆå¹¾ä½•/å††ä½œå›³/é‡å¿ƒ/ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ç­‰ï¼‰ -->
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js"></script>

<!-- EXIF è§£æï¼ˆGPSæŠ½å‡ºï¼‰ -->
<script src="https://cdn.jsdelivr.net/npm/exifr@7.1.3/dist/full.umd.js"></script>

<!-- Yjs + y-webrtcï¼ˆP2PåŒæœŸï¼‰-->
<script src="https://cdn.jsdelivr.net/npm/yjs@13.6.18/dist/yjs.js"></script>
<script src="https://cdn.jsdelivr.net/npm/y-webrtc@10.6.3/dist/y-webrtc.min.js"></script>

<style>
:root{--bg:#f8fafc;--line:#e5e7eb;--text:#0f172a;--muted:#64748b;--accent:#2563eb;--panel:#ffffff}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Noto Sans CJK JP",sans-serif;color:var(--text)}
#topbar{display:flex;gap:.5rem;align-items:center;padding:.6rem .75rem;border-bottom:1px solid var(--line);background:var(--bg);position:relative;z-index:3;flex-wrap:wrap}
#brand{font-weight:700}
.btn{padding:.5rem .75rem;border:1px solid var(--line);border-radius:.6rem;background:#fff;cursor:pointer;font-size:.95rem}
.btn.active{border-color:var(--accent);box-shadow:0 0 0 2px rgba(37,99,235,.15) inset}
.btn:disabled{opacity:.5;cursor:not-allowed}
.badge{font-size:.82rem;padding:.2rem .55rem;border:1px solid var(--line);border-radius:999px;background:#fff}
.sep{width:1px;height:28px;background:var(--line);margin:0 .25rem}
.muted{color:var(--muted);font-size:.9rem}
#layout{position:relative;height:calc(100% - 64px)}
#map{position:absolute;inset:0 320px 0 0}
#side{position:absolute;right:0;top:0;bottom:0;width:320px;background:var(--panel);border-left:1px solid var(--line);display:flex;flex-direction:column}
#side .head{padding:.6rem .75rem;border-bottom:1px solid var(--line);display:flex;gap:.5rem;align-items:center;justify-content:space-between}
#list{overflow:auto;padding:.5rem}
.group{border:1px solid var(--line);border-radius:.6rem;margin-bottom:.5rem}
.group .ghead{display:flex;align-items:center;justify-content:space-between;padding:.45rem .6rem;background:#f9fafb;border-bottom:1px solid var(--line)}
.group .gitems{padding:.35rem}
.item{display:flex;align-items:center;gap:.4rem;padding:.35rem;border-radius:.5rem}
.item:hover{background:#f3f4f6}
.item .name{flex:1;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.item .eye{cursor:pointer}
.item[draggable="true"]{cursor:grab}
.hidden{opacity:.5}
#err{display:none;position:fixed;left:12px;top:76px;background:#fee2e2;color:#7f1d1d;border:1px solid #fecaca;border-radius:.5rem;padding:.5rem .75rem;z-index:10}
#help{position:fixed;left:12px;bottom:12px;background:#fff;border:1px solid var(--line);border-radius:.75rem;padding:.6rem .75rem;font-size:.9rem;color:var(--muted);z-index:2}
.pin{width:26px;height:26px;transform:translateY(-2px)}
.photo-thumb{width:64px;height:64px;object-fit:cover;border-radius:.4rem;border:1px solid var(--line);box-shadow:0 1px 2px rgba(0,0,0,.06)}
#photo-input{display:none}
#modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:20}
#modal img{max-width:90vw;max-height:90vh;border-radius:.5rem;background:#000}
@media (max-width:1024px){#map{right:0}#side{position:static;width:100%;height:280px;border-left:none;border-top:1px solid var(--line)}#layout{height:calc(100% - 64px - 280px)}}
</style>
</head>
<body>
<div id="topbar">
  <span id="brand">PHN Field Collab</span>
  <span class="muted">ã€Œéƒ¨å±‹ã€ã€Œç·¨é›†ãƒªãƒ³ã‚¯ã€ã¯ãƒœã‚¿ãƒ³ã§è‡ªå‹•ç™ºè¡Œï¼ˆçŸ­ã„URLï¼‰</span>
  <div class="sep"></div>

  <!-- Basemap -->
  <span class="muted">åœ°å›³:</span>
  <button class="btn" id="bm-osm">OSM</button>
  <button class="btn" id="bm-gsi-std">åœ°ç†é™¢ æ¨™æº–</button>
  <button class="btn" id="bm-gsi-photo">åœ°ç†é™¢ å†™çœŸ</button>
  <div class="sep"></div>

  <!-- Tools -->
  <button class="btn" id="tool-pin">ãƒ”ãƒ³</button>
  <button class="btn" id="tool-line">ãƒ©ã‚¤ãƒ³</button>
  <button class="btn" id="tool-poly">ãƒãƒªã‚´ãƒ³</button>
  <button class="btn" id="tool-circle">å††</button>
  <button class="btn" id="tool-delete" title="é¸æŠå‰Šé™¤ / é•·æŠ¼ã—ã§å…¨å‰Šé™¤">å‰Šé™¤</button>
  <button class="btn" id="tool-photo">å†™çœŸ</button>
  <input type="file" id="photo-input" accept="image/*" multiple />
  <div class="sep"></div>

  <!-- Links -->
  <button class="btn" id="btn-make-room">éƒ¨å±‹ã‚’ä½œæˆ</button>
  <button class="btn" id="btn-make-editor">ç·¨é›†ãƒªãƒ³ã‚¯ã‚’ä½œæˆ</button>
  <button class="btn" id="btn-copy-view">é–²è¦§ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼</button>

  <div style="margin-left:auto;display:flex;gap:.5rem;align-items:center">
    <span class="badge" id="role-badge">é–²è¦§å°‚ç”¨</span>
    <span class="badge" id="room-pill">room: -</span>
  </div>
</div>

<div id="layout">
  <div id="map"></div>
  <aside id="side">
    <div class="head">
      <strong>ãƒ¬ã‚¤ãƒ¤ä¸€è¦§</strong>
      <div style="display:flex;gap:.4rem">
        <button class="btn" id="btn-add-group">ã‚°ãƒ«ãƒ¼ãƒ—è¿½åŠ </button>
        <button class="btn" id="btn-toggle-all">å…¨è¡¨ç¤º/éè¡¨ç¤º</button>
      </div>
    </div>
    <div id="list"></div>
  </aside>
</div>

<div id="help">â‘ ã€Œéƒ¨å±‹ã‚’ä½œæˆã€ã§çŸ­ã„roomã‚’ç™ºè¡Œ â†’ â‘¡OSM/åœ°ç†é™¢ã‚’åˆ‡æ›¿ â†’ â‘¢ãƒ”ãƒ³/ãƒ©ã‚¤ãƒ³/ãƒãƒªã‚´ãƒ³/å††/å†™çœŸã‚’è¿½åŠ  â†’ â‘£ã€Œç·¨é›†ãƒªãƒ³ã‚¯ã€orã€Œé–²è¦§ãƒªãƒ³ã‚¯ã€é…å¸ƒã€‚</div>
<div id="err"></div>

<!-- ç”»åƒæ‹¡å¤§ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="modal" onclick="this.style.display='none'"><img id="modal-img" alt="photo"/></div>

<script>
(function(){
  // ========= ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =========
  const $ = (id)=>document.getElementById(id);
  const showErr = (msg)=>{ const el=$('err'); el.textContent=msg; el.style.display='block'; console.error(msg); };
  const getHash = ()=> new URLSearchParams(location.hash.slice(1));
  const setHash = (q)=>{ location.hash=q.toString(); };
  const base62="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
  function randomKey(len=12){ const a=new Uint8Array(len); crypto.getRandomValues(a); return Array.from(a, v=>base62[v%62]).join(''); }
  const nowId = ()=> 'id_'+Date.now().toString(36)+Math.random().toString(36).slice(2,7);

  // ========= URLï¼ˆçŸ­ã„ r/kï¼‰ =========
  const H = getHash();
  let ROOM_ID = H.get('r') || "";
  let EDITOR_KEY = H.get('k') || "";
  const READ_ONLY = !EDITOR_KEY;
  $('role-badge').textContent = READ_ONLY ? 'é–²è¦§å°‚ç”¨' : 'ç·¨é›†å¯';
  $('room-pill').textContent  = 'room: ' + (ROOM_ID || '-');

  function ensureRoom(q){ let r=q.get('r'); if(!r){ r=randomKey(12); q.set('r', r); } return r; }
  function buildViewURL(){ const q=getHash(); ensureRoom(q); q.delete('k'); q.delete('state'); return location.origin+location.pathname+'#'+q.toString(); }
  function buildEditorURL(){ const q=getHash(); ensureRoom(q); q.set('k', randomKey(16)); q.delete('state'); return location.origin+location.pathname+'#'+q.toString(); }

  // ========= Map =========
  const EMPTY_STYLE={version:8,sources:{},layers:[],glyphs:"https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf"};
  let map;
  try{
    map=new maplibregl.Map({container:'map',style:EMPTY_STYLE,center:[135.79,34.51],zoom:8.2,bearing:0,pitch:0});
  }catch(e){ showErr('MapåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: '+e.message); return; }

  // Basemap
  function addBasemap(){
    if(!map.getSource('osm')){
      map.addSource('osm',{type:'raster',tiles:['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],tileSize:256,
        attribution:'Â© OpenStreetMap contributors'});
    }
    if(!map.getSource('gsi-std')){
      map.addSource('gsi-std',{type:'raster',tiles:['https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png'],tileSize:256,
        attribution:'åœ°ç†é™¢ æ¨™æº–'});
    }
    if(!map.getSource('gsi-photo')){
      map.addSource('gsi-photo',{type:'raster',tiles:['https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/{z}/{x}/{y}.jpg'],tileSize:256,
        attribution:'åœ°ç†é™¢ æœ€æ–°å†™çœŸ'});
    }
    if(!map.getLayer('bm-osm')) map.addLayer({id:'bm-osm',type:'raster',source:'osm'});
    if(!map.getLayer('bm-gsi-std')) map.addLayer({id:'bm-gsi-std',type:'raster',source:'gsi-std'});
    if(!map.getLayer('bm-gsi-photo')) map.addLayer({id:'bm-gsi-photo',type:'raster',source:'gsi-photo'});
  }
  function showBasemap(id){
    ['bm-osm','bm-gsi-std','bm-gsi-photo'].forEach(l=> map.getLayer(l) && map.setLayoutProperty(l,'visibility', l===id?'visible':'none'));
    ['bm-osm','bm-gsi-std','bm-gsi-photo'].forEach(btn=> $(btn.replace('bm-','bm-')).classList.toggle('active', btn===id));
  }
  map.on('load', ()=>{
    addBasemap(); showBasemap('bm-osm');
    // ç¾åœ¨åœ° â†’ å¤±æ•—æ™‚ã¯å¥ˆè‰¯çœŒ
    if (navigator.geolocation){
      navigator.geolocation.getCurrentPosition(
        pos=>map.jumpTo({center:[pos.coords.longitude,pos.coords.latitude],zoom:14}),
        _=>map.jumpTo({center:[135.79,34.51],zoom:8.2}),
        {enableHighAccuracy:true, timeout:7000, maximumAge:0}
      );
    } else { map.jumpTo({center:[135.79,34.51],zoom:8.2}); }
  });
  $('bm-osm').onclick = ()=>showBasemap('bm-osm');
  $('bm-gsi-std').onclick = ()=>showBasemap('bm-gsi-std');
  $('bm-gsi-photo').onclick = ()=>showBasemap('bm-gsi-photo');
  map.addControl(new maplibregl.NavigationControl({showZoom:true}), 'top-right');
  map.addControl(new maplibregl.GeolocateControl({positionOptions:{enableHighAccuracy:true},trackUserLocation:true,showUserHeading:true}));

  // ========= Drawï¼ˆä½œå›³UI + ä½œæˆä¸­ç ´ç·šåŒ–ï¼‰ =========
  const draw = new MapboxDraw({displayControlsDefault:false});
  map.addControl(draw,'top-left');

  // ä½œæˆä¸­ï¼ˆactiveï¼‰ã®ç ´ç·šåŒ–ï¼ˆãƒ¬ã‚¤ãƒ¤ç”Ÿæˆå¾Œã«é©ç”¨ï¼‰
  function applyDashedPreview(){
    const targets=[
      ['gl-draw-line-stroke-active','line-dasharray',[2,2]],
      ['gl-draw-polygon-stroke-active','line-dasharray',[2,2]]
    ];
    targets.forEach(([id,prop,val])=>{
      if (map.getLayer(id)) try{ map.setPaintProperty(id, prop, val); }catch(_){}
    });
  }
  map.on('render', function once(){
    applyDashedPreview(); map.off('render', once);
  });

  // ========= Yjs åŒæœŸ =========
  const hasY = !!(window.Y && window.ywebrtc);
  const ydoc = hasY ? new Y.Doc() : null;
  if (hasY && !ROOM_ID){ /* roomæœªæŒ‡å®š â†’ åŒæœŸã¯å¾Œã§ */ }
  const provider = hasY && ROOM_ID ? new ywebrtc.WebrtcProvider(ROOM_ID, ydoc) : null;
  const yFeatures = hasY ? ydoc.getArray('features') : null; // ã™ã¹ã¦ã®è¦ç´ ã‚’ã“ã“ã«ä¿å­˜ï¼ˆGeoJSON Featureï¼‰
  const yGroups   = hasY ? ydoc.getMap('groups')   : null;   // ã‚°ãƒ«ãƒ¼ãƒ—å¯è¦–æ€§ç­‰

  // ========= ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆãƒãƒ¼ã‚«ãƒ¼/å†™çœŸ/å›³å½¢/ãƒ©ãƒ™ãƒ«/ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼‰ =========
  const markers = new Map(); // id -> Marker
  const photosFull = new Map(); // id -> objectURLï¼ˆå¤§ãã‚ï¼‰

  function clearMarkers(){
    markers.forEach(m=>m.remove()); markers.clear();
  }

  function featureToBbox(f){
    try { return turf.bbox(f); } catch { return null; }
  }

  function addPinMarker(f){
    const el=document.createElement('div');
    el.innerHTML = `
      <svg class="pin" viewBox="0 0 24 24" fill="#d00" stroke="#fff" stroke-width="1.5">
        <path d="M12 22s-6-5.33-6-10a6 6 0 1 1 12 0c0 4.67-6 10-6 10z"></path>
        <circle cx="12" cy="10" r="2.8" fill="#fff"></circle>
      </svg>
    `;
    const marker = new maplibregl.Marker({element:el, anchor:'bottom'}).setLngLat(f.geometry.coordinates).addTo(map);
    if (f.properties?.label){
      const pop = new maplibregl.Popup({offset:25}).setText(f.properties.label);
      marker.setPopup(pop);
    }
    markers.set(f.id, marker);
  }

  function addPhotoMarker(f){
    const el=document.createElement('div');
    el.style.display='flex'; el.style.flexDirection='column'; el.style.alignItems='center';
    const img=document.createElement('img');
    img.src=f.properties.thumb; img.className='photo-thumb'; img.alt=f.properties.label||'photo';
    el.appendChild(img);
    if (f.properties?.label){
      const cap=document.createElement('div'); cap.textContent=f.properties.label;
      cap.style.fontSize='.8rem'; cap.style.marginTop='.2rem';
      el.appendChild(cap);
    }
    img.onclick=()=>{
      const full=photosFull.get(f.id) || f.properties.thumb;
      $('modal-img').src=full; $('modal').style.display='flex';
    };
    const marker = new maplibregl.Marker({element:el, anchor:'bottom'}).setLngLat(f.geometry.coordinates).addTo(map);
    markers.set(f.id, marker);
  }

  function ensureLabelSource(){
    if (!map.getSource('labels')) map.addSource('labels', {type:'geojson', data:{type:'FeatureCollection',features:[]}});
    if (!map.getLayer('labels')){
      map.addLayer({
        id:'labels', type:'symbol', source:'labels',
        layout:{ 'text-field':['get','label'],'text-offset':[0,1.2],'text-size':14,'text-anchor':'top' },
        paint:{ 'text-halo-color':'#fff','text-halo-width':1.2 }
      });
    }
  }

  function renderAll(){
    // æç”»ãƒ¬ã‚¤ãƒ¤ã¯å…¨éƒ¨ä½œã‚Šç›´ã—ï¼ˆvisible=falseã¯é™¤å¤–ï¼‰
    const feats = hasY ? yFeatures.toArray() : localFeatures;
    // Drawã‚’ã‚¯ãƒªã‚¢ã—ã¦å¯è¦–ãªå›³å½¢ã®ã¿å…¥ã‚Œã‚‹ï¼ˆpin/photoã¯ãƒãƒ¼ã‚«ãƒ¼ï¼‰
    try{ draw.deleteAll(); }catch(_){}
    clearMarkers();
    const labelPts = [];

    for(const f of feats){
      if (f.properties?.visible===false) continue;
      if (f.properties?.kind==='pin'){
        addPinMarker(f);
        if (f.properties?.label){
          labelPts.push({type:'Feature',geometry:{type:'Point',coordinates:f.geometry.coordinates},properties:{label:f.properties.label}});
        }
      } else if (f.properties?.kind==='photo'){
        addPhotoMarker(f);
      } else {
        // line/polygon/circle ã¯ Draw ã«
        try{ draw.add(f); }catch(_){}
        if (f.properties?.label){
          let p;
          try{
            if (f.geometry.type==='LineString'){ p=turf.center(f).geometry; }
            else { p=turf.centerOfMass(f).geometry; }
            labelPts.push({type:'Feature',geometry:p,properties:{label:f.properties.label}});
          }catch(_){}
        }
      }
    }
    ensureLabelSource();
    const labelFC={type:'FeatureCollection',features:labelPts};
    map.getSource('labels')?.setData(labelFC);
    rebuildSidebar();
  }

  // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆYjsãŒä½¿ãˆãªã„å ´åˆã‚‚å‹•ä½œï¼‰
  const localFeatures = [];

  // ========= ä½œå›³ãƒ•ãƒ­ãƒ¼ =========
  let activeTool = null;     // 'pin'|'line'|'poly'|'circle'|'photo'
  let circleDrawing = null;  // {center:[lng,lat]} during drag
  let placingPhoto = null;   // {thumb, fullURL, label}

  function setTool(t){
    activeTool=t;
    ['tool-pin','tool-line','tool-poly','tool-circle','tool-photo'].forEach(id=>$(id).classList.toggle('active', id==='tool-'+t));
    if (t==='line') draw.changeMode('draw_line_string');
    else if (t==='poly') draw.changeMode('draw_polygon');
    else draw.changeMode('simple_select'); // pin/circle/photo ã¯ç‹¬è‡ªå‡¦ç†
  }
  $('tool-pin').onclick = ()=> { if(!EDITOR_KEY){alert('é–²è¦§å°‚ç”¨ã§ã™ã€‚ç·¨é›†ãƒªãƒ³ã‚¯ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚'); return;} setTool('pin'); };
  $('tool-line').onclick= ()=> { if(!EDITOR_KEY){alert('é–²è¦§å°‚ç”¨ã§ã™ã€‚'); return;} setTool('line'); };
  $('tool-poly').onclick= ()=> { if(!EDITOR_KEY){alert('é–²è¦§å°‚ç”¨ã§ã™ã€‚'); return;} setTool('poly'); };
  $('tool-circle').onclick=()=> { if(!EDITOR_KEY){alert('é–²è¦§å°‚ç”¨ã§ã™ã€‚'); return;} setTool('circle'); };
  $('tool-photo').onclick =()=> { if(!EDITOR_KEY){alert('é–²è¦§å°‚ç”¨ã§ã™ã€‚'); return;} $('photo-input').click(); };

  // å††ï¼šãƒ‰ãƒ©ãƒƒã‚°ã§åŠå¾„æ±ºå®šï¼ˆä½œæˆä¸­ã¯ç ´ç·šãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰
  let circlePreviewId=null;
  function updateCirclePreview(center, edge){
    const r = turf.distance(center, edge, {units:'kilometers'});
    const poly = turf.circle(center, r, {steps:64, units:'kilometers'});
    if (!map.getSource('circle-preview')){
      map.addSource('circle-preview',{type:'geojson',data:poly});
      map.addLayer({id:'circle-preview',type:'line',source:'circle-preview',
        paint:{'line-color':'#333','line-width':2,'line-dasharray':[2,2]}});
    } else {
      map.getSource('circle-preview').setData(poly);
    }
  }
  function clearCirclePreview(){
    if (map.getLayer('circle-preview')) map.removeLayer('circle-preview');
    if (map.getSource('circle-preview')) map.removeSource('circle-preview');
  }
  map.on('mousedown', (e)=>{
    if (activeTool==='circle'){ circleDrawing={center:[e.lngLat.lng,e.lngLat.lat]}; map.getCanvas().style.cursor='crosshair'; }
  });
  map.on('mousemove', (e)=>{
    if (circleDrawing){ updateCirclePreview(circleDrawing.center, [e.lngLat.lng,e.lngLat.lat]); }
  });
  map.on('mouseup', (e)=>{
    if (!circleDrawing) return;
    const center = circleDrawing.center;
    const rkm = turf.distance(center, [e.lngLat.lng,e.lngLat.lat], {units:'kilometers'});
    const poly = turf.circle(center, rkm, {steps:64, units:'kilometers'});
    clearCirclePreview(); map.getCanvas().style.cursor='';
    circleDrawing=null;

    const label = prompt('å††ã®ãƒ©ãƒ™ãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä»»æ„ï¼‰') || '';
    const feat = {type:'Feature', id:nowId(), geometry:poly.geometry, properties:{kind:'circle', label, visible:true}};
    addFeature(feat);
  });

  // ãƒ”ãƒ³ï¼šã‚¯ãƒªãƒƒã‚¯ã§è¿½åŠ ï¼ˆãƒ”ãƒ³å…ˆç«¯ã‚’åº§æ¨™ã«åˆã‚ã›ã‚‹ï¼‰
  map.on('click', (e)=>{
    if (activeTool==='pin'){
      const label = prompt('ãƒ”ãƒ³ã®ãƒ©ãƒ™ãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä»»æ„ï¼‰') || '';
      const feat = {type:'Feature', id:nowId(), geometry:{type:'Point',coordinates:[e.lngLat.lng,e.lngLat.lat]},
                    properties:{kind:'pin', label, visible:true}};
      addFeature(feat);
    }
    if (placingPhoto){
      const feat = {type:'Feature', id:nowId(), geometry:{type:'Point',coordinates:[e.lngLat.lng,e.lngLat.lat]},
                    properties:{kind:'photo', label:placingPhoto.label||'', thumb:placingPhoto.thumb, visible:true}};
      photosFull.set(feat.id, placingPhoto.fullURL);
      placingPhoto=null; addFeature(feat);
      alert('å†™çœŸã‚’é…ç½®ã—ã¾ã—ãŸã€‚');
    }
  });

  // ãƒ©ã‚¤ãƒ³/ãƒãƒªã‚´ãƒ³ï¼šç¢ºå®šæ™‚ã«ãƒ©ãƒ™ãƒ«å…¥åŠ›
  map.on('draw.create', (e)=>{
    const f = e.features[0];
    if (!f) return;
    if (f.geometry.type==='Point'){
      // Drawã®Pointã¯ä½¿ã‚ãšå‰Šé™¤ï¼ˆãƒ”ãƒ³ã¯ç‹¬è‡ªå‡¦ç†ï¼‰
      draw.delete(f.id);
      return;
    }
    const label = prompt((f.geometry.type==='LineString'?'ãƒ©ã‚¤ãƒ³':'ãƒãƒªã‚´ãƒ³')+'ã®ãƒ©ãƒ™ãƒ«ï¼ˆä»»æ„ï¼‰') || '';
    const feat = {type:'Feature', id:nowId(), geometry:f.geometry, properties:{kind:(f.geometry.type==='LineString'?'line':'polygon'), label, visible:true}};
    // Drawç®¡ç†ã‹ã‚‰å¤–ã™
    draw.delete(f.id);
    addFeature(feat);
  });

  // å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼šEXIFã‹ã‚‰åº§æ¨™â†’ã‚µãƒ ãƒç”Ÿæˆï¼ˆè»½é‡ï¼‰
  $('photo-input').addEventListener('change', async (ev)=>{
    const files=[...ev.target.files];
    for(const file of files){
      const gps = await exifr.gps(file).catch(()=>null);
      const img = await fileToImage(file);
      const {thumb,fullURL} = await makeThumb(img, 800, 512); // full:æœ€å¤§800px, thumb:æœ€å¤§512px
      const label = file.name.replace(/\.[^.]+$/,'');
      if (gps && gps.longitude!=null && gps.latitude!=null){
        const feat = {type:'Feature', id:nowId(), geometry:{type:'Point',coordinates:[gps.longitude,gps.latitude]},
                      properties:{kind:'photo', label, thumb, visible:true}};
        photosFull.set(feat.id, fullURL);
        addFeature(feat);
      } else {
        placingPhoto = {thumb, fullURL, label};
        alert('ã“ã®å†™çœŸã«ã¯GPSãŒã‚ã‚Šã¾ã›ã‚“ã€‚åœ°å›³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦é…ç½®ã—ã¦ãã ã•ã„ã€‚');
      }
    }
    ev.target.value='';
  });
  function fileToImage(file){ return new Promise((res,rej)=>{ const url=URL.createObjectURL(file); const img=new Image(); img.onload=()=>res(img); img.onerror=rej; img.src=url; }); }
  async function makeThumb(img, fullMax=800, thumbMax=512){
    function resizeToDataURL(img, max){
      const scale=Math.min(1, max/Math.max(img.naturalWidth,img.naturalHeight));
      const w=Math.round(img.naturalWidth*scale), h=Math.round(img.naturalHeight*scale);
      const c=document.createElement('canvas'); c.width=w; c.height=h;
      const ctx=c.getContext('2d'); ctx.imageSmoothingEnabled=true; ctx.imageSmoothingQuality='high';
      ctx.drawImage(img,0,0,w,h);
      return c.toDataURL('image/jpeg', 0.75); // åœ§ç¸®ç‡ãƒãƒ©ãƒ³ã‚¹
    }
    const fullURL = resizeToDataURL(img, fullMax);
    const thumb   = resizeToDataURL(img, thumbMax);
    return {thumb, fullURL};
  }

  // ========= æ©Ÿèƒ½: è¿½åŠ /æ›´æ–°/å‰Šé™¤ =========
  function addFeature(feat){
    if (hasY){ yFeatures.push([feat]); }
    else { localFeatures.push(feat); }
    renderAll();
  }
  function updateFeature(id, updater){
    const feats = hasY ? yFeatures.toArray() : localFeatures;
    const idx = feats.findIndex(f=>f.id===id);
    if (idx<0) return;
    const nf = JSON.parse(JSON.stringify(feats[idx]));
    updater(nf);
    if (hasY){
      yFeatures.delete(idx,1); yFeatures.insert(idx,[nf]);
    } else {
      localFeatures[idx]=nf;
    }
    renderAll();
  }
  function deleteFeature(id){
    const feats = hasY ? yFeatures.toArray() : localFeatures;
    const idx = feats.findIndex(f=>f.id===id);
    if (idx<0) return;
    if (hasY){ yFeatures.delete(idx,1); }
    else { localFeatures.splice(idx,1); }
    photosFull.delete(id);
    renderAll();
  }

  // ========= ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼ˆã‚°ãƒ«ãƒ¼ãƒ—/è¡¨ç¤ºåˆ‡æ›¿/ã‚ºãƒ¼ãƒ /ãƒ‰ãƒ©ãƒƒã‚°ä¸¦ã³æ›¿ãˆï¼‰ =========
  function groupKeyOf(f){ return f.properties?.group || 'æœªåˆ†é¡'; }
  function kindLabel(k){ return k==='pin'?'ãƒ”ãƒ³':k==='photo'?'å†™çœŸ':k==='line'?'ãƒ©ã‚¤ãƒ³':k==='polygon'?'ãƒãƒªã‚´ãƒ³':k==='circle'?'å††':'é …ç›®'; }

  function rebuildSidebar(){
    const feats = hasY ? yFeatures.toArray() : localFeatures;
    // orderã§ã‚½ãƒ¼ãƒˆ
    feats.sort((a,b)=>(a.properties?.order||0)-(b.properties?.order||0));
    const groups={};
    for(const f of feats){
      const g=groupKeyOf(f); (groups[g]||(groups[g]=[])).push(f);
    }
    const list = $('list'); list.innerHTML='';
    Object.keys(groups).forEach(gname=>{
      const box=document.createElement('div'); box.className='group';
      const head=document.createElement('div'); head.className='ghead';
      const t=document.createElement('div'); t.textContent=gname;
      const vis=document.createElement('span'); vis.textContent='ğŸ‘'; vis.style.cursor='pointer';
      let gVisible=true;
      vis.onclick=()=>{
        gVisible=!gVisible; vis.style.opacity=gVisible?1:.4;
        groups[gname].forEach(f=>updateFeature(f.id, nf=>{ nf.properties.visible=gVisible; }));
      };
      head.appendChild(t); head.appendChild(vis); box.appendChild(head);

      const items=document.createElement('div'); items.className='gitems';
      groups[gname].forEach(f=>{
        const it=document.createElement('div'); it.className='item'; it.setAttribute('draggable','true'); it.dataset.id=f.id;
        if (f.properties?.visible===false) it.classList.add('hidden');
        const eye=document.createElement('span'); eye.textContent=(f.properties?.visible===false)?'ğŸ™ˆ':'ğŸ‘'; eye.className='eye';
        eye.onclick=()=> updateFeature(f.id, nf=>{ nf.properties.visible = !(nf.properties?.visible===false); });
        const name=document.createElement('div'); name.className='name';
        name.textContent=`${kindLabel(f.properties?.kind)}ï¼š${f.properties?.label||'(ç„¡é¡Œ)'}`;
        name.onclick=()=>{
          if (f.geometry.type==='Point'){ map.flyTo({center:f.geometry.coordinates, zoom:18}); }
          else { const b=featureToBbox(f); if(b) map.fitBounds([[b[0],b[1]],[b[2],b[3]]],{padding:40}); }
        };
        const edit=document.createElement('button'); edit.textContent='âœï¸'; edit.className='btn';
        edit.onclick=()=>{
          const lab=prompt('ãƒ©ãƒ™ãƒ«ã‚’ç·¨é›†', f.properties?.label||'')||'';
          updateFeature(f.id, nf=>{ nf.properties.label=lab; });
        };
        const del=document.createElement('button'); del.textContent='ğŸ—‘'; del.className='btn';
        del.onclick=()=>{ if(confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) deleteFeature(f.id); };
        it.appendChild(eye); it.appendChild(name); it.appendChild(edit); it.appendChild(del);
        items.appendChild(it);
      });
      // D&D ä¸¦ã³æ›¿ãˆ
      items.addEventListener('dragstart', e=>{ if(e.target.classList.contains('item')) e.dataTransfer.setData('text/plain', e.target.dataset.id); });
      items.addEventListener('dragover', e=>{ e.preventDefault(); });
      items.addEventListener('drop', e=>{
        e.preventDefault();
        const fromId=e.dataTransfer.getData('text/plain');
        const toEl=e.target.closest('.item'); if(!toEl) return;
        const toId=toEl.dataset.id;
        const feats2 = hasY ? yFeatures.toArray() : localFeatures;
        const order = (id)=> (feats2.find(f=>f.id===id)?.properties?.order)||0;
        const toOrder = order(toId);
        updateFeature(fromId, nf=>{ nf.properties.order = toOrder - 0.1; });
      });

      box.appendChild(items);
      list.appendChild(box);
    });
  }

  $('btn-add-group').onclick=()=>{
    const name = prompt('ã‚°ãƒ«ãƒ¼ãƒ—åã‚’å…¥åŠ›','æ–°ã—ã„ã‚°ãƒ«ãƒ¼ãƒ—'); if(!name) return;
    // ã‚°ãƒ«ãƒ¼ãƒ—ã¯æ˜ç¤ºçš„ã«ä½œã‚‰ãšã€ã‚¢ã‚¤ãƒ†ãƒ ã® properties.group ã«ä»˜ã‘ãŸæ™‚ç‚¹ã§å‡ºç¾ã™ã‚‹ä»•æ§˜ã€‚ã“ã“ã§ã¯æç¤ºã®ã¿ã€‚
    alert('ã‚°ãƒ«ãƒ¼ãƒ—ã€Œ'+name+'ã€ã‚’ä½œæˆã—ã¾ã—ãŸã€‚\né …ç›®ã®âœï¸ã‹ã‚‰ã€Œã‚°ãƒ«ãƒ¼ãƒ—åã€ã« '+name+' ã‚’è¿½è¨˜ã—ã¦ç®¡ç†ã—ã¦ãã ã•ã„ã€‚');
  };
  $('btn-toggle-all').onclick=()=>{
    const feats = hasY ? yFeatures.toArray() : localFeatures;
    const anyVisible = feats.some(f=>f.properties?.visible!==false);
    feats.forEach(f=>updateFeature(f.id, nf=>{ nf.properties.visible = !anyVisible; }));
  };

  if (hasY){
    yFeatures.observeDeep(()=> renderAll());
  }

  // ========= å‰Šé™¤ãƒœã‚¿ãƒ³ =========
  $('tool-delete').onclick=()=>{
    if(!EDITOR_KEY){ alert('é–²è¦§å°‚ç”¨ã§ã™ã€‚'); return; }
    const ids = draw.getSelectedIds ? draw.getSelectedIds() : [];
    if (ids.length) { draw.trash(); return; }
    // ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‹ã‚‰å‰Šé™¤æ¨å¥¨ï¼ˆã“ã“ã§ã¯ãƒ’ãƒ³ãƒˆï¼‰
    alert('å‰Šé™¤ã¯ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®ğŸ—‘ã‹ã‚‰è¡Œã£ã¦ãã ã•ã„ã€‚');
  };

  // ========= ãƒªãƒ³ã‚¯ä½œæˆï¼ˆçŸ­ã„URLï¼‰ =========
  $('btn-make-room').onclick=()=>{
    const q=getHash(); const r=ensureRoom(q); q.delete('k'); q.delete('state'); setHash(q);
    ROOM_ID=r; $('room-pill').textContent='room: '+ROOM_ID;
    alert('éƒ¨å±‹ã‚’ä½œæˆã—ã¾ã—ãŸã€‚URLã‚’å…±æœ‰ã—ã¦ãã ã•ã„ã€‚');
    if (hasY && !provider){ new ywebrtc.WebrtcProvider(ROOM_ID, ydoc); }
  };
  $('btn-make-editor').onclick=async ()=>{
    const url=buildEditorURL();
    try{ await navigator.clipboard.writeText(url); }catch(e){}
    location.hash = url.split('#')[1];
    const q=getHash(); ROOM_ID=q.get('r')||ROOM_ID; EDITOR_KEY=q.get('k')||EDITOR_KEY;
    $('role-badge').textContent=EDITOR_KEY?'ç·¨é›†å¯':'é–²è¦§å°‚ç”¨';
    $('room-pill').textContent='room: '+ROOM_ID;
    alert('ç·¨é›†ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚\n'+url);
  };
  $('btn-copy-view').onclick=async ()=>{
    const url=buildViewURL();
    try{ await navigator.clipboard.writeText(url); alert('é–²è¦§ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚\n'+url); }
    catch(e){ prompt('ã‚³ãƒ”ãƒ¼ã§ããªã„å ´åˆã¯æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„', url); }
  };

  // åˆå›æç”»
  renderAll();
})();
</script>
</body>
</html>
