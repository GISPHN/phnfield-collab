<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>PHN Field Collab</title>

  <!-- MapLibre + Draw CSS -->
  <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css"/>
  <link rel="stylesheet" href="https://unpkg.com/@mapbox/mapbox-gl-draw@1.5.0/dist/mapbox-gl-draw.css"/>

  <style>
    html,body,#map{height:100%;width:100%;margin:0}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP","Hiragino Kaku Gothic ProN",Meiryo,sans-serif;color:#111827}

    /* トップバー */
    .topbar{position:absolute;left:12px;right:12px;top:8px;z-index:30;display:flex;gap:8px;flex-wrap:wrap;pointer-events:none}
    .chip{pointer-events:auto;padding:6px 10px;border-radius:10px;border:1px solid #e5e7eb;background:rgba(255,255,255,.9);backdrop-filter:blur(6px);font-size:12px;font-weight:700}
    .chip.btn{cursor:pointer;background:#0ea5e9;color:#fff}
    .chip.btn.secondary{background:#eef2ff;color:#111827}
    #btnSurvey{position:relative;display:inline-flex;align-items:center;gap:6px}
    .recBadge{display:inline-flex;align-items:center;justify-content:center;padding:1px 6px;border-radius:6px;font-size:11px;font-weight:700;background:rgba(255,255,255,.9);color:#dc2626;border:1px solid rgba(220,38,38,.25)}
    .recBadge.recBlink{animation:recBlink 1s steps(2,start) infinite}
    .recBadge.paused{animation:none;color:#111827;background:#fde68a;border-color:#fbbf24}
    @keyframes recBlink{0%,49%{opacity:1}50%,100%{opacity:.2}}

    /* 左パネル（半透明） */
    .panel{position:absolute;left:12px;top:56px;width:340px;max-height:calc(100% - 68px);padding:12px;border-radius:12px;background:rgba(255,255,255,.86);backdrop-filter:blur(6px);box-shadow:0 8px 28px rgba(0,0,0,.12);overflow:auto;z-index:20}
    .panel h3{margin:0 0 8px;font-size:16px}
    .panel .group{margin:10px 0}
    .panel .row{display:flex;gap:8px}
    .panel .row>*{flex:1 1 0}
    .layerRow{display:flex;align-items:center;gap:8px;margin:6px 0}
    .layerRow label{flex:1}
    .layerActions{display:flex;gap:4px}
    .panel label{font-size:13px;display:inline-flex;align-items:center;gap:6px;margin:4px 8px 4px 0}
    .panel input[type="text"],.panel select{width:100%;padding:8px 10px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;font-size:13px}
    .panel .btn{display:inline-block;padding:8px 12px;border-radius:10px;border:1px solid #e5e7eb;background:#0ea5e9;color:#fff;font-weight:700;cursor:pointer;text-align:center}
    .panel .btn.secondary{background:#f3f4f6;color:#111827}
    .panel .btn:disabled{opacity:.55;cursor:not-allowed}

    /* 右パネル（半透明） */
.rightpane{
  position:absolute; right:12px; top:56px;
  width:320px; max-height:calc(100% - 68px);
  padding:12px; border-radius:12px;
  background:rgba(255,255,255,.86); backdrop-filter:blur(6px);
  box-shadow:0 8px 28px rgba(0,0,0,.12); overflow:auto; z-index:20;
}
.rightpane h4{ margin:0 0 8px; font-size:16px; }


    /* 左下：Supabase 操作 */
    .supabox{position:absolute;left:12px;bottom:12px;z-index:20;min-width:260px;padding:10px;border-radius:12px;background:rgba(255,255,255,.88);backdrop-filter:blur(6px);box-shadow:0 8px 28px rgba(0,0,0,.12)}
    .supabox h4{margin:0 0 6px;font-size:14px;font-weight:800}
    .supabox .row{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:6px}
    .supabox button{padding:6px 9px;border-radius:10px;border:1px solid #e5e7eb;background:#f8fafc;cursor:pointer;font-size:12px}
    .supabox button:hover{background:#eef2ff}
    .supabox .danger{background:#fee2e2;border-color:#fecaca}
    .supabox .wfull{flex:1 1 100%}

    /* サジェスト */
    .suggest{position:absolute;width:calc(100% - 24px);max-height:220px;overflow:auto;z-index:40;background:#fff;border:1px solid #e5e7eb;border-radius:10px;box-shadow:0 10px 28px rgba(0,0,0,.12);display:none}
    .suggest-item{padding:8px 10px;cursor:pointer}
    .suggest-item:hover{background:#f1f5f9}

    /* トースト/エラー */
    .toast{position:fixed;right:12px;bottom:12px;z-index:40;background:#ecfeff;border:1px solid #a5f3fc;border-radius:10px;padding:10px 12px;font-size:12px}
    .toast.bad{background:#fee2e2;border-color:#fecaca;color:#7f1d1d}
    .errbar{position:absolute;left:50%;transform:translateX(-50%);top:8px;z-index:50;background:#fee2e2;color:#7f1d1d;border:1px solid #fecaca;border-radius:10px;padding:8px 12px;display:none}

    /* ポップアップ整形 */
    .popup-list{margin:0;padding:0;list-style:none;font-size:12px;max-width:340px}
    .popup-list li{border-bottom:1px solid #f1f5f9;padding:6px 0}
    .popup-list li:last-child{border-bottom:none}
    .popup-list b{display:inline-block;min-width:120px;color:#374151}
    .note-popup{font-size:12px;line-height:1.4;max-width:240px}
    .note-popup div{margin:2px 0}
    /* --- 既存パネルを少し透明に --- */
.panel{ background:rgba(255,255,255,.80); }
.rightpane{ background:rgba(255,255,255,.82); }
.cursor-crosshair{cursor:crosshair!important;}

/* --- 上部のオブジェクト追加ボタンとサブツール --- */
#objToolbar{ display:flex; gap:6px; align-items:center; pointer-events:auto; }
#objSubtools{ display:none; gap:6px; margin-left:8px; pointer-events:auto; }
.chip.toggle-on{ background:#1e88e5; color:#fff; }
.tool{ padding:6px 10px; border-radius:8px; background:#fff; box-shadow:0 2px 8px rgba(0,0,0,.12); cursor:pointer; user-select:none; pointer-events:auto; }
.tool.active{ outline:2px solid #1e88e5; }

/* --- 右側：オブジェクト一覧（ドラッグ&ドロップ対応） --- */
#objPanel{  position: static;  /* ← absolute をやめる */
  width: auto;
  background: transparent;
  backdrop-filter: none;
  border-radius: 0;
  box-shadow: none;
  padding: 0;
}
#objList{ max-height:280px; overflow:auto; margin-top:6px; }
.objItem, .grpItem{
  background:#fff; border-radius:8px; padding:8px; margin:6px 0; box-shadow:0 1px 6px rgba(0,0,0,.08);
  display:flex; align-items:center; gap:8px;
}
.objItem.dragging, .grpItem.dragging{ opacity:.4; }
.objType{ width:22px; height:22px; border-radius:4px; display:inline-block; }
.type-point{ background:#1976d2; }
.type-line{  background:linear-gradient(90deg,#e53935 0 50%, transparent 0); border-bottom:3px solid #e53935; width:28px; }
.type-poly{  background:#43a047; opacity:.6; }
.type-circle{ background:#6d4c41; opacity:.6; border-radius:50%; }
.dropHint{ outline:2px dashed #1e88e5; }

/* ラベル入力と色・サイズUI */
.inline{ display:flex; align-items:center; gap:6px; flex-wrap:wrap; }
.small{ font-size:12px; color:#666; }
input[type="color"]{ width:36px; height:26px; padding:0; border:none; background:transparent; }
input[type="number"]{ width:70px; }

/* --- 現在地パルス（CSSアニメ） --- */
.pulse{
  width:18px; height:18px; border-radius:50%; background:#2196f3; box-shadow:0 0 0 rgba(33,150,243,.4);
  animation:pulse 2s infinite;
  border:2px solid #fff;
}
@keyframes pulse{
  0%{ box-shadow:0 0 0 0 rgba(33,150,243,.4); }
  70%{ box-shadow:0 0 0 18px rgba(33,150,243,0); }
  100%{ box-shadow:0 0 0 0 rgba(33,150,243,0); }
}
/* 自治体候補の前面化 */
.suggest{ position:absolute; z-index:9999; }
    
.small-creator{font-size:12px;color:#4b5563}
.small-creator .xicon{font-weight:700;margin-right:4px}
.floating{
  position:fixed; left:50%; top:50%; transform:translate(-50%,-50%);
  width:340px;
  background:rgba(255,255,255,.92); backdrop-filter:blur(8px);
  box-shadow:0 10px 32px rgba(0,0,0,.18); border-radius:12px; z-index:1000; padding:0;
}
.floating .group{margin:10px 0;}
.floating .row{display:flex;gap:8px;flex-wrap:wrap;}
.floating .btn{display:inline-block;padding:8px 12px;border-radius:10px;border:1px solid #e5e7eb;background:#0ea5e9;color:#fff;font-weight:700;cursor:pointer;text-align:center;}
.floating .btn.secondary{background:#f3f4f6;color:#111827;}
.floating .btn.danger{background:#fee2e2;border-color:#fecaca;color:#7f1d1d;}
.floating .btn:disabled{opacity:.55;cursor:not-allowed;}
.floating .btn.toggle-active{background:#2563eb;color:#fff;}
.floatHeader{display:flex;align-items:center;gap:8px;padding:10px 12px;border-bottom:1px solid #e5e7eb;font-weight:700}
.floatHeader .sub{font-weight:400;color:#6b7280;margin-left:6px}
.floatHeader .handle{margin-left:auto;cursor:move}
.floatBody{padding:10px 12px}
.suggest{position:absolute;z-index:9999} /* 候補は最前面 */

.labelBubble{
  position:absolute;
  z-index:60;
  min-width:220px;
  max-width:280px;
  padding:10px 12px;
  border-radius:10px;
  background:rgba(255,255,255,.95);
  box-shadow:0 10px 28px rgba(0,0,0,.18);
  border:1px solid rgba(148,163,184,.45);
  display:none;
  pointer-events:auto;
  transform:translate(-50%,-100%);
}
.labelBubble::after{
  content:"";
  position:absolute;
  left:50%;
  bottom:-8px;
  transform:translateX(-50%);
  border-width:8px 8px 0 8px;
  border-style:solid;
  border-color:rgba(255,255,255,.95) transparent transparent transparent;
}
.labelBubbleTitle{
  font-size:13px;
  font-weight:700;
  margin-bottom:6px;
}
.labelBubbleActions{
  display:flex;
  gap:6px;
  margin-top:8px;
}
.labelBubble input[type="text"]{
  width:100%;
  padding:6px 8px;
  border:1px solid #d1d5db;
  border-radius:8px;
  font-size:13px;
  box-sizing:border-box;
}
.labelBubble .btn{
  padding:6px 10px;
  font-size:12px;
}

.objItem{display:flex;align-items:center;gap:8px;padding:6px;border:1px solid #e5e7eb;border-radius:8px;margin:4px 0;background:rgba(255,255,255,.86);backdrop-filter:blur(4px)}
.objItem .objLabel{flex:1 1 auto;cursor:default}
.miniBtn{padding:4px 8px;border-radius:8px;border:none;background:#f3f4f6;cursor:pointer}
.miniBtn:hover{background:#e5e7eb}

  </style>
</head>
<body>
  <div id="map"></div>

  <!-- トップバー -->
  <div class="topbar">
    <div class="chip" style="display:flex;flex-direction:column;align-items:flex-start">
  <div>PHN Field Collab</div>
  <div class="small-creator">
    作成者：
    <a href="https://x.com/GISPHN" target="_blank" rel="noopener">
      <span class="xicon">𝕏</span> GISPHN
    </a>
  </div>
</div>
    <div class="chip">ベース:
      <select id="basemapSel" style="border:none;background:transparent;font-weight:700">
        <option value="osm">OSM</option>
        <option value="gsi_std">地理院 標準</option>
        <option value="gsi_photo">地理院 写真</option>
      </select>
    </div>
    <div class="chip btn secondary" id="btnExport">描画をGeoJSON出力</div>

    <!-- オブジェクト追加：メインボタン＋サブツール -->
<div id="objToolbar">
  <div id="btnObj" class="chip btn secondary">オブジェクト</div>
  <div id="objSubtools">
    <div class="tool" data-mode="point">ポイント</div>
    <div class="tool" data-mode="line">ライン</div>
    <div class="tool" data-mode="polygon">ポリゴン</div>
    <div class="tool" data-mode="circle">円</div>
  </div>
</div>
    <div class="chip btn secondary" id="btnSurvey">地区踏査<span id="surveyRecBadge" class="recBadge" style="display:none">REC</span></div>
    <div style="flex:1"></div>
    <div class="chip btn secondary" id="btnSignIn">サインイン（保存/共同編集）</div>
<div class="chip" id="signinState" style="display:none">保存ON</div>
<div class="chip btn secondary" id="btnShare" style="display:none">共有リンク</div>

  </div>

  <div id="surveyPanel" class="floating" style="display:none">
    <div class="floatHeader">地区踏査
      <span class="handle" title="ドラッグで移動">⣿</span>
    </div>
    <div class="floatBody">
      <div class="group" style="display:flex;flex-wrap:wrap;gap:8px">
        <button class="btn" id="surveyStartBtn">記録開始</button>
        <button class="btn secondary" id="surveyAddHereBtn">ココで追加</button>
        <button class="btn secondary" id="surveyAddManualBtn">手動追加</button>
        <button class="btn secondary" id="surveyEditBtn">修正</button>
        <button class="btn secondary" id="surveyToggleLabelBtn">ラベル表示</button>
        <button class="btn secondary" id="surveyPauseBtn">一時停止</button>
        <button class="btn danger" id="surveyFinishBtn">完了</button>
      </div>
      <div id="surveyStatus" class="small" style="margin-top:6px;color:#4b5563"></div>
      <div id="surveyFinishPanel" style="display:none;margin-top:12px"></div>
    </div>
  </div>

  <div id="surveyNotePanel" class="floating" style="display:none">
    <div class="floatHeader">メモ入力
      <span class="handle" title="ドラッグで移動">⣿</span>
    </div>
    <div class="floatBody">
      <div class="group">
        <input type="text" id="surveyNoteLine1" placeholder="ラベル1"/>
        <input type="text" id="surveyNoteLine2" placeholder="ラベル2" style="margin-top:8px"/>
      </div>
      <div class="group">
        <button class="btn secondary" id="surveyCapBtn">CAPタグ</button>
        <div id="surveyCapSelectWrap" style="display:none;margin-top:8px">
          <select id="surveyCapSelect" style="width:100%"></select>
        </div>
      </div>
      <div class="group" id="surveyNoteMoveWrap" style="display:none">
        <button class="btn secondary" id="surveyNoteMoveBtn">位置を変更</button>
      </div>
      <div class="group">
        <div class="row">
          <button class="btn" id="surveyNoteConfirm">OK</button>
          <button class="btn secondary" id="surveyNoteCancel">キャンセル</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 左パネル -->
  <div class="panel" id="panel">
    <h3>レイヤ / 背景地図</h3>
    <div class="group">
      <button class="btn" id="btnExtent">一括表示範囲</button>
      <span style="font-size:12px;color:#6b7280;margin-left:6px">（全レイヤに適用）</span>
    </div>

    <div class="group">
      <div class="layerRow">
        <label><input type="checkbox" id="chkFlood"> 洪水浸水想定区域（想定最大規模）</label>
      </div>
      <div class="layerRow">
        <label><input type="checkbox" id="chkSediment"> 土砂災害警戒区域（3レイヤ一括ON/OFF）</label>
      </div>
      <div class="row" style="align-items:center;margin-top:6px">
        <div style="font-size:12px;min-width:64px">透明度</div>
        <input type="range" id="hazOpacity" min="0" max="1" step="0.05" value="0.60"/>
        <div id="hazOpacityVal" style="width:36px;text-align:right;font-size:12px">0.60</div>
      </div>
      <div style="font-size:12px;color:#6b7280;margin-top:6px">※ハザードのタイルURLを設定していない場合は無効</div>
      <div style="font-size:12px;color:#6b7280;margin-top:4px">凡例（例示画像を必要に応じ差替）</div>
      <img src="l2_flood_l.png" style="max-width:100%;opacity:.85" alt="凡例(洪水)">
      <img src="l2_sediment_l.png" style="max-width:100%;opacity:.85" alt="凡例(土砂)">
    </div>

    <div class="group">
      <div>避難施設（FGB）:</div>
      <div class="layerRow">
        <label><input type="checkbox" id="chkEmergency"> 指定<strong>緊急避難場所</strong>（赤）</label>
        <div class="layerActions">
          <button class="miniBtn" data-layer="emergency" data-action="scope">表示範囲</button>
          <button class="miniBtn" data-layer="emergency" data-action="label">ラベル</button>
        </div>
      </div>
      <div class="layerRow">
        <label><input type="checkbox" id="chkShelter"> 指定<strong>避難所</strong>（青）</label>
        <div class="layerActions">
          <button class="miniBtn" data-layer="shelter" data-action="scope">表示範囲</button>
          <button class="miniBtn" data-layer="shelter" data-action="label">ラベル</button>
        </div>
      </div>

    </div>
<!-- ▼ 表示範囲フローティングパネル（ドラッグ可） ▼ -->
<div id="extentPanel" class="floating" style="display:none">
  <div class="floatHeader">表示範囲 <span class="sub" id="extentScopeNote">(全レイヤ)</span>
    <span class="handle" title="ドラッグで移動">⣿</span>
  </div>
  <div class="floatBody">

    <div class="group">
      <div>表示範囲：</div>
      <label><input type="radio" name="areaMode" value="all" checked> 日本全国</label>
      <label><input type="radio" name="areaMode" value="pref"> 都道府県</label>
      <label><input type="radio" name="areaMode" value="muni"> 市区町村</label>
    </div>

    <div class="group" id="prefRow" style="display:none">
      <div style="font-size:12px;margin-bottom:4px">都道府県（複数選択可 / Ctrl+クリック）</div>
      <select id="prefSelect" multiple size="7"></select>
    </div>

    <div class="group" id="muniRow" style="display:none;position:relative">
      <div style="font-size:12px;margin-bottom:4px">市区町村（複数選択可 / Ctrl+クリック）</div>
      <input id="qMuni" type="text" placeholder="例）奈良市、生駒市 / 東京都"/>
      <div class="suggest" id="suggest"></div>
      <div style="height:6px"></div>
      <select id="muniSelect" multiple size="10" style="display:none"></select>
    </div>

      <div class="group">
        <div class="row">
          <button class="btn" id="btnExtentConfirm">OK</button>
          <button class="btn secondary" id="btnExtentCancel">キャンセル</button>
        </div>
        <div style="font-size:12px;color:#6b7280;margin-top:6px">※設定はOKで反映されます</div>
  </div>
</div>
<!-- ▲ 表示範囲フローティングパネル ▲ -->

<!-- ▼ ラベル選択パネル ▼ -->
<div id="labelPanel" class="floating" style="display:none">
  <div class="floatHeader">ラベル選択 <span class="sub" id="labelScopeNote"></span>
    <span class="handle" title="ドラッグで移動">⣿</span>
  </div>
  <div class="floatBody">
    <div class="group">
      <div style="font-size:12px;margin-bottom:4px">表示するカラム</div>
      <select id="labelFieldList"></select>
    </div>
    <div class="group">
      <div class="row">
        <button class="btn" id="btnLabelConfirm">OK</button>
        <button class="btn secondary" id="btnLabelCancel">キャンセル</button>
      </div>
      <div style="font-size:12px;color:#6b7280;margin-top:6px">※「なし」を選択するとラベルを非表示にします</div>
    </div>
  </div>
</div>
<!-- ▲ ラベル選択パネル ▲ -->

<!-- ▼ ポリゴン ラベル入力パネル ▼ -->
<div id="polygonLabelPanel" class="floating" style="display:none">
  <div class="floatHeader">ポリゴン ラベル
    <span class="handle" title="ドラッグで移動">⣿</span>
  </div>
  <div class="floatBody">
    <div class="group">
      <input type="text" id="polyLabelInput1" placeholder="ラベル1"/>
      <input type="text" id="polyLabelInput2" placeholder="ラベル2" style="margin-top:8px"/>
    </div>
    <div class="group">
      <div class="row">
        <button class="btn" id="polyLabelConfirm">OK</button>
        <button class="btn secondary" id="polyLabelCancel">キャンセル</button>
      </div>
    </div>
  </div>
</div>
<!-- ▲ ポリゴン ラベル入力パネル ▲ -->

    </div>
  </div>

  <!-- ▼ オブジェクト ラベル入力バブル ▼ -->
  <div id="simpleLabelPanel" class="labelBubble" style="display:none">
    <div class="labelBubbleTitle" id="simpleLabelTitle">ラベル入力</div>
    <input type="text" id="simpleLabelInput" placeholder="ラベル"/>
    <div class="labelBubbleActions">
      <button class="btn" id="simpleLabelConfirm">OK</button>
      <button class="btn secondary" id="simpleLabelCancel">キャンセル</button>
    </div>
  </div>
  <!-- ▲ オブジェクト ラベル入力バブル ▲ -->

  <!-- 右パネル -->
  <div class="rightpane">
<div id="objPanel">
  <div class="inline small" style="margin-bottom:6px">
    <strong>オブジェクト一覧</strong>
    <span style="margin-left:auto"></span>
    <label><input type="radio" name="styleScope" value="single" checked> 個別</label>
    <label><input type="radio" name="styleScope" value="group"> グループ</label>
    <label><input type="radio" name="styleScope" value="all"> 全体</label>
  </div>
  <div id="objList"></div>
</div>

 </div>
<!-- ==== /Object List Panel ==== -->


  <!-- 左下：Supabase 操作 -->
  <div class="supabox" style="display:none">
    <h4>共同編集 / GPS</h4>
    <div class="row">
      <button class="wfull" onclick="window.__supaload()">図形を再読込</button>
      <button class="wfull" onclick="window.__supasave()">図形を保存</button>
    </div>
    <div class="row">
      <button onclick="window.__gpstart()">GPS開始</button>
      <button class="danger" onclick="window.__gpstop()">GPS停止</button>
      <button onclick="window.__gpshow()">軌跡表示</button>
    </div>
    <div class="row">
      <button class="wfull" onclick="(async()=>{const e=prompt('メールアドレス');if(!e)return;await __supa.auth.signInWithOtp({email:e});alert('届いたメールのリンクを開いたらこの画面に戻ってください');})();">メールでログイン</button>
      <button class="wfull" onclick="__supa.auth.signOut().then(()=>alert('サインアウトしました'))">サインアウト</button>
    </div>
  </div>

  <div id="err" class="errbar"></div>

  <!-- ライブラリ -->
  <script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>
  <script src="https://unpkg.com/@mapbox/mapbox-gl-draw@1.5.0/dist/mapbox-gl-draw.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js"></script>

  <script>
  /*************** ★★★ TODO 1：Supabase の Project URL / anon public key ***************/
  const SUPABASE_URL  = 'https://tdoxxwhkvdguyfrofnaw.supabase.co';   // ←置換
  const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRkb3h4d2hrdmRndXlmcm9mbmF3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0MTQ0NDQsImV4cCI6MjA3NDk5MDQ0NH0.h2ZnTGr0jml2V7SUvEaOSzjNXxKvCJuJryFEyEkrQQc';                // ←置換

  // Supabase クライアント（UMD で window.supabase が生える前提）
  try {
    if (!window.supabase) throw new Error('Supabase SDK (UMD) が読み込まれていません');
    window.__supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
  } catch (e) {
    console.error(e);
    // 共同編集/GPS系が使えないときでも地図は動かすためのダミー
    window.__supa = {
      from(){ return { select:async()=>({}), insert:async()=>({}), in:async()=>({}), eq:async()=>({}), order:async()=>({}), single:async()=>({}) }; },
      auth:{ signInWithOtp:async()=>({}), signOut:async()=>({}) }
    };
    // 失敗は画面にも出す
    setTimeout(()=>{ const b=document.createElement('div'); b.className='toast bad'; b.textContent='Supabase の初期化に失敗（共同編集/GPSは無効ですが地図は動きます）'; document.body.appendChild(b); setTimeout(()=>b.remove(), 5000); }, 1000);
  }
  // ▲▲▲ ここまで置換
  window.__room = new URLSearchParams(location.hash.slice(1)).get('r') || 'default';

  // ユーティリティ
  const $ = (id)=>document.getElementById(id);
  const toast=(m,bad=false)=>{const el=document.createElement('div');el.className='toast'+(bad?' bad':'');el.textContent=m;document.body.appendChild(el);setTimeout(()=>el.remove(),3000);}
  const showErr=(m)=>{const e=$('err');e.textContent=m;e.style.display='block';setTimeout(()=>e.style.display='none',10000);}
  const showFloatingPanel=(panel)=>{ panel.style.display='block'; panel.style.left='50%'; panel.style.top='50%'; panel.style.transform='translate(-50%,-50%)'; };
  const makeDraggable=(panel)=>{
    const header=panel.querySelector('.handle');
    if(!header) return;
    let dragging=false,sx=0,sy=0,left=0,top=0;
    header.addEventListener('pointerdown',e=>{
      dragging=true; sx=e.clientX; sy=e.clientY;
      const rect=panel.getBoundingClientRect();
      panel.style.transform='none';
      panel.style.left=rect.left+'px';
      panel.style.top=rect.top+'px';
      left=rect.left; top=rect.top;
      header.setPointerCapture(e.pointerId);
    });
    header.addEventListener('pointermove',e=>{
      if(!dragging) return;
      const dx=e.clientX-sx, dy=e.clientY-sy;
      panel.style.left=(left+dx)+'px';
      panel.style.top=(top+dy)+'px';
    });
    header.addEventListener('pointerup',()=>{dragging=false;});
  };
  const centerPanel=(panel)=>{ if(panel) showFloatingPanel(panel); };

  const simpleLabelPanel=$('simpleLabelPanel');
  const simpleLabelInput=$('simpleLabelInput');
  const simpleLabelTitle=$('simpleLabelTitle');
  const SIMPLE_LABEL_EVENTS=['move','moveend','zoom','rotate','pitch'];
  let simpleLabelContext={ feature:null,isNew:false,resumeMode:null,onApply:null,anchor:null,positionMode:'anchor' };
  function computeSimpleLabelAnchor(feature){
    if(!feature?.geometry) return null;
    const geom=feature.geometry;
    try{
      if(geom.type==='Point' && Array.isArray(geom.coordinates)){
        return geom.coordinates.slice();
      }
      if(Array.isArray(geom.coordinates)){
        if(!geom.coordinates.length) return null;
        const bbox=turf.bbox(feature);
        const midLng=(bbox[0]+bbox[2])/2;
        const topLat=bbox[3];
        return [midLng, topLat];
      }
    }catch(err){
      console.warn('computeSimpleLabelAnchor', err);
    }
    return null;
  }
  function updateSimpleLabelPosition(){
    if(!simpleLabelPanel || simpleLabelPanel.style.display==='none') return;
    if(simpleLabelContext.positionMode==='center'){
      simpleLabelPanel.style.left='50%';
      simpleLabelPanel.style.top='50%';
      simpleLabelPanel.style.transform='translate(-50%,-50%)';
      return;
    }
    const anchor=simpleLabelContext.anchor;
    if(!anchor) return;
    if(typeof map==='undefined' || !map || typeof map.project!=='function') return;
    const pt=map.project(anchor);
    const offset=12;
    simpleLabelPanel.style.left=`${pt.x}px`;
    simpleLabelPanel.style.top=`${pt.y - offset}px`;
    simpleLabelPanel.style.transform='translate(-50%,-100%)';
  }
  function attachSimpleLabelPosition(){
    if(typeof map==='undefined' || !map) return;
    SIMPLE_LABEL_EVENTS.forEach(evt=>map.on(evt, updateSimpleLabelPosition));
    window.addEventListener('resize', updateSimpleLabelPosition);
  }
  function detachSimpleLabelPosition(){
    if(typeof map!=='undefined' && map){
      SIMPLE_LABEL_EVENTS.forEach(evt=>map.off(evt, updateSimpleLabelPosition));
    }
    window.removeEventListener('resize', updateSimpleLabelPosition);
  }
  function openSimpleLabelEditor(feature,{resumeMode=null,isNew=false,onApply=null,title='ラベル入力'}={}){
    detachSimpleLabelPosition();
    simpleLabelContext={ feature, isNew, resumeMode, onApply, anchor:null, positionMode:'anchor' };
    if(simpleLabelTitle) simpleLabelTitle.textContent=title;
    if(simpleLabelInput) simpleLabelInput.value=feature?.properties?.label||'';
    simpleLabelContext.anchor=computeSimpleLabelAnchor(feature);
    if(simpleLabelPanel){
      if(simpleLabelContext.anchor){
        simpleLabelContext.positionMode='anchor';
        simpleLabelPanel.style.display='block';
        updateSimpleLabelPosition();
        attachSimpleLabelPosition();
      }else{
        simpleLabelContext.positionMode='center';
        simpleLabelPanel.style.display='block';
        updateSimpleLabelPosition();
      }
    }
    if(simpleLabelInput){
      simpleLabelInput.focus();
      simpleLabelInput.select();
    }
  }
  function closeSimpleLabel(apply){
    const ctx=simpleLabelContext;
    if(simpleLabelPanel) simpleLabelPanel.style.display='none';
    detachSimpleLabelPosition();
    if(!ctx.feature){
      simpleLabelContext={ feature:null,isNew:false,resumeMode:null,onApply:null,anchor:null,positionMode:'anchor' };
      return;
    }
    if(apply){
      ctx.feature.properties=ctx.feature.properties||{};
      const labelVal=simpleLabelInput ? simpleLabelInput.value.trim() : '';
      ctx.feature.properties.label=labelVal;
      if(typeof ctx.onApply==='function'){
        ctx.onApply(ctx.feature);
      }else if(ctx.isNew){
        if(typeof window.pushFeature==='function') window.pushFeature(ctx.feature);
        else if(window.userFC && Array.isArray(window.userFC.features)){ window.userFC.features.push(ctx.feature); }
        if(typeof syncUserFeatures==='function' && typeof window.pushFeature!=='function') syncUserFeatures();
      }else{
        if(typeof syncUserFeatures==='function') syncUserFeatures();
      }
    }
    if(ctx.resumeMode && typeof activateTool==='function') activateTool(ctx.resumeMode);
    simpleLabelContext={ feature:null,isNew:false,resumeMode:null,onApply:null,anchor:null,positionMode:'anchor' };
    if(typeof updateMapCursor==='function') updateMapCursor();
  }
  $('simpleLabelConfirm')?.addEventListener('click',()=>closeSimpleLabel(true));
  $('simpleLabelCancel')?.addEventListener('click',()=>closeSimpleLabel(false));
  simpleLabelInput?.addEventListener('keydown',ev=>{ if(ev.key==='Enter'){ ev.preventDefault(); closeSimpleLabel(true); } });
  window.openSimpleLabelEditor=openSimpleLabelEditor;

  const polygonLabelPanel=$('polygonLabelPanel');
  makeDraggable(polygonLabelPanel);
  let polygonLabelTarget=null;
  let polygonResumeMode=null;
  let polygonIsNew=false;
  function openPolygonLabelEditor(feature,{resumeMode=null,isNew=false}={}){
    polygonLabelTarget=feature;
    polygonResumeMode=resumeMode;
    polygonIsNew=isNew;
    if(feature){
      const props=feature.properties||{};
      $('polyLabelInput1').value=props.label1||'';
      $('polyLabelInput2').value=props.label2||'';
    }
    centerPanel(polygonLabelPanel);
    requestAnimationFrame(()=>{
      const input=$('polyLabelInput1');
      if(input){ input.focus(); input.select(); }
    });
  }
  function closePolygonLabel(apply){
    if(polygonLabelTarget && apply){
      const l1=$('polyLabelInput1').value.trim();
      const l2=$('polyLabelInput2').value.trim();
      polygonLabelTarget.properties=polygonLabelTarget.properties||{};
      polygonLabelTarget.properties.label1=l1;
      polygonLabelTarget.properties.label2=l2;
      polygonLabelTarget.properties.label=[l1,l2].filter(Boolean).join(' / ');
      const polyProps=polygonLabelTarget.properties;
      if(!('fillColor' in polyProps)) polyProps.fillColor='#43a047';
      if(!('fillOpacity' in polyProps)) polyProps.fillOpacity=0.5;
      if(!('lineColor' in polyProps)) polyProps.lineColor='#2e7d32';
      if(!('lineWidth' in polyProps)) polyProps.lineWidth=2;
      if(polygonIsNew){
        if(typeof window.pushFeature==='function') window.pushFeature(polygonLabelTarget);
        else if(window.userFC && Array.isArray(window.userFC.features)){ window.userFC.features.push(polygonLabelTarget); if(typeof syncUserFeatures==='function') syncUserFeatures(); }
      }else{
        if(typeof syncUserFeatures==='function') syncUserFeatures();
      }
    }
    polygonLabelTarget=null;
    polygonIsNew=false;
    if(polygonLabelPanel) polygonLabelPanel.style.display='none';
    if(polygonResumeMode && typeof activateTool==='function') activateTool(polygonResumeMode);
    polygonResumeMode=null;
    if(typeof updateMapCursor==='function') updateMapCursor();
  }
  $('polyLabelConfirm')?.addEventListener('click',()=>closePolygonLabel(true));
  $('polyLabelCancel')?.addEventListener('click',()=>closePolygonLabel(false));
  window.openPolygonLabelEditor=openPolygonLabelEditor;

  const STORAGE_KEYS={
    userObjects:'phnfc_user_objects_v1',
    surveyNotes:'phnfc_survey_notes_v1'
  };
  function loadStoredUserFC(){
    if(!window.localStorage) return null;
    try{
      const raw=localStorage.getItem(STORAGE_KEYS.userObjects);
      if(!raw) return null;
      const parsed=JSON.parse(raw);
      if(parsed && parsed.type==='FeatureCollection' && Array.isArray(parsed.features)){
        return parsed;
      }
    }catch(err){ console.warn('loadStoredUserFC', err); }
    return null;
  }
  function saveUserFCToStorage(fc){
    if(!window.localStorage) return;
    try{
      localStorage.setItem(STORAGE_KEYS.userObjects, JSON.stringify(fc));
    }catch(err){ console.warn('saveUserFCToStorage', err); }
  }
  let storedUserFC=loadStoredUserFC();
  window.userFC = storedUserFC || { type:'FeatureCollection', features:[] };

  // 都道府県
  const PREFS=["北海道","青森県","岩手県","宮城県","秋田県","山形県","福島県","茨城県","栃木県","群馬県","埼玉県","千葉県","東京都","神奈川県","新潟県","富山県","石川県","福井県","山梨県","長野県","岐阜県","静岡県","愛知県","三重県","滋賀県","京都府","大阪府","兵庫県","奈良県","和歌山県","鳥取県","島根県","岡山県","広島県","山口県","徳島県","香川県","愛媛県","高知県","福岡県","佐賀県","長崎県","熊本県","大分県","宮崎県","鹿児島県","沖縄県"];

  /*************** ベースマップ（OSM & 地理院タイル） ***************/
  const BASE_SOURCES = {
    osm: { type:'raster', tiles:["https://tile.openstreetmap.org/{z}/{x}/{y}.png"], tileSize:256, attribution:"© OpenStreetMap" },
    gsi_std:   { type:'raster', tiles:["https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png"], tileSize:256, attribution:"© GSI" },
    gsi_photo: { type:'raster', tiles:["https://cyberjapandata.gsi.go.jp/xyz/ort/{z}/{x}/{y}.jpg"], tileSize:256, attribution:"© GSI" }
  };
  const BASE_OPACITY = 0.75;

const map = new maplibregl.Map({
  container:'map',
  style:{
    version:8,
    glyphs:'https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf',
      sources:{ base: BASE_SOURCES.osm },
      layers:[{id:'base',type:'raster',source:'base',paint:{'raster-opacity':BASE_OPACITY}}]
    },
    center:[139.767,35.681], zoom:5.2
  });
// 縮尺バー
map.addControl(new maplibregl.ScaleControl({maxWidth:140, unit:'metric'}), 'bottom-left');

map.on('styledata', ensureUserPointFlagIcon);

// 現在地（MapLibre 組み込み）
const geoControl = new maplibregl.GeolocateControl({ positionOptions:{ enableHighAccuracy:true }, trackUserLocation:true, showUserHeading:true });
map.addControl(geoControl, 'bottom-left');
  let pulse;
geoControl.on('geolocate', (pos)=>{
  const { longitude, latitude } = pos.coords;
  surveyState.currentPosition=pos;
  if(!pulse){
    const el=document.createElement('div');
    el.className='pulse';
    el.style.pointerEvents='none';
    el.style.cursor='inherit';
    pulse=new maplibregl.Marker({element:el, anchor:'center'});
  }
  pulse.setLngLat([longitude, latitude]).addTo(map);
});

const overlayLayerOrder=[
  'user-temp-fill','user-temp-line',
  'user-poly-fill','user-poly-line','user-line','user-line-label','user-poly-label','user-circle-label',
  'user-point-emoji','user-point-label',
  'survey-track-line','survey-track-points',
  'survey-notes-icon','survey-notes-label'
];
function ensureOverlayOrder(){
  overlayLayerOrder.forEach(id=>{ if(map.getLayer(id)) map.moveLayer(id); });
}

function ensureSurveyFlagIcon(){
  if(typeof map==='undefined' || !map || typeof map.hasImage!=='function') return;
  if(map.hasImage('survey-flag')) return;
  const size=64;
  const canvas=document.createElement('canvas');
  canvas.width=size;
  canvas.height=size;
  const ctx=canvas.getContext('2d');
  if(!ctx) return;
  ctx.clearRect(0,0,size,size);
  // pole shadow
  ctx.fillStyle='rgba(15,23,42,0.12)';
  ctx.beginPath();
  ctx.ellipse(size*0.22, size*0.84, size*0.12, size*0.04, 0, 0, Math.PI*2);
  ctx.fill();
  // pole
  ctx.fillStyle='#1f2937';
  ctx.fillRect(size*0.18, size*0.16, size*0.08, size*0.68);
  // flag cloth
  ctx.fillStyle='#ef4444';
  ctx.beginPath();
  ctx.moveTo(size*0.26, size*0.2);
  ctx.lineTo(size*0.78, size*0.32);
  ctx.lineTo(size*0.26, size*0.44);
  ctx.closePath();
  ctx.fill();
  try{
    const data=ctx.getImageData(0,0,size,size);
    map.addImage('survey-flag', { width:size, height:size, data:data.data }, { pixelRatio:2 });
  }catch(err){
    if(!(err && typeof err.message==='string' && err.message.includes('already exists'))){
      console.warn('ensureSurveyFlagIcon', err);
    }
  }
}

function ensureUserPointFlagIcon(){
  if(typeof map==='undefined' || !map || typeof map.hasImage!=='function') return;
  if(map.hasImage('user-point-flag')) return;
  const baseSize=64;
  const ratio=Math.max(1, Math.min(3, window.devicePixelRatio||1));
  const canvas=document.createElement('canvas');
  canvas.width=baseSize*ratio;
  canvas.height=baseSize*ratio;
  const ctx=canvas.getContext('2d');
  if(!ctx) return;
  ctx.scale(ratio,ratio);
  ctx.clearRect(0,0,baseSize,baseSize);
  ctx.textAlign='center';
  ctx.textBaseline='middle';
  ctx.font=`${Math.round(baseSize*0.78)}px "Noto Color Emoji","Segoe UI Emoji","Apple Color Emoji",system-ui`;
  ctx.fillText('🚩', baseSize/2, baseSize/2 + baseSize*0.04);
  try{
    const data=ctx.getImageData(0,0,canvas.width,canvas.height);
    map.addImage('user-point-flag',{width:canvas.width,height:canvas.height,data:data.data},{pixelRatio:ratio});
  }catch(err){
    if(!(err && typeof err.message==='string' && err.message.includes('already exists'))){
      console.warn('ensureUserPointFlagIcon', err);
    }
  }
}


$('basemapSel').addEventListener('change', ()=>{
  const key = $('basemapSel').value;

  // 既存の base を外す
  if (map.getLayer('base')) map.removeLayer('base');
  if (map.getSource('base')) map.removeSource('base');

  // 新しい source を用意
  map.addSource('base', BASE_SOURCES[key]);

  // hillshade の「直上」に置く（＝陰影は常に下、ベースはその上に来る）
  const layers = map.getStyle().layers.map(l=>l.id);
  // hillshade より上に置きたいので、hillshadeの“次”のレイヤを before に指定
  const idxHill = layers.indexOf('hillshade');
  const beforeId = (idxHill >= 0 && layers[idxHill+1]) ? layers[idxHill+1] : undefined;

  map.addLayer({ id:'base', type:'raster', source:'base', paint:{'raster-opacity':BASE_OPACITY} }, beforeId);
  ensureOverlayOrder();
});

  /*************** Draw（ポイント/ライン/ポリゴン + 円ツール） ***************/
const draw = new MapboxDraw({
  displayControlsDefault:false,
  controls:{} // ← すべてUI非表示
});
// map.addControl(draw,'top-right'); ← 追加しない

  /*************** ハザード（洪水=1、土砂=3まとめ） ***************/
  // ★ 必要に応じてURLを設定（空なら自動無効）
  const FLOOD_TILES = "https://disaportaldata.gsi.go.jp/raster/01_flood_l2_shinsuishin_data/{z}/{x}/{y}.png"; // 例: 'https://{s}.example.com/flood/{z}/{x}/{y}.png'
  const SEDIMENT_TILES = [
    "https://disaportaldata.gsi.go.jp/raster/05_dosekiryukeikaikuiki/{z}/{x}/{y}.png", //"例: 'https://{s}.example.com/sediment/debrisflow/{z}/{x}/{y}.png'
    "https://disaportaldata.gsi.go.jp/raster/05_kyukeishakeikaikuiki/{z}/{x}/{y}.png", // 例: 'https://{s}.example.com/sediment/steepslope/{z}/{x}/{y}.png'
    "https://disaportaldata.gsi.go.jp/raster/05_jisuberikeikaikuiki/{z}/{x}/{y}.png"  // 例: 'https://{s}.example.com/sediment/landslide/{z}/{x}/{y}.png'
  ];
  const HAZ_FLOOD_SOURCE_ID="haz-flood", HAZ_FLOOD_LAYER_ID="haz-flood";
  const HAZ_SED_SOURCE_IDS=["haz-sed-0","haz-sed-1","haz-sed-2"];
  const HAZ_SED_LAYER_IDS =["haz-sed-0","haz-sed-1","haz-sed-2"];

  function ensureHazardLayers(){
    const opa=Number($('hazOpacity').value||0.6);
    if(FLOOD_TILES && !map.getSource(HAZ_FLOOD_SOURCE_ID)){
      map.addSource(HAZ_FLOOD_SOURCE_ID,{type:'raster',tiles:[FLOOD_TILES],tileSize:256});
    }
    if(FLOOD_TILES && !map.getLayer(HAZ_FLOOD_LAYER_ID)){
      map.addLayer({id:HAZ_FLOOD_LAYER_ID,type:'raster',source:HAZ_FLOOD_SOURCE_ID,paint:{'raster-opacity':opa}});
    }
    SEDIMENT_TILES.forEach((url,i)=>{
      if(!url) return;
      if(!map.getSource(HAZ_SED_SOURCE_IDS[i])){
        map.addSource(HAZ_SED_SOURCE_IDS[i],{type:'raster',tiles:[url],tileSize:256});
      }
      if(!map.getLayer(HAZ_SED_LAYER_IDS[i])){
        map.addLayer({id:HAZ_SED_LAYER_IDS[i],type:'raster',source:HAZ_SED_SOURCE_IDS[i],paint:{'raster-opacity':opa}});
      }
    });
  }
  function updateHazard(){
    const opa=Number($('hazOpacity').value||0.6);
    $('hazOpacityVal').textContent=opa.toFixed(2);
    if(map.getLayer(HAZ_FLOOD_LAYER_ID)){
      map.setPaintProperty(HAZ_FLOOD_LAYER_ID,'raster-opacity',opa);
      map.setLayoutProperty(HAZ_FLOOD_LAYER_ID,'visibility',$('chkFlood').checked?'visible':'none');
    }
    HAZ_SED_LAYER_IDS.forEach(lid=>{
      if(!map.getLayer(lid)) return;
      map.setPaintProperty(lid,'raster-opacity',opa);
      map.setLayoutProperty(lid,'visibility',$('chkSediment').checked?'visible':'none');
    });
  }
  $('chkFlood').addEventListener('change',()=>{ensureHazardLayers();updateHazard();});
  $('chkSediment').addEventListener('change',()=>{ensureHazardLayers();updateHazard();});
  $('hazOpacity').addEventListener('input',updateHazard);

  /*************** ★★★ TODO 2：FGB（公開URL）を貼る ***************/
  // Supabase Storage の Public URL をそのまま貼ってください（署名URLではありません）
  const FGB_URL_EMERGENCY='https://tdoxxwhkvdguyfrofnaw.supabase.co/storage/v1/object/public/data/Designated%20Emergency%20Evacuation%20Site.fgb'; // ←置換（先頭 e）
  const FGB_URL_SHELTER  ='https://tdoxxwhkvdguyfrofnaw.supabase.co/storage/v1/object/public/data/Designated%20Shelter%20for%20Evacuees.fgb';     // ←置換

// 自己ホストした flatgeobuf を “必ず最初に” 読みにいく
const LOCAL_FGB_LIB = './flatgeobuf-geojson.min.js';

/**
 * flatgeobuf の GeoJSON デシリアライザ（deserialize）を確実に読み込む。
 * 1) 自己ホスト（LOCAL_FGB_LIB）
 * 2) jsDelivr
 * 3) unpkg
 * それでもダメならエラー。
 */
async function loadFgbLib() {
  if (window.flatgeobuf?.deserialize) return window.flatgeobuf.deserialize;

  const candidates = [
    LOCAL_FGB_LIB,
    'https://cdn.jsdelivr.net/npm/flatgeobuf@3.27.4/dist/flatgeobuf-geojson.min.js',
    'https://unpkg.com/flatgeobuf@3.27.4/dist/flatgeobuf-geojson.min.js'
  ];

  for (const url of candidates) {
    try {
      await new Promise((resolve, reject) => {
        const s = document.createElement('script');
        s.src = url;
        s.async = true;
        s.onload = resolve;
        s.onerror = () => reject(new Error('failed: ' + url));
        document.head.appendChild(s);
      });
      if (window.flatgeobuf?.deserialize) {
        return window.flatgeobuf.deserialize;
      }
    } catch (e) {
      console.warn('[flatgeobuf] load failed ->', e.message);
    }
  }
  throw new Error('flatgeobufの読み込みに失敗（自己ホスト/CDNとも不可）');
}

/**
 * FGB を URL から読み、GeoJSON Feature[] を返す。
 * - 先頭1バイト Range 取得で HTML誤配信を検知
 * - loadFgbLib() を通して自己ホスト/フォールバックでライブラリを確実にロード
 */
/**
 * FGB を URL から読み、GeoJSON Feature[] を返す。
 * 1) まず URL をそのまま渡してストリーミング解析（Range）を試す
 * 2) 失敗したら全量ダウンロード → Uint8Array でパース（確実）
 */
async function readFGB_fromURL(url) {
  const deserialize = await loadFgbLib();

  // --- まずは簡易チェック（HTML 誤配信防止） ---
  try {
    const head = await fetch(url, { headers: { 'Range': 'bytes=0-0' }, cache: 'no-store' });
    if (!head.ok) throw new Error(`FGBヘッダ取得失敗 ${head.status} ${head.statusText}`);
    const ct = (head.headers.get('content-type') || '').toLowerCase();
    if (ct.includes('text/html')) {
      throw new Error('FGB直リンクがHTMLを返しています（URL/公開設定/パスを確認）');
    }
  } catch (e) {
    // ヘッダ取得がダメでも後段の「全量取得」で救えるので続行
    console.warn('[FGB] head check skip ->', e.message);
  }

  // --- (A) URL ストリーミングでパース（成功すれば最速） ---
  try {
    const featsA = [];
    for await (const f of deserialize(url)) featsA.push(f);
    if (featsA.length) return featsA;
  } catch (e) {
    console.warn('[FGB] stream parse failed, fallback to full download ->', e.message);
    // 例の「Cannot destructure property 'minX' of 'r' as it is undefined」もここに来ます
  }

  // --- (B) フォールバック：全量ダウンロードしてからパース（確実） ---
  const resp = await fetch(url, { cache: 'no-store' });
  if (!resp.ok) throw new Error(`FGBダウンロード失敗 ${resp.status} ${resp.statusText}`);
  const buf = await resp.arrayBuffer();
  const featsB = [];
  for await (const f of deserialize(new Uint8Array(buf))) featsB.push(f);
  if (!featsB.length) throw new Error('FGBの中身が空です');
  return featsB;
}

  // クリックで属性ポップアップ
  function bindClickPopup(layerId){
    map.on('click', layerId, (e)=>{
      const f=e.features?.[0]; if(!f) return;
      const props=f.properties||{};
      const html='<ul class="popup-list">'+Object.entries(props).filter(([k])=>k!=='__label__')
        .map(([k,v])=>`<li><b>${k}</b> ${String(v)}</li>`).join('')+'</ul>';
      new maplibregl.Popup({offset:12}).setLngLat(e.lngLat).setHTML(html).addTo(map);
    });
    map.on('mouseenter', layerId, ()=> map.getCanvas().style.cursor='pointer');
    map.on('mouseleave', layerId, ()=> map.getCanvas().style.cursor='');
  }

  const MUNI_COL_CANDIDATES=["都道府県名及び市町村名","都道府県及び市町村名"];
  const LABEL_CANDIDATES   =["施設・場所名","住所","共通ID","NO"];
  const CAP_TAGS=[
    '1.行政と政治','2.人口統計','3.歴史、民族性、価値観','4.物理的環境','5.保健医療と社会福祉','6.経済','7.交通と安全','8.教育・レクリエーション','9.情報とコミュニケーション'
  ];
  const escapeXml=(str)=>String(str??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&apos;').replace(/\r?\n/g,'&#10;');
  const escapeHtml=(str)=>String(str??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
  let cacheEmergency=null, cacheShelter=null, COL_MUNI=null;
  let layerScopeGlobal={ mode:'all', prefs:[], munis:[] };
  const layerScopeOverrides={ emergency:null, shelter:null };
  const layerLabelFields={ emergency:null, shelter:null };
  const layerColumns={ emergency:[], shelter:[] };
  let currentScopeTarget='global';
  const surveyState={
    panelVisible:false,
    recording:false,
    paused:false,
    watchId:null,
    trackPoints:[],
    notes:[],
    manualMode:false,
    editMode:false,
    labelsVisible:false,
    awaitingMove:false,
    movingNote:null,
    pendingNote:null,
    lastRecordTs:0,
    totalDistance:0,
    currentPosition:null
  };
  let surveyNoteContext={ note:null, isNew:false };

  const surveyPanelEl=$('surveyPanel');
  const surveyNotePanelEl=$('surveyNotePanel');
  const surveyStatusEl=$('surveyStatus');
  const surveyFinishEl=$('surveyFinishPanel');
  const surveyCapBtn=$('surveyCapBtn');
  const surveyCapSelect=$('surveyCapSelect');
  const surveyCapWrap=$('surveyCapSelectWrap');
  const surveyNoteMoveWrap=$('surveyNoteMoveWrap');
  const surveyRecBadge=$('surveyRecBadge');
  window.__surveyNotePopup=null;
  makeDraggable(surveyPanelEl);
  makeDraggable(surveyNotePanelEl);
  function showSurveyPanel(){
    const btn=$('btnSurvey');
    const rect=btn.getBoundingClientRect();
    surveyPanelEl.style.display='block';
    surveyPanelEl.style.transform='none';
    surveyPanelEl.style.left=`${rect.left}px`;
    surveyPanelEl.style.top=`${rect.bottom+8}px`;
  }
  surveyCapSelect.innerHTML='';
  const noneOpt=document.createElement('option'); noneOpt.value=''; noneOpt.textContent='選択しない'; surveyCapSelect.appendChild(noneOpt);
  CAP_TAGS.forEach(tag=>{ const opt=document.createElement('option'); opt.value=tag; opt.textContent=tag; surveyCapSelect.appendChild(opt); });
  const surveyButtons={
    start:$('surveyStartBtn'),
    addHere:$('surveyAddHereBtn'),
    addManual:$('surveyAddManualBtn'),
    edit:$('surveyEditBtn'),
    toggleLabel:$('surveyToggleLabelBtn'),
    pause:$('surveyPauseBtn'),
    finish:$('surveyFinishBtn')
  };
  updateCapButtonText();

  const toJst=(ts)=>{
    const pad=n=>String(n).padStart(2,'0');
    const jst=new Date(ts + 9*60*60*1000);
    const y=jst.getUTCFullYear();
    const m=pad(jst.getUTCMonth()+1);
    const d=pad(jst.getUTCDate());
    const hh=pad(jst.getUTCHours());
    const mm=pad(jst.getUTCMinutes());
    const ss=pad(jst.getUTCSeconds());
    return { timeJst:`${y}-${m}-${d} ${hh}:${mm}:${ss}`, timeIso:`${y}-${m}-${d}T${hh}:${mm}:${ss}+09:00` };
  };
  const buildNoteLabel=(note)=>{
    const lines=[];
    if(note.text1) lines.push(note.text1);
    if(note.text2) lines.push(note.text2);
    if(note.capTag) lines.push(`[${note.capTag}]`);
    return lines.join('\n');
  };
  function loadStoredSurveyNotes(){
    if(!window.localStorage) return [];
    try{
      const raw=localStorage.getItem(STORAGE_KEYS.surveyNotes);
      if(!raw) return [];
      const parsed=JSON.parse(raw);
      if(Array.isArray(parsed)){
        return parsed.map(n=>({
          id:n.id||('note-'+Date.now()+Math.random().toString(36).slice(2)),
          lon:Number(n.lon),
          lat:Number(n.lat),
          text1:n.text1||'',
          text2:n.text2||'',
          capTag:n.capTag||'',
          labelText:n.labelText || buildNoteLabel(n)
        }));
      }
    }catch(err){ console.warn('loadStoredSurveyNotes', err); }
    return [];
  }
  function saveSurveyNotesToStorage(notes){
    if(!window.localStorage) return;
    try{
      localStorage.setItem(STORAGE_KEYS.surveyNotes, JSON.stringify(notes));
    }catch(err){ console.warn('saveSurveyNotesToStorage', err); }
  }
  const storedSurveyNotes=loadStoredSurveyNotes();
  if(storedSurveyNotes.length){
    surveyState.notes=storedSurveyNotes;
    saveSurveyNotesToStorage(surveyState.notes);
  }
  function updateCapButtonText(){
    const val=surveyCapSelect.value;
    surveyCapBtn.textContent = val ? `CAPタグ: ${val}` : 'CAPタグ';
  }
  function updateSurveyRecIndicator(){
    if(!surveyRecBadge) return;
    if(!surveyState.recording){
      surveyRecBadge.style.display='none';
      surveyRecBadge.classList.remove('recBlink','paused');
      return;
    }
    surveyRecBadge.style.display='inline-flex';
    if(surveyState.paused){
      surveyRecBadge.textContent='⏸';
      surveyRecBadge.classList.remove('recBlink');
      surveyRecBadge.classList.add('paused');
    }else{
      surveyRecBadge.textContent='REC';
      surveyRecBadge.classList.add('recBlink');
      surveyRecBadge.classList.remove('paused');
    }
  }
  function updateSurveyStatus(){
    const parts=[];
    parts.push(surveyState.recording ? (surveyState.paused?'記録一時停止':'記録中') : '停止中');
    parts.push(`ポイント: ${surveyState.trackPoints.length}`);
    parts.push(`距離: ${surveyState.totalDistance.toFixed(1)} m`);
    parts.push(`メモ: ${surveyState.notes.length}`);
    surveyStatusEl.textContent=parts.join(' / ');
    surveyButtons.pause.disabled=!surveyState.recording;
    surveyButtons.pause.textContent=surveyState.paused?'再開 ⏸️一時停止中':'一時停止';
    updateSurveyRecIndicator();
  }
  function updateSurveyTrackSource(){
    const src=map.getSource('survey-track'); if(!src) return;
    const features=[];
    if(surveyState.trackPoints.length>=2){
      features.push({type:'Feature',properties:{kind:'line'},geometry:{type:'LineString',coordinates:surveyState.trackPoints.map(p=>[p.lon,p.lat])}});
    }
    surveyState.trackPoints.forEach(p=>{
      features.push({type:'Feature',properties:{kind:'point',time:p.timeJst,distance:p.distance},geometry:{type:'Point',coordinates:[p.lon,p.lat]}});
    });
    src.setData({type:'FeatureCollection',features});
  }
  function updateSurveyNotesSource(){
    const src=map.getSource('survey-notes'); if(!src) return;
    const features=surveyState.notes.map(n=>({
      type:'Feature',
      properties:{ id:n.id, labelText:n.labelText, text1:n.text1, text2:n.text2, capTag:n.capTag },
      geometry:{ type:'Point', coordinates:[n.lon,n.lat] }
    }));
    src.setData({type:'FeatureCollection',features});
    if(map.getLayer('survey-notes-label')){
      map.setLayoutProperty('survey-notes-label','visibility', (surveyState.labelsVisible && features.length)?'visible':'none');
    }
  }
  function resetSurveyData(){
    surveyState.trackPoints=[];
    surveyState.notes=[];
    surveyState.totalDistance=0;
    surveyState.lastRecordTs=0;
    surveyState.awaitingMove=false;
    surveyState.movingNote=null;
    surveyState.manualMode=false;
    surveyNoteContext={note:null,isNew:false};
    surveyButtons.addManual.classList.remove('toggle-active');
    updateSurveyTrackSource();
    updateSurveyNotesSource();
    updateSurveyStatus();
    saveSurveyNotesToStorage(surveyState.notes);
    if(typeof updateMapCursor==='function') updateMapCursor();
    if(window.__surveyNotePopup){ window.__surveyNotePopup.remove(); window.__surveyNotePopup=null; }
  }
  function ensureSurveyWatch(){
    if(!navigator.geolocation){ toast('位置情報が使えません',true); return false; }
    if(surveyState.watchId) return true;
    surveyState.watchId = navigator.geolocation.watchPosition(handleSurveyPosition, err=>toast('位置情報エラー: '+err.message,true), {enableHighAccuracy:true,maximumAge:1000,timeout:10000});
    return true;
  }
  function handleSurveyPosition(pos){
    surveyState.currentPosition=pos;
    if(!surveyState.recording || surveyState.paused) return;
    const now=Date.now();
    if(surveyState.trackPoints.length>0 && now - surveyState.lastRecordTs < 5000) return;
    surveyState.lastRecordTs=now;
    addTrackPoint(pos);
  }
  function addTrackPoint(pos){
    const {longitude:lon, latitude:lat, altitude} = pos.coords;
    const {timeJst,timeIso}=toJst(pos.timestamp||Date.now());
    const point={ id:'trk-'+(pos.timestamp||Date.now()), lon, lat, ele:altitude ?? 0, timeJst, timeIso, distance:0 };
    if(surveyState.trackPoints.length){
      const last=surveyState.trackPoints[surveyState.trackPoints.length-1];
      const dist=turf.distance([last.lon,last.lat],[lon,lat],{units:'kilometers'})*1000;
      surveyState.totalDistance+=dist;
      point.distance=Number(surveyState.totalDistance.toFixed(1));
    }else{
      surveyState.totalDistance=0;
      point.distance=0;
    }
    surveyState.trackPoints.push(point);
    updateSurveyTrackSource();
    updateSurveyStatus();
  }
  function openSurveyNoteForm(note,{isNew=false}={}){
    surveyNoteContext={note,isNew};
    $('surveyNoteLine1').value=note.text1||'';
    $('surveyNoteLine2').value=note.text2||'';
    surveyCapSelect.value=note.capTag||'';
    updateCapButtonText();
    surveyCapWrap.style.display='none';
    surveyNoteMoveWrap.style.display=isNew?'none':'';
    showFloatingPanel(surveyNotePanelEl);
  }
  function finalizeSurveyNote(apply){
    const ctx=surveyNoteContext;
    if(!ctx.note){ surveyNotePanelEl.style.display='none'; return; }
    if(apply){
      ctx.note.text1=$('surveyNoteLine1').value.trim();
      ctx.note.text2=$('surveyNoteLine2').value.trim();
      ctx.note.capTag=surveyCapSelect.value||'';
      ctx.note.labelText=buildNoteLabel(ctx.note);
      if(ctx.isNew){
        ctx.note.id=ctx.note.id || ('note-'+Date.now());
        surveyState.notes.push(ctx.note);
      }
      updateSurveyNotesSource();
      updateSurveyStatus();
      saveSurveyNotesToStorage(surveyState.notes);
      if(window.__surveyNotePopup){ window.__surveyNotePopup.remove(); window.__surveyNotePopup=null; }
    }
    surveyNoteContext={note:null,isNew:false};
    surveyNotePanelEl.style.display='none';
  }
  function beginMoveNote(){
    if(!surveyNoteContext.note) return;
    surveyNoteContext.note.text1=$('surveyNoteLine1').value.trim();
    surveyNoteContext.note.text2=$('surveyNoteLine2').value.trim();
    surveyNoteContext.note.capTag=surveyCapSelect.value||'';
    surveyNoteContext.note.labelText=buildNoteLabel(surveyNoteContext.note);
    surveyState.awaitingMove=true;
    surveyState.movingNote=surveyNoteContext.note;
    surveyNoteContext={note:null,isNew:false};
    surveyNotePanelEl.style.display='none';
    toast('新しい位置を地図上でクリックしてください');
    if(typeof updateMapCursor==='function') updateMapCursor();
  }
  function handleSurveyMapClick(e){
    if(surveyState.awaitingMove && surveyState.movingNote){
      surveyState.movingNote.lon=e.lngLat.lng;
      surveyState.movingNote.lat=e.lngLat.lat;
      surveyState.movingNote.labelText=buildNoteLabel(surveyState.movingNote);
      surveyState.awaitingMove=false;
      surveyState.movingNote=null;
      updateSurveyNotesSource();
      toast('位置を更新しました');
      updateSurveyStatus();
      saveSurveyNotesToStorage(surveyState.notes);
      if(window.__surveyNotePopup){ window.__surveyNotePopup.remove(); window.__surveyNotePopup=null; }
      if(typeof updateMapCursor==='function') updateMapCursor();
      return true;
    }
    if(surveyState.manualMode){
      surveyState.manualMode=false;
      surveyButtons.addManual.classList.remove('toggle-active');
      const note={ id:'note-'+Date.now(), lon:e.lngLat.lng, lat:e.lngLat.lat, text1:'', text2:'', capTag:'', labelText:'' };
      openSurveyNoteForm(note,{isNew:true});
      if(window.__surveyNotePopup){ window.__surveyNotePopup.remove(); window.__surveyNotePopup=null; }
      if(typeof updateMapCursor==='function') updateMapCursor();
      return true;
    }
    return false;
  }
  function openSurveyFinishPrompt(){
    surveyFinishEl.innerHTML=`<div style="margin-bottom:8px">記録を終了しますか？</div>
    <div class="row">
      <button class="btn" id="surveyFinishConfirm">終了</button>
      <button class="btn secondary" id="surveyFinishResume">再開</button>
    </div>`;
    surveyFinishEl.style.display='block';
    $('surveyFinishConfirm').onclick=()=>{
      surveyState.recording=false;
      surveyState.paused=false;
      updateSurveyStatus();
      surveyFinishEl.innerHTML=`<div style="margin-bottom:8px">出力・保存を選択してください</div>
      <div class="group">
        <div class="row">
          <button class="btn" id="surveyExportGpx">GPXを出力</button>
          <button class="btn secondary" id="surveySaveBtn">保存</button>
        </div>
        <div class="row">
          <button class="btn danger" id="surveyDiscardBtn">記録を破棄</button>
        </div>
      </div>`;
      $('surveyExportGpx').onclick=exportSurveyGpx;
      $('surveySaveBtn').onclick=saveSurveyData;
      $('surveyDiscardBtn').onclick=discardSurveyData;
    };
    $('surveyFinishResume').onclick=()=>{ surveyFinishEl.style.display='none'; };
  }
  function exportSurveyGpx(){
    if(!surveyState.trackPoints.length){ toast('出力する記録がありません',true); return; }
    let gpx=`<?xml version="1.0" encoding="UTF-8"?>\n`;
    gpx+=`<gpx version="1.1" creator="PHN Field Collab" xmlns="http://www.topografix.com/GPX/1/1">\n`;
    gpx+=`  <trk>\n    <name>District Survey Track</name>\n    <trkseg>\n`;
    surveyState.trackPoints.forEach(p=>{
      const eleVal = (p.ele ?? 0);
      const distVal = Number.isFinite(p.distance) ? p.distance : 0;
      gpx+=`      <trkpt lat="${p.lat}" lon="${p.lon}"><ele>${eleVal}</ele><time>${escapeXml(p.timeIso)}</time>`;
      const exts=[];
      if(p.timeJst) exts.push(`<time_jst>${escapeXml(p.timeJst)}</time_jst>`);
      exts.push(`<distance_m>${escapeXml(distVal)}</distance_m>`);
      if(exts.length) gpx+=`<extensions>${exts.join('')}</extensions>`;
      gpx+='</trkpt>\n';
    });
    gpx+=`    </trkseg>\n  </trk>\n`;
    surveyState.notes.forEach(n=>{
      const label1=n.text1||'';
      const label2=n.text2||'';
      const capTag=n.capTag||'';
      const name=label1||label2||'メモ';
      const descLines=[label1,label2,capTag?`CAP:${capTag}`:''].filter(Boolean);
      gpx+=`  <wpt lat="${n.lat}" lon="${n.lon}"><name>${escapeXml(name)}</name>`;
      if(descLines.length){
        gpx+=`<desc>${escapeXml(descLines.join('\n'))}</desc>`;
      }
      const noteExt=[`<label1>${escapeXml(label1)}</label1>`,`<label2>${escapeXml(label2)}</label2>`];
      if(capTag) noteExt.push(`<capTag>${escapeXml(capTag)}</capTag>`);
      gpx+=`<extensions>${noteExt.join('')}</extensions></wpt>\n`;
    });
    gpx+='</gpx>';
    const blob=new Blob([gpx],{type:'application/gpx+xml'});
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob);
    a.download='district-survey.gpx';
    a.click();
    surveyFinishEl.style.display='none';
    toast('GPXを出力しました');
  }
  async function saveSurveyData(){
    if(!surveyState.trackPoints.length && !surveyState.notes.length){ toast('保存する記録がありません',true); return; }
    try{
      const payload={ track:surveyState.trackPoints, notes:surveyState.notes };
      const { error } = await __supa.from('district_surveys').insert({ room:__room, payload });
      if(error) throw error;
      toast('保存しました');
    }catch(err){ toast('保存に失敗: '+err.message,true); }
    surveyFinishEl.style.display='none';
  }
  function discardSurveyData(){
    surveyState.recording=false;
    surveyState.paused=false;
    resetSurveyData();
    surveyFinishEl.style.display='none';
    toast('記録を破棄しました');
  }

  $('btnSurvey').addEventListener('click',()=>{
    surveyState.panelVisible=!surveyState.panelVisible;
    $('btnSurvey').classList.toggle('toggle-on',surveyState.panelVisible);
    if(surveyState.panelVisible){
      showSurveyPanel();
      surveyFinishEl.style.display='none';
      ensureSurveyWatch();
    }else{
      surveyPanelEl.style.display='none';
      surveyFinishEl.style.display='none';
      surveyState.manualMode=false;
      surveyButtons.addManual.classList.remove('toggle-active');
      surveyState.editMode=false;
      surveyButtons.edit.classList.remove('toggle-active');
      surveyState.awaitingMove=false;
      surveyState.movingNote=null;
      if(typeof updateMapCursor==='function') updateMapCursor();
      if(window.__surveyNotePopup){ window.__surveyNotePopup.remove(); window.__surveyNotePopup=null; }
    }
  });
  surveyButtons.start.addEventListener('click',()=>{
    resetSurveyData();
    if(!ensureSurveyWatch()) return;
    surveyState.recording=true;
    surveyState.paused=false;
    toast('記録を開始しました');
    surveyFinishEl.style.display='none';
    updateSurveyStatus();
    geoControl.trigger();
  });
  surveyButtons.addHere.addEventListener('click',()=>{
    if(!surveyState.currentPosition){ toast('現在地が取得できません',true); ensureSurveyWatch(); return; }
    const { longitude:lon, latitude:lat } = surveyState.currentPosition.coords;
    const note={ id:'note-'+Date.now(), lon, lat, text1:'', text2:'', capTag:'', labelText:'' };
    openSurveyNoteForm(note,{isNew:true});
  });
  surveyButtons.addManual.addEventListener('click',()=>{
    surveyState.manualMode=!surveyState.manualMode;
    surveyButtons.addManual.classList.toggle('toggle-active',surveyState.manualMode);
    if(surveyState.manualMode){ toast('追加する位置を地図上でクリックしてください'); surveyState.awaitingMove=false; }
    if(typeof updateMapCursor==='function') updateMapCursor();
    if(window.__surveyNotePopup){ window.__surveyNotePopup.remove(); window.__surveyNotePopup=null; }
  });
  surveyButtons.edit.addEventListener('click',()=>{
    surveyState.editMode=!surveyState.editMode;
    surveyButtons.edit.classList.toggle('toggle-active',surveyState.editMode);
    toast(surveyState.editMode?'修正モード：メモをクリックして編集':'修正モードを終了しました');
    if(!surveyState.editMode){ surveyState.awaitingMove=false; surveyState.movingNote=null; }
    if(window.__surveyNotePopup){ window.__surveyNotePopup.remove(); window.__surveyNotePopup=null; }
  });
  surveyButtons.toggleLabel.addEventListener('click',()=>{
    surveyState.labelsVisible=!surveyState.labelsVisible;
    updateSurveyNotesSource();
    surveyButtons.toggleLabel.textContent=surveyState.labelsVisible?'ラベル非表示':'ラベル表示';
  });
  surveyButtons.pause.addEventListener('click',()=>{
    if(!surveyState.recording) { toast('記録開始後に一時停止できます',true); return; }
    surveyState.paused=!surveyState.paused;
    toast(surveyState.paused?'記録を一時停止しました':'記録を再開しました');
    updateSurveyStatus();
  });
  surveyButtons.finish.addEventListener('click',openSurveyFinishPrompt);
  surveyCapBtn.addEventListener('click',()=>{
    surveyCapWrap.style.display = surveyCapWrap.style.display==='none' ? '' : 'none';
  });
  surveyCapSelect.addEventListener('change',updateCapButtonText);
  $('surveyNoteConfirm').addEventListener('click',()=>finalizeSurveyNote(true));
  $('surveyNoteCancel').addEventListener('click',()=>finalizeSurveyNote(false));
  $('surveyNoteMoveBtn').addEventListener('click',beginMoveNote);
  updateSurveyStatus();


function updateLayerVisibility(){
  const ev = $('chkEmergency').checked ? 'visible' : 'none';
  const sv = $('chkShelter').checked  ? 'visible' : 'none';
  if(map.getLayer('emg-circle'))  map.setLayoutProperty('emg-circle','visibility', ev);
  if(map.getLayer('shel-circle')) map.setLayoutProperty('shel-circle','visibility', sv);
  const evLabel = (ev==='visible' && layerLabelFields.emergency) ? 'visible' : 'none';
  const svLabel = (sv==='visible' && layerLabelFields.shelter) ? 'visible' : 'none';
  if(map.getLayer('emg-label'))   map.setLayoutProperty('emg-label','visibility', evLabel);
  if(map.getLayer('shel-label'))  map.setLayoutProperty('shel-label','visibility', svLabel);
}

  function fitToData(){
    const fc1=map.getSource('emergency')._data;
    const fc2=map.getSource('shelter')._data;
    const all=[...fc1.features,...fc2.features]; if(!all.length) return;
    let minX=180,minY=90,maxX=-180,maxY=-90;
    all.forEach(f=>{ if(f.geometry.type!=='Point') return; const [x,y]=f.geometry.coordinates;
      if(x<minX)minX=x;if(y<minY)minY=y;if(x>maxX)maxX=x;if(y>maxY)maxY=y;});
    if(minX<maxX&&minY<maxY) map.fitBounds([[minX,minY],[maxX,maxY]],{padding:40,maxZoom:13});
  }
  function cloneScope(src){
    return { mode:src.mode, prefs:[...src.prefs], munis:[...src.munis] };
  }
  function getScopeFor(layer){
    return layerScopeOverrides[layer] ? cloneScope(layerScopeOverrides[layer]) : cloneScope(layerScopeGlobal);
  }
  function filterByScope(scope, feature){
    const fullName = String(feature.properties?.[COL_MUNI]||'');
    if(scope.mode==='all') return true;
    const pref = PREFS.find(p=>fullName.startsWith(p))||'';
    const city = fullName.slice(pref.length).trim();
    if(scope.mode==='pref'){
      if(scope.prefs.length===0) return true;
      return scope.prefs.includes(pref);
    }
    if(scope.mode==='muni'){
      if(scope.munis.length>0) return scope.munis.includes(`${pref} ${city}`);
      if(scope.prefs.length>0) return scope.prefs.includes(pref);
      return true;
    }
    return true;
  }
  function decorateFeature(f,labelField){
    const props={...(f.properties||{})};
    props.__label__ = labelField ? String(props[labelField]??'') : '';
    return {...f,properties:props};
  }
  function refreshLayers(showToast=false){
    if(!cacheEmergency||!cacheShelter) return;
    const scopeE = getScopeFor('emergency');
    const scopeS = getScopeFor('shelter');
    const emgFiltered=(cacheEmergency||[]).filter(f=>filterByScope(scopeE,f)).map(f=>decorateFeature(f,layerLabelFields.emergency));
    const shlFiltered=(cacheShelter  ||[]).filter(f=>filterByScope(scopeS,f)).map(f=>decorateFeature(f,layerLabelFields.shelter));
    map.getSource('emergency').setData({type:'FeatureCollection',features:emgFiltered});
    map.getSource('shelter').setData({type:'FeatureCollection',features:shlFiltered});
    updateLayerVisibility();
    fitToData();
    if(showToast) toast('表示範囲を更新しました');
  }

  function hideSuggest(){ $('suggest').style.display='none'; $('suggest').innerHTML=''; }
  function updateSuggest(query){
    const q=String(query||'').trim();
    const chosenPrefs=new Set(Array.from($('prefSelect').selectedOptions).map(o=>o.value));
    const src=(chosenPrefs.size===0)?window.__allMunicipalLabels:window.__allMunicipalLabels.filter(lbl=>chosenPrefs.has(lbl.split(" ")[0]));
    if(!q){hideSuggest();return;}
    const hits=src.filter(lbl=>lbl.includes(q)).slice(0,5);
    if(hits.length===0){hideSuggest();return;}
    $('suggest').innerHTML=hits.map(h=>`<div class="suggest-item" data-v="${h}">${h}</div>`).join("");
    $('suggest').style.display='block';
    Array.from($('suggest').children).forEach(div=>{
      div.addEventListener('click',()=>{
        const val=div.getAttribute('data-v');
        const opt=Array.from($('muniSelect').options).find(o=>o.value===val);
        if(opt){opt.selected=true;}
        $('qMuni').value=''; hideSuggest();
      });
    });
  }

  async function initFGB(){
    // ソース/レイヤ
    if(!map.getSource('emergency')) map.addSource('emergency',{type:'geojson',data:{type:'FeatureCollection',features:[]}});
    if(!map.getSource('shelter'))   map.addSource('shelter',  {type:'geojson',data:{type:'FeatureCollection',features:[]}});
    if(!map.getLayer('emg-circle')) map.addLayer({id:'emg-circle',type:'circle',source:'emergency',layout:{ visibility:'none' },paint:{'circle-radius':5,'circle-color':'#e23b3b','circle-stroke-color':'#fff','circle-stroke-width':1}});
    if(!map.getLayer('shel-circle')) map.addLayer({id:'shel-circle',type:'circle',source:'shelter',layout:{ visibility:'none' },paint:{'circle-radius':5,'circle-color':'#2a7be4','circle-stroke-color':'#fff','circle-stroke-width':1}});
    if(!map.getLayer('emg-label'))   map.addLayer({id:'emg-label',type:'symbol',source:'emergency',layout:{ visibility:'none','text-field':['get','__label__'],'text-size':12,'text-offset':[0,1.2],'text-anchor':'top'},paint:{'text-halo-width':1.2,'text-halo-color':'#fff'}
});
    if(!map.getLayer('shel-label'))  map.addLayer({id:'shel-label',type:'symbol',source:'shelter',  layout:{ visibility:'none','text-field':['get','__label__'],'text-size':12,'text-offset':[0,1.2],'text-anchor':'top'},paint:{'text-halo-width':1.2,'text-halo-color':'#fff'}});
    bindClickPopup('emg-circle'); bindClickPopup('shel-circle');
      ['chkEmergency','chkShelter'].forEach(id=>$(id).addEventListener('change',updateLayerVisibility));

      document.querySelectorAll('input[name="areaMode"]').forEach(r=>{
        r.addEventListener('change',()=>{
          const v=document.querySelector('input[name="areaMode"]:checked').value;
          $('prefRow').style.display=(v==='pref'||v==='muni')?'':'none';
          $('muniRow').style.display=(v==='muni')?'':'none';
        });
      });

      const extentPanel = $('extentPanel');
      function loadScopeToUI(scope){
        const radio=document.querySelector(`input[name="areaMode"][value="${scope.mode}"]`);
        if(radio) radio.checked=true;
        $('prefRow').style.display=(scope.mode==='pref'||scope.mode==='muni')?'':'none';
        $('muniRow').style.display=(scope.mode==='muni')?'':'none';
        Array.from($('prefSelect').options).forEach(o=>o.selected=scope.prefs.includes(o.value));
        if(typeof window.renderMuniOptions==='function') window.renderMuniOptions();
        Array.from($('muniSelect').options).forEach(o=>o.selected=scope.munis.includes(o.value));
      }
      function readScopeFromUI(){
        const mode=document.querySelector('input[name="areaMode"]:checked').value;
        const prefs=Array.from($('prefSelect').selectedOptions).map(o=>o.value);
        const munis=Array.from($('muniSelect').selectedOptions).map(o=>o.value);
        return { mode, prefs, munis };
      }
      function openExtentPanel(target){
        currentScopeTarget=target;
        const note = target==='global' ? '(全レイヤ)' : (target==='emergency'?'(緊急避難場所)':'(避難所)');
        $('extentScopeNote').textContent=note;
        const scope = target==='global' ? layerScopeGlobal : (layerScopeOverrides[target] || layerScopeGlobal);
        loadScopeToUI(scope);
        $('qMuni').value='';
        hideSuggest();
        centerPanel(extentPanel);
      }
      $('btnExtent').addEventListener('click',()=>openExtentPanel('global'));
      document.querySelectorAll('.miniBtn[data-action="scope"]').forEach(btn=>{
        btn.addEventListener('click',()=>openExtentPanel(btn.dataset.layer));
      });
      $('btnExtentCancel').onclick=()=>{ extentPanel.style.display='none'; };
      $('btnExtentConfirm').onclick=()=>{
        const scope=readScopeFromUI();
        if(currentScopeTarget==='global') layerScopeGlobal=scope; else layerScopeOverrides[currentScopeTarget]=scope;
        extentPanel.style.display='none';
        refreshLayers(true);
      };

      (function(){
        const header=extentPanel.querySelector('.handle');
        let sx=0,sy=0,left=0,top=0,dragging=false;
        if(!header) return;
        header.addEventListener('pointerdown',e=>{
          dragging=true; sx=e.clientX; sy=e.clientY;
          const rect=extentPanel.getBoundingClientRect();
          extentPanel.style.transform='none';
          extentPanel.style.left=rect.left+'px';
          extentPanel.style.top=rect.top+'px';
          left=rect.left; top=rect.top;
          header.setPointerCapture(e.pointerId);
        });
        header.addEventListener('pointermove',e=>{
          if(!dragging)return;
          const dx=e.clientX-sx, dy=e.clientY-sy;
          extentPanel.style.left=(left+dx)+'px';
          extentPanel.style.top=(top+dy)+'px';
        });
        header.addEventListener('pointerup',()=>{dragging=false;});
      })();

      const labelPanel=$('labelPanel');
      const labelList=$('labelFieldList');
      let currentLabelTarget='emergency';
      function openLabelPanel(layer){
        if(!layerColumns[layer] || layerColumns[layer].length===0){ toast('データ読み込み後に利用できます',true); return; }
        currentLabelTarget=layer;
        $('labelScopeNote').textContent = layer==='emergency' ? '(緊急避難場所)' : '(避難所)';
        labelList.innerHTML='';
        const cols=['__none__', ...layerColumns[layer]];
        cols.forEach(col=>{
          const opt=document.createElement('option');
          opt.value=col;
          opt.textContent=col==='__none__'?'表示しない':col;
          labelList.appendChild(opt);
        });
        labelList.value=layerLabelFields[layer] || '__none__';
        centerPanel(labelPanel);
      }
      document.querySelectorAll('.miniBtn[data-action="label"]').forEach(btn=>{
        btn.addEventListener('click',()=>openLabelPanel(btn.dataset.layer));
      });
      $('btnLabelCancel').onclick=()=>{ labelPanel.style.display='none'; };
      $('btnLabelConfirm').onclick=()=>{
        const val=labelList.value;
        layerLabelFields[currentLabelTarget]=(val==='__none__')?null:val;
        labelPanel.style.display='none';
        refreshLayers();
      };
      (function(){
        const header=labelPanel.querySelector('.handle');
        let sx=0,sy=0,left=0,top=0,dragging=false;
        if(!header) return;
        header.addEventListener('pointerdown',e=>{
          dragging=true;sx=e.clientX;sy=e.clientY;
          const rect=labelPanel.getBoundingClientRect();
          labelPanel.style.transform='none';
          labelPanel.style.left=rect.left+'px';
          labelPanel.style.top=rect.top+'px';
          left=rect.left;top=rect.top;
          header.setPointerCapture(e.pointerId);
        });
        header.addEventListener('pointermove',e=>{
          if(!dragging)return;
          const dx=e.clientX-sx,dy=e.clientY-sy;
          labelPanel.style.left=(left+dx)+'px';
          labelPanel.style.top=(top+dy)+'px';
        });
        header.addEventListener('pointerup',()=>{dragging=false;});
      })();

      // 都道府県セレクト
      PREFS.forEach(p=>{const o=document.createElement('option');o.value=p;o.textContent=p;$('prefSelect').appendChild(o);});
      $('prefSelect').addEventListener('change',renderMuniOptions);

    // FGB 読み込み
    try{
      const [emgFeats,shelFeats]=await Promise.all([
        readFGB_fromURL(FGB_URL_EMERGENCY),
        readFGB_fromURL(FGB_URL_SHELTER)
      ]);
      cacheEmergency=emgFeats; cacheShelter=shelFeats;

        const propKeys=new Set([...Object.keys(emgFeats[0]?.properties||{}),...Object.keys(shelFeats[0]?.properties||{})]);
        COL_MUNI=MUNI_COL_CANDIDATES.find(k=>propKeys.has(k))||null;
        if(!COL_MUNI) showErr('「都道府県名及び市町村名」列が見つかりません（COL_MUNI未設定）');

        // ラベル候補
        const emCols=new Set();
        emgFeats.forEach(f=>Object.keys(f.properties||{}).forEach(k=>emCols.add(k)));
        const shCols=new Set();
        shelFeats.forEach(f=>Object.keys(f.properties||{}).forEach(k=>shCols.add(k)));
        layerColumns.emergency=[...emCols].sort();
        layerColumns.shelter=[...shCols].sort();
        layerLabelFields.emergency=null;
        layerLabelFields.shelter=null;

      // 市区町村候補
      const uniq=a=>[...new Set(a)];
      const names=uniq([...emgFeats,...shelFeats].map(f=>String(f.properties?.[COL_MUNI]||"").trim()).filter(Boolean));
      function splitPrefCity(full){const pref=PREFS.find(p=>full.startsWith(p))||"";return {pref,city:full.slice(pref.length).trim()||full};}
      window.__allMunicipalLabels=names.map(n=>{const {pref,city}=splitPrefCity(n);return pref?`${pref} ${city||"(名称不明)"}`:n;}).sort((a,b)=>a.localeCompare(b,'ja'));
      function renderMuniOptions(){
        const chosenPrefs=new Set(Array.from($('prefSelect').selectedOptions).map(o=>o.value));
        $('muniSelect').innerHTML="";
        const list=(chosenPrefs.size===0)?window.__allMunicipalLabels:window.__allMunicipalLabels.filter(lbl=>chosenPrefs.has(lbl.split(" ")[0]));
        list.forEach(lbl=>{const o=document.createElement('option');o.value=lbl;o.textContent=lbl;$('muniSelect').appendChild(o);});
        updateSuggest($('qMuni').value);
      }
      window.renderMuniOptions=renderMuniOptions;
      $('qMuni').addEventListener('input',()=>updateSuggest($('qMuni').value));
      $('qMuni').addEventListener('blur',()=>setTimeout(hideSuggest,150));
      $('qMuni').addEventListener('keydown',(ev)=>{if(ev.key==='Enter'){const val=$('qMuni').value;if(val){updateSuggest(val);}}});
        renderMuniOptions();

        // 初回描画
        refreshLayers();
    }catch(e){
      showErr('FGBデータの読み込みに失敗：'+e.message);
    }
  }

  /*************** 部屋・共有・エクスポート ***************/
$('btnExport').onclick=()=>{
  const fc = window.userFC || {type:'FeatureCollection',features:[]};
  const blob=new Blob([JSON.stringify(fc)],{type:'application/json'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='features.geojson';
  a.click();
};

  /*************** Supabase：図形保存/読込 + GPS ***************/
  (function whenReady(){
    const ok=!!(window.map&&window.draw&&typeof draw.add==='function');
    if(!ok) return setTimeout(whenReady,200);
    window.__supaload=loadFeatures;
    window.__supasave=saveFeatures;
    window.__gpstart =startGpsLog;
    window.__gpstop  =stopGpsLog;
    window.__gpshow  =showTracks;
  })();

  async function loadFeatures(){
    try{
      const {data,error}=await __supa.from('features').select('id,geojson').eq('room',__room).order('id');
      if(error) throw error;
      const feats=(data||[]).map(r=>r.geojson);
      if(feats.length){draw.deleteAll();draw.add({type:'FeatureCollection',features:feats});}
      toast('図形を読み込みました（'+(feats.length||0)+'件）');
    }catch(e){toast('読込失敗: '+e.message,true);}
  }
  async function saveFeatures(){
    try{
      const fc=draw.getAll();
      if(!fc.features?.length){toast('保存する図形がありません',true);return;}
      const rows=fc.features.map(f=>({room:__room,kind:(f.properties?.kind)||f.geometry?.type?.toLowerCase()||'feature',geojson:f,props:f.properties||{}}));
      const {error}=await __supa.from('features').insert(rows);
      if(error) throw error;
      toast('図形を保存しました');
    }catch(e){toast('保存失敗: '+e.message,true);}
  }

  let watchId=null,currentTrackId=null;
  async function startGpsLog(name='フィールド調査'){
    if(!navigator.geolocation){toast('位置情報が使えません',true);return;}
    const {data:tk,error:e1}=await __supa.from('tracks').insert({room:__room,name}).select().single();
    if(e1){toast('トラック作成失敗: '+e1.message,true);return;}
    currentTrackId=tk.id;
    let last=null;
    watchId=navigator.geolocation.watchPosition(async pos=>{
      const {longitude:lon,latitude:lat,accuracy:acc,speed,heading}=pos.coords;
      const tiso=new Date(pos.timestamp).toISOString();
      if(last){
        const dx=Math.abs(lon-last.lon)*111320, dy=Math.abs(lat-last.lat)*110540;
        if(dx<10&&dy<10) return;
      }
      last={lon,lat};
      await __supa.from('track_points').insert({track_id:currentTrackId,t:tiso,lon,lat,acc,speed,heading});
    }, err=>toast('GPSエラー: '+err.message,true), {enableHighAccuracy:true,maximumAge:1000,timeout:10000});
    toast('GPSロガー開始');
  }
  function stopGpsLog(){ if(watchId){navigator.geolocation.clearWatch(watchId);watchId=null;} currentTrackId=null; toast('GPSロガー停止'); }
  async function showTracks(){
    const {data:tracks}=await __supa.from('tracks').select('id').eq('room',__room);
    if(!tracks?.length){toast('トラックがありません',true);return;}
    const ids=tracks.map(r=>r.id);
    const {data:pts}=await __supa.from('track_points').select('track_id,t,lon,lat').in('track_id',ids).order('t');
    const by=new Map(); (pts||[]).forEach(p=>{if(!by.has(p.track_id))by.set(p.track_id,[]);by.get(p.track_id).push([p.lon,p.lat]);});
    const fc={type:'FeatureCollection',features:[...by.entries()].map(([id,coords])=>({type:'Feature',properties:{id},geometry:{type:'LineString',coordinates:coords}}))};
    if(!map.getSource('tracks')) map.addSource('tracks',{type:'geojson',data:fc}); else map.getSource('tracks').setData(fc);
    if(!map.getLayer('tracks-line')) map.addLayer({id:'tracks-line',type:'line',source:'tracks',paint:{'line-color':'#ef4444','line-width':3}});
    toast('軌跡を表示しました');
  }

  /*************** 地図ロード：一括初期化 ***************/
  map.on('load', async ()=>{
    /* ==== basemap & controls（陰影起伏図＋GSIレイヤ） ==== */
// 陰影起伏図（いちばん下）
if (!map.getSource('hillshade')) {
  map.addSource('hillshade', {
    type:'raster',
    tiles:['https://cyberjapandata.gsi.go.jp/xyz/hillshademap/{z}/{x}/{y}.png'],
    tileSize:256,
    attribution:'<a href="https://maps.gsi.go.jp/development/ichiran.html" target="_blank">GSI</a>'
  });
  const first = map.getStyle().layers[0]?.id;
  map.addLayer({ id:'hillshade', type:'raster', source:'hillshade', paint:{ 'raster-opacity':0.45 } }, first);
}
// 地理院 標準/写真（少し透明）
if (!map.getSource('gsi-std')) {
  map.addSource('gsi-std', { type:'raster', tiles:['https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png'], tileSize:256 });
  map.addLayer({ id:'gsi-std', type:'raster', source:'gsi-std', layout:{ visibility:'none' }, paint:{ 'raster-opacity':0.75 } });
}
if (!map.getSource('gsi-photo')) {
  map.addSource('gsi-photo', { type:'raster', tiles:['https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/{z}/{x}/{y}.jpg'], tileSize:256 });
  map.addLayer({ id:'gsi-photo', type:'raster', source:'gsi-photo', layout:{ visibility:'none' }, paint:{ 'raster-opacity':0.75 } });
}

    try{
      // ハザード
      ensureHazardLayers(); updateHazard();

      // FGB
      initFGB();

      // 共有表示
    }catch(e){
      console.error(e); showErr('初期化エラー: '+e.message);
    }

/* ==== /basemap & controls ==== */
/* ==== user objects layers ==== */
// ユーザー図形（グローバル）
if (!map.getSource('user-src')){
  map.addSource('user-src', { type:'geojson', data:window.userFC });

  ensureUserPointFlagIcon();
  map.addLayer({ id:'user-point-emoji', type:'symbol', source:'user-src',
    filter:['==',['get','_type'],'point'],
    layout:{ 'icon-image':'user-point-flag','icon-size':0.5,'icon-anchor':'bottom','icon-offset':[0,-4],'icon-allow-overlap':true },
    paint:{}
  });
  map.addLayer({ id:'user-point-label', type:'symbol', source:'user-src',
    filter:['==',['get','_type'],'point'],
    layout:{ 'text-field':['coalesce',['get','label'],''],'text-size':['+', ['coalesce',['get','labelSize'],12], 5],
      'text-anchor':'top','text-offset':[0,0.7],'text-allow-overlap':true },
    paint:{ 'text-color':['coalesce',['get','labelColor'],'#000000'],'text-halo-color':'#fff','text-halo-width':1.6 }
  });
  map.addLayer({ id:'user-line', type:'line', source:'user-src',
    filter:['==',['get','_type'],'line'],
    layout:{ 'line-cap':'round','line-join':'round' },
    paint:{ 'line-color':['coalesce',['get','lineColor'],'#e53935'],'line-width':['coalesce',['get','lineWidth'],2] }
  });
  map.addLayer({ id:'user-line-label', type:'symbol', source:'user-src',
    filter:['==',['get','_type'],'line'],
    layout:{ 'symbol-placement':'line','text-field':['coalesce',['get','label'],''],'text-size':['+', ['coalesce',['get','labelSize'],12], 5],
      'text-rotation-alignment':'map','text-keep-upright':false,'text-allow-overlap':false },
    paint:{ 'text-color':['coalesce',['get','labelColor'],'#000000'],'text-halo-color':'#fff','text-halo-width':1.6 }
  });
  map.addLayer({ id:'user-poly-fill', type:'fill', source:'user-src',
    filter:['in',['get','_type'],['literal',['polygon','circle']]],
    paint:{ 'fill-color':['coalesce',['get','fillColor'],'#43a047'],'fill-opacity':['coalesce',['get','fillOpacity'],0.5] }
  });
  map.addLayer({ id:'user-poly-line', type:'line', source:'user-src',
    filter:['in',['get','_type'],['literal',['polygon','circle']]],
    paint:{ 'line-color':['coalesce',['get','lineColor'],'#2e7d32'],'line-width':['coalesce',['get','lineWidth'],2] }
  });
  map.addLayer({ id:'user-poly-label', type:'symbol', source:'user-src',
    filter:['==',['get','_type'],'polygon'],
    layout:{
      'text-field':["case",
        ["all",["!",["has","label1"]],["!",["has","label2"]]],"",
        ["all",["has","label1"],["has","label2"]],["concat",["get","label1"],"\n",["get","label2"]],
        ["has","label1"],["get","label1"],
        ["has","label2"],["get","label2"],
        ""
      ],
      'text-size':17,
      'text-anchor':'center',
      'text-offset':[0,0],
      'text-justify':'center',
      'text-allow-overlap':false
    },
    paint:{ 'text-color':['coalesce',['get','labelColor'],'#000000'],'text-halo-color':'#fff','text-halo-width':1.6 }
  });
  map.addLayer({ id:'user-circle-label', type:'symbol', source:'user-src',
    filter:['==',['get','_type'],'circle'],
    layout:{
      'text-field':['coalesce',['get','label'],''],
      'text-size':['+', ['coalesce',['get','labelSize'],12], 5],
      'text-anchor':'center',
      'text-offset':[0,0],
      'text-justify':'center',
      'text-allow-overlap':false
    },
    paint:{ 'text-color':['coalesce',['get','labelColor'],'#000000'],'text-halo-color':'#fff','text-halo-width':1.6 }
  });

  map.addSource('user-temp', { type:'geojson', data:{ type:'FeatureCollection', features:[] }});
  map.addLayer({ id:'user-temp-line', type:'line', source:'user-temp',
    paint:{ 'line-color':'#1976d2','line-width':2,'line-dasharray':[1,1] }});
  map.addLayer({ id:'user-temp-fill', type:'fill', source:'user-temp',
    paint:{ 'fill-color':'#1976d2','fill-opacity':0.2 }});

  map.addSource('survey-track', { type:'geojson', data:{ type:'FeatureCollection', features:[] }});
  map.addLayer({ id:'survey-track-line', type:'line', source:'survey-track',
    filter:['==',['get','kind'],'line'],
    paint:{ 'line-color':'#ef4444','line-width':3,'line-opacity':0.85 }});
  map.addLayer({ id:'survey-track-points', type:'circle', source:'survey-track',
    filter:['==',['get','kind'],'point'],
    paint:{ 'circle-radius':4,'circle-color':'#1d4ed8','circle-stroke-color':'#fff','circle-stroke-width':1 } });

  map.addSource('survey-notes', { type:'geojson', data:{ type:'FeatureCollection', features:[] }});
  ensureSurveyFlagIcon();
  map.addLayer({ id:'survey-notes-icon', type:'symbol', source:'survey-notes',
    layout:{
      'icon-image':'survey-flag',
      'icon-size':1.2,
      'icon-anchor':'bottom',
      'icon-allow-overlap':true,
      'icon-offset':[0,-4]
    }
  });
  map.addLayer({ id:'survey-notes-label', type:'symbol', source:'survey-notes',
    layout:{ 'text-field':['get','labelText'],'text-size':17,'text-anchor':'top','text-offset':[0,0.45],'text-allow-overlap':true,'visibility':'none' },
    paint:{ 'text-color':'#000000','text-halo-color':'#fff','text-halo-width':1.6 } });
  ensureOverlayOrder();
}
/* ==== /user objects layers ==== */

  updateSurveyNotesSource();
  updateSurveyStatus();

  });
  </script>
  <script>
/* ==== object tools & list ==== */
let addMode=null, tempCoords=[], circleCenter=null;
const objToolbarBtn=document.getElementById('btnObj');
const objSubtools=document.getElementById('objSubtools');
const syncObjToolbar=open=>{
  if(!objToolbarBtn || !objSubtools) return;
  objSubtools.style.display=open?'flex':'none';
  objToolbarBtn.classList.toggle('toggle-on', !!open);
};
const setTemp = fc => map.getSource('user-temp').setData(fc || {type:'FeatureCollection',features:[]});
function syncUserFeatures({refreshList=true}={}){
  if(map.getSource('user-src')) map.getSource('user-src').setData(window.userFC);
  if(refreshList) refreshObjList();
  saveUserFCToStorage(window.userFC);
}
const pushFeature = f => { window.userFC.features.push(f); syncUserFeatures(); };
window.pushFeature = pushFeature;
function updateMapCursor(){
  const canvas=map.getCanvas();
  const shouldCross = !!addMode || surveyState.manualMode || surveyState.awaitingMove;
  canvas.style.cursor = shouldCross ? 'crosshair' : '';
  canvas.classList.toggle('cursor-crosshair', shouldCross);
}
function activateTool(mode){
  addMode=mode;
  tempCoords=[]; circleCenter=null; setTemp();
  document.querySelectorAll('#objSubtools .tool').forEach(t=>t.classList.toggle('active', !!mode && t.dataset.mode===mode));
  if(mode){
    syncObjToolbar(true);
  }else{
    syncObjToolbar(false);
  }
  if(mode==='line' || mode==='polygon' || mode==='circle') map.doubleClickZoom.disable();
  else map.doubleClickZoom.enable();
  updateMapCursor();
}

// オブジェクト：メインボタン → サブツール開閉
objToolbarBtn?.addEventListener('click', ()=>{
  if(!objSubtools) return;
  const isOpen=objSubtools.style.display==='flex';
  const nextOpen=!isOpen;
  syncObjToolbar(nextOpen);
  if(!nextOpen){
    activateTool(null);
  }
});
// 各ツール選択
document.querySelectorAll('#objSubtools .tool').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    activateTool(btn.dataset.mode);
  });
});

// マップ操作
map.on('click', (e)=>{
  if(handleSurveyMapClick(e)) return;
  if (!addMode) return;
  if (addMode==='point'){
    const feature={ type:'Feature', properties:{ _type:'point' }, geometry:{ type:'Point', coordinates:[e.lngLat.lng,e.lngLat.lat] }};
    activateTool(null);
    openSimpleLabelEditor(feature,{ resumeMode:'point', isNew:true, title:'ポイント ラベル' });
    return;
  }
  if (addMode==='circle'){
    if (!circleCenter){ circleCenter=[e.lngLat.lng,e.lngLat.lat]; setTemp(); }
    return;
  }
  const p=[e.lngLat.lng,e.lngLat.lat]; tempCoords.push(p); drawTemp();
});
map.on('mousemove',(e)=>{
  if (!addMode) return;
  if (addMode==='circle' && circleCenter){
    const rKm=turf.distance(circleCenter,[e.lngLat.lng,e.lngLat.lat],{units:'kilometers'});
    const poly=turf.circle(circleCenter,rKm,{steps:64,units:'kilometers'});
    setTemp({ type:'FeatureCollection', features:[{ type:'Feature', properties:{}, geometry:poly.geometry }] });
    return;
  }
  if ((addMode==='line'||addMode==='polygon') && tempCoords.length){
    const coords=tempCoords.concat([[e.lngLat.lng,e.lngLat.lat]]);
    const feat = (addMode==='line')
      ? { type:'Feature', properties:{}, geometry:{ type:'LineString', coordinates:coords } }
      : { type:'Feature', properties:{}, geometry:{ type:'Polygon', coordinates:[ coords.concat([tempCoords[0]]) ] } };
    setTemp({ type:'FeatureCollection', features:[feat] });
  }
});
map.on('dblclick',(e)=>{
  if (!addMode) return;
  e.preventDefault();
  if (addMode==='line' && tempCoords.length>=2){
    const coords=tempCoords.slice();
    const feature={ type:'Feature', properties:{ _type:'line' },
      geometry:{ type:'LineString', coordinates: coords } };
    tempCoords=[]; setTemp();
    activateTool(null);
    openSimpleLabelEditor(feature,{ resumeMode:'line', isNew:true, title:'ライン ラベル' });
    return;
  }
  if (addMode==='polygon' && tempCoords.length>=3){
    const coords=tempCoords.slice();
    const first=coords[0];
    const last=coords[coords.length-1];
    const p0=map.project(first), pN=map.project(last);
    if (Math.hypot(p0.x-pN.x,p0.y-pN.y)<15) coords[coords.length-1]=first;
    const feature={ type:'Feature', properties:{ _type:'polygon' },
      geometry:{ type:'Polygon', coordinates:[ coords.concat([coords[0]]) ] } };
    tempCoords=[]; setTemp();
    activateTool(null);
    openPolygonLabelEditor(feature,{resumeMode:'polygon',isNew:true});
    return;
  }
  if (addMode==='circle' && circleCenter){
    const edge=[e.lngLat.lng,e.lngLat.lat];
    const rKm=turf.distance(circleCenter,edge,{units:'kilometers'});
    if(!Number.isFinite(rKm) || rKm===0){
      circleCenter=null; setTemp();
      activateTool('circle');
      return;
    }
    const poly=turf.circle(circleCenter,rKm,{steps:64,units:'kilometers'});
    const feature={ type:'Feature', properties:{ _type:'circle' }, geometry:poly.geometry };
    circleCenter=null; setTemp();
    activateTool(null);
    openSimpleLabelEditor(feature,{ resumeMode:'circle', isNew:true, title:'円 ラベル' });
  }
});
function drawTemp(){
  if (!tempCoords.length) return setTemp();
  const feat=(addMode==='line')
    ? { type:'Feature', properties:{}, geometry:{ type:'LineString', coordinates:tempCoords } }
    : { type:'Feature', properties:{}, geometry:{ type:'Polygon', coordinates:[ tempCoords.concat([tempCoords[0]]) ] } };
  setTemp({ type:'FeatureCollection', features:[feat] });
}

map.on('click','survey-notes-icon',(e)=>{
  const f=e.features?.[0];
  if(!f) return;
  const note=surveyState.notes.find(n=>n.id===f.properties?.id);
  if(!note) return;
  if(surveyState.editMode){
    if(window.__surveyNotePopup){ window.__surveyNotePopup.remove(); window.__surveyNotePopup=null; }
    openSurveyNoteForm(note,{isNew:false});
    return;
  }
  if(window.__surveyNotePopup){ window.__surveyNotePopup.remove(); }
  const rows=[];
  if(note.text1) rows.push(`<div><strong>ラベル1:</strong> ${escapeHtml(note.text1)}</div>`);
  if(note.text2) rows.push(`<div><strong>ラベル2:</strong> ${escapeHtml(note.text2)}</div>`);
  if(note.capTag) rows.push(`<div><strong>CAP:</strong> ${escapeHtml(note.capTag)}</div>`);
  if(!rows.length) rows.push('<div>(内容なし)</div>');
  const html=`<div class="note-popup">${rows.join('')}</div>`;
  window.__surveyNotePopup=new maplibregl.Popup({offset:18}).setLngLat([note.lon,note.lat]).setHTML(html).addTo(map);
});
map.on('mouseenter','survey-notes-icon',()=>{
  if((typeof surveyState!=='undefined' && (surveyState.manualMode||surveyState.awaitingMove)) || addMode){
    return;
  }
  map.getCanvas().style.cursor='pointer';
});
map.on('mouseleave','survey-notes-icon',()=>{ if(typeof updateMapCursor==='function') updateMapCursor(); else map.getCanvas().style.cursor=''; });

// 右パネル：リスト＆グループ＆スタイル
const objList=document.getElementById('objList');
const scopeRadios=[...document.querySelectorAll('input[name="styleScope"]')];
function getId(f){ return f.id || (f.id=Math.random().toString(36).slice(2)); }
function findFeatureById(fid){ return window.userFC.features.find(f=>getId(f)===fid); }
function removeFeature(f){ const i=window.userFC.features.indexOf(f); if(i>-1){ userFC.features.splice(i,1); syncUserFeatures(); } }
window.removeFeature = removeFeature;

function refreshObjList(){
  objList.innerHTML='';
  const groups={}, orphans=[];
  for (const f of window.userFC.features){ const g=f.properties._group; g ? (groups[g]??=({id:g,items:[]})).items.push(f) : orphans.push(f); }
  orphans.forEach(f=> objList.appendChild(makeObjItem(f)));
  Object.values(groups).forEach(g=>{
    const box=document.createElement('div'); box.className='grpItem'; box.draggable=true; box.dataset.gid=g.id;
    box.innerHTML=`<div class="objType type-poly"></div><strong>グループ</strong>`;
    const wrap=document.createElement('div'); wrap.style.marginTop='4px'; g.items.forEach(f=> wrap.appendChild(makeObjItem(f)));
    box.appendChild(wrap); addDnD(box,'group'); objList.appendChild(box);
  });
}
function makeObjItem(f){
  const el=document.createElement('div'); el.className='objItem'; el.draggable=true; el.dataset.fid=getId(f);
  const typ=f.properties._type;
  const icon=document.createElement('div'); icon.className='objType type-'+typ;

  // ラベル：ダブルクリックで編集
  const label=document.createElement('span'); label.className='objLabel';
  const makeLabelText=()=>{
    if(f.properties._type==='polygon'){
      return [f.properties.label1,f.properties.label2].filter(Boolean).join(' / ') || '(無題)';
    }
    return f.properties.label || '(無題)';
  };
  label.textContent=makeLabelText();
  label.title='ダブルクリックでラベル編集';
  label.ondblclick=()=>{
    if(f.properties._type==='polygon'){
      openPolygonLabelEditor(f,{isNew:false});
      return;
    }
    openSimpleLabelEditor(f,{
      isNew:false,
      title:'ラベル編集',
      onApply:()=>{
        label.textContent=makeLabelText();
        syncUserFeatures({refreshList:false});
      }
    });
  };

  // 🎨 スタイル編集ポップ
  const styBtn=document.createElement('button'); styBtn.className='miniBtn'; styBtn.textContent='🎨';
  styBtn.title='色/太さ/透明度';
  styBtn.onclick=(e)=>{
    e.stopPropagation();
    const p=document.createElement('div');
    p.className='floating'; p.style.left=(e.clientX-140)+'px'; p.style.top=(e.clientY-40)+'px'; p.style.transform='none';
    p.innerHTML=`
      <div class="floatHeader">スタイル<span class="handle">⣿</span></div>
      <div class="floatBody">
        <div class="row"><label>線色 <input type="color" id="stLine" value="${f.properties.stroke||'#1f2d3d'}"></label></div>
        <div class="row"><label>線幅 <input type="number" id="stWidth" value="${f.properties.strokeWidth||2}" min="1" max="12"></label></div>
        <div class="row"><label>塗色 <input type="color" id="stFill" value="${f.properties.fill||'#1f78b4'}"></label></div>
        <div class="row"><label>不透明度 <input type="number" id="stFillOp" value="${f.properties.fillOpacity??0.3}" min="0" max="1" step="0.05"></label></div>
        <div class="row" style="margin-top:8px">
          <button class="btn" id="stApply">適応</button>
          <button class="btn secondary" id="stClose">閉じる</button>
        </div>
      </div>`;
    document.body.appendChild(p);
    // ドラッグ
    (function(h= p.querySelector('.handle')){let sx,sy,L=p.offsetLeft,T=p.offsetTop,D=false;
      h.addEventListener('pointerdown',e=>{D=true;sx=e.clientX;sy=e.clientY;h.setPointerCapture(e.pointerId);});
      h.addEventListener('pointermove',e=>{if(!D)return; p.style.left=(L+e.clientX-sx)+'px';p.style.top=(T+e.clientY-sy)+'px';});
      h.addEventListener('pointerup',()=>{D=false;L=p.offsetLeft;T=p.offsetTop;});
    })();
    p.querySelector('#stApply').onclick=()=>{
      const g=f.properties;
      g.stroke = p.querySelector('#stLine').value;
      g.strokeWidth = Number(p.querySelector('#stWidth').value)||2;
      g.fill = p.querySelector('#stFill').value;
      g.fillOpacity = Number(p.querySelector('#stFillOp').value)||0.3;
      syncUserFeatures({refreshList:false});
    };
    p.querySelector('#stClose').onclick=()=> p.remove();
  };

  const del=document.createElement('button'); del.className='miniBtn'; del.textContent='削除'; del.onclick=()=>removeFeature(f);

  el.append(icon,label,styBtn,del);
  addDnD(el,'feature');
  return el;
}

// 初期描画
refreshObjList();
/* ==== /object tools & list ==== */
</script>
<script>
  // ★ここにあなたの設定を入れてください（上部スクリプトの window.__supa を利用 / 未設定時は以下を使用）
  const SUPABASE_FALLBACK_URL = '';        // 例: 'https://xxxxx.supabase.co'
  const SUPABASE_FALLBACK_ANON_KEY = '';   // anon public key
  let sb = null, sbUser = null;

  (async function initAuth(){
    if(window.__supa && typeof window.__supa.auth?.getUser === 'function'){
      sb = window.__supa;
    }else if(SUPABASE_FALLBACK_URL && SUPABASE_FALLBACK_ANON_KEY && window.supabase){
      sb = window.supabase.createClient(SUPABASE_FALLBACK_URL, SUPABASE_FALLBACK_ANON_KEY);
      window.__supa = sb;
    }else{
      updateSignUI();
      return; // Supabase 未設定
    }

    try{
      const { data:{ user } = {} } = await sb.auth.getUser();
      sbUser = user || null;
    }catch(e){
      console.warn('initAuth', e);
      sbUser = null;
    }
    updateSignUI();
    if(sbUser && sb.from) await loadUserData();
  })();

  function updateSignUI(){
    if(!sb) return;
    $('btnSignIn').style.display = sbUser ? 'none' : '';
    $('signinState').style.display = sbUser ? '' : 'none';
    $('btnShare').style.display = sbUser ? '' : 'none';
  }

  $('btnSignIn')?.addEventListener('click', async ()=>{
    const email = prompt('メールアドレスを入力してください');
    if(!email || !sb?.auth?.signInWithOtp) return;
    const { error } = await sb.auth.signInWithOtp({ email, options:{ emailRedirectTo: location.href }});
    if(error) alert('送信に失敗しました: '+error.message);
    else alert('メールを送信しました。届いたリンクから開いてください。');
  });

  $('btnShare')?.addEventListener('click', async ()=>{
    if(!sbUser) return;
    // シンプルに「ユーザー固有URL」を共有（?uid=）
    const url = new URL(location.href);
    url.searchParams.set('uid', sbUser.id);
    await navigator.clipboard.writeText(url.toString());
    alert('共有リンクをコピーしました');
  });

  async function loadUserData(){
    try{
      const uid = new URL(location.href).searchParams.get('uid') || sbUser?.id;
      if(!uid) return;
      if(!sb?.from) return;
      const { data, error } = await sb.from('user_maps').select('data').eq('user_id', uid).single();
      if(error || !data) return;
      if(data.data?.features){
        window.userFC = data.data;
        syncUserFeatures();
      }
    }catch(e){ console.warn('loadUserData', e); }
  }

  // 変更のたび自動保存
  async function autoSave(){
    if(!sb || !sbUser || !sb.from) return;
    try{
      const rec = { user_id: sbUser.id, data: window.userFC, updated_at: new Date().toISOString() };
      await sb.from('user_maps').upsert(rec, { onConflict:'user_id' });
    }catch(e){ console.warn('autosave', e); }
  }
  // 既存の pushFeature / removeFeature などの末尾で autoSave() を呼びます
  const _push = window.pushFeature;
  window.pushFeature = (f)=>{ _push(f); autoSave(); };
  const _rm = window.removeFeature;
  window.removeFeature = (f)=>{ _rm(f); autoSave(); };
</script>

</body>
</html>
