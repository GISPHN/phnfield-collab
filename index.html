<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PHN Field Collab – サーバ不要コラボ地図</title>

<!-- MapLibre -->
<link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet"/>
<script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>

<!-- Mapbox GL Draw -->
<link href="https://cdn.jsdelivr.net/npm/@mapbox/mapbox-gl-draw@1.4.3/dist/mapbox-gl-draw.css" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/@mapbox/mapbox-gl-draw@1.4.3/dist/mapbox-gl-draw.js"></script>

<!-- Turf -->
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js"></script>

<!-- EXIF -->
<script src="https://cdn.jsdelivr.net/npm/exifr@7.1.3/dist/full.umd.js"></script>

<!-- Yjs + y-webrtc -->
<script src="https://cdn.jsdelivr.net/npm/yjs@13.6.18/dist/yjs.js"></script>
<script src="https://cdn.jsdelivr.net/npm/y-webrtc@10.6.3/dist/y-webrtc.min.js"></script>

<!-- FlatGeobuf（GeoJSONシリアライズ対応のUMD版を使用） -->
<script src="https://cdn.jsdelivr.net/npm/flatgeobuf@3.25.0/dist/flatgeobuf-geojson.min.js"></script>

<!-- JSZip -->
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<style>
:root{--bg:#f8fafc;--line:#e5e7eb;--text:#0f172a;--muted:#64748b;--accent:#2563eb;--panel:#ffffff}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Noto Sans CJK JP","Noto Sans",sans-serif;color:var(--text)}
#topbar{display:flex;gap:.5rem;align-items:center;padding:.6rem .75rem;border-bottom:1px solid var(--line);background:var(--bg);position:relative;z-index:3;flex-wrap:wrap}
#brand{font-weight:700}
.btn{padding:.5rem .75rem;border:1px solid var(--line);border-radius:.6rem;background:#fff;cursor:pointer;font-size:.95rem}
.btn.active{border-color:var(--accent);box-shadow:0 0 0 2px rgba(37,99,235,.15) inset}
.btn:disabled{opacity:.5;cursor:not-allowed}
.badge{font-size:.82rem;padding:.2rem .55rem;border:1px solid var(--line);border-radius:999px;background:#fff}
.sep{width:1px;height:28px;background:var(--line);margin:0 .25rem}
.muted{color:var(--muted);font-size:.9rem}
#layout{position:relative;height:calc(100% - 64px)}
#map{position:absolute;inset:0 340px 0 0}
#side{position:absolute;right:0;top:0;bottom:0;width:340px;background:var(--panel);border-left:1px solid var(--line);display:flex;flex-direction:column}
#side .head{padding:.6rem .75rem;border-bottom:1px solid var(--line);display:flex;gap:.5rem;align-items:center;justify-content:space-between}
#list{overflow:auto;padding:.5rem}
.group{border:1px solid var(--line);border-radius:.6rem;margin-bottom:.5rem}
.group .ghead{display:flex;align-items:center;justify-content:space-between;padding:.45rem .6rem;background:#f9fafb;border-bottom:1px solid var(--line)}
.group .gitems{padding:.35rem;min-height:16px}
.item{display:flex;align-items:center;gap:.4rem;padding:.35rem;border-radius:.5rem}
.item:hover{background:#f3f4f6}
.item .name{flex:1;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.item .eye{cursor:pointer}
.item[draggable="true"]{cursor:grab}
.hidden{opacity:.5}
#err{display:none;position:fixed;left:12px;top:76px;background:#fee2e2;color:#7f1d1d;border:1px solid #fecaca;border-radius:.5rem;padding:.5rem .75rem;z-index:10}
#help{position:fixed;left:12px;bottom:12px;background:#fff;border:1px solid var(--line);border-radius:.75rem;padding:.6rem .75rem;font-size:.9rem;color:var(--muted);z-index:2}
.pin{width:26px;height:26px;transform:translateY(-2px)}
.photo-thumb{width:64px;height:64px;object-fit:cover;border-radius:.4rem;border:1px solid var(--line);box-shadow:0 1px 2px rgba(0,0,0,.06)}
#photo-input{display:none}
#modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:20}
#modal img{max-width:90vw;max-height:90vh;border-radius:.5rem;background:#000}
@media (max-width:1100px){#map{right:0}#side{position:static;width:100%;height:300px;border-left:none;border-top:1px solid var(--line)}#layout{height:calc(100% - 64px - 300px)}}
</style>
</head>
<body>
<div id="topbar">
  <span id="brand">PHN Field Collab</span>
  <span class="muted">短い room / editorKey をボタンで発行（短いURL）</span>
  <div class="sep"></div>

  <span class="muted">地図:</span>
  <button class="btn" id="bm-osm">OSM</button>
  <button class="btn" id="bm-gsi-std">地理院 標準</button>
  <button class="btn" id="bm-gsi-photo">地理院 写真</button>

  <div class="sep"></div>

  <button class="btn" id="tool-select">選択</button>
  <button class="btn" id="tool-pin">ピン</button>
  <button class="btn" id="tool-line">ライン</button>
  <button class="btn" id="tool-poly">ポリゴン</button>
  <button class="btn" id="tool-circle">円</button>
  <button class="btn" id="tool-delete">削除</button>
  <button class="btn" id="tool-photo">写真</button>
  <input type="file" id="photo-input" accept="image/*" multiple />

  <div class="sep"></div>

  <button class="btn" id="btn-make-room">部屋を作成</button>
  <button class="btn" id="btn-make-editor">編集リンクを作成</button>
  <button class="btn" id="btn-copy-view">閲覧リンクをコピー</button>
  <button class="btn" id="btn-export">エクスポート</button>

  <div style="margin-left:auto;display:flex;gap:.5rem;align-items:center">
    <span class="badge" id="role-badge">閲覧専用</span>
    <span class="badge" id="room-pill">room: -</span>
  </div>
</div>

<div id="layout">
  <div id="map"></div>
  <aside id="side">
    <div class="head">
      <strong>レイヤ一覧</strong>
      <div style="display:flex;gap:.4rem">
        <button class="btn" id="btn-add-group">グループ追加</button>
        <button class="btn" id="btn-toggle-all">全表示/非表示</button>
      </div>
    </div>
    <div id="list"></div>
  </aside>
</div>

<div id="help">①部屋作成 → ②地図選択 → ③選択/ピン/ライン/ポリゴン/円/写真 → ④リンク配布 → ⑤エクスポート。</div>
<div id="err"></div>
<div id="modal" onclick="this.style.display='none'"><img id="modal-img" alt="photo"/></div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const showErr = (m)=>{ const e=$('err'); e.textContent=m; e.style.display='block'; console.error(m); };
  const getHash = ()=> new URLSearchParams(location.hash.slice(1));
  const setHash = (q)=>{ location.hash=q.toString(); };
  const base62="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
  const rand = (n=12)=>{ const a=new Uint8Array(n); crypto.getRandomValues(a); return Array.from(a,v=>base62[v%62]).join(''); };
  const nowId = ()=> 'id_'+Date.now().toString(36)+Math.random().toString(36).slice(2,7);
  const pad=(n)=>String(n).padStart(2,'0');
  const ts = ()=>{ const d=new Date(); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}_${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}`; };

  // ---------- URL ----------
  const H=getHash();
  let ROOM_ID = H.get('r')||''; let EDITOR_KEY=H.get('k')||''; const READ_ONLY=!EDITOR_KEY;
  $('role-badge').textContent = READ_ONLY?'閲覧専用':'編集可';
  $('room-pill').textContent = 'room: '+(ROOM_ID||'-');
  const ensureRoom=(q)=>{ let r=q.get('r'); if(!r){ r=rand(12); q.set('r',r);} return r; };
  const viewURL = ()=>{ const q=getHash(); ensureRoom(q); q.delete('k'); q.delete('state'); return location.origin+location.pathname+'#'+q.toString(); };
  const editURL = ()=>{ const q=getHash(); ensureRoom(q); q.set('k',rand(16)); q.delete('state'); return location.origin+location.pathname+'#'+q.toString(); };

  // ---------- Map ----------
  const EMPTY_STYLE={version:8,sources:{},layers:[],glyphs:"https://fonts.openmaptiles.org/{fontstack}/{range}.pbf"}; // ← 重要：汎用グリフ
  let map;
  try{ map=new maplibregl.Map({container:'map',style:EMPTY_STYLE,center:[135.79,34.51],zoom:8.2}); }
  catch(e){ showErr('Map初期化エラー: '+e.message); return; }

  function addBasemap(){
    if(!map.getSource('osm')) map.addSource('osm',{type:'raster',tiles:['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],tileSize:256,attribution:'© OpenStreetMap'});
    if(!map.getSource('gsi-std')) map.addSource('gsi-std',{type:'raster',tiles:['https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png'],tileSize:256,attribution:'地理院 標準'});
    if(!map.getSource('gsi-photo')) map.addSource('gsi-photo',{type:'raster',tiles:['https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/{z}/{x}/{y}.jpg'],tileSize:256,attribution:'地理院 最新写真'});
    if(!map.getLayer('bm-osm')) map.addLayer({id:'bm-osm',type:'raster',source:'osm'});
    if(!map.getLayer('bm-gsi-std')) map.addLayer({id:'bm-gsi-std',type:'raster',source:'gsi-std'});
    if(!map.getLayer('bm-gsi-photo')) map.addLayer({id:'bm-gsi-photo',type:'raster',source:'gsi-photo'});
  }
  const showBM=(id)=>['bm-osm','bm-gsi-std','bm-gsi-photo'].forEach(l=> map.getLayer(l)&&map.setLayoutProperty(l,'visibility',l===id?'visible':'none'));
  map.on('load', ()=>{
    addBasemap(); showBM('bm-osm');
    if(navigator.geolocation){
      navigator.geolocation.getCurrentPosition(
        p=>map.jumpTo({center:[p.coords.longitude,p.coords.latitude],zoom:14}),
        _=>map.jumpTo({center:[135.79,34.51],zoom:8.2}),
        {enableHighAccuracy:true,timeout:7000}
      );
    } else map.jumpTo({center:[135.79,34.51],zoom:8.2});
  });
  $('bm-osm').onclick=()=>showBM('bm-osm'); $('bm-gsi-std').onclick=()=>showBM('bm-gsi-std'); $('bm-gsi-photo').onclick=()=>showBM('bm-gsi-photo');
  map.addControl(new maplibregl.NavigationControl({showZoom:true}),'top-right');
  map.addControl(new maplibregl.GeolocateControl({positionOptions:{enableHighAccuracy:true},trackUserLocation:true,showUserHeading:true}));

  // ---------- Draw ----------
  const draw=new MapboxDraw({displayControlsDefault:false});
  map.addControl(draw,'top-left');
  const dashed=()=>{[['gl-draw-line-stroke-active','line-dasharray',[2,2]],['gl-draw-polygon-stroke-active','line-dasharray',[2,2]]].forEach(([id,p,v])=>map.getLayer(id)&&map.setPaintProperty(id,p,v));};
  map.on('render', function once(){ dashed(); map.off('render', once); });

  // ---------- Labels（数字/英字/記号OK） ----------
  function ensureLabel(){
    if(!map.getSource('labels')) map.addSource('labels',{type:'geojson',data:{type:'FeatureCollection',features:[]}})
    if(!map.getLayer('labels')){
      map.addLayer({
        id:'labels', type:'symbol', source:'labels',
        layout:{
          'text-field':['coalesce',['to-string',['get','label']], ''],
          'text-offset':[0,1.2], 'text-size':15, 'text-anchor':'top',
          'text-font':['Open Sans Regular','Open Sans Bold','Noto Sans Regular','Noto Sans CJK JP Regular']
        },
        paint:{'text-color':'#111','text-halo-color':'#fff','text-halo-width':2.6,'text-halo-blur':0.4}
      });
    }
  }

  // ---------- Yjs / local ----------
  const hasY=!!(window.Y&&window.ywebrtc);
  const ydoc=hasY?new Y.Doc():null;
  const provider=hasY&&ROOM_ID?new ywebrtc.WebrtcProvider(ROOM_ID, ydoc):null;
  const yFeatures=hasY?ydoc.getArray('features'):null;
  const yGroups=hasY?ydoc.getArray('groupList'):null;
  const localFeatures=[]; const localGroupList=[{id:'__ungroup',name:'未分類',order:0,visible:true}];
  const featsArr=()=> hasY?yFeatures.toArray():localFeatures;
  const setFeats=(a)=>{ if(hasY){ yFeatures.delete(0,yFeatures.length); a.forEach(f=>yFeatures.push([f])); } else { localFeatures.splice(0,localFeatures.length,...a); } };
  const groupsArr=()=> hasY?yGroups.toArray():localGroupList;
  const setGroups=(a)=>{ if(hasY){ yGroups.delete(0,yGroups.length); a.forEach(g=>yGroups.push([g])); } else { localGroupList.splice(0,localGroupList.length,...a); } };
  if(hasY && yGroups.length===0) yGroups.push([{id:'__ungroup',name:'未分類',order:0,visible:true}]);

  // ---------- Render ----------
  const markers=new Map(); const photosFull=new Map();
  const clearMarkers=()=>{ markers.forEach(m=>m.remove()); markers.clear(); };
  const bbox=(f)=>{ try{return turf.bbox(f);}catch{return null;} };

  function addPinMarker(f){
    const el=document.createElement('div');
    el.innerHTML=`<svg class="pin" viewBox="0 0 24 24" fill="#d00" stroke="#fff" stroke-width="1.5"><path d="M12 22s-6-5.33-6-10a6 6 0 1 1 12 0c0 4.67-6 10-6 10z"></path><circle cx="12" cy="10" r="2.8" fill="#fff"/></svg>`;
    const m=new maplibregl.Marker({element:el,anchor:'bottom'}).setLngLat(f.geometry.coordinates).addTo(map);
    markers.set(f.id,m);
  }
  function addPhotoMarker(f){
    const el=document.createElement('div'); el.style.display='flex'; el.style.flexDirection='column'; el.style.alignItems='center';
    const img=document.createElement('img'); img.src=f.properties.thumb; img.className='photo-thumb'; img.alt=f.properties.label||'photo';
    el.appendChild(img);
    if (f.properties?.label){ const cap=document.createElement('div'); cap.textContent=f.properties.label; cap.style.fontSize='.8rem'; cap.style.marginTop='.2rem'; el.appendChild(cap); }
    img.onclick=()=>{ const full=photosFull.get(f.id)||f.properties.thumb; $('modal-img').src=full; $('modal').style.display='flex'; };
    const m=new maplibregl.Marker({element:el,anchor:'bottom'}).setLngLat(f.geometry.coordinates).addTo(map);
    markers.set(f.id,m);
  }

  function render(){
    const feats=featsArr();
    try{ draw.deleteAll(); }catch(_){}
    clearMarkers();
    const labels=[];
    feats.forEach(f=>{
      if(f.properties?.visible===false) return;
      if(f.properties?.kind==='pin'){ addPinMarker(f); if(f.properties?.label){ labels.push({type:'Feature',geometry:{type:'Point',coordinates:f.geometry.coordinates},properties:{label:f.properties.label}}); } }
      else if(f.properties?.kind==='photo'){ addPhotoMarker(f); if(f.properties?.label){ labels.push({type:'Feature',geometry:{type:'Point',coordinates:f.geometry.coordinates},properties:{label:f.properties.label}}); } }
      else{ try{ draw.add(f);}catch(_){}
        if(f.properties?.label){
          let g; try{ g=f.geometry.type==='LineString'?turf.center(f).geometry:turf.centerOfMass(f).geometry; labels.push({type:'Feature',geometry:g,properties:{label:f.properties.label}});}catch(_){}
        }
      }
    });
    ensureLabel();
    map.getSource('labels')?.setData({type:'FeatureCollection',features:labels});
    rebuildSidebar();
  }

  // ---------- Tools & events ----------
  let tool='select'; let circleCenter=null; let placingPhoto=null;
  const setTool=(t)=>{ tool=t; ['tool-select','tool-pin','tool-line','tool-poly','tool-circle','tool-photo'].forEach(id=>$(id).classList.toggle('active', id==='tool-'+t)); if(t==='line')draw.changeMode('draw_line_string'); else if(t==='poly')draw.changeMode('draw_polygon'); else draw.changeMode('simple_select'); };
  $('tool-select').onclick=()=>setTool('select');
  $('tool-pin').onclick=()=>{ if(!EDITOR_KEY){alert('閲覧専用です。'); return;} setTool('pin'); };
  $('tool-line').onclick=()=>{ if(!EDITOR_KEY){alert('閲覧専用です。'); return;} setTool('line'); };
  $('tool-poly').onclick=()=>{ if(!EDITOR_KEY){alert('閲覧専用です。'); return;} setTool('poly'); };
  $('tool-circle').onclick=()=>{ if(!EDITOR_KEY){alert('閲覧専用です。'); return;} setTool('circle'); circleCenter=null; };
  $('tool-photo').onclick=()=>{ if(!EDITOR_KEY){alert('閲覧専用です。'); return;} $('photo-input').click(); };
  setTool('select');

  // 円プレビュー
  function circlePreview(center, edge){
    const r=turf.distance(center,edge,{units:'kilometers'});
    const poly=turf.circle(center,r,{steps:64,units:'kilometers'});
    if(!map.getSource('circle-preview')){ map.addSource('circle-preview',{type:'geojson',data:poly}); map.addLayer({id:'circle-preview',type:'line',source:'circle-preview',paint:{'line-color':'#333','line-width':2,'line-dasharray':[2,2]}}); }
    else map.getSource('circle-preview').setData(poly);
  }
  function clearCircle(){ if(map.getLayer('circle-preview'))map.removeLayer('circle-preview'); if(map.getSource('circle-preview'))map.removeSource('circle-preview'); }
  map.on('mousemove',(e)=>{ if(tool==='circle'&&circleCenter) circlePreview(circleCenter,[e.lngLat.lng,e.lngLat.lat]); });
  map.on('click',(e)=>{
    if(tool==='pin'){
      const label=prompt('ピンのラベル（任意）')||'';
      addF({type:'Feature',id:nowId(),geometry:{type:'Point',coordinates:[e.lngLat.lng,e.lngLat.lat]},properties:{kind:'pin',label,visible:true}});
      return;
    }
    if(tool==='circle'){
      if(!circleCenter){ circleCenter=[e.lngLat.lng,e.lngLat.lat]; circlePreview(circleCenter,circleCenter); return; }
      const rkm=turf.distance(circleCenter,[e.lngLat.lng,e.lngLat.lat],{units:'kilometers'});
      const poly=turf.circle(circleCenter,rkm,{steps:64,units:'kilometers'});
      clearCircle(); const label=prompt('円のラベル（任意）')||'';
      addF({type:'Feature',id:nowId(),geometry:poly.geometry,properties:{kind:'circle',label,visible:true,radius_m:Math.round(rkm*1000)}});
      circleCenter=null; setTool('select'); return;
    }
    if(placingPhoto){
      addPhotoAt([e.lngLat.lng,e.lngLat.lat], placingPhoto);
      placingPhoto=null;
    }
  });
  map.on('draw.create',(e)=>{
    const f=e.features[0]; if(!f) return;
    if(f.geometry.type==='Point'){ draw.delete(f.id); return; }
    const label=prompt((f.geometry.type==='LineString'?'ライン':'ポリゴン')+'のラベル（任意）')||'';
    const kind=(f.geometry.type==='LineString'?'line':'polygon');
    draw.delete(f.id);
    addF({type:'Feature',id:nowId(),geometry:f.geometry,properties:{kind,label,visible:true}});
    setTool('select');
  });
  $('tool-delete').onclick=()=>{ if(!EDITOR_KEY){alert('閲覧専用です。'); return;} const ids=draw.getSelectedIds?draw.getSelectedIds():[]; if(ids.length){draw.trash();} else alert('削除はサイドバーの🗑から行ってください。'); };

  // 写真
  $('photo-input').addEventListener('change', async (ev)=>{
    const files=[...ev.target.files];
    for(const file of files){
      let lat=null,lon=null;
      try{
        const gps=await exifr.gps(file);
        if(gps && typeof gps.latitude==='number' && typeof gps.longitude==='number'){ lat=gps.latitude; lon=gps.longitude; }
        else{
          const ex=await exifr.parse(file,{gps:true}).catch(()=>null);
          if(ex && ex.GPSLatitude && ex.GPSLongitude){
            const toDec=(a,ref)=> (a[0]+a[1]/60+a[2]/3600) * (ref==='S'||ref==='W'?-1:1);
            lat=toDec(ex.GPSLatitude, ex.GPSLatitudeRef||'N');
            lon=toDec(ex.GPSLongitude, ex.GPSLongitudeRef||'E');
          }
        }
      }catch(_) {}
      const img=await fileToImage(file);
      const {thumb,fullURL}=await makeThumb(img,800,512);
      const payload={thumb, fullURL, label:file.name.replace(/\.[^.]+$/,'')};
      if(lat!=null && lon!=null){ addPhotoAt([lon,lat], payload); }
      else { placingPhoto=payload; alert('この写真にはGPSがありません。地図をクリックして配置してください。'); }
    }
    ev.target.value='';
  });
  function addPhotoAt(ll, payload){
    const feat={type:'Feature',id:nowId(),geometry:{type:'Point',coordinates:ll},properties:{kind:'photo',label:payload.label,thumb:payload.thumb,visible:true}};
    photosFull.set(feat.id, payload.fullURL); addF(feat);
  }
  function fileToImage(f){ return new Promise((res,rej)=>{ const u=URL.createObjectURL(f); const i=new Image(); i.onload=()=>res(i); i.onerror=rej; i.src=u; }); }
  async function makeThumb(img, fullMax=800, thumbMax=512){
    const to=(max)=>{ const s=Math.min(1,max/Math.max(img.naturalWidth,img.naturalHeight)); const w=Math.round(img.naturalWidth*s), h=Math.round(img.naturalHeight*s); const c=document.createElement('canvas'); c.width=w; c.height=h; const ctx=c.getContext('2d'); ctx.imageSmoothingEnabled=true; ctx.imageSmoothingQuality='high'; ctx.drawImage(img,0,0,w,h); return c.toDataURL('image/jpeg',0.75); };
    return {fullURL:to(fullMax), thumb:to(thumbMax)};
  }

  // 追加/更新/削除
  function addF(f){ if(hasY) yFeatures.push([f]); else localFeatures.push(f); render(); }
  function updF(id,fn){ const a=featsArr(); const i=a.findIndex(x=>x.id===id); if(i<0)return; const n=JSON.parse(JSON.stringify(a[i])); fn(n); a[i]=n; setFeats(a); render(); }
  function delF(id){ const a=featsArr(); const i=a.findIndex(x=>x.id===id); if(i<0)return; a.splice(i,1); setFeats(a); render(); }

  // サイドバー（グループ）
  function ensureGroup(name){ const gl=groupsArr(); const f=gl.find(g=>g.name===name); if(f) return f.id; const id='g_'+rand(8); const max=Math.max(0,...gl.map(g=>g.order||0)); const ng={id,name,order:max+1,visible:true}; setGroups([...gl,ng]); return id; }
  function rebuildSidebar(){
    const feats=featsArr().slice().sort((a,b)=>(a.properties?.order||0)-(b.properties?.order||0));
    const gl=groupsArr().slice().sort((a,b)=>(a.order||0)-(b.order||0));
    if(!gl.find(g=>g.id==='__ungroup')) setGroups([{id:'__ungroup',name:'未分類',order:0,visible:true},...gl]);
    const by=new Map(gl.map(g=>[g.id,[]])); feats.forEach(f=>{ const gid=f.properties?.groupId||'__ungroup'; (by.get(gid)||by.get('__ungroup')).push(f); });
    const list=$('list'); list.innerHTML='';

    gl.forEach(g=>{
      const box=document.createElement('div'); box.className='group'; box.dataset.gid=g.id;
      const head=document.createElement('div'); head.className='ghead'; head.dataset.gid=g.id;
      const title=document.createElement('div'); title.textContent=g.name; head.appendChild(title);
      const eye=document.createElement('span'); eye.textContent='👁'; eye.style.cursor='pointer'; head.appendChild(eye);
      eye.onclick=()=>{ (by.get(g.id)||[]).forEach(f=>updF(f.id,n=>{ n.properties.visible = !(n.properties?.visible!==false); })); };
      head.addEventListener('dragover', e=>e.preventDefault());
      head.addEventListener('drop', e=>{ const from=e.dataTransfer.getData('text/plain'); if(from) updF(from, n=>{ n.properties.groupId=g.id; }); });
      box.appendChild(head);

      const items=document.createElement('div'); items.className='gitems'; items.dataset.gid=g.id;
      (by.get(g.id)||[]).forEach(f=>{
        const it=document.createElement('div'); it.className='item'; it.setAttribute('draggable','true'); it.dataset.id=f.id; it.dataset.gid=g.id;
        if (f.properties?.visible===false) it.classList.add('hidden');
        const eyeI=document.createElement('span'); eyeI.textContent=(f.properties?.visible===false)?'🙈':'👁'; eyeI.className='eye';
        eyeI.onclick=()=> updF(f.id, n=>{ const cur=n.properties?.visible!==false; n.properties.visible=!cur; });
        const name=document.createElement('div'); name.className='name'; name.textContent=`${kind(f.properties?.kind)}：${f.properties?.label||'(無題)'}`;
        name.onclick=()=>{ if(f.geometry.type==='Point') map.flyTo({center:f.geometry.coordinates,zoom:18}); else { const b=bbox(f); if(b) map.fitBounds([[b[0],b[1]],[b[2],b[3]]],{padding:40}); } };
        const edit=document.createElement('button'); edit.textContent='✏️'; edit.className='btn'; edit.onclick=()=>{ const l=prompt('ラベルを編集', f.properties?.label||'')||''; updF(f.id,n=>{n.properties.label=l;}); };
        const del=document.createElement('button'); del.textContent='🗑'; del.className='btn'; del.onclick=()=>{ if(confirm('削除しますか？')) delF(f.id); };
        it.appendChild(eyeI); it.appendChild(name); it.appendChild(edit); it.appendChild(del); items.appendChild(it);
      });
      let dragId=null;
      items.addEventListener('dragstart', e=>{ const it=e.target.closest('.item'); if(!it)return; dragId=it.dataset.id; e.dataTransfer.setData('text/plain',dragId); });
      items.addEventListener('dragover', e=>e.preventDefault());
      items.addEventListener('drop', e=>{
        e.preventDefault();
        const from=e.dataTransfer.getData('text/plain'); if(!from) return;
        const toItem=e.target.closest('.item');
        if(toItem){
          const toId=toItem.dataset.id; const fa=featsArr(); const fromF=fa.find(x=>x.id===from); const toF=fa.find(x=>x.id===toId); if(!fromF||!toF) return;
          const same=(fromF.properties?.groupId||'__ungroup')===(toF.properties?.groupId||'__ungroup');
          if(same){
            const newName=prompt('新しいグループ名','新規グループ'); if(!newName) return;
            const newG=ensureGroup(newName);
            updF(from, n=>{ n.properties.groupId=newG; });
            updF(toId, n=>{ n.properties.groupId=newG; });
          }else{
            updF(from, n=>{ n.properties.groupId = (toF.properties?.groupId||'__ungroup'); });
          }
        }
      });
      box.appendChild(items); list.appendChild(box);
    });
  }
  const kind=(k)=>k==='pin'?'ピン':k==='photo'?'写真':k==='line'?'ライン':k==='polygon'?'ポリゴン':k==='circle'?'円':'項目';

  // トグル・エクスポートなど
  $('btn-add-group').onclick=()=>{ const n=prompt('新しいグループ名','新しいグループ'); if(!n)return; ensureGroup(n); rebuildSidebar(); };
  $('btn-toggle-all').onclick=()=>{ const a=featsArr(); const any=a.some(f=>f.properties?.visible!==false); a.forEach(f=>f.properties={...f.properties,visible:!any}); setFeats(a); render(); };

  // リンク
  $('btn-make-room').onclick=()=>{ const q=getHash(); const r=ensureRoom(q); q.delete('k'); q.delete('state'); setHash(q); ROOM_ID=r; $('room-pill').textContent='room: '+ROOM_ID; alert('部屋を作成しました。URLを共有してください。'); if(hasY && !provider){ new ywebrtc.WebrtcProvider(ROOM_ID, ydoc);} };
  $('btn-make-editor').onclick=async ()=>{ const url=editURL(); try{await navigator.clipboard.writeText(url);}catch(e){} location.hash=url.split('#')[1]; const q=getHash(); ROOM_ID=q.get('r')||ROOM_ID; EDITOR_KEY=q.get('k')||EDITOR_KEY; $('role-badge').textContent=EDITOR_KEY?'編集可':'閲覧専用'; $('room-pill').textContent='room: '+ROOM_ID; alert('編集リンクをコピーしました。\n'+url); };
  $('btn-copy-view').onclick=async ()=>{ const url=viewURL(); try{await navigator.clipboard.writeText(url); alert('閲覧リンクをコピーしました。\n'+url);}catch(e){prompt('コピーできない場合は手動で',url);} };

  // エクスポート（FGB & CSV → ZIP）
  $('btn-export').onclick=async ()=>{
    try{
      const a=featsArr().map(f=>JSON.parse(JSON.stringify(f)));
      const points = a.filter(f=>f.properties?.kind==='pin' || f.properties?.kind==='photo');
      const lines  = a.filter(f=>f.properties?.kind==='line');
      const polys  = a.filter(f=>f.properties?.kind==='polygon');
      const circs  = a.filter(f=>f.properties?.kind==='circle');

      lines.forEach(f=>{ try{ f.properties.length_m = Math.round(turf.length(f,{units:'kilometers'})*1000); }catch{} });
      polys.forEach(f=>{ try{ f.properties.area_m2 = Math.round(turf.area(f)); }catch{} });
      // circle は radius_m を保存済み

      const pinRows = points.map(f=>({label:String(f.properties?.label??''), lon:f.geometry.coordinates[0], lat:f.geometry.coordinates[1]}));
      const csv = toCSV(pinRows);

      if(!(window.flatgeobuf && flatgeobuf.GeoJSON && flatgeobuf.GeoJSON.serialize)){
        throw new Error('flatgeobuf-geojson を読み込めていません（CDNブロックの可能性）');
      }
      const toFGB = (features)=> features.length? flatgeobuf.GeoJSON.serialize({type:'FeatureCollection',features}) : null;

      const name = ts();
      const zip = new JSZip();
      const pF=toFGB(points), lF=toFGB(lines), gF=toFGB(polys), cF=toFGB(circs);
      if(pF) zip.file(`${name}_points.fgb`, new Blob([pF]));
      if(lF) zip.file(`${name}_lines.fgb`, new Blob([lF]));
      if(gF) zip.file(`${name}_polygons.fgb`, new Blob([gF]));
      if(cF) zip.file(`${name}_circles.fgb`, new Blob([cF]));
      zip.file(`${name}_points.csv`, new Blob([csv], {type:'text/csv'}));

      const blob = await zip.generateAsync({type:'blob'});

      if(window.showSaveFilePicker){
        const handle = await showSaveFilePicker({suggestedName:`${name}_export.zip`,types:[{description:'ZIP',accept:{'application/zip':['.zip']}}]});
        const w=await handle.createWritable(); await w.write(blob); await w.close();
        alert('エクスポート完了：'+handle.name);
      }else{
        const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`${name}_export.zip`; a.click(); setTimeout(()=>URL.revokeObjectURL(url),3000);
      }
    }catch(e){ alert('エクスポートでエラー：'+e.message); }
  };
  const toCSV=(rows)=>{ if(!rows.length) return 'label,lon,lat\n'; const keys=Object.keys(rows[0]); const esc=v=>`"${String(v).replace(/"/g,'""')}"`; return [keys.join(',')].concat(rows.map(r=>keys.map(k=>esc(r[k]??'')).join(','))).join('\n')+'\n'; };

  // 監視
  if(hasY){ yFeatures.observeDeep(()=>render()); if(yGroups) yGroups.observe(()=>rebuildSidebar()); }
  render();

})();
</script>
</body>
</html>
