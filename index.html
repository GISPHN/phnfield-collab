<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PHN Field Collab + FGBビューア（統合パネル・機能美UI 完全版）</title>

<!-- MapLibre -->
<link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet"/>
<script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>

<!-- Draw（Mapbox版を互換で使用） -->
<script>window.mapboxgl = window.maplibregl;</script>
<link href="https://cdn.jsdelivr.net/npm/@mapbox/mapbox-gl-draw@1.4.3/dist/mapbox-gl-draw.css" rel="stylesheet" crossorigin="anonymous"/>
<script src="https://cdn.jsdelivr.net/npm/@mapbox/mapbox-gl-draw@1.4.3/dist/mapbox-gl-draw.js" crossorigin="anonymous"></script>

<!-- その他ライブラリ -->
<script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js" crossorigin="anonymous"></script>
<script src="https://unpkg.com/exifr@7.1.3/dist/full.umd.js" crossorigin="anonymous"></script>
<script src="https://unpkg.com/yjs@13.6.18/dist/yjs.js" crossorigin="anonymous"></script>
<script src="https://unpkg.com/y-webrtc@10.6.3/dist/y-webrtc.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" crossorigin="anonymous"></script>

<style>
:root{
  --paper:#ffffff;
  --ink:#0f172a;
  --muted:#64748b;
  --line:#e5e7eb;
  --accent:#2563eb;
  --accent-2:#0ea5e9;
  --danger:#dc2626;
  --shadow:0 10px 30px rgba(0,0,0,.18);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Noto Sans CJK JP","Noto Sans",sans-serif;color:var(--ink);background:#f6f7fb}

/* ====== Topbar ====== */
#topbar{
  display:flex;gap:.5rem;align-items:center;padding:.55rem .75rem .6rem;
  border-bottom:1px solid var(--line);
  position:relative; z-index:1000; flex-wrap:wrap;
  background:rgba(255,255,255,.88); backdrop-filter:saturate(1.2) blur(10px);
}
#brand{font-weight:800;letter-spacing:.02em}
#subbrand{font-size:.9rem;color:#475569;display:flex;gap:.35rem;align-items:center}
#subbrand a{color:var(--accent-2);text-decoration:none}
#subbrand a:hover{text-decoration:underline}

.btn{
  --b:1px solid var(--line);
  padding:.46rem .7rem;border:var(--b);border-radius:.65rem;background:#fff;cursor:pointer;
  font-size:.95rem; transition:.15s; box-shadow:0 1px 0 rgba(0,0,0,.03);
}
.btn:hover{transform:translateY(-1px)}
.btn:active{transform:translateY(0)}
.btn.primary{background:linear-gradient(180deg,#3b82f6,#2563eb); color:#fff; border-color:#1e40af; box-shadow:0 6px 18px rgba(37,99,235,.28)}
.btn.ghost{background:rgba(255,255,255,.75); backdrop-filter:saturate(1.2) blur(6px)}
.btn.active{outline:2px solid rgba(37,99,235,.35)}
.btn:disabled{opacity:.45;cursor:not-allowed;filter:grayscale(.25)}
.badge{font-size:.8rem;padding:.2rem .55rem;border:1px solid var(--line);border-radius:999px;background:#fff}
.sep{width:1px;height:28px;background:var(--line);margin:0 .25rem}
.muted{color:var(--muted);font-size:.9rem}

/* ====== Layout ====== */
#layout{position:relative;height:calc(100% - 64px)}
#map{position:absolute; inset:0 340px 0 0; transition:right .2s; z-index:0}
.maplibregl-canvas,.maplibregl-canvas-container{ z-index:0 !important; }

/* 右パネル（レイヤ一覧） */
#side{
  position:absolute;right:0;top:0;bottom:0;width:340px;
  border-left:1px solid var(--line);display:flex;flex-direction:column;z-index:900;
  background:rgba(255,255,255,.86); backdrop-filter:saturate(1.2) blur(10px);
}
#side .head{padding:.6rem .75rem;border-bottom:1px solid var(--line);display:flex;gap:.5rem;align-items:center;justify-content:space-between}
#side .head .fold{cursor:pointer; user-select:none; display:flex; align-items:center; gap:.35rem}
#list{overflow:auto;padding:.5rem}
#side.folded #list{display:none}
body.side-collapsed #side{ width:36px; }
body.side-collapsed #side .head{ padding:.35rem .4rem; }
body.side-collapsed #side .head > div:last-child{ display:none; }
body.side-collapsed #list{ display:none; }
body.side-collapsed #map{ inset:0 0 0 0; }

/* グループ一覧 */
.group{border:1px solid var(--line);border-radius:.65rem;margin-bottom:.55rem;background:#fff}
.group .ghead{display:flex;align-items:center;justify-content:space-between;padding:.45rem .6rem;background:#f9fafb;border-bottom:1px solid var(--line)}
.group .gitems{padding:.35rem;min-height:16px}
.item{display:flex;align-items:center;gap:.45rem;padding:.35rem;border-radius:.5rem}
.item:hover{background:#f3f4f6}
.item .name{flex:1;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;cursor:pointer}
.item .eye,.item .edit,.item .paint,.item .del{cursor:pointer}
.item[draggable="true"]{cursor:grab}
.hidden{opacity:.5}

/* 通知/モーダル */
#err{display:none;position:fixed;left:12px;top:74px;background:#fee2e2;color:#7f1d1d;border:1px solid #fecaca;border-radius:.6rem;padding:.5rem .75rem;z-index:1100;box-shadow:var(--shadow)}
#help{position:fixed;left:12px;bottom:12px;border:1px solid var(--line);border-radius:.8rem;padding:.6rem .75rem;font-size:.9rem;color:#475569;z-index:6;background:rgba(255,255,255,.82);backdrop-filter:saturate(1.1) blur(6px)}
#modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:1200}
#modal img{max-width:90vw;max-height:90vh;border-radius:.5rem;background:#000}

/* 現在地 */
.loc-wrap{position:relative;width:18px;height:18px}
.loc-dot{position:absolute;left:50%;top:50%;width:12px;height:12px;margin:-6px 0 0 -6px;border-radius:50%;background:#2563eb;box-shadow:0 0 0 2px #fff}
.loc-pulse{position:absolute;left:50%;top:50%;width:12px;height:12px;margin:-6px 0 0 -6px;border-radius:50%;background:rgba(37,99,235,.35);animation:pulse 2.2s ease-out infinite}
@keyframes pulse{0%{transform:translate(-50%,-50%) scale(.6);opacity:.8}70%{transform:translate(-50%,-50%) scale(2.6);opacity:0}100%{transform:translate(-50%,-50%) scale(2.6);opacity:0}}

/* ====== 左上：統合パネル（ハザード＋避難データ） ====== */
.panel{
  position:absolute; left:10px; top:70px; width:320px;
  background:rgba(255,255,255,.92); backdrop-filter:saturate(1.2) blur(10px);
  border:1px solid var(--line); border-radius:.9rem; z-index:950;
  box-shadow:var(--shadow); overflow:hidden;
}
.panel .phead{background:linear-gradient(180deg,#f8fafc,#eef2ff);padding:10px 12px;cursor:pointer;font-weight:800;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between}
.panel .pbody{padding:10px 12px}
.panel .row{margin:.45em 0}
.panel .pill{padding:4px 8px;border-radius:999px;background:#f5f5f5;border:1px solid #ddd;user-select:none}
.panel label.inline{display:inline-flex;align-items:center;gap:8px;margin:6px 0}
.panel .legend span{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:6px;vertical-align:middle}
.panel .emg{background:#e23b3b}
.panel .shel{background:#2a7be4}
.panel select{font-size:14px}
.panel select[multiple]{min-width:296px;min-height:110px}
.small{font-size:12px;color:#555}

/* オートコンプリート */
.suggest-box{position:relative}
#qMuni{width:292px;font-size:14px}
#suggest{
  position:absolute; left:0; right:0; top:30px; background:#fff; border:1px solid var(--line);
  border-radius:.55rem; box-shadow:0 10px 28px rgba(0,0,0,.12); z-index:2000; display:none; max-height:220px; overflow:auto
}
.suggest-item{padding:7px 9px; cursor:pointer}
.suggest-item:hover, .suggest-item.active{background:#eef2ff}

/* ラベル（HTMLマーカー） */
.mlabel{
  font-weight:700; font-size:15px; color:#111; white-space:nowrap; pointer-events:none;
  text-shadow:0 0 2px #fff,0 0 2px #fff,0 0 2px #fff,0 0 2px #fff;
  transform: translateY(-2px);
}

/* 写真 */
.photo-thumb{width:64px;height:64px;object-fit:cover;border-radius:.4rem;border:1px solid var(--line);box-shadow:0 1px 2px rgba(0,0,0,.06)}
#photo-input{display:none}

/* レスポンシブ */
@media (max-width:1100px){
  #map{right:0}
  #side{position:static;width:100%;height:300px;border-left:none;border-top:1px solid var(--line)}
  #layout{height:calc(100% - 64px - 300px)}
  .panel{position:static;width:calc(100% - 20px);margin:8px 10px}
}
</style>
</head>
<body>
<!-- ===== Topbar ===== -->
<div id="topbar">
  <div style="display:flex;flex-direction:column;gap:2px">
    <span id="brand">PHN Field Collab</span>
    <span id="subbrand">
      保健師活動支援マップ
      <svg width="14" height="14" viewBox="0 0 1200 1227" aria-hidden="true" style="margin-top:-1px"><path d="M714 519l275-319h-130L653 453 478 200H200l300 435L200 1027h130l219-254 194 254h279L714 519zm-96 111l-25-34-242-339h104l195 274 25 34 258 361H1037L618 630z"/></svg>
      <a href="https://x.com/GISPHN" target="_blank" rel="noopener">GISPHN</a>
    </span>
  </div>

  <span class="sep"></span>

  <span class="muted">地図:</span>
  <button class="btn ghost" id="bm-osm"    title="OpenStreetMap">OSM</button>
  <button class="btn ghost" id="bm-gsi-std"   title="地理院 標準">標準</button>
  <button class="btn ghost" id="bm-gsi-photo" title="地理院 最新写真">写真</button>

  <span class="sep"></span>

  <button class="btn ghost" id="tool-select">選択</button>
  <button class="btn ghost" id="tool-pin">ピン</button>
  <button class="btn ghost" id="tool-line">ライン</button>
  <button class="btn ghost" id="tool-poly">ポリゴン</button>
  <button class="btn ghost" id="tool-circle">円</button>
  <button class="btn ghost" id="tool-photo">写真</button>
  <input type="file" id="photo-input" accept="image/*" multiple />

  <span class="sep"></span>

  <button class="btn primary" id="btn-make-room">部屋を作成</button>
  <button class="btn ghost" id="btn-make-editor" title="部屋作成後に有効">編集リンク</button>
  <button class="btn ghost" id="btn-copy-view">閲覧リンク</button>
  <button class="btn ghost" id="btn-export">エクスポート</button>
  <button class="btn ghost" id="btn-screenshot">スクショ</button>

  <div style="margin-left:auto;display:flex;gap:.5rem;align-items:center">
    <span class="badge" id="role-badge">閲覧専用</span>
    <span class="badge" id="room-pill">room: -</span>
  </div>
</div>

<!-- ===== Map / Right panel ===== -->
<div id="layout">
  <div id="map"></div>
  <aside id="side">
    <div class="head">
      <div class="fold" id="side-fold"><span id="side-fold-icon">▼</span><strong>レイヤ一覧</strong></div>
      <div style="display:flex;gap:.4rem">
        <button class="btn ghost" id="btn-add-group" title="編集モードで有効">グループ追加</button>
        <button class="btn ghost" id="btn-bulk-style" title="編集モードで有効">一括スタイル</button>
        <button class="btn ghost" id="btn-toggle-all" title="編集モードで有効">全表示/非表示</button>
      </div>
    </div>
    <div id="list"></div>
  </aside>
</div>

<!-- ===== 左上：統合パネル ===== -->
<div class="panel" id="panel">
  <div class="phead" id="panel-h">ハザード / 避難データ <span id="panel-fold">▼</span></div>
  <div class="pbody" id="panel-b">
    <!-- ハザード -->
    <div class="row">
      <label class="inline"><input type="checkbox" id="chk-flood"> 洪水浸水想定区域（想定最大規模）</label><br>
      <label class="inline"><input type="checkbox" id="chk-dosha"> 土砂災害警戒区域（3種一括）</label>
    </div>
    <div class="row" style="display:flex;align-items:center;gap:10px">
      <span class="small">透明度</span>
      <input type="range" id="hazard-opacity" min="0" max="1" step="0.05" value="0.6" style="flex:1">
      <span id="hazard-ov">0.60</span>
    </div>
    <div class="row small">凡例（洪水）<br>
      <img src="https://disaportal.gsi.go.jp/maps/_images/l2_flood_l.png" alt="洪水凡例" style="max-width:100%;border:1px solid #ddd;border-radius:.35rem;margin-top:4px">
    </div>

    <hr style="border:none;border-top:1px dashed #dbeafe;margin:8px 0">

    <!-- 避難データ -->
    <div class="row" style="display:flex;gap:6px;flex-wrap:wrap">
      <label class="pill"><input type="radio" name="areaMode" value="all" checked> 日本全国</label>
      <label class="pill"><input type="radio" name="areaMode" value="pref"> 都道府県で絞る</label>
      <label class="pill"><input type="radio" name="areaMode" value="muni"> 市区町村で絞る</label>
    </div>

    <div id="prefRow" class="row" style="display:none">
      <div class="small">都道府県（複数選択可）</div>
      <select id="prefSelect" multiple></select>
    </div>

    <div id="muniRow" class="row" style="display:none">
      <div class="small">市区町村（複数選択可）</div>
      <select id="muniSelect" multiple></select>
      <div class="small">※都道府県を先に選ぶと市区町村リストが絞られます</div>
    </div>

    <div class="row" style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
      <div class="pill"><label class="inline" style="margin:0"><input id="chkLabel" type="checkbox" checked> ラベル</label></div>
      <select id="labelFieldSelect" style="max-width:180px"></select>
    </div>

    <div class="row suggest-box">
      <div class="small">クイック検索</div>
      <input id="qMuni" placeholder="例）奈良市, 生駒市 / 東京都"/>
      <div id="suggest"></div>
      <div class="small">Enterで選択に追加（カンマ区切りで複数）</div>
    </div>

    <div class="row" style="display:flex;gap:6px;flex-wrap:wrap">
      <label class="pill"><input id="chkEmergency" type="checkbox" checked> 指定緊急避難場所</label>
      <label class="pill"><input id="chkShelter" type="checkbox" checked> 指定避難所</label>
    </div>

    <div class="row small">
      <span class="emg" style="display:inline-block;width:10px;height:10px;border-radius:50%;vertical-align:middle"></span> 緊急避難場所　
      <span class="shel" style="display:inline-block;width:10px;height:10px;border-radius:50%;vertical-align:middle"></span> 避難所
    </div>

    <div class="row">
      <button id="btnApply" class="btn primary" style="width:100%">表示を更新</button>
    </div>
  </div>
</div>

<div id="help">①部屋作成 → ②編集リンク → ③作図/写真 → ④リンク配布 → ⑤エクスポート/スクショ</div>
<div id="err"></div>
<div id="modal" onclick="this.style.display='none'"><img id="modal-img" alt="photo"/></div>

<script>
window.addEventListener('DOMContentLoaded', () => {
  const $ = (id)=>document.getElementById(id);
  const showErr = (m)=>{ const e=$('err'); e.textContent=m; e.style.display='block'; console.error(m); setTimeout(()=>e.style.display='none',9000); };
  window.addEventListener('error', (ev)=>{ const msg = ev?.error?.message || ev?.message || 'Script error.'; showErr('JSエラー: '+msg); });

  if (typeof maplibregl === 'undefined') { showErr('MapLibreが読み込まれていません'); return; }
  const DrawCtor = window.MapboxDraw;

  /* ===== URL / 権限 ===== */
  const getHash = ()=> new URLSearchParams(location.hash.slice(1));
  const setHash = (q)=>{ location.hash=q.toString(); };
  const base62="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
  const rand=(n=12)=>{const a=new Uint8Array(n); crypto.getRandomValues(a); return Array.from(a,v=>base62[v%62]).join('');};
  let H=getHash(); let ROOM_ID=H.get('r')||''; let EDITOR_KEY=H.get('k')||'';
  const allowEdit = ()=> Boolean(ROOM_ID && EDITOR_KEY);
  function updateRoleUI(){
    $('role-badge').textContent = allowEdit() ? '編集可' : '閲覧専用';
    $('room-pill').textContent  = 'room: ' + (ROOM_ID || '-');
    ['tool-pin','tool-line','tool-poly','tool-circle','tool-photo','btn-add-group','btn-bulk-style','btn-toggle-all']
      .forEach(id=>{ const el=$(id); if(el) el.disabled = !allowEdit(); });
    $('btn-make-room').disabled = false;
    $('btn-make-editor').disabled = !ROOM_ID;
  }
  updateRoleUI();
  window.addEventListener('hashchange', ()=>{ H=getHash(); ROOM_ID=H.get('r')||''; EDITOR_KEY=H.get('k')||''; updateRoleUI(); renderAll(); });

  /* ===== サイド折りたたみ ===== */
  $('side-fold').onclick=()=>{ document.body.classList.toggle('side-collapsed'); $('side-fold-icon').textContent = document.body.classList.contains('side-collapsed') ? '▶' : '▼'; };

  /* ===== Map ===== */
  const EMPTY_STYLE={version:8,sources:{},layers:[]};
  let map;
  try{
    map = new maplibregl.Map({ container:'map', style:EMPTY_STYLE, center:[135.79,34.51], zoom:8.2, attributionControl:false, preserveDrawingBuffer:true });
  }catch(e){ showErr('Map初期化エラー: '+e.message); return; }
  window.appMap = map;
  map.dragRotate.enable(); map.touchPitch.enable();
  map.on('mousedown',()=>{ map.getCanvas().style.cursor='grabbing'; });
  map.on('mouseup',()=>{ map.getCanvas().style.cursor='grab'; });

  let mapLoaded = false;
  function addBasemap(){
    if(!map.getSource('gsi-relief')) map.addSource('gsi-relief',{type:'raster',tiles:['https://cyberjapandata.gsi.go.jp/xyz/hillshademap/{z}/{x}/{y}.png'],tileSize:256,attribution:'地理院タイル（陰影起伏図）'});
    if(!map.getLayer('bm-relief')) map.addLayer({id:'bm-relief',type:'raster',source:'gsi-relief',paint:{'raster-opacity':1.0}});
    if(!map.getSource('osm')) map.addSource('osm',{type:'raster',tiles:['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],tileSize:256,attribution:'© OpenStreetMap contributors'});
    if(!map.getSource('gsi-std')) map.addSource('gsi-std',{type:'raster',tiles:['https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png'],tileSize:256,attribution:'地理院 標準地図'});
    if(!map.getSource('gsi-photo')) map.addSource('gsi-photo',{type:'raster',tiles:['https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/{z}/{x}/{y}.jpg'],tileSize:256,attribution:'地理院 最新写真'});
    if(!map.getLayer('bm-osm')) map.addLayer({id:'bm-osm',type:'raster',source:'osm',paint:{'raster-opacity':0.85}});
    if(!map.getLayer('bm-gsi-std')) map.addLayer({id:'bm-gsi-std',type:'raster',source:'gsi-std',paint:{'raster-opacity':0.85}});
    if(!map.getLayer('bm-gsi-photo')) map.addLayer({id:'bm-gsi-photo',type:'raster',source:'gsi-photo',paint:{'raster-opacity':0.85}});
  }
  function showBM(id){ ['bm-osm','bm-gsi-std','bm-gsi-photo'].forEach(l=> map.getLayer(l)&&map.setLayoutProperty(l,'visibility', l===id?'visible':'none')); }
  $('bm-osm').onclick=()=>showBM('bm-osm'); $('bm-gsi-std').onclick=()=>showBM('bm-gsi-std'); $('bm-gsi-photo').onclick=()=>showBM('bm-gsi-photo');

  map.on('load', ()=>{
    mapLoaded = true; addBasemap(); showBM('bm-osm');
    map.addControl(new maplibregl.AttributionControl({ customAttribution:'© OpenStreetMap contributors | <a target="_blank" href="https://maps.gsi.go.jp/development/ichiran.html">地理院タイル</a>'}), 'bottom-right');
    if(navigator.geolocation){
      navigator.geolocation.getCurrentPosition(p=>map.jumpTo({center:[p.coords.longitude,p.coords.latitude],zoom:14}), _=>map.jumpTo({center:[135.79,34.51],zoom:8.2}), {enableHighAccuracy:true,timeout:7000});
    }else map.jumpTo({center:[135.79,34.51],zoom:8.2});
    ensureHazardSources();
    renderAll();
    initDriveFGB();                 // ← Drive/FGB 読み込み
  });

  map.addControl(new maplibregl.NavigationControl({showCompass:true,visualizePitch:true,showZoom:true}),'top-right');
  map.addControl(new maplibregl.ScaleControl({maxWidth:150,unit:'metric'}),'top-right');

  /* ===== 統合パネルの開閉 ===== */
  $('panel-h').addEventListener('click',()=>{
    const b=$('panel-b'); const f=$('panel-fold');
    const v=(b.style.display!=='none');
    b.style.display=v?'none':'block';
    f.textContent=v?'▲':'▼';
  });

  /* ===== 現在地 ===== */
  class LocateControl {
    onAdd(map){
      this._map=map; this._container=document.createElement('div');
      this._container.className='maplibregl-ctrl maplibregl-ctrl-group';
      const btn=document.createElement('button'); btn.type='button'; btn.title='現在地'; btn.innerHTML='📍'; btn.onclick=()=>this.locate();
      this._container.appendChild(btn); return this._container;
    }
    onRemove(){ this._container.remove(); this._map=null; if(this._marker) this._marker.remove(); if(this._map && this._map.getSource('loc-acc')){ this._map.removeLayer('loc-acc-fill'); this._map.removeSource('loc-acc'); } }
    locate(){
      if(!navigator.geolocation) return alert('位置情報が利用できません');
      navigator.geolocation.getCurrentPosition(p=>{
        const ll=[p.coords.longitude,p.coords.latitude]; const acc=p.coords.accuracy||40;
        this._map.flyTo({center:ll,zoom:16});
        const wrap=document.createElement('div'); wrap.className='loc-wrap';
        wrap.innerHTML='<div class="loc-pulse"></div><div class="loc-dot"></div>';
        if(this._marker) this._marker.remove();
        this._marker=new maplibregl.Marker({element:wrap}).setLngLat(ll).addTo(this._map);
        const circle=turf.circle(ll, acc, {steps:64, units:'meters'});
        if(!this._map.getSource('loc-acc')){
          this._map.addSource('loc-acc',{type:'geojson',data:circle});
          this._map.addLayer({id:'loc-acc-fill',type:'fill',source:'loc-acc',paint:{'fill-color':'#60a5fa','fill-opacity':0.15}});
        }else{ this._map.getSource('loc-acc').setData(circle); }
      }, err=>alert('現在地取得に失敗：'+err.message), {enableHighAccuracy:true,timeout:7000});
    }
  }
  map.addControl(new LocateControl(),'top-right');

  /* ===== ハザード ===== */
  function ensureHazardSources(){
    if(!map.getSource('flood')){
      map.addSource('flood',{type:'raster',tiles:['https://disaportaldata.gsi.go.jp/raster/01_flood_l2_shinsuishin_data/{z}/{x}/{y}.png'],tileSize:256});
      map.addLayer({id:'flood',type:'raster',source:'flood',paint:{'raster-opacity':0.6},layout:{visibility:'none'}});
    }
    ['dosha0','dosha1','dosha2'].forEach((id,i)=>{
      if(!map.getSource(id)){
        const p=['05_dosekiryukeikaikuiki','05_kyukeishakeikaikuiki','05_jisuberikeikaikuiki'][i];
        map.addSource(id,{type:'raster',tiles:[`https://disaportaldata.gsi.go.jp/raster/${p}/{z}/{x}/{y}.png`],tileSize:256});
        map.addLayer({id, type:'raster', source:id, paint:{'raster-opacity':0.6}, layout:{visibility:'none'}});
      }
    });
  }
  $('chk-flood').addEventListener('change',e=>{ ensureHazardSources(); map.setLayoutProperty('flood','visibility', e.target.checked?'visible':'none'); });
  $('chk-dosha').addEventListener('change',e=>{ ['dosha0','dosha1','dosha2'].forEach(id=> map.setLayoutProperty(id,'visibility', e.target.checked?'visible':'none')); });
  $('hazard-opacity').addEventListener('input',e=>{ const o=+e.target.value; $('hazard-ov').textContent=o.toFixed(2); if(map.getLayer('flood')) map.setPaintProperty('flood','raster-opacity',o); ['dosha0','dosha1','dosha2'].forEach(id=> map.getLayer(id)&&map.setPaintProperty(id,'raster-opacity',o)); });

  /* ===== 共同編集・作図（必要機能） ===== */
  const hasY=!!(window.Y&&window.ywebrtc);
  const ydoc=hasY?new Y.Doc():null;
  const provider=hasY&&ROOM_ID?new ywebrtc.WebrtcProvider(ROOM_ID, ydoc):null;
  const yFeatures=hasY?ydoc.getArray('features'):null;
  const yGroups=hasY?ydoc.getArray('groupList'):null;

  const localFeatures=[];
  const localGroups=[{id:'__ungroup',name:'未分類',order:0,visible:true}];

  const featsArr = ()=> hasY?yFeatures.toArray():localFeatures;
  const setFeats = (arr)=>{ if(hasY){ yFeatures.delete(0,yFeatures.length); arr.forEach(f=>yFeatures.push([f])); } else { localFeatures.splice(0,localFeatures.length,...arr); } };
  const groupsArr= ()=> hasY?yGroups.toArray():localGroups;
  const setGroups=(arr)=>{ if(hasY){ yGroups.delete(0,yGroups.length); arr.forEach(g=>yGroups.push([g])); } else { localGroups.splice(0,localGroups.length,...arr); } };
  if(hasY && yGroups && yGroups.length===0) yGroups.push([{id:'__ungroup',name:'未分類',order:0,visible:true}]);

  const nowId=()=> 'id_'+Date.now().toString(36)+Math.random().toString(36).slice(2,7);

  const labelMarkers=new Map(), pinMarkers=new Map(), photoMarkers=new Map(), photosFull=new Map();
  function clearMarkers(){ labelMarkers.forEach(m=>m.remove()); labelMarkers.clear(); pinMarkers.forEach(m=>m.remove()); pinMarkers.clear(); photoMarkers.forEach(m=>m.remove()); photoMarkers.clear(); }

  function ensureGeomLayers(){
    if(!map.getSource('geom-src')) map.addSource('geom-src',{type:'geojson',data:{type:'FeatureCollection',features:[]}}); 
    if(!map.getLayer('geom-line')) map.addLayer({id:'geom-line',type:'line',source:'geom-src',filter:['==',['geometry-type'],'LineString'],paint:{'line-color':['coalesce',['get','styleColor'],'#2563eb'],'line-width':['coalesce',['get','styleWidth'],3]}});
    if(!map.getLayer('geom-fill')) map.addLayer({id:'geom-fill',type:'fill',source:'geom-src',filter:['==',['geometry-type'],'Polygon'],paint:{'fill-color':['coalesce',['get','styleColor'],'#22c55e'],'fill-opacity':0.2}});
    if(!map.getLayer('geom-outline')) map.addLayer({id:'geom-outline',type:'line',source:'geom-src',filter:['==',['geometry-type'],'Polygon'],paint:{'line-color':['coalesce',['get','styleColor'],'#15803d'],'line-width':['coalesce',['get','styleWidth'],2]}});
  }

  function addLabelMarker(id, lngLat, text){ if(!text) return; const el=document.createElement('div'); el.className='mlabel'; el.textContent=String(text); labelMarkers.set(id,new maplibregl.Marker({element:el,anchor:'top'}).setLngLat(lngLat).addTo(map)); }
  function labelCoordFor(f){ try{ if(f.geometry.type==='Point') return f.geometry.coordinates; if(f.geometry.type==='LineString') return turf.center(f).geometry.coordinates; return turf.centerOfMass(f).geometry.coordinates; }catch(_){ return null; } }
  function addPinMarker(f){ const color=f.properties?.styleColor||'#d00'; const size=Number(f.properties?.styleSize ?? 50); const el=document.createElement('div'); el.innerHTML=`<svg class="pin" width="${size}" height="${size}" viewBox="0 0 24 24" fill="${color}" stroke="#fff" stroke-width="1.5"><path d="M12 22s-6-5.33-6-10a6 6 0 1 1 12 0c0 4.67-6 10-6 10z"></path><circle cx="12" cy="10" r="2.8" fill="#fff"/></svg>`; pinMarkers.set(f.id,new maplibregl.Marker({element:el,anchor:'bottom'}).setLngLat(f.geometry.coordinates).addTo(map)); }
  function addPhotoMarker(f){ const el=document.createElement('div'); el.style.display='flex'; el.style.flexDirection='column'; el.style.alignItems='center'; const img=document.createElement('img'); img.src=f.properties.thumb; img.className='photo-thumb'; img.alt=f.properties.label||'photo'; el.appendChild(img); if(f.properties?.label){ const cap=document.createElement('div'); cap.textContent=f.properties.label; cap.style.fontSize='.8rem'; cap.style.marginTop='.2rem'; el.appendChild(cap); } img.onclick=()=>{ const full=photosFull.get(f.id)||f.properties.thumb; $('modal-img').src=full; $('modal').style.display='flex'; }; photoMarkers.set(f.id,new maplibregl.Marker({element:el,anchor:'bottom'}).setLngLat(f.geometry.coordinates).addTo(map)); }

  function renderAll(){
    ensureGeomLayers();
    const feats=featsArr(); clearMarkers();
    const geo=[];
    feats.forEach(f=>{
      if(f.properties?.visible===false) return;
      if(f.properties?.kind==='pin') addPinMarker(f);
      else if(f.properties?.kind==='photo') addPhotoMarker(f);
      else geo.push(f);
      if(f.properties?.label){ const p=labelCoordFor(f); if(p) addLabelMarker('lbl_'+f.id,p,f.properties.label); }
    });
    map.getSource('geom-src').setData({type:'FeatureCollection',features:geo});
    rebuildSidebar();
  }

  function rebuildSidebar(){
    const feats=featsArr();
    const gl=groupsArr();
    const list=$('list'); list.innerHTML='';
    const by=new Map(gl.map(g=>[g.id,[]]));
    feats.forEach(f=>{ const gid=f.properties?.group||'__ungroup'; if(!by.has(gid)) by.set(gid,[]); by.get(gid).push(f); });

    gl.sort((a,b)=>(a.order||0)-(b.order||0)).forEach(g=>{
      const wrap=document.createElement('div'); wrap.className='group'; wrap.dataset.gid=g.id;

      // head
      const head=document.createElement('div'); head.className='ghead';
      const title=document.createElement('span'); title.textContent=g.name||'グループ';
      const eye=document.createElement('span'); eye.textContent=g.visible===false?'🙈':'👁';
      eye.onclick=()=>{ 
        const next=!(g.visible===false); 
        g.visible=!next; 
        setGroups(gl);
        const feats2=structuredClone(featsArr()).map(f=>{ 
          if((f.properties?.group||'__ungroup')===g.id){ 
            f.properties={...(f.properties||{}), visible:!next}; 
          } 
          return f; 
        }); 
        setFeats(feats2); 
        renderAll();
      };

      head.appendChild(title); head.appendChild(eye);
      wrap.appendChild(head);

      // items
      const items=document.createElement('div'); items.className='gitems';
      (by.get(g.id)||[]).forEach(f=>{
        const it=document.createElement('div'); it.className='item'; it.dataset.fid=f.id;

        const eye=document.createElement('span'); eye.className='eye'; eye.textContent=f.properties?.visible===false?'🙈':'👁';
        eye.onclick=(ev)=>{ ev.stopPropagation(); const arr=structuredClone(featsArr()); const i=arr.findIndex(x=>x.id===f.id); arr[i].properties.visible=!arr[i].properties.visible; setFeats(arr); renderAll(); };

        const nm=document.createElement('span'); nm.className='name'; nm.textContent=f.properties?.label||f.properties?.kind||'obj';
        nm.onclick=()=> zoomToFeature(f);

        const del=document.createElement('span'); del.className='del'; del.textContent='🗑';
        del.onclick=(ev)=>{ ev.stopPropagation(); if(confirm('削除しますか？')){ const arr=structuredClone(featsArr()).filter(x=>x.id!==f.id); setFeats(arr); renderAll(); } };

        it.appendChild(eye); it.appendChild(nm); it.appendChild(del);
        items.appendChild(it);
      });

      wrap.appendChild(items);
      list.appendChild(wrap);
    });
  }

  function zoomToFeature(f){
    try{
      if(f.geometry.type==='Point'){
        map.flyTo({center:f.geometry.coordinates, zoom:17});
      }else{
        const b=turf.bbox(f);
        map.fitBounds([[b[0],b[1]],[b[2],b[3]]],{padding:60, maxZoom:18});
      }
    }catch(e){ console.warn('zoom failed', e); }
  }

  // 作図ツール
  let tool='select', pinHandler=null, circleState=null, moveHandler=null, clickHandler=null;
  function setTool(t){
    tool=t;
    ['tool-select','tool-pin','tool-line','tool-poly','tool-circle','tool-photo'].forEach(id=>$(''+id).classList.remove('active'));
    $('tool-'+t).classList.add('active');
    if(pinHandler){ map.off('click', pinHandler); pinHandler=null; }
    if(moveHandler){ map.off('mousemove', moveHandler); moveHandler=null; }
    if(clickHandler){ map.off('click', clickHandler); clickHandler=null; }
    removeCirclePreview();

    if(!DrawCtor && (t==='line'||t==='poly')){ alert('描画ライブラリが読み込まれていません'); return; }

    if(t==='select'){ DrawCtor && map.fire('draw.modechange'); return; }
    if(t==='line'){   DrawCtor && new MapboxDraw().changeMode('draw_line_string'); return; }
    if(t==='poly'){   DrawCtor && new MapboxDraw().changeMode('draw_polygon'); return; }
    if(t==='pin'){
      pinHandler=(e)=>{
        const [lon,lat]=e.lngLat.toArray();
        const label=prompt('ラベル（任意）')||'';
        addFeature({type:'Feature',id:nowId(),geometry:{type:'Point',coordinates:[lon,lat]},
          properties:{kind:'pin',label,visible:true,lon,lat,styleColor:'#d00',styleSize:50}});
      };
      map.on('click', pinHandler);
      return;
    }
    if(t==='circle'){
      circleState={center:null};
      clickHandler=(e)=>{
        const pt=e.lngLat.toArray();
        if(!circleState.center){
          circleState.center=pt; addCirclePreview(pt,1);
        }else{
          const r_m=turf.distance(circleState.center, pt, {units:'kilometers'})*1000;
          const poly=turf.circle(circleState.center, r_m, {steps:64,units:'meters'});
          const label=prompt('ラベル（任意）')||'';
          addFeature({type:'Feature',id:nowId(),geometry:poly.geometry,
            properties:{kind:'circle',label,visible:true,styleColor:'#22c55e',styleWidth:2,radius_m:Math.round(r_m)}});
          removeCirclePreview(); circleState=null; setTool('select');
        }
      };
      moveHandler=(e)=>{
        if(!circleState||!circleState.center) return;
        const r_m=turf.distance(circleState.center, e.lngLat.toArray(), {units:'kilometers'})*1000;
        updateCirclePreview(circleState.center, r_m);
      };
      map.on('click', clickHandler); map.on('mousemove', moveHandler);
      return;
    }
    if(t==='photo'){ $('photo-input').click(); return; }
  }
  ['select','pin','line','poly','circle','photo'].forEach(k=>{$('tool-'+k).onclick=()=>setTool(k);});
  setTool('select');

  function addFeature(f){ const arr=featsArr(); arr.push(f); setFeats(arr); renderAll(); }

  // 円プレビュー
  function addCirclePreview(center,r_m){
    const poly=turf.circle(center, r_m, {steps:64,units:'meters'});
    if(!map.getSource('circle-prev')) map.addSource('circle-prev',{type:'geojson',data:poly}); else map.getSource('circle-prev').setData(poly);
    if(!map.getLayer('circle-prev-line')){
      map.addLayer({id:'circle-prev-line',type:'line',source:'circle-prev',
        paint:{'line-color':'#0f172a','line-width':3,'line-dasharray':[3,2]}});
    }
    if(!map.getLayer('circle-prev-outline')){
      map.addLayer({id:'circle-prev-outline',type:'line',source:'circle-prev',
        paint:{'line-color':'#ffffff','line-width':5,'line-opacity':0.35}});
    }
  }
  function updateCirclePreview(center,r_m){ const poly=turf.circle(center, r_m, {steps:64,units:'meters'}); if(map.getSource('circle-prev')) map.getSource('circle-prev').setData(poly); }
  function removeCirclePreview(){ ['circle-prev-outline','circle-prev-line'].forEach(id=>{ if(map.getLayer(id)) map.removeLayer(id); }); if(map.getSource('circle-prev')) map.removeSource('circle-prev'); }

  // 写真（EXIF）
  const pendingPhotos=[];
  $('photo-input').addEventListener('change', async ev=>{
    const files=Array.from(ev.target.files||[]); if(!files.length) return;
    for(const file of files){
      try{
        const meta=await exifr.parse(file).catch(()=>null);
        const url=URL.createObjectURL(file);
        const thumb=await createThumb(url,256);
        if(meta && meta.longitude!=null && meta.latitude!=null){
          const label=prompt('写真のラベル（任意）')||'';
          addFeature({type:'Feature',id:nowId(),geometry:{type:'Point',coordinates:[meta.longitude,meta.latitude]},properties:{kind:'photo',label,visible:true,thumb,url}});
        }else{
          pendingPhotos.push({url,thumb});
          alert('写真の位置を地図上で1回クリックして指定してください。');
          const placeOnce=(e)=>{ const coords=e.lngLat.toArray(); const ph=pendingPhotos.shift(); const label=prompt('写真のラベル（任意）')||''; addFeature({type:'Feature',id:nowId(),geometry:{type:'Point',coordinates:coords},properties:{kind:'photo',label,visible:true,thumb:ph.thumb,url:ph.url}}); map.off('click',placeOnce); };
          map.on('click', placeOnce);
        }
      }catch{ showErr('写真の読み込みに失敗しました'); }
    }
    ev.target.value='';
  });
  function createThumb(src,maxW){ return new Promise(res=>{ const img=new Image(); img.crossOrigin='anonymous'; img.onload=()=>{ const s=Math.min(1,maxW/img.width); const w=img.width*s, h=img.height*s; const c=document.createElement('canvas'); c.width=w; c.height=h; c.getContext('2d').drawImage(img,0,0,w,h); res(c.toDataURL('image/jpeg',0.75)); }; img.src=src; }); }

  // エクスポート
  function pad2(n){return String(n).padStart(2,'0');}
  $('btn-export').onclick=()=>{
    const zip=new JSZip();
    const feats=featsArr();
    const points=feats.filter(f=>f.properties.kind==='pin'||f.properties.kind==='photo');
    const lines =feats.filter(f=>f.properties.kind==='line');
    const polys =feats.filter(f=>f.properties.kind==='polygon'||f.properties.kind==='circle');
    const t=new Date(); const stamp=`${t.getFullYear()}${pad2(t.getMonth()+1)}${pad2(t.getDate())}_${pad2(t.getHours())}${pad2(t.getMinutes())}${pad2(t.getSeconds())}`;
    zip.file(`points_${stamp}.geojson`,JSON.stringify({type:'FeatureCollection',features:points},null,2));
    zip.file(`lines_${stamp}.geojson`, JSON.stringify({type:'FeatureCollection',features:lines},null,2));
    zip.file(`polygons_${stamp}.geojson`,JSON.stringify({type:'FeatureCollection',features:polys},null,2));
    zip.generateAsync({type:'blob'}).then(b=>{
      const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download=`export_${stamp}.zip`; a.click();
    });
  };

  // スクショ
  $('btn-screenshot').onclick=async()=>{
    try{
      const canvas=await html2canvas(document.body,{backgroundColor:'#fff',scale:2,useCORS:true});
      const a=document.createElement('a');
      a.href=canvas.toDataURL('image/png');
      a.download='screenshot_'+(new Date().toISOString().replace(/[:T\-]/g,'').slice(0,14))+'.png';
      a.click();
    }catch(e){ console.error(e); alert('スクショに失敗しました'); }
  };

  /* ===== Drive / FGB 読み込み ===== */
  async function initDriveFGB(){
    const FILE_ID_EMERGENCY = "1Shon9KvxIHHA3Si4QF99sG7i0BR3VBh0"; // 指定緊急避難場所
    const FILE_ID_SHELTER   = "10R9hFMPSliGgmMlEdekv96d8yTPhTpQH"; // 指定避難所

    // 列名（両表記を許容）
    const MUNI_COL_CANDIDATES = ["都道府県名及び市町村名","都道府県及び市町村名"];

    // ラベル候補
    const LABEL_CANDIDATES = ["施設・場所名","住所","共通ID","NO"];

    // 直ダウンロード（APIキー不要）
    const driveUrl = (id)=>`https://drive.usercontent.google.com/download?id=${id}&export=download&cb=${Date.now()}`;

    // ESMロード
    const fgb = await import("https://cdn.jsdelivr.net/npm/flatgeobuf@3.27.4/dist/flatgeobuf-geojson.min.js");

    // 先に疎通チェック（403/404を拾う）
    async function probe(url){
      try{
        const r = await fetch(url, {method:'GET', headers:{'Range':'bytes=0-0'}});
        if(!r.ok) throw new Error(r.status+' '+r.statusText);
        return true;
      }catch(e){
        showErr('Driveファイルにアクセスできません：' + e.message + '（共有設定を「リンクを知っている全員が閲覧可」にしてください）');
        return false;
      }
    }

    // 読み込み
    async function readFGB(fileId){
      const url = driveUrl(fileId);
      const ok = await probe(url);
      if(!ok) throw new Error('Driveアクセス失敗');
      const feats=[]; for await (const f of fgb.deserialize(url)) feats.push(f);
      if(!feats.length) throw new Error('FGBの中身が空です');
      return feats;
    }

    // Mapソース/レイヤ
    if(!map.getSource('emergency')) map.addSource('emergency',{type:'geojson',data:{type:'FeatureCollection',features:[]}});
    if(!map.getSource('shelter'))   map.addSource('shelter',  {type:'geojson',data:{type:'FeatureCollection',features:[]}});
    if(!map.getLayer('emg-circle')) map.addLayer({id:'emg-circle',type:'circle',source:'emergency',paint:{'circle-radius':5,'circle-color':'#e23b3b','circle-stroke-color':'#fff','circle-stroke-width':1}});
    if(!map.getLayer('shel-circle')) map.addLayer({id:'shel-circle',type:'circle',source:'shelter',paint:{'circle-radius':5,'circle-color':'#2a7be4','circle-stroke-color':'#fff','circle-stroke-width':1}});
    if(!map.getLayer('emg-label')) map.addLayer({id:'emg-label',type:'symbol',source:'emergency',layout:{'text-field':['get','__label__'],'text-size':12,'text-offset':[0,1.2],'text-anchor':'top'},paint:{'text-halo-width':1.2,'text-halo-color':'#fff'}});
    if(!map.getLayer('shel-label')) map.addLayer({id:'shel-label',type:'symbol',source:'shelter',layout:{'text-field':['get','__label__'],'text-size':12,'text-offset':[0,1.2],'text-anchor':'top'},paint:{'text-halo-width':1.2,'text-halo-color':'#fff'}});

    // ポップアップ
    const escapeHtml=(s)=>String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    function bindPop(layerId){
      map.on('click', layerId, (e)=>{
        const f=e.features[0]; const props=f.properties||{};
        const html=Object.keys(props).filter(k=>k!=="__label__").map(k=>`<div class="small"><strong>${escapeHtml(k)}</strong><br>${escapeHtml(String(props[k]))}</div>`).join("<hr style='border:none;border-top:1px solid #eee;margin:6px 0'>");
        new maplibregl.Popup({closeButton:true,offset:12}).setLngLat(e.lngLat).setHTML(html).addTo(map);
      });
    }
    bindPop('emg-circle'); bindPop('shel-circle');

    // 実データ読み込み
    let cacheEmergency=null, cacheShelter=null, PREFS=["北海道","青森県","岩手県","宮城県","秋田県","山形県","福島県","茨城県","栃木県","群馬県","埼玉県","千葉県","東京都","神奈川県","新潟県","富山県","石川県","福井県","山梨県","長野県","岐阜県","静岡県","愛知県","三重県","滋賀県","京都府","大阪府","兵庫県","奈良県","和歌山県","鳥取県","島根県","岡山県","広島県","山口県","徳島県","香川県","愛媛県","高知県","福岡県","佐賀県","長崎県","熊本県","大分県","宮崎県","鹿児島県","沖縄県"];
    const prefSelect=$('prefSelect'), muniSelect=$('muniSelect'), labelFieldSelect=$('labelFieldSelect'), chkEmergency=$('chkEmergency'), chkShelter=$('chkShelter'), chkLabel=$('chkLabel');
    const qBox=$('qMuni'), suggest=$('suggest');

    try{
      const [emgFeats, shelFeats] = await Promise.all([readFGB(FILE_ID_EMERGENCY), readFGB(FILE_ID_SHELTER)]);
      cacheEmergency = emgFeats; cacheShelter = shelFeats;

      // 列名（市区町村）自動検出
      const propKeys = new Set([...Object.keys(emgFeats[0]?.properties||{}), ...Object.keys(shelFeats[0]?.properties||{})]);
      const COL_MUNI = MUNI_COL_CANDIDATES.find(k=>propKeys.has(k));
      if(!COL_MUNI){
        showErr('「都道府県名及び市町村名」列が見つかりません。実データの列名をご確認ください。');
      }

      // ラベル候補
      const candidates = LABEL_CANDIDATES.filter(k=>propKeys.has(k));
      const labels = candidates.length ? candidates : Array.from(propKeys);
      labels.forEach(k=>{ const o=document.createElement('option'); o.value=k; o.textContent=k; labelFieldSelect.appendChild(o); });
      labelFieldSelect.value = labels[0];

      // 都道府県初期化
      PREFS.forEach(p=>{ const o=document.createElement('option'); o.value=p; o.textContent=p; prefSelect.appendChild(o); });
      document.querySelectorAll('input[name="areaMode"]').forEach(r=>{
        r.addEventListener('change', ()=>{
          const v = document.querySelector('input[name="areaMode"]:checked').value;
          $('prefRow').style.display = (v==='pref'||v==='muni') ? '' : 'none';
          $('muniRow').style.display = (v==='muni') ? '' : 'none';
        });
      });

      // 市区町村一覧
      const uniq=(a)=>[...new Set(a)];
      const names = uniq([...emgFeats, ...shelFeats].map(f=>String(f.properties?.[COL_MUNI]||"").trim()).filter(Boolean));
      function splitPrefCity(full){ const pref=PREFS.find(p=>full.startsWith(p))||""; return {pref, city: full.slice(pref.length).trim()||full}; }
      const allMunicipalLabels = names.map(n=>{ const {pref, city}=splitPrefCity(n); return pref ? `${pref} ${city||"(名称不明)"}` : n; })
                                      .sort((a,b)=>a.localeCompare(b,'ja'));

      // セレクト描画
      function renderMuniOptions(){
        const chosenPrefs = new Set(Array.from(prefSelect.selectedOptions).map(o=>o.value));
        muniSelect.innerHTML = "";
        const list = (chosenPrefs.size===0) ? allMunicipalLabels : allMunicipalLabels.filter(lbl=>chosenPrefs.has(lbl.split(" ")[0]));
        list.forEach(lbl=>{ const o=document.createElement('option'); o.value=lbl; o.textContent=lbl; muniSelect.appendChild(o); });
        updateSuggest(qBox.value);
      }
      prefSelect.addEventListener('change', renderMuniOptions);
      renderMuniOptions();

      // クイック検索
      function addSelectionByQuery(q){
        const tokens = String(q||'').split(/[、,]/).map(s=>s.trim()).filter(Boolean);
        if(!tokens.length) return;
        const currentPrefs = new Set(Array.from(prefSelect.selectedOptions).map(o=>o.value));
        tokens.forEach(t=>{ PREFS.forEach(p=>{ if(p.includes(t)) currentPrefs.add(p); }); });
        Array.from(prefSelect.options).forEach(o=> o.selected = currentPrefs.has(o.value));
        renderMuniOptions();
        const currentMunis = new Set(Array.from(muniSelect.selectedOptions).map(o=>o.value));
        Array.from(muniSelect.options).forEach(o=>{ if(tokens.some(t=>o.text.includes(t))) currentMunis.add(o.value); });
        Array.from(muniSelect.options).forEach(o=> o.selected = currentMunis.has(o.value));
        refresh();
      }
      qBox.addEventListener('keydown', (ev)=>{ if(ev.key==='Enter'){ addSelectionByQuery(qBox.value); qBox.select(); hideSuggest(); } });

      // オートコンプリート
      function updateSuggest(query){
        const q = String(query||'').trim();
        const chosenPrefs = new Set(Array.from(prefSelect.selectedOptions).map(o=>o.value));
        const src = (chosenPrefs.size===0) ? allMunicipalLabels : allMunicipalLabels.filter(lbl=>chosenPrefs.has(lbl.split(" ")[0]));
        if(!q){ hideSuggest(); return; }
        const hits = src.filter(lbl=>lbl.includes(q)).slice(0,10);
        if(hits.length===0){ hideSuggest(); return; }
        suggest.innerHTML = hits.map(h=>`<div class="suggest-item" data-v="${h}">${h}</div>`).join("");
        suggest.style.display='block';
        Array.from(suggest.children).forEach(div=>{
          div.addEventListener('click', ()=>{
            const val = div.getAttribute('data-v');
            const opt = Array.from(muniSelect.options).find(o=>o.value===val);
            if(opt){ opt.selected=true; refresh(); }
            qBox.value=''; hideSuggest();
          });
        });
      }
      function hideSuggest(){ suggest.style.display='none'; suggest.innerHTML=''; }
      qBox.addEventListener('input', ()=> updateSuggest(qBox.value));
      qBox.addEventListener('blur', ()=> setTimeout(hideSuggest, 150));

      // 可視・イベント
      function applyVisibility(){
        map.setLayoutProperty('emg-circle','visibility', $('chkEmergency').checked ? 'visible':'none');
        map.setLayoutProperty('shel-circle','visibility', $('chkShelter').checked ? 'visible':'none');
        const vis = $('chkLabel').checked ? 'visible':'none';
        map.setLayoutProperty('emg-label','visibility', vis);
        map.setLayoutProperty('shel-label','visibility', vis);
      }
      ['chkEmergency','chkShelter','chkLabel'].forEach(id=>$(id).addEventListener('change', applyVisibility));
      $('btnApply').addEventListener('click', refresh);

      function fitToData(){
        const fc1 = map.getSource('emergency')._data;
        const fc2 = map.getSource('shelter')._data;
        const all=[...fc1.features, ...fc2.features];
        if(!all.length) return;
        let minX=180,minY=90,maxX=-180,maxY=-90;
        all.forEach(f=>{ if(f.geometry.type!=='Point') return; const [x,y]=f.geometry.coordinates; if(x<minX)minX=x; if(y<minY)minY=y; if(x>maxX)maxX=x; if(y>maxY)maxY=y; });
        if(minX<maxX && minY<maxY) map.fitBounds([[minX,minY],[maxX,maxY]],{padding:40,maxZoom:13});
      }

      function refresh(){
        const mode = document.querySelector('input[name="areaMode"]:checked').value;
        const prefs = new Set(Array.from(prefSelect.selectedOptions).map(o=>o.value));
        const munis = new Set(Array.from(muniSelect.selectedOptions).map(o=>o.value)); // "奈良県 奈良市"
        const labelField = labelFieldSelect.value;

        const filterByArea = (fullName)=>{
          if (!fullName) return mode==='all';
          const pref = PREFS.find(p=>fullName.startsWith(p)) || "";
          const city = fullName.slice(pref.length).trim();
          if (mode==='all') return true;
          if (mode==='pref') return prefs.size===0 ? true : prefs.has(pref);
          if (mode==='muni'){
            if (munis.size===0 && prefs.size===0) return true;
            if (munis.size>0) return munis.has(`${pref} ${city}`);
            return prefs.has(pref);
          }
          return true;
        };

        const decorate = (f)=>{
          const p=f.properties||{};
          const label = (p[labelField] ?? p["施設・場所名"] ?? p["住所"] ?? p["共通ID"] ?? "");
          return {...f, properties:{...p, __label__: String(label)}};
        };

        const emgFiltered = (cacheEmergency||[]).filter(f=>filterByArea(String(f.properties?.[COL_MUNI]||""))).map(decorate);
        const shlFiltered = (cacheShelter  ||[]).filter(f=>filterByArea(String(f.properties?.[COL_MUNI]||""))).map(decorate);

        map.getSource('emergency').setData({type:'FeatureCollection', features:emgFiltered});
        map.getSource('shelter').setData({type:'FeatureCollection', features:shlFiltered});

        applyVisibility(); fitToData();
      }

      // 初回描画
      refresh();

    }catch(e){
      showErr('Driveデータの読み込みに失敗：' + e.message);
    }
  }
});
</script>
</body>
</html>
