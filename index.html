<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>PHN Field Collab（OSM/GSI・ハザード・FGB・描画・共同編集・GPS）</title>

  <!-- MapLibre + Draw CSS -->
  <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css"/>
  <link rel="stylesheet" href="https://unpkg.com/@mapbox/mapbox-gl-draw@1.5.0/dist/mapbox-gl-draw.css"/>

  <style>
    html,body,#map{height:100%;width:100%;margin:0}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP","Hiragino Kaku Gothic ProN",Meiryo,sans-serif;color:#111827}

    /* トップバー */
    .topbar{position:absolute;left:12px;right:12px;top:8px;z-index:30;display:flex;gap:8px;flex-wrap:wrap;pointer-events:none}
    .chip{pointer-events:auto;padding:6px 10px;border-radius:10px;border:1px solid #e5e7eb;background:rgba(255,255,255,.9);backdrop-filter:blur(6px);font-size:12px;font-weight:700}
    .chip.btn{cursor:pointer;background:#0ea5e9;color:#fff}
    .chip.btn.secondary{background:#eef2ff;color:#111827}

    /* 左パネル（半透明） */
    .panel{position:absolute;left:12px;top:56px;width:340px;max-height:calc(100% - 68px);padding:12px;border-radius:12px;background:rgba(255,255,255,.86);backdrop-filter:blur(6px);box-shadow:0 8px 28px rgba(0,0,0,.12);overflow:auto;z-index:20}
    .panel h3{margin:0 0 8px;font-size:16px}
    .panel .group{margin:10px 0}
    .panel .row{display:flex;gap:8px}
    .panel .row>*{flex:1 1 0}
    .panel label{font-size:13px;display:inline-flex;align-items:center;gap:6px;margin:4px 8px 4px 0}
    .panel input[type="text"],.panel select{width:100%;padding:8px 10px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;font-size:13px}
    .panel .btn{display:inline-block;padding:8px 12px;border-radius:10px;border:1px solid #e5e7eb;background:#0ea5e9;color:#fff;font-weight:700;cursor:pointer;text-align:center}
    .panel .btn.secondary{background:#f3f4f6;color:#111827}
    .panel .btn:disabled{opacity:.55;cursor:not-allowed}

    /* 右パネル（半透明） */
    .rightpane{position:absolute;right:12px;top:56px;width:300px;max-height:calc(100% - 68px);padding:10px;border-radius:12px;background:rgba(255,255,255,.88);backdrop-filter:blur(6px);box-shadow:0 8px 28px rgba(0,0,0,.12);overflow:auto;z-index:20}
    .rightpane h4{margin:0 0 6px;font-size:14px}

    /* 左下：Supabase 操作 */
    .supabox{position:absolute;left:12px;bottom:12px;z-index:20;min-width:260px;padding:10px;border-radius:12px;background:rgba(255,255,255,.88);backdrop-filter:blur(6px);box-shadow:0 8px 28px rgba(0,0,0,.12)}
    .supabox h4{margin:0 0 6px;font-size:14px;font-weight:800}
    .supabox .row{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:6px}
    .supabox button{padding:6px 9px;border-radius:10px;border:1px solid #e5e7eb;background:#f8fafc;cursor:pointer;font-size:12px}
    .supabox button:hover{background:#eef2ff}
    .supabox .danger{background:#fee2e2;border-color:#fecaca}
    .supabox .wfull{flex:1 1 100%}

    /* サジェスト */
    .suggest{position:absolute;width:calc(100% - 24px);max-height:220px;overflow:auto;z-index:40;background:#fff;border:1px solid #e5e7eb;border-radius:10px;box-shadow:0 10px 28px rgba(0,0,0,.12);display:none}
    .suggest-item{padding:8px 10px;cursor:pointer}
    .suggest-item:hover{background:#f1f5f9}

    /* トースト/エラー */
    .toast{position:fixed;right:12px;bottom:12px;z-index:40;background:#ecfeff;border:1px solid #a5f3fc;border-radius:10px;padding:10px 12px;font-size:12px}
    .toast.bad{background:#fee2e2;border-color:#fecaca;color:#7f1d1d}
    .errbar{position:absolute;left:50%;transform:translateX(-50%);top:8px;z-index:50;background:#fee2e2;color:#7f1d1d;border:1px solid #fecaca;border-radius:10px;padding:8px 12px;display:none}

    /* ポップアップ整形 */
    .popup-list{margin:0;padding:0;list-style:none;font-size:12px;max-width:340px}
    .popup-list li{border-bottom:1px solid #f1f5f9;padding:6px 0}
    .popup-list li:last-child{border-bottom:none}
    .popup-list b{display:inline-block;min-width:120px;color:#374151}
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- トップバー -->
  <div class="topbar">
    <div class="chip">PHN Field Collab</div>
    <div class="chip">ベース:
      <select id="basemapSel" style="border:none;background:transparent;font-weight:700">
        <option value="osm">OSM</option>
        <option value="gsi_std">地理院 標準</option>
        <option value="gsi_pale">地理院 淡色</option>
        <option value="gsi_photo">地理院 写真</option>
      </select>
    </div>
    <div class="chip btn" id="btnNewRoom">部屋を作成</div>
    <div class="chip btn secondary" id="btnShareEdit">編集リンク</div>
    <div class="chip btn secondary" id="btnShareView">閲覧リンク</div>
    <div class="chip btn secondary" id="btnExport">描画をGeoJSON出力</div>
    <div style="flex:1"></div>
    <div class="chip" id="roomLabel">room: -</div>
  </div>

  <!-- 左パネル -->
  <div class="panel" id="panel">
    <h3>ハザード / 避難関連データ</h3>

    <div class="group">
      <label><input type="checkbox" id="chkFlood"> 洪水浸水想定区域（想定最大規模）</label><br>
      <label><input type="checkbox" id="chkSediment"> 土砂災害警戒区域（3レイヤ一括ON/OFF）</label>
      <div class="row" style="align-items:center;margin-top:6px">
        <div style="font-size:12px;min-width:64px">透明度</div>
        <input type="range" id="hazOpacity" min="0" max="1" step="0.05" value="0.60"/>
        <div id="hazOpacityVal" style="width:36px;text-align:right;font-size:12px">0.60</div>
      </div>
      <div style="font-size:12px;color:#6b7280;margin-top:6px">※ハザードのタイルURLを設定していない場合は無効</div>
      <div style="font-size:12px;color:#6b7280;margin-top:4px">凡例（例示画像を必要に応じ差替）</div>
      <img src="l2_flood_l.png" style="max-width:100%;opacity:.85" alt="凡例(洪水)">
      <img src="l2_sediment_l.png" style="max-width:100%;opacity:.85" alt="凡例(土砂)">
    </div>

    <div class="group">
      <div>避難施設（FGB）:</div>
      <label><input type="checkbox" id="chkEmergency" checked> 指定<strong>緊急避難場所</strong>（赤）</label>
      <label><input type="checkbox" id="chkShelter" checked> 指定<strong>避難所</strong>（青）</label><br>
      <label><input type="checkbox" id="chkLabel" checked> ラベルを表示</label>
    </div>

    <div class="group">
      <div>表示範囲：</div>
      <label><input type="radio" name="areaMode" value="all" checked> 日本全国</label>
      <label><input type="radio" name="areaMode" value="pref"> 都道府県</label>
      <label><input type="radio" name="areaMode" value="muni"> 市区町村</label>
    </div>

    <div class="group" id="prefRow" style="display:none">
      <div style="font-size:12px;margin-bottom:4px">都道府県（複数選択可 / Ctrl+クリック）</div>
      <select id="prefSelect" multiple size="7"></select>
    </div>

    <div class="group" id="muniRow" style="display:none;position:relative">
      <div style="font-size:12px;margin-bottom:4px">市区町村（複数選択可 / Ctrl+クリック）</div>
      <input id="qMuni" type="text" placeholder="例）奈良市、生駒市 / 東京都"/>
      <div class="suggest" id="suggest"></div>
      <div style="height:6px"></div>
      <select id="muniSelect" multiple size="10"></select>
    </div>

    <div class="group">
      <div style="font-size:12px;margin-bottom:4px">ラベルに使うカラム</div>
      <select id="labelFieldSelect"></select>
    </div>

    <div class="group">
      <div class="row">
        <button class="btn" id="btnApply">表示を更新</button>
        <button class="btn secondary" id="btnReset">リセット</button>
      </div>
      <div style="font-size:12px;color:#6b7280;margin-top:6px">※「表示を更新」で絞り込みを反映します</div>
    </div>
  </div>

  <!-- 右パネル -->
  <div class="rightpane">
    <h4>レイヤ一覧 / 操作</h4>
    <div style="font-size:12px;color:#6b7280">必要に応じて追加してください</div>
  </div>

  <!-- 左下：Supabase 操作 -->
  <div class="supabox">
    <h4>共同編集 / GPS</h4>
    <div class="row">
      <button class="wfull" onclick="window.__supaload()">図形を再読込</button>
      <button class="wfull" onclick="window.__supasave()">図形を保存</button>
    </div>
    <div class="row">
      <button onclick="window.__gpstart()">GPS開始</button>
      <button class="danger" onclick="window.__gpstop()">GPS停止</button>
      <button onclick="window.__gpshow()">軌跡表示</button>
    </div>
    <div class="row">
      <button class="wfull" onclick="(async()=>{const e=prompt('メールアドレス');if(!e)return;await __supa.auth.signInWithOtp({email:e});alert('届いたメールのリンクを開いたらこの画面に戻ってください');})();">メールでログイン</button>
      <button class="wfull" onclick="__supa.auth.signOut().then(()=>alert('サインアウトしました'))">サインアウト</button>
    </div>
  </div>

  <div id="err" class="errbar"></div>

  <!-- ライブラリ -->
  <script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>
  <script src="https://unpkg.com/@mapbox/mapbox-gl-draw@1.5.0/dist/mapbox-gl-draw.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/yjs@13.6.8/dist/yjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/y-webrtc@10.3.5/dist/y-webrtc.min.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js"></script>

  <script>
  /*************** ★★★ TODO 1：Supabase の Project URL / anon public key ***************/
  const SUPABASE_URL  = 'https://tdoxxwhkvdguyfrofnaw.supabase.co';   // ←置換
  const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRkb3h4d2hrdmRndXlmcm9mbmF3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0MTQ0NDQsImV4cCI6MjA3NDk5MDQ0NH0.h2ZnTGr0jml2V7SUvEaOSzjNXxKvCJuJryFEyEkrQQc;                // ←置換

  // Supabase クライアント（UMD で window.supabase が生える前提）
  try {
    if (!window.supabase) throw new Error('Supabase SDK (UMD) が読み込まれていません');
    window.__supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
  } catch (e) {
    console.error(e);
    // 共同編集/GPS系が使えないときでも地図は動かすためのダミー
    window.__supa = {
      from(){ return { select:async()=>({}), insert:async()=>({}), in:async()=>({}), eq:async()=>({}), order:async()=>({}), single:async()=>({}) }; },
      auth:{ signInWithOtp:async()=>({}), signOut:async()=>({}) }
    };
    // 失敗は画面にも出す
    setTimeout(()=>{ const b=document.createElement('div'); b.className='toast bad'; b.textContent='Supabase の初期化に失敗（共同編集/GPSは無効ですが地図は動きます）'; document.body.appendChild(b); setTimeout(()=>b.remove(), 5000); }, 1000);
  }
  // ▲▲▲ ここまで置換
  window.__room = new URLSearchParams(location.hash.slice(1)).get('r') || 'default';

  // ユーティリティ
  const $ = (id)=>document.getElementById(id);
  const toast=(m,bad=false)=>{const el=document.createElement('div');el.className='toast'+(bad?' bad':'');el.textContent=m;document.body.appendChild(el);setTimeout(()=>el.remove(),3000);}
  const showErr=(m)=>{const e=$('err');e.textContent=m;e.style.display='block';setTimeout(()=>e.style.display='none',10000);}

  // 都道府県
  const PREFS=["北海道","青森県","岩手県","宮城県","秋田県","山形県","福島県","茨城県","栃木県","群馬県","埼玉県","千葉県","東京都","神奈川県","新潟県","富山県","石川県","福井県","山梨県","長野県","岐阜県","静岡県","愛知県","三重県","滋賀県","京都府","大阪府","兵庫県","奈良県","和歌山県","鳥取県","島根県","岡山県","広島県","山口県","徳島県","香川県","愛媛県","高知県","福岡県","佐賀県","長崎県","熊本県","大分県","宮崎県","鹿児島県","沖縄県"];

  /*************** ベースマップ（OSM & 地理院タイル） ***************/
  const BASE_SOURCES = {
    osm: { type:'raster', tiles:["https://tile.openstreetmap.org/{z}/{x}/{y}.png"], tileSize:256, attribution:"© OpenStreetMap" },
    gsi_std:   { type:'raster', tiles:["https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png"], tileSize:256, attribution:"© GSI" },
    gsi_pale:  { type:'raster', tiles:["https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png"], tileSize:256, attribution:"© GSI" },
    gsi_photo: { type:'raster', tiles:["https://cyberjapandata.gsi.go.jp/xyz/ort/{z}/{x}/{y}.jpg"], tileSize:256, attribution:"© GSI" }
  };

  const map = new maplibregl.Map({
    container:'map',
    style:{ version:8, sources:{ base: BASE_SOURCES.osm }, layers:[{id:'base',type:'raster',source:'base'}] },
    center:[139.767,35.681], zoom:5.2
  });

  $('basemapSel').addEventListener('change', ()=>{
    const key=$('basemapSel').value;
    map.removeLayer('base'); map.removeSource('base');
    map.addSource('base', BASE_SOURCES[key]);
    map.addLayer({id:'base',type:'raster',source:'base'});
  });

  /*************** Draw（ポイント/ライン/ポリゴン + 円ツール） ***************/
  const draw = new MapboxDraw({
    displayControlsDefault:false,
    controls:{ point:true, line_string:true, polygon:true, trash:true }
  });
  map.addControl(draw,'top-right');

  // 円ツール：中心クリック → 半径(m)入力 → 円ポリゴン作成
  const circleBtn = document.createElement('div');
  circleBtn.className='mapbox-gl-draw_ctrl-draw-btn mapbox-gl-draw_circle'; // 既存の見た目に寄せる
  circleBtn.title='円を追加';
  circleBtn.onclick=()=>{
    toast('円の中心を地図上でクリックしてください');
    const once=(e)=>{
      const r=prompt('半径 (m) を入力', '200');
      if(!r) return;
      const poly=turf.circle([e.lngLat.lng,e.lngLat.lat], Number(r), {steps:64, units:'meters'});
      draw.add(poly);
      map.off('click',once);
    };
    map.once('click',once);
  };
  // DrawコントロールのDOMへ差し込む
  map.once('load',()=>{
    const ctrls=document.getElementsByClassName('mapbox-gl-draw_ctrl-top-right');
    if(ctrls[0]) ctrls[0].appendChild(circleBtn);
  });

  /*************** ハザード（洪水=1、土砂=3まとめ） ***************/
  // ★ 必要に応じてURLを設定（空なら自動無効）
  const FLOOD_TILES = "https://disaportaldata.gsi.go.jp/raster/01_flood_l2_shinsuishin_data/{z}/{x}/{y}.png"; // 例: 'https://{s}.example.com/flood/{z}/{x}/{y}.png'
  const SEDIMENT_TILES = [
    "https://disaportaldata.gsi.go.jp/raster/05_dosekiryukeikaikuiki/{z}/{x}/{y}.png", //"例: 'https://{s}.example.com/sediment/debrisflow/{z}/{x}/{y}.png'
    "https://disaportaldata.gsi.go.jp/raster/05_kyukeishakeikaikuiki/{z}/{x}/{y}.png", // 例: 'https://{s}.example.com/sediment/steepslope/{z}/{x}/{y}.png'
    "https://disaportaldata.gsi.go.jp/raster/05_jisuberikeikaikuiki/{z}/{x}/{y}.png"  // 例: 'https://{s}.example.com/sediment/landslide/{z}/{x}/{y}.png'
  ];
  const HAZ_FLOOD_SOURCE_ID="haz-flood", HAZ_FLOOD_LAYER_ID="haz-flood";
  const HAZ_SED_SOURCE_IDS=["haz-sed-0","haz-sed-1","haz-sed-2"];
  const HAZ_SED_LAYER_IDS =["haz-sed-0","haz-sed-1","haz-sed-2"];

  function ensureHazardLayers(){
    const opa=Number($('hazOpacity').value||0.6);
    if(FLOOD_TILES && !map.getSource(HAZ_FLOOD_SOURCE_ID)){
      map.addSource(HAZ_FLOOD_SOURCE_ID,{type:'raster',tiles:[FLOOD_TILES],tileSize:256});
    }
    if(FLOOD_TILES && !map.getLayer(HAZ_FLOOD_LAYER_ID)){
      map.addLayer({id:HAZ_FLOOD_LAYER_ID,type:'raster',source:HAZ_FLOOD_SOURCE_ID,paint:{'raster-opacity':opa}});
    }
    SEDIMENT_TILES.forEach((url,i)=>{
      if(!url) return;
      if(!map.getSource(HAZ_SED_SOURCE_IDS[i])){
        map.addSource(HAZ_SED_SOURCE_IDS[i],{type:'raster',tiles:[url],tileSize:256});
      }
      if(!map.getLayer(HAZ_SED_LAYER_IDS[i])){
        map.addLayer({id:HAZ_SED_LAYER_IDS[i],type:'raster',source:HAZ_SED_SOURCE_IDS[i],paint:{'raster-opacity':opa}});
      }
    });
  }
  function updateHazard(){
    const opa=Number($('hazOpacity').value||0.6);
    $('hazOpacityVal').textContent=opa.toFixed(2);
    if(map.getLayer(HAZ_FLOOD_LAYER_ID)){
      map.setPaintProperty(HAZ_FLOOD_LAYER_ID,'raster-opacity',opa);
      map.setLayoutProperty(HAZ_FLOOD_LAYER_ID,'visibility',$('chkFlood').checked?'visible':'none');
    }
    HAZ_SED_LAYER_IDS.forEach(lid=>{
      if(!map.getLayer(lid)) return;
      map.setPaintProperty(lid,'raster-opacity',opa);
      map.setLayoutProperty(lid,'visibility',$('chkSediment').checked?'visible':'none');
    });
  }
  $('chkFlood').addEventListener('change',()=>{ensureHazardLayers();updateHazard();});
  $('chkSediment').addEventListener('change',()=>{ensureHazardLayers();updateHazard();});
  $('hazOpacity').addEventListener('input',updateHazard);

  /*************** ★★★ TODO 2：FGB（公開URL）を貼る ***************/
  // Supabase Storage の Public URL をそのまま貼ってください（署名URLではありません）
  const FGB_URL_EMERGENCY='https://tdoxxwhkvdguyfrofnaw.supabase.co/storage/v1/object/public/data/Designated%20Emergency%20Evacuation%20Site.fgb'; // ←置換（先頭 e）
  const FGB_URL_SHELTER  ='https://tdoxxwhkvdguyfrofnaw.supabase.co/storage/v1/object/public/data/Designated%20Shelter%20for%20Evacuees.fgb';     // ←置換

  // FlatGeobuf ローダ（jsDelivr → unpkg → UMDフォールバック）
  async function loadFgbLib(){
    const urls=[
      "https://cdn.jsdelivr.net/npm/flatgeobuf@3.27.4/dist/flatgeobuf-geojson.min.js",
      "https://unpkg.com/flatgeobuf@3.27.4/dist/flatgeobuf-geojson.min.js"
    ];
    for(const u of urls){
      try{
        const m=await import(/* @vite-ignore */ u);
        if(m&&(m.deserialize||(m.default&&m.default.deserialize))){
          return m.deserialize||m.default.deserialize;
        }
      }catch(_){}
    }
    await new Promise((res,rej)=>{
      const s=document.createElement('script');
      s.src=urls[0]; s.onload=res; s.onerror=()=>{
        const s2=document.createElement('script');
        s2.src=urls[1]; s2.onload=res; s2.onerror=()=>rej(new Error('flatgeobufの読み込みに失敗（CDN到達不可）'));
        document.head.appendChild(s2);
      };
      document.head.appendChild(s);
    });
    if(window.flatgeobuf?.deserialize) return window.flatgeobuf.deserialize;
    throw new Error('flatgeobufの読み込みに失敗（deserialize未検出）');
  }
  async function readFGB_fromURL(url){
    const head=await fetch(url,{headers:{'Range':'bytes=0-0'},cache:'no-store'});
    if(!head.ok) throw new Error(`FGBヘッダ取得失敗 ${head.status} ${head.statusText}`);
    const ct=(head.headers.get('content-type')||'').toLowerCase();
    if(ct.includes('text/html')) throw new Error('FGB直リンクがHTMLを返しています（URL/公開設定/パスを確認）');
    const deserialize=await loadFgbLib();
    const feats=[]; for await(const f of deserialize(url)) feats.push(f);
    if(!feats.length) throw new Error('FGBの中身が空です');
    return feats;
  }

  // クリックで属性ポップアップ
  function bindClickPopup(layerId){
    map.on('click', layerId, (e)=>{
      const f=e.features?.[0]; if(!f) return;
      const props=f.properties||{};
      const html='<ul class="popup-list">'+Object.entries(props).filter(([k])=>k!=='__label__')
        .map(([k,v])=>`<li><b>${k}</b> ${String(v)}</li>`).join('')+'</ul>';
      new maplibregl.Popup({offset:12}).setLngLat(e.lngLat).setHTML(html).addTo(map);
    });
    map.on('mouseenter', layerId, ()=> map.getCanvas().style.cursor='pointer');
    map.on('mouseleave', layerId, ()=> map.getCanvas().style.cursor='');
  }

  const MUNI_COL_CANDIDATES=["都道府県名及び市町村名","都道府県及び市町村名"];
  const LABEL_CANDIDATES   =["施設・場所名","住所","共通ID","NO"];
  let cacheEmergency=null, cacheShelter=null, COL_MUNI=null;

  function applyVisibility(){
    map.setLayoutProperty('emg-circle','visibility', $('chkEmergency').checked?'visible':'none');
    map.setLayoutProperty('shel-circle','visibility', $('chkShelter').checked?'visible':'none');
    const vis=$('chkLabel').checked?'visible':'none';
    if(map.getLayer('emg-label')) map.setLayoutProperty('emg-label','visibility', vis);
    if(map.getLayer('shel-label')) map.setLayoutProperty('shel-label','visibility', vis);
  }
  function fitToData(){
    const fc1=map.getSource('emergency')._data;
    const fc2=map.getSource('shelter')._data;
    const all=[...fc1.features,...fc2.features]; if(!all.length) return;
    let minX=180,minY=90,maxX=-180,maxY=-90;
    all.forEach(f=>{ if(f.geometry.type!=='Point') return; const [x,y]=f.geometry.coordinates;
      if(x<minX)minX=x;if(y<minY)minY=y;if(x>maxX)maxX=x;if(y>maxY)maxY=y;});
    if(minX<maxX&&minY<maxY) map.fitBounds([[minX,minY],[maxX,maxY]],{padding:40,maxZoom:13});
  }
  function refresh(){
    if(!cacheEmergency||!cacheShelter) return;
    const mode=document.querySelector('input[name="areaMode"]:checked').value;
    const prefs=new Set(Array.from($('prefSelect').selectedOptions).map(o=>o.value));
    const munis=new Set(Array.from($('muniSelect').selectedOptions).map(o=>o.value));
    const labelField=$('labelFieldSelect').value;

    const filterByArea=(fullName)=>{
      if(!fullName) return mode==='all';
      const pref=PREFS.find(p=>fullName.startsWith(p))||"";
      const city=fullName.slice(pref.length).trim();
      if(mode==='all') return true;
      if(mode==='pref') return prefs.size===0?true:prefs.has(pref);
      if(mode==='muni'){
        if(munis.size===0&&prefs.size===0) return true;
        if(munis.size>0) return munis.has(`${pref} ${city}`);
        return prefs.has(pref);
      }
      return true;
    };
    const decorate=(f)=>{
      const p=f.properties||{};
      const label=(p[labelField]??p["施設・場所名"]??p["住所"]??p["共通ID"]??p["NO"]??"");
      return {...f,properties:{...p,__label__:String(label)}};
    };
    const emgFiltered=(cacheEmergency||[]).filter(f=>filterByArea(String(f.properties?.[COL_MUNI]||""))).map(decorate);
    const shlFiltered=(cacheShelter  ||[]).filter(f=>filterByArea(String(f.properties?.[COL_MUNI]||""))).map(decorate);

    map.getSource('emergency').setData({type:'FeatureCollection',features:emgFiltered});
    map.getSource('shelter').setData({type:'FeatureCollection',features:shlFiltered});
    applyVisibility(); fitToData(); toast('表示を更新しました');
  }

  function hideSuggest(){ $('suggest').style.display='none'; $('suggest').innerHTML=''; }
  function updateSuggest(query){
    const q=String(query||'').trim();
    const chosenPrefs=new Set(Array.from($('prefSelect').selectedOptions).map(o=>o.value));
    const src=(chosenPrefs.size===0)?window.__allMunicipalLabels:window.__allMunicipalLabels.filter(lbl=>chosenPrefs.has(lbl.split(" ")[0]));
    if(!q){hideSuggest();return;}
    const hits=src.filter(lbl=>lbl.includes(q)).slice(0,10);
    if(hits.length===0){hideSuggest();return;}
    $('suggest').innerHTML=hits.map(h=>`<div class="suggest-item" data-v="${h}">${h}</div>`).join("");
    $('suggest').style.display='block';
    Array.from($('suggest').children).forEach(div=>{
      div.addEventListener('click',()=>{
        const val=div.getAttribute('data-v');
        const opt=Array.from($('muniSelect').options).find(o=>o.value===val);
        if(opt){opt.selected=true;refresh();}
        $('qMuni').value=''; hideSuggest();
      });
    });
  }

  async function initFGB(){
    // ソース/レイヤ
    if(!map.getSource('emergency')) map.addSource('emergency',{type:'geojson',data:{type:'FeatureCollection',features:[]}});
    if(!map.getSource('shelter'))   map.addSource('shelter',  {type:'geojson',data:{type:'FeatureCollection',features:[]}});
    if(!map.getLayer('emg-circle')) map.addLayer({id:'emg-circle',type:'circle',source:'emergency',paint:{'circle-radius':5,'circle-color':'#e23b3b','circle-stroke-color':'#fff','circle-stroke-width':1}});
    if(!map.getLayer('shel-circle')) map.addLayer({id:'shel-circle',type:'circle',source:'shelter',paint:{'circle-radius':5,'circle-color':'#2a7be4','circle-stroke-color':'#fff','circle-stroke-width':1}});
    if(!map.getLayer('emg-label'))   map.addLayer({id:'emg-label',type:'symbol',source:'emergency',layout:{'text-field':['get','__label__'],'text-size':12,'text-offset':[0,1.2],'text-anchor':'top'},paint:{'text-halo-width':1.2,'text-halo-color':'#fff'}});
    if(!map.getLayer('shel-label'))  map.addLayer({id:'shel-label',type:'symbol',source:'shelter',  layout:{'text-field':['get','__label__'],'text-size':12,'text-offset':[0,1.2],'text-anchor':'top'},paint:{'text-halo-width':1.2,'text-halo-color':'#fff'}});
    bindClickPopup('emg-circle'); bindClickPopup('shel-circle');

    // UI
    document.querySelectorAll('input[name="areaMode"]').forEach(r=>{
      r.addEventListener('change',()=>{
        const v=document.querySelector('input[name="areaMode"]:checked').value;
        $('prefRow').style.display=(v==='pref'||v==='muni')?'':'none';
        $('muniRow').style.display=(v==='muni')?'':'none';
      });
    });
    $('btnReset').addEventListener('click',()=>{
      document.querySelector('input[name="areaMode"][value="all"]').checked=true;
      $('prefRow').style.display='none'; $('muniRow').style.display='none';
      Array.from($('prefSelect').options).forEach(o=>o.selected=false);
      Array.from($('muniSelect').options).forEach(o=>o.selected=false);
      $('qMuni').value=''; refresh();
    });
    ['chkEmergency','chkShelter','chkLabel'].forEach(id=>$(id).addEventListener('change',applyVisibility));
    $('btnApply').addEventListener('click',refresh);

    // 都道府県セレクト
    PREFS.forEach(p=>{const o=document.createElement('option');o.value=p;o.textContent=p;$('prefSelect').appendChild(o);});
    $('prefSelect').addEventListener('change',renderMuniOptions);

    // FGB 読み込み
    try{
      const [emgFeats,shelFeats]=await Promise.all([
        readFGB_fromURL(FGB_URL_EMERGENCY),
        readFGB_fromURL(FGB_URL_SHELTER)
      ]);
      cacheEmergency=emgFeats; cacheShelter=shelFeats;

      const propKeys=new Set([...Object.keys(emgFeats[0]?.properties||{}),...Object.keys(shelFeats[0]?.properties||{})]);
      COL_MUNI=MUNI_COL_CANDIDATES.find(k=>propKeys.has(k))||null;
      if(!COL_MUNI) showErr('「都道府県名及び市町村名」列が見つかりません（COL_MUNI未設定）');

      // ラベル候補
      $('labelFieldSelect').innerHTML='';
      const labels=LABEL_CANDIDATES.filter(k=>propKeys.has(k));
      (labels.length?labels:Array.from(propKeys)).forEach(k=>{
        const o=document.createElement('option');o.value=k;o.textContent=k;$('labelFieldSelect').appendChild(o);
      });
      if($('labelFieldSelect').options.length) $('labelFieldSelect').value=$('labelFieldSelect').options[0].value;

      // 市区町村候補
      const uniq=a=>[...new Set(a)];
      const names=uniq([...emgFeats,...shelFeats].map(f=>String(f.properties?.[COL_MUNI]||"").trim()).filter(Boolean));
      function splitPrefCity(full){const pref=PREFS.find(p=>full.startsWith(p))||"";return {pref,city:full.slice(pref.length).trim()||full};}
      window.__allMunicipalLabels=names.map(n=>{const {pref,city}=splitPrefCity(n);return pref?`${pref} ${city||"(名称不明)"}`:n;}).sort((a,b)=>a.localeCompare(b,'ja'));
      function renderMuniOptions(){
        const chosenPrefs=new Set(Array.from($('prefSelect').selectedOptions).map(o=>o.value));
        $('muniSelect').innerHTML="";
        const list=(chosenPrefs.size===0)?window.__allMunicipalLabels:window.__allMunicipalLabels.filter(lbl=>chosenPrefs.has(lbl.split(" ")[0]));
        list.forEach(lbl=>{const o=document.createElement('option');o.value=lbl;o.textContent=lbl;$('muniSelect').appendChild(o);});
        updateSuggest($('qMuni').value);
      }
      window.renderMuniOptions=renderMuniOptions;
      $('qMuni').addEventListener('input',()=>updateSuggest($('qMuni').value));
      $('qMuni').addEventListener('blur',()=>setTimeout(hideSuggest,150));
      $('qMuni').addEventListener('keydown',(ev)=>{if(ev.key==='Enter'){const val=$('qMuni').value;if(val){updateSuggest(val);}}});
      renderMuniOptions();

      // 初回描画
      refresh();
    }catch(e){
      showErr('FGBデータの読み込みに失敗：'+e.message);
    }
  }

  /*************** 部屋・共有・エクスポート ***************/
  $('roomLabel').textContent='room: '+__room;
  $('btnNewRoom').onclick=()=>{
    const r=prompt('新しいroom名（英数字推奨）','room-'+Math.random().toString(36).slice(2,8));
    if(!r) return; location.hash='#r='+encodeURIComponent(r); location.reload();
  };
  $('btnShareEdit').onclick=()=> prompt('編集リンク', location.origin+location.pathname+'#r='+encodeURIComponent(__room));
  $('btnShareView').onclick=()=> prompt('閲覧リンク', location.origin+location.pathname+'#r='+encodeURIComponent(__room));
  $('btnExport').onclick=()=>{
    const fc=draw.getAll();
    const blob=new Blob([JSON.stringify(fc)],{type:'application/json'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='features.geojson'; a.click();
  };

  /*************** Supabase：図形保存/読込 + GPS ***************/
  (function whenReady(){
    const ok=!!(window.map&&window.draw&&typeof draw.add==='function');
    if(!ok) return setTimeout(whenReady,200);
    window.__supaload=loadFeatures;
    window.__supasave=saveFeatures;
    window.__gpstart =startGpsLog;
    window.__gpstop  =stopGpsLog;
    window.__gpshow  =showTracks;
  })();

  async function loadFeatures(){
    try{
      const {data,error}=await __supa.from('features').select('id,geojson').eq('room',__room).order('id');
      if(error) throw error;
      const feats=(data||[]).map(r=>r.geojson);
      if(feats.length){draw.deleteAll();draw.add({type:'FeatureCollection',features:feats});}
      toast('図形を読み込みました（'+(feats.length||0)+'件）');
    }catch(e){toast('読込失敗: '+e.message,true);}
  }
  async function saveFeatures(){
    try{
      const fc=draw.getAll();
      if(!fc.features?.length){toast('保存する図形がありません',true);return;}
      const rows=fc.features.map(f=>({room:__room,kind:(f.properties?.kind)||f.geometry?.type?.toLowerCase()||'feature',geojson:f,props:f.properties||{}}));
      const {error}=await __supa.from('features').insert(rows);
      if(error) throw error;
      toast('図形を保存しました');
    }catch(e){toast('保存失敗: '+e.message,true);}
  }

  let watchId=null,currentTrackId=null;
  async function startGpsLog(name='フィールド調査'){
    if(!navigator.geolocation){toast('位置情報が使えません',true);return;}
    const {data:tk,error:e1}=await __supa.from('tracks').insert({room:__room,name}).select().single();
    if(e1){toast('トラック作成失敗: '+e1.message,true);return;}
    currentTrackId=tk.id;
    let last=null;
    watchId=navigator.geolocation.watchPosition(async pos=>{
      const {longitude:lon,latitude:lat,accuracy:acc,speed,heading}=pos.coords;
      const tiso=new Date(pos.timestamp).toISOString();
      if(last){
        const dx=Math.abs(lon-last.lon)*111320, dy=Math.abs(lat-last.lat)*110540;
        if(dx<10&&dy<10) return;
      }
      last={lon,lat};
      await __supa.from('track_points').insert({track_id:currentTrackId,t:tiso,lon,lat,acc,speed,heading});
    }, err=>toast('GPSエラー: '+err.message,true), {enableHighAccuracy:true,maximumAge:1000,timeout:10000});
    toast('GPSロガー開始');
  }
  function stopGpsLog(){ if(watchId){navigator.geolocation.clearWatch(watchId);watchId=null;} currentTrackId=null; toast('GPSロガー停止'); }
  async function showTracks(){
    const {data:tracks}=await __supa.from('tracks').select('id').eq('room',__room);
    if(!tracks?.length){toast('トラックがありません',true);return;}
    const ids=tracks.map(r=>r.id);
    const {data:pts}=await __supa.from('track_points').select('track_id,t,lon,lat').in('track_id',ids).order('t');
    const by=new Map(); (pts||[]).forEach(p=>{if(!by.has(p.track_id))by.set(p.track_id,[]);by.get(p.track_id).push([p.lon,p.lat]);});
    const fc={type:'FeatureCollection',features:[...by.entries()].map(([id,coords])=>({type:'Feature',properties:{id},geometry:{type:'LineString',coordinates:coords}}))};
    if(!map.getSource('tracks')) map.addSource('tracks',{type:'geojson',data:fc}); else map.getSource('tracks').setData(fc);
    if(!map.getLayer('tracks-line')) map.addLayer({id:'tracks-line',type:'line',source:'tracks',paint:{'line-color':'#ef4444','line-width':3}});
    toast('軌跡を表示しました');
  }

  /*************** 地図ロード：一括初期化 ***************/
  map.on('load',()=>{
    try{
      // ハザード
      ensureHazardLayers(); updateHazard();

      // FGB
      initFGB();

      // 共有表示
      $('roomLabel').textContent='room: '+__room;
    }catch(e){
      console.error(e); showErr('初期化エラー: '+e.message);
    }
  });
  </script>
</body>
</html>
