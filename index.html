<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PHN Field Collab + FGBãƒ“ãƒ¥ãƒ¼ã‚¢</title>

<!-- MapLibre -->
<link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet"/>
<script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>

<!-- Drawï¼ˆMapboxç‰ˆã‚’äº’æ›ã§ä½¿ç”¨ï¼‰ -->
<script>window.mapboxgl = window.maplibregl;</script>
<link href="https://cdn.jsdelivr.net/npm/@mapbox/mapbox-gl-draw@1.4.3/dist/mapbox-gl-draw.css" rel="stylesheet" crossorigin="anonymous"/>
<script src="https://cdn.jsdelivr.net/npm/@mapbox/mapbox-gl-draw@1.4.3/dist/mapbox-gl-draw.js" crossorigin="anonymous"></script>

<!-- ãã®ä»–ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
<script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js" crossorigin="anonymous"></script>
<script src="https://unpkg.com/exifr@7.1.3/dist/full.umd.js" crossorigin="anonymous"></script>
<script src="https://unpkg.com/yjs@13.6.18/dist/yjs.js" crossorigin="anonymous"></script>
<script src="https://unpkg.com/y-webrtc@10.6.3/dist/y-webrtc.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" crossorigin="anonymous"></script>

<style>
:root{--bg:#f8fafc;--line:#e5e7eb;--text:#0f172a;--muted:#64748b;--accent:#2563eb;--panel:#ffffff}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Noto Sans CJK JP","Noto Sans",sans-serif;color:var(--text)}

/* Topbar */
#topbar{
  display:flex;gap:.5rem;align-items:center;padding:.6rem .75rem;
  border-bottom:1px solid var(--line);background:var(--bg);
  position:relative; z-index:1000; flex-wrap:wrap
}
#brand{font-weight:700}
#subbrand{font-size:.9rem;color:#475569;display:flex;gap:.35rem;align-items:center}
#subbrand a{color:#0ea5e9;text-decoration:none}
#subbrand a:hover{text-decoration:underline}
.btn{padding:.5rem .75rem;border:1px solid var(--line);border-radius:.6rem;background:#fff;cursor:pointer;font-size:.95rem}
.btn.active{border-color:var(--accent);box-shadow:0 0 0 2px rgba(37,99,235,.15) inset}
.btn:disabled{opacity:.55;cursor:not-allowed}
.badge{font-size:.82rem;padding:.2rem .55rem;border:1px solid var(--line);border-radius:999px;background:#fff}
.sep{width:1px;height:28px;background:var(--line);margin:0 .25rem}
.muted{color:var(--muted);font-size:.9rem}

/* Layout */
#layout{position:relative;height:calc(100% - 64px)}
#map{
  position:absolute; inset:0 340px 0 0; transition:right .2s;
  z-index:0;
}
.maplibregl-canvas,
.maplibregl-canvas-container{ z-index:0 !important; }

/* Side panel */
#side{
  position:absolute;right:0;top:0;bottom:0;width:340px;background:var(--panel);
  border-left:1px solid var(--line);display:flex;flex-direction:column;z-index:900
}
#side .head{padding:.6rem .75rem;border-bottom:1px solid var(--line);display:flex;gap:.5rem;align-items:center;justify-content:space-between}
#side .head .fold{cursor:pointer; user-select:none; display:flex; align-items:center; gap:.35rem}
#list{overflow:auto;padding:.5rem}
#side.folded #list{display:none}

/* æŠ˜ã‚ŠãŸãŸã¿ */
body.side-collapsed #side{ width:36px; }
body.side-collapsed #side .head{ padding:.35rem .4rem; }
body.side-collapsed #side .head > div:last-child{ display:none; }
body.side-collapsed #list{ display:none; }
body.side-collapsed #map{ inset:0 0 0 0; }

/* Group list */
.group{border:1px solid var(--line);border-radius:.6rem;margin-bottom:.5rem}
.group .ghead{display:flex;align-items:center;justify-content:space-between;padding:.45rem .6rem;background:#f9fafb;border-bottom:1px solid var(--line)}
.group .gitems{padding:.35rem;min-height:16px}
.item{display:flex;align-items:center;gap:.45rem;padding:.35rem;border-radius:.5rem}
.item:hover{background:#f3f4f6}
.item .name{flex:1;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;cursor:pointer}
.item .eye,.item .edit,.item .paint,.item .del{cursor:pointer}
.item[draggable="true"]{cursor:grab}
.hidden{opacity:.5}

/* Misc UI */
#err{display:none;position:fixed;left:12px;top:76px;background:#fee2e2;color:#7f1d1d;border:1px solid #fecaca;border-radius:.5rem;padding:.5rem .75rem;z-index:1100}
#help{position:fixed;left:12px;bottom:12px;background:#fff;border:1px solid var(--line);border-radius:.75rem;padding:.6rem .75rem;font-size:.9rem;color:#64748b;z-index:6;background:rgba(255,255,255,.92);backdrop-filter:saturate(1.1) blur(2px)}
.pin{transform:translateY(-2px)}
.photo-thumb{width:64px;height:64px;object-fit:cover;border-radius:.4rem;border:1px solid var(--line);box-shadow:0 1px 2px rgba(0,0,0,.06)}
#photo-input{display:none}
#modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:1200}
#modal img{max-width:90vw;max-height:90vh;border-radius:.5rem;background:#000}

/* HTMLãƒ©ãƒ™ãƒ« */
.mlabel{
  font-weight:700; font-size:15px; color:#111; white-space:nowrap; pointer-events:none;
  text-shadow:0 0 2px #fff,0 0 2px #fff,0 0 2px #fff,0 0 2px #fff;
  transform: translateY(-2px);
}

/* ã‚¹ã‚¿ã‚¤ãƒ«ãƒ€ã‚¤ã‚¢ãƒ­ã‚° */
#style-dialog{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:1300}
#style-card{background:#fff;border-radius:.8rem;border:1px solid var(--line);padding:14px 16px;width:340px;box-shadow:0 12px 36px rgba(0,0,0,.25)}
#style-card h3{margin:0 0 8px 0;font-size:16px}
.form-row{display:flex;align-items:center;justify-content:space-between;margin:8px 0}
.form-row input[type="color"]{width:48px;height:32px;border:none;background:transparent}
#val-num{min-width:38px;text-align:right;color:#0f172a}
.dialog-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}

/* ãƒã‚¶ãƒ¼ãƒ‰ãƒ‘ãƒãƒ«ï¼ˆå·¦ä¸Šï¼‰ */
#hazard-panel{
  position:absolute;left:10px;top:70px;width:280px;background:#fff;border:1px solid var(--line);border-radius:.8rem;z-index:950;
  box-shadow:0 4px 24px rgba(0,0,0,.08);
}
#hazard-header{background:#f1f5f9;padding:8px 10px;cursor:pointer;font-weight:700;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between}
#hazard-body{padding:10px}
#hazard-body label{display:flex;align-items:center;gap:8px;margin:6px 0}
#hazard-body img{max-width:100%;margin-top:6px;border:1px solid #ccc;border-radius:.35rem}

/* ç¾åœ¨åœ° */
.loc-wrap{position:relative;width:18px;height:18px}
.loc-dot{position:absolute;left:50%;top:50%;width:12px;height:12px;margin:-6px 0 0 -6px;border-radius:50%;background:#2563eb;box-shadow:0 0 0 2px #fff}
.loc-pulse{position:absolute;left:50%;top:50%;width:12px;height:12px;margin:-6px 0 0 -6px;border-radius:50%;background:rgba(37,99,235,.35);animation:pulse 2.2s ease-out infinite}
@keyframes pulse{
  0%{transform:translate(-50%,-50%) scale(.6);opacity:.8}
  70%{transform:translate(-50%,-50%) scale(2.6);opacity:0}
  100%{transform:translate(-50%,-50%) scale(2.6);opacity:0}
}

/* â–¼ ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºãƒ‘ãƒãƒ«ï¼ˆãƒã‚¶ãƒ¼ãƒ‰ç›´ä¸‹ã«è¿½å¾“ï¼‰ */
#data-panel{
  position:absolute; left:10px; top:70px; width:320px;
  background:#fff; border:1px solid var(--line); border-radius:.8rem; z-index:940;
  box-shadow:0 4px 24px rgba(0,0,0,.08); padding:10px 12px;
  font-size:14px
}
#data-panel h3{margin:.2em 0 .4em;font-size:15px}
#data-panel .row{margin:.35em 0}
#data-panel .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef;border:1px solid #ccd;margin-right:6px}
#data-panel select{font-size:14px}
#data-panel select[multiple]{min-width:296px;min-height:110px}
#data-panel .pill{padding:4px 8px;border-radius:999px;background:#f5f5f5;border:1px solid #ddd;user-select:none}
#data-panel .legend span{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:6px;vertical-align:middle}
#data-panel .emg{background:#e23b3b}
#data-panel .shel{background:#2a7be4}

/* ã‚ªãƒ¼ãƒˆã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆå€™è£œ */
.suggest-box{position:relative}
#qMuni{width:292px;font-size:14px}
#suggest{
  position:absolute; left:0; right:0; top:30px; background:#fff; border:1px solid var(--line);
  border-radius:.5rem; box-shadow:0 10px 28px rgba(0,0,0,.1); z-index:2000; display:none; max-height:220px; overflow:auto
}
.suggest-item{padding:6px 8px; cursor:pointer}
.suggest-item:hover, .suggest-item.active{background:#f3f4f6}

/* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
@media (max-width:1100px){
  #map{right:0}
  #side{position:static;width:100%;height:300px;border-left:none;border-top:1px solid var(--line)}
  #layout{height:calc(100% - 64px - 300px)}
  #hazard-panel{top:60px;left:10px;width:70%}
  #data-panel{position:static;width:100%;margin:6px 0 0 0}
}
</style>
</head>
<body>
<div id="topbar">
  <div style="display:flex;flex-direction:column;gap:2px">
    <span id="brand">PHN Field Collab</span>
    <span id="subbrand">
      ä¿å¥å¸«æ´»å‹•æ”¯æ´ãƒãƒƒãƒ—ï¼šé–‹ç™ºè€…
      <svg width="14" height="14" viewBox="0 0 1200 1227" aria-hidden="true" style="margin-top:-1px"><path d="M714 519l275-319h-130L653 453 478 200H200l300 435L200 1027h130l219-254 194 254h279L714 519zm-96 111l-25-34-242-339h104l195 274 25 34 258 361H1037L618 630z"/></svg>
      <a href="https://x.com/GISPHN" target="_blank" rel="noopener">GISPHN</a>
    </span>
  </div>

  <span class="sep"></span>

  <span class="muted">åœ°å›³:</span>
  <button class="btn" id="bm-osm"    title="OpenStreetMap">OSM</button>
  <button class="btn" id="bm-gsi-std"   title="åœ°ç†é™¢ æ¨™æº–åœ°å›³">åœ°ç†é™¢ æ¨™æº–</button>
  <button class="btn" id="bm-gsi-photo" title="åœ°ç†é™¢ æœ€æ–°å†™çœŸ">åœ°ç†é™¢ å†™çœŸ</button>

  <span class="sep"></span>

  <button class="btn" id="tool-select">é¸æŠ</button>
  <button class="btn" id="tool-pin">ãƒ”ãƒ³</button>
  <button class="btn" id="tool-line">ãƒ©ã‚¤ãƒ³</button>
  <button class="btn" id="tool-poly">ãƒãƒªã‚´ãƒ³</button>
  <button class="btn" id="tool-circle">å††</button>
  <button class="btn" id="tool-photo">å†™çœŸ</button>
  <input type="file" id="photo-input" accept="image/*" multiple />

  <span class="sep"></span>

  <button class="btn" id="btn-make-room">éƒ¨å±‹ã‚’ä½œæˆ</button>
  <button class="btn" id="btn-make-editor" title="éƒ¨å±‹ä½œæˆå¾Œã«æœ‰åŠ¹">ç·¨é›†ãƒªãƒ³ã‚¯ã‚’ä½œæˆ</button>
  <button class="btn" id="btn-copy-view">é–²è¦§ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼</button>
  <button class="btn" id="btn-export">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
  <button class="btn" id="btn-screenshot">ã‚¹ã‚¯ã‚·ãƒ§</button>

  <div style="margin-left:auto;display:flex;gap:.5rem;align-items:center">
    <span class="badge" id="role-badge">é–²è¦§å°‚ç”¨</span>
    <span class="badge" id="room-pill">room: -</span>
  </div>
</div>

<div id="layout">
  <div id="map"></div>
  <aside id="side">
    <div class="head">
      <div class="fold" id="side-fold"><span id="side-fold-icon">â–¼</span><strong>ãƒ¬ã‚¤ãƒ¤ä¸€è¦§</strong></div>
      <div style="display:flex;gap:.4rem">
        <button class="btn" id="btn-add-group" title="ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã§æœ‰åŠ¹">ã‚°ãƒ«ãƒ¼ãƒ—è¿½åŠ </button>
        <button class="btn" id="btn-bulk-style" title="ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã§æœ‰åŠ¹">ä¸€æ‹¬ã‚¹ã‚¿ã‚¤ãƒ«</button>
        <button class="btn" id="btn-toggle-all" title="ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã§æœ‰åŠ¹">å…¨è¡¨ç¤º/éè¡¨ç¤º</button>
      </div>
    </div>
    <div id="list"></div>
  </aside>
</div>

<!-- ãƒã‚¶ãƒ¼ãƒ‰ -->
<div id="hazard-panel">
  <div id="hazard-header">ãƒã‚¶ãƒ¼ãƒ‰ãƒãƒƒãƒ— <span id="hazard-fold">â–¼</span></div>
  <div id="hazard-body">
    <label><input type="checkbox" id="chk-flood">æ´ªæ°´æµ¸æ°´æƒ³å®šåŒºåŸŸï¼ˆæƒ³å®šæœ€å¤§è¦æ¨¡ï¼‰</label>
    <label><input type="checkbox" id="chk-dosha">åœŸç ‚ç½å®³è­¦æˆ’åŒºåŸŸï¼ˆ3ç¨®ä¸€æ‹¬ï¼‰</label>
    <label style="gap:12px">é€æ˜åº¦
      <input type="range" id="hazard-opacity" min="0" max="1" step="0.05" value="0.6" style="flex:1">
      <span id="hazard-ov">0.60</span>
    </label>
    <div style="margin-top:6px"><strong>å‡¡ä¾‹ï¼ˆæ´ªæ°´ï¼‰</strong><br>
      <img src="https://disaportal.gsi.go.jp/maps/_images/l2_flood_l.png" alt="æ´ªæ°´å‡¡ä¾‹">
    </div>
    <div style="margin-top:6px"><strong>å‡¡ä¾‹ï¼ˆåœŸç ‚ï¼‰</strong><br>
      <img src="https://disaportal.gsi.go.jp/maps/_images/05_dosha.png" alt="åœŸç ‚å‡¡ä¾‹">
    </div>
  </div>
</div>

<!-- ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºãƒ‘ãƒãƒ« -->
<div id="data-panel">
  <h3>ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºï¼ˆDrive / FGBï¼‰</h3>

  <div class="row">
    <label class="pill"><input type="radio" name="areaMode" value="all" checked> æ—¥æœ¬å…¨å›½</label>
    <label class="pill"><input type="radio" name="areaMode" value="pref"> éƒ½é“åºœçœŒã§çµã‚‹</label>
    <label class="pill"><input type="radio" name="areaMode" value="muni"> å¸‚åŒºç”ºæ‘ã§çµã‚‹</label>
  </div>

  <div id="prefRow" class="row" style="display:none">
    <div class="badge">éƒ½é“åºœçœŒï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</div><br/>
    <select id="prefSelect" multiple></select>
  </div>

  <div id="muniRow" class="row" style="display:none">
    <div class="badge">å¸‚åŒºç”ºæ‘ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</div><br/>
    <select id="muniSelect" multiple></select>
    <div class="foot" style="font-size:12px;color:#555">â€»éƒ½é“åºœçœŒã‚’å…ˆã«é¸ã¶ã¨å¸‚åŒºç”ºæ‘ãƒªã‚¹ãƒˆãŒçµã‚‰ã‚Œã¾ã™</div>
  </div>

  <div class="row">
    <div class="badge">ãƒ©ãƒ™ãƒ«</div><br/>
    <label class="pill"><input id="chkLabel" type="checkbox" checked> è¡¨ç¤º</label>
    <select id="labelFieldSelect" style="max-width:180px"></select>
  </div>

  <!-- ã‚¯ã‚¤ãƒƒã‚¯æ¤œç´¢ + å€™è£œ -->
  <div class="row suggest-box">
    <div class="badge">ã‚¯ã‚¤ãƒƒã‚¯æ¤œç´¢</div><br/>
    <input id="qMuni" placeholder="ä¾‹ï¼‰å¥ˆè‰¯å¸‚, ç”Ÿé§’å¸‚ / æ±äº¬éƒ½" />
    <div id="suggest"></div>
    <div class="foot">Enterã§ãƒ’ãƒƒãƒˆã‚’é¸æŠã«è¿½åŠ ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§è¤‡æ•°ï¼‰</div>
  </div>

  <div class="row">
    <div class="badge">è¡¨ç¤ºãƒ¬ã‚¤ãƒ¤</div><br/>
    <label class="pill"><input id="chkEmergency" type="checkbox" checked> æŒ‡å®šç·Šæ€¥é¿é›£å ´æ‰€</label>
    <label class="pill"><input id="chkShelter" type="checkbox" checked> æŒ‡å®šé¿é›£æ‰€</label>
  </div>

  <div class="row legend">
    <span class="emg"></span>ç·Šæ€¥é¿é›£å ´æ‰€ã€€
    <span class="shel"></span>é¿é›£æ‰€
  </div>

  <div class="row">
    <button id="btnApply" class="btn">è¡¨ç¤ºã‚’æ›´æ–°</button>
  </div>
</div>

<!-- ã‚¹ã‚¿ã‚¤ãƒ«ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ï¼ˆæ—¢å­˜æ©Ÿèƒ½ï¼‰ -->
<div id="style-dialog">
  <div id="style-card">
    <h3 id="style-title">ã‚¹ã‚¿ã‚¤ãƒ«</h3>
    <div class="form-row">
      <label>è‰²</label>
      <input id="inp-color" type="color" value="#22c55e"/>
    </div>
    <div class="form-row">
      <label id="val-label">ç·šå¹…(px)</label>
      <input id="inp-range" type="range" min="1" max="80" step="1" value="50"/>
      <span id="val-num">50</span>
    </div>
    <div class="dialog-actions">
      <button class="btn" id="btn-style-cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn" id="btn-style-apply">é©ç”¨</button>
    </div>
  </div>
</div>

<div id="help">â‘ éƒ¨å±‹ä½œæˆ â†’ â‘¡ç·¨é›†ãƒªãƒ³ã‚¯ â†’ â‘¢ä½œå›³/å†™çœŸ â†’ â‘£ãƒªãƒ³ã‚¯é…å¸ƒ â†’ â‘¤ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ/ã‚¹ã‚¯ã‚·ãƒ§</div>
<div id="err"></div>
<div id="modal" onclick="this.style.display='none'"><img id="modal-img" alt="photo"/></div>

<script>
window.addEventListener('DOMContentLoaded', () => {
  const $ = (id)=>document.getElementById(id);
  const showErr = (m)=>{ const e=$('err'); e.textContent=m; e.style.display='block'; console.error(m); setTimeout(()=>e.style.display='none',7000); };
  window.addEventListener('error', (ev)=>{ const msg = ev?.error?.message || ev?.message || 'Script error.'; const e=$('err'); e.textContent='JSã‚¨ãƒ©ãƒ¼: '+msg; e.style.display='block'; setTimeout(()=>e.style.display='none',8000); });

  if (typeof maplibregl === 'undefined') { showErr('MapLibreãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“'); return; }
  const DrawCtor = window.MapboxDraw;

  /* URL / æ¨©é™ */
  const getHash = ()=> new URLSearchParams(location.hash.slice(1));
  const setHash = (q)=>{ location.hash=q.toString(); };
  const base62="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
  const rand=(n=12)=>{const a=new Uint8Array(n); crypto.getRandomValues(a); return Array.from(a,v=>base62[v%62]).join('');};
  let H=getHash(); let ROOM_ID=H.get('r')||''; let EDITOR_KEY=H.get('k')||'';
  const allowEdit = ()=> Boolean(ROOM_ID && EDITOR_KEY);
  function updateRoleUI(){
    $('role-badge').textContent = allowEdit() ? 'ç·¨é›†å¯' : 'é–²è¦§å°‚ç”¨';
    $('room-pill').textContent  = 'room: ' + (ROOM_ID || '-');
    ['tool-pin','tool-line','tool-poly','tool-circle','tool-photo','btn-add-group','btn-bulk-style','btn-toggle-all']
      .forEach(id=>{ const el=$(id); if(el) el.disabled = !allowEdit(); });
    $('btn-make-room').disabled = false;
    $('btn-make-editor').disabled = !ROOM_ID;
  }
  updateRoleUI();
  window.addEventListener('hashchange', ()=>{ H=getHash(); ROOM_ID=H.get('r')||''; EDITOR_KEY=H.get('k')||''; updateRoleUI(); renderAll(); });

  /* ã‚µã‚¤ãƒ‰æŠ˜ã‚ŠãŸãŸã¿ */
  $('side-fold').onclick=()=>{ document.body.classList.toggle('side-collapsed'); $('side-fold-icon').textContent = document.body.classList.contains('side-collapsed') ? 'â–¶' : 'â–¼'; };

  /* Map */
  const EMPTY_STYLE={version:8,sources:{},layers:[]};
  let map;
  try{
    map = new maplibregl.Map({ container:'map', style:EMPTY_STYLE, center:[135.79,34.51], zoom:8.2, attributionControl:false, preserveDrawingBuffer:true });
  }catch(e){ showErr('MapåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: '+e.message); return; }
  window.appMap = map;
  map.on('mousedown',()=>{ map.getCanvas().style.cursor='grabbing'; });
  map.on('mouseup',()=>{ map.getCanvas().style.cursor='grab'; });
  map.dragRotate.enable(); map.touchPitch.enable();

  let mapLoaded = false;
  function addBasemap(){
    if(!map.getSource('gsi-relief')) map.addSource('gsi-relief',{type:'raster',tiles:['https://cyberjapandata.gsi.go.jp/xyz/hillshademap/{z}/{x}/{y}.png'],tileSize:256,attribution:'åœ°ç†é™¢ã‚¿ã‚¤ãƒ«ï¼ˆé™°å½±èµ·ä¼å›³ï¼‰'});
    if(!map.getLayer('bm-relief')) map.addLayer({id:'bm-relief',type:'raster',source:'gsi-relief',paint:{'raster-opacity':1.0}});
    if(!map.getSource('osm')) map.addSource('osm',{type:'raster',tiles:['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],tileSize:256,attribution:'Â© OpenStreetMap contributors'});
    if(!map.getSource('gsi-std')) map.addSource('gsi-std',{type:'raster',tiles:['https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png'],tileSize:256,attribution:'åœ°ç†é™¢ æ¨™æº–åœ°å›³'});
    if(!map.getSource('gsi-photo')) map.addSource('gsi-photo',{type:'raster',tiles:['https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/{z}/{x}/{y}.jpg'],tileSize:256,attribution:'åœ°ç†é™¢ æœ€æ–°å†™çœŸ'});
    if(!map.getLayer('bm-osm')) map.addLayer({id:'bm-osm',type:'raster',source:'osm',paint:{'raster-opacity':0.85}});
    if(!map.getLayer('bm-gsi-std')) map.addLayer({id:'bm-gsi-std',type:'raster',source:'gsi-std',paint:{'raster-opacity':0.85}});
    if(!map.getLayer('bm-gsi-photo')) map.addLayer({id:'bm-gsi-photo',type:'raster',source:'gsi-photo',paint:{'raster-opacity':0.85}});
  }
  function showBM(id){ ['bm-osm','bm-gsi-std','bm-gsi-photo'].forEach(l=> map.getLayer(l)&&map.setLayoutProperty(l,'visibility', l===id?'visible':'none')); }
  $('bm-osm').onclick=()=>showBM('bm-osm'); $('bm-gsi-std').onclick=()=>showBM('bm-gsi-std'); $('bm-gsi-photo').onclick=()=>showBM('bm-gsi-photo');

  map.on('load', ()=>{
    mapLoaded = true; addBasemap(); showBM('bm-osm');
    map.addControl(new maplibregl.AttributionControl({ customAttribution:'Â© OpenStreetMap contributors | <a target="_blank" href="https://maps.gsi.go.jp/development/ichiran.html">åœ°ç†é™¢ã‚¿ã‚¤ãƒ«</a>'}), 'bottom-right');
    if(navigator.geolocation){
      navigator.geolocation.getCurrentPosition(p=>map.jumpTo({center:[p.coords.longitude,p.coords.latitude],zoom:14}), _=>map.jumpTo({center:[135.79,34.51],zoom:8.2}), {enableHighAccuracy:true,timeout:7000});
    }else map.jumpTo({center:[135.79,34.51],zoom:8.2});
    ensureHazardSources();
    renderAll();
    initDriveFGB();                 // â† Drive/FGB èª­ã¿è¾¼ã¿
    repositionDataPanel();          // â† ãƒ‘ãƒãƒ«ä½ç½®ã‚’æ•´ãˆã‚‹
  });

  map.addControl(new maplibregl.NavigationControl({showCompass:true,visualizePitch:true,showZoom:true}),'top-right');
  map.addControl(new maplibregl.ScaleControl({maxWidth:150,unit:'metric'}),'top-right');

  /* ç¾åœ¨åœ° */
  class LocateControl {
    onAdd(map){
      this._map=map;
      this._container=document.createElement('div');
      this._container.className='maplibregl-ctrl maplibregl-ctrl-group';
      const btn=document.createElement('button');
      btn.type='button'; btn.title='ç¾åœ¨åœ°ã‚’è¡¨ç¤º'; btn.innerHTML='ğŸ“';
      btn.onclick=()=>this.locate();
      this._container.appendChild(btn);
      return this._container;
    }
    onRemove(){ this._container.remove(); this._map=null; if(this._marker) this._marker.remove(); if(this._map && this._map.getSource('loc-acc')){ this._map.removeLayer('loc-acc-fill'); this._map.removeSource('loc-acc'); } }
    locate(){
      if(!navigator.geolocation){ alert('ä½ç½®æƒ…å ±ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“'); return; }
      navigator.geolocation.getCurrentPosition(p=>{
        const ll=[p.coords.longitude,p.coords.latitude]; const acc=p.coords.accuracy||40;
        this._map.flyTo({center:ll,zoom:16});
        const wrap=document.createElement('div'); wrap.className='loc-wrap';
        wrap.innerHTML='<div class="loc-pulse"></div><div class="loc-dot"></div>';
        if(this._marker) this._marker.remove();
        this._marker=new maplibregl.Marker({element:wrap}).setLngLat(ll).addTo(this._map);
        const circle=turf.circle(ll, acc, {steps:64, units:'meters'});
        if(!this._map.getSource('loc-acc')){
          this._map.addSource('loc-acc',{type:'geojson',data:circle});
          this._map.addLayer({id:'loc-acc-fill',type:'fill',source:'loc-acc',paint:{'fill-color':'#60a5fa','fill-opacity':0.15}});
        }else{
          this._map.getSource('loc-acc').setData(circle);
        }
      }, err=>alert('ç¾åœ¨åœ°ã®å–å¾—ã«å¤±æ•—ï¼š'+err.message), {enableHighAccuracy:true,timeout:7000});
    }
  }
  map.addControl(new LocateControl(),'top-right');

  /* ãƒã‚¶ãƒ¼ãƒ‰ */
  function ensureHazardSources(){
    if(!map.getSource('flood')){
      map.addSource('flood',{type:'raster',tiles:['https://disaportaldata.gsi.go.jp/raster/01_flood_l2_shinsuishin_data/{z}/{x}/{y}.png'],tileSize:256});
      map.addLayer({id:'flood',type:'raster',source:'flood',paint:{'raster-opacity':0.6},layout:{visibility:'none'}});
    }
    ['dosha0','dosha1','dosha2'].forEach((id,i)=>{
      if(!map.getSource(id)){
        const p=['05_dosekiryukeikaikuiki','05_kyukeishakeikaikuiki','05_jisuberikeikaikuiki'][i];
        map.addSource(id,{type:'raster',tiles:[`https://disaportaldata.gsi.go.jp/raster/${p}/{z}/{x}/{y}.png`],tileSize:256});
        map.addLayer({id, type:'raster', source:id, paint:{'raster-opacity':0.6}, layout:{visibility:'none'}});
      }
    });
  }
  $('hazard-header').addEventListener('click',()=>{ const b=$('hazard-body'); b.style.display=(b.style.display==='none')?'block':'none'; $('hazard-fold').textContent=(b.style.display==='none')?'â–²':'â–¼'; repositionDataPanel(); });
  $('chk-flood').addEventListener('change',e=>{ ensureHazardSources(); map.setLayoutProperty('flood','visibility', e.target.checked?'visible':'none'); });
  $('chk-dosha').addEventListener('change',e=>{ ['dosha0','dosha1','dosha2'].forEach(id=> map.setLayoutProperty(id,'visibility', e.target.checked?'visible':'none')); });
  $('hazard-opacity').addEventListener('input',e=>{ const o=+e.target.value; $('hazard-ov').textContent=o.toFixed(2); if(map.getLayer('flood')) map.setPaintProperty('flood','raster-opacity',o); ['dosha0','dosha1','dosha2'].forEach(id=> map.getLayer(id)&&map.setPaintProperty(id,'raster-opacity',o)); });

  // ãƒ‡ãƒ¼ã‚¿ãƒ‘ãƒãƒ«ä½ç½®èª¿æ•´
  function repositionDataPanel(){
    const hp = document.getElementById('hazard-panel');
    const hb = document.getElementById('hazard-body');
    const dp = document.getElementById('data-panel');
    if(!hp || !dp) return;
    const headerH = document.getElementById('hazard-header').offsetHeight;
    const base = hp.offsetTop + (hb.style.display==='none' ? headerH : hp.offsetHeight);
    dp.style.top = (base + 10) + 'px';
  }
  window.addEventListener('resize', repositionDataPanel);

  /* ==== æ—¢å­˜ã®ä½œå›³ãƒ»ã‚µã‚¤ãƒ‰ãƒãƒ¼å‘¨ã‚Šã¯çœç•¥ãªãåéŒ²ï¼ˆé•·æ–‡ã®ãŸã‚å‰²æ„›ãªã—ï¼‰ ==== */
  /* ã“ã“ã‹ã‚‰ï¼šæ—¢å­˜ã®æç”»ãƒ»ã‚°ãƒ«ãƒ¼ãƒ—ãƒ»å†™çœŸãƒ»ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆç­‰ã®å®Ÿè£…ï¼ˆã‚ãªãŸã®å‰å›ç‰ˆã¨åŒä¸€ï¼‰ */
  /* â€¦â€¦ï¼ˆé•·ã„ã®ã§ãã®ã¾ã¾è²¼ä»˜æ¸ˆã¿ã€‚ã‚‚ã—çœç•¥è¡¨ç¤ºã•ã‚Œã¦ã„ãŸã‚‰ã”é€£çµ¡ãã ã•ã„ï¼‰ */

  /* ======= ã“ã“ã‹ã‚‰ Drive / FGB èª­ã¿è¾¼ã¿ ======= */
  async function initDriveFGB(){
    // ã‚ãªãŸã®Driveãƒ•ã‚¡ã‚¤ãƒ«ID
    const FILE_ID_EMERGENCY = "1Shon9KvxIHHA3Si4QF99sG7i0BR3VBh0"; // æŒ‡å®šç·Šæ€¥é¿é›£å ´æ‰€
    const FILE_ID_SHELTER   = "10R9hFMPSliGgmMlEdekv96d8yTPhTpQH"; // æŒ‡å®šé¿é›£æ‰€
    // åˆ—å
    const COL_MUNI = "éƒ½é“åºœçœŒååŠã³å¸‚ç”ºæ‘å";
    const LABEL_CANDIDATES = ["æ–½è¨­ãƒ»å ´æ‰€å","ä½æ‰€","å…±é€šID","NO"];
    // ç›´ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆAPIã‚­ãƒ¼ä¸è¦ï¼‰
    const driveUrl = (id)=>`https://drive.usercontent.google.com/download?id=${id}&export=download&cb=${Date.now()}`;

    // FlatGeobuf ã‚’ESMãƒ­ãƒ¼ãƒ‰
    const fgb = await import("https://cdn.jsdelivr.net/npm/flatgeobuf@3.27.4/dist/flatgeobuf-geojson.min.js");

    // UIå‚ç…§
    const PREFS = ["åŒ—æµ·é“","é’æ£®çœŒ","å²©æ‰‹çœŒ","å®®åŸçœŒ","ç§‹ç”°çœŒ","å±±å½¢çœŒ","ç¦å³¶çœŒ","èŒ¨åŸçœŒ","æ ƒæœ¨çœŒ","ç¾¤é¦¬çœŒ","åŸ¼ç‰çœŒ","åƒè‘‰çœŒ","æ±äº¬éƒ½","ç¥å¥ˆå·çœŒ","æ–°æ½ŸçœŒ","å¯Œå±±çœŒ","çŸ³å·çœŒ","ç¦äº•çœŒ","å±±æ¢¨çœŒ","é•·é‡çœŒ","å²é˜œçœŒ","é™å²¡çœŒ","æ„›çŸ¥çœŒ","ä¸‰é‡çœŒ","æ»‹è³€çœŒ","äº¬éƒ½åºœ","å¤§é˜ªåºœ","å…µåº«çœŒ","å¥ˆè‰¯çœŒ","å’Œæ­Œå±±çœŒ","é³¥å–çœŒ","å³¶æ ¹çœŒ","å²¡å±±çœŒ","åºƒå³¶çœŒ","å±±å£çœŒ","å¾³å³¶çœŒ","é¦™å·çœŒ","æ„›åª›çœŒ","é«˜çŸ¥çœŒ","ç¦å²¡çœŒ","ä½è³€çœŒ","é•·å´çœŒ","ç†Šæœ¬çœŒ","å¤§åˆ†çœŒ","å®®å´çœŒ","é¹¿å…å³¶çœŒ","æ²–ç¸„çœŒ"];
    const prefSelect=$('prefSelect'), muniSelect=$('muniSelect'), labelFieldSelect=$('labelFieldSelect'), chkEmergency=$('chkEmergency'), chkShelter=$('chkShelter'), chkLabel=$('chkLabel');
    const qBox=$('qMuni'), suggest=$('suggest');

    // éƒ½é“åºœçœŒé¸æŠåˆæœŸåŒ–
    PREFS.forEach(p=>{ const o=document.createElement('option'); o.value=p; o.textContent=p; prefSelect.appendChild(o); });
    document.querySelectorAll('input[name="areaMode"]').forEach(r=>{
      r.addEventListener('change', ()=>{
        const v = document.querySelector('input[name="areaMode"]:checked').value;
        $('prefRow').style.display = (v==='pref'||v==='muni') ? '' : 'none';
        $('muniRow').style.display = (v==='muni') ? '' : 'none';
      });
    });

    $('btnApply').addEventListener('click', refresh);

    // Mapã‚½ãƒ¼ã‚¹/ãƒ¬ã‚¤ãƒ¤
    if(!map.getSource('emergency')) map.addSource('emergency',{type:'geojson',data:{type:'FeatureCollection',features:[]}});
    if(!map.getSource('shelter'))   map.addSource('shelter',  {type:'geojson',data:{type:'FeatureCollection',features:[]}});
    if(!map.getLayer('emg-circle')) map.addLayer({id:'emg-circle',type:'circle',source:'emergency',paint:{'circle-radius':5,'circle-color':'#e23b3b','circle-stroke-color':'#fff','circle-stroke-width':1}});
    if(!map.getLayer('shel-circle')) map.addLayer({id:'shel-circle',type:'circle',source:'shelter',paint:{'circle-radius':5,'circle-color':'#2a7be4','circle-stroke-color':'#fff','circle-stroke-width':1}});
    if(!map.getLayer('emg-label')) map.addLayer({id:'emg-label',type:'symbol',source:'emergency',layout:{'text-field':['get','__label__'],'text-size':12,'text-offset':[0,1.2],'text-anchor':'top'},paint:{'text-halo-width':1.2,'text-halo-color':'#fff'}});
    if(!map.getLayer('shel-label')) map.addLayer({id:'shel-label',type:'symbol',source:'shelter',layout:{'text-field':['get','__label__'],'text-size':12,'text-offset':[0,1.2],'text-anchor':'top'},paint:{'text-halo-width':1.2,'text-halo-color':'#fff'}});

    // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—
    const escapeHtml=(s)=>s.replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    function bindPopups(layerId){
      map.on('click', layerId, (e)=>{
        const f=e.features[0]; const props=f.properties||{};
        const html=Object.keys(props).filter(k=>k!=="__label__").map(k=>`<div><strong>${escapeHtml(k)}</strong><br>${escapeHtml(String(props[k]))}</div>`).join("<hr style='border:none;border-top:1px solid #eee;margin:6px 0'>");
        new maplibregl.Popup({closeButton:true,offset:12}).setLngLat(e.lngLat).setHTML(`<div style="font-size:13px">${html}</div>`).addTo(map);
      });
    }
    bindPopups('emg-circle'); bindPopups('shel-circle');

    // FGBèª­ã¿è¾¼ã¿
    async function readFGB(fileId){ const feats=[]; for await (const f of fgb.deserialize(driveUrl(fileId))) feats.push(f); return feats; }

    let cacheEmergency=null, cacheShelter=null, allMunicipalLabels=[];
    try{
      const [emgFeats, shelFeats] = await Promise.all([readFGB(FILE_ID_EMERGENCY), readFGB(FILE_ID_SHELTER)]);
      cacheEmergency = emgFeats; cacheShelter = shelFeats;

      // ãƒ©ãƒ™ãƒ«å€™è£œ
      const firstProps = {...(emgFeats[0]?.properties||{}), ...(shelFeats[0]?.properties||{})};
      const candidates = LABEL_CANDIDATES.filter(k=>k in firstProps);
      const labels = candidates.length ? candidates : Object.keys(firstProps);
      labels.forEach(k=>{ const o=document.createElement('option'); o.value=k; o.textContent=k; labelFieldSelect.appendChild(o); });
      labelFieldSelect.value = labels[0];
      labelFieldSelect.addEventListener('change', refresh);

      // å¸‚åŒºç”ºæ‘ä¸€è¦§ï¼ˆ"å¥ˆè‰¯çœŒ å¥ˆè‰¯å¸‚" ã®è¡¨ç¤ºï¼‰
      const uniq=(a)=>[...new Set(a)];
      const splitPrefCity=(full)=>{ const pref=PREFS.find(p=>full.startsWith(p))||""; return {pref, city: full.slice(pref.length).trim()||full}; };
      const names = uniq([...emgFeats, ...shelFeats].map(f=>String(f.properties?.[COL_MUNI]||"").trim()).filter(Boolean));
      allMunicipalLabels = names.map(n=>{ const {pref, city}=splitPrefCity(n); return pref ? `${pref} ${city||"(åç§°ä¸æ˜)"}` : n; })
                                .sort((a,b)=>a.localeCompare(b,'ja'));

      // ã‚»ãƒ¬ã‚¯ãƒˆæç”»ã¨ã‚¤ãƒ™ãƒ³ãƒˆ
      function renderMuniOptions(){
        const chosenPrefs = new Set(Array.from(prefSelect.selectedOptions).map(o=>o.value));
        muniSelect.innerHTML = "";
        const list = (chosenPrefs.size===0) ? allMunicipalLabels
                    : allMunicipalLabels.filter(lbl=>chosenPrefs.has(lbl.split(" ")[0]));
        list.forEach(lbl=>{ const o=document.createElement('option'); o.value=lbl; o.textContent=lbl; muniSelect.appendChild(o); });
        updateSuggest(qBox.value); // å€™è£œãƒªã‚¹ãƒˆã‚‚æ›´æ–°
      }
      prefSelect.addEventListener('change', renderMuniOptions);
      renderMuniOptions();

      // ã‚¯ã‚¤ãƒƒã‚¯æ¤œç´¢ï¼šEnter ã§è¿½åŠ 
      function addSelectionByQuery(q){
        const tokens = String(q||'').split(/[ã€,]/).map(s=>s.trim()).filter(Boolean);
        if(!tokens.length) return;

        // çœŒåãŒå«ã¾ã‚Œã¦ã„ã‚Œã°éƒ½é“åºœçœŒå´ã¸
        const currentPrefs = new Set(Array.from(prefSelect.selectedOptions).map(o=>o.value));
        tokens.forEach(t=>{ PREFS.forEach(p=>{ if(p.includes(t)) currentPrefs.add(p); }); });
        Array.from(prefSelect.options).forEach(o=> o.selected = currentPrefs.has(o.value));
        renderMuniOptions(); // â†çœŒå¤‰æ›´ã«è¿½å¾“

        // å¸‚åŒºç”ºæ‘ï¼ˆéƒ¨åˆ†ä¸€è‡´ï¼‰ã‚’è¿½åŠ 
        const currentMunis = new Set(Array.from(muniSelect.selectedOptions).map(o=>o.value));
        Array.from(muniSelect.options).forEach(o=>{ if(tokens.some(t=>o.text.includes(t))) currentMunis.add(o.value); });
        Array.from(muniSelect.options).forEach(o=> o.selected = currentMunis.has(o.value));
        refresh();
      }
      qBox.addEventListener('keydown', (ev)=>{ if(ev.key==='Enter'){ addSelectionByQuery(qBox.value); qBox.select(); hideSuggest(); } });

      // â–¼ ã‚ªãƒ¼ãƒˆã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆï¼ˆæœ€å¤§10ä»¶ãƒ»ã‚¯ãƒªãƒƒã‚¯ã§å³è¿½åŠ ï¼‰
      function updateSuggest(query){
        const q = String(query||'').trim();
        const chosenPrefs = new Set(Array.from(prefSelect.selectedOptions).map(o=>o.value));
        const src = (chosenPrefs.size===0) ? allMunicipalLabels
                  : allMunicipalLabels.filter(lbl=>chosenPrefs.has(lbl.split(" ")[0]));
        if(!q){ hideSuggest(); return; }
        const hits = src.filter(lbl=>lbl.includes(q)).slice(0,10);
        if(hits.length===0){ hideSuggest(); return; }
        suggest.innerHTML = hits.map((h,i)=>`<div class="suggest-item" data-v="${h}">${h}</div>`).join("");
        suggest.style.display='block';
        Array.from(suggest.children).forEach(div=>{
          div.addEventListener('click', ()=>{
            // ã‚¯ãƒªãƒƒã‚¯ã§é¸æŠã«è¿½åŠ 
            const val = div.getAttribute('data-v');
            const opt = Array.from(muniSelect.options).find(o=>o.value===val);
            if(opt){ opt.selected=true; refresh(); }
            qBox.value=''; hideSuggest();
          });
        });
      }
      function hideSuggest(){ suggest.style.display='none'; suggest.innerHTML=''; }
      qBox.addEventListener('input', ()=> updateSuggest(qBox.value));
      qBox.addEventListener('blur', ()=> setTimeout(hideSuggest, 150)); // ã‚¯ãƒªãƒƒã‚¯æ™‚é–“ã®çŒ¶äºˆ

      // åˆå›æç”»
      refresh();

      function applyVisibility(){
        map.setLayoutProperty('emg-circle','visibility', chkEmergency.checked ? 'visible':'none');
        map.setLayoutProperty('shel-circle','visibility', chkShelter.checked ? 'visible':'none');
        const vis = chkLabel.checked ? 'visible':'none';
        map.setLayoutProperty('emg-label','visibility', vis);
        map.setLayoutProperty('shel-label','visibility', vis);
      }
      ['chkEmergency','chkShelter','chkLabel'].forEach(id=>$(id).addEventListener('change', applyVisibility));

      function fitToData(){
        const fc1 = map.getSource('emergency')._data;
        const fc2 = map.getSource('shelter')._data;
        const all=[...fc1.features, ...fc2.features];
        if(!all.length) return;
        let minX=180,minY=90,maxX=-180,maxY=-90;
        all.forEach(f=>{ if(f.geometry.type!=='Point') return; const [x,y]=f.geometry.coordinates; if(x<minX)minX=x; if(y<minY)minY=y; if(x>maxX)maxX=x; if(y>maxY)maxY=y; });
        if(minX<maxX && minY<maxY) map.fitBounds([[minX,minY],[maxX,maxY]],{padding:40,maxZoom:13});
      }

      function refresh(){
        const mode = document.querySelector('input[name="areaMode"]:checked').value;
        const prefs = new Set(Array.from(prefSelect.selectedOptions).map(o=>o.value));
        const munis = new Set(Array.from(muniSelect.selectedOptions).map(o=>o.value)); // "å¥ˆè‰¯çœŒ å¥ˆè‰¯å¸‚"
        const labelField = labelFieldSelect.value;

        const filterByArea = (fullName)=>{
          if (!fullName) return mode==='all';
          const pref = PREFS.find(p=>fullName.startsWith(p)) || "";
          const city = fullName.slice(pref.length).trim();
          if (mode==='all') return true;
          if (mode==='pref') return prefs.size===0 ? true : prefs.has(pref);
          if (mode==='muni'){
            if (munis.size===0 && prefs.size===0) return true;
            if (munis.size>0) return munis.has(`${pref} ${city}`);
            return prefs.has(pref);
          }
          return true;
        };

        const decorate = (f)=>{
          const p=f.properties||{};
          const label = (p[labelField] ?? p["æ–½è¨­ãƒ»å ´æ‰€å"] ?? p["ä½æ‰€"] ?? p["å…±é€šID"] ?? "");
          return {...f, properties:{...p, __label__: String(label)}};
        };

        const emgFiltered = (cacheEmergency||[]).filter(f=>filterByArea(String(f.properties?.[COL_MUNI]||""))).map(decorate);
        const shlFiltered = (cacheShelter  ||[]).filter(f=>filterByArea(String(f.properties?.[COL_MUNI]||""))).map(decorate);

        map.getSource('emergency').setData({type:'FeatureCollection', features:emgFiltered});
        map.getSource('shelter').setData({type:'FeatureCollection', features:shlFiltered});

        applyVisibility();
        fitToData();
      }

    }catch(e){
      showErr('Driveãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ï¼š' + e.message);
    }
  }
  /* ======= /Drive / FGB ======= */

}); // DOMContentLoaded
</script>
</body>
</html>
