<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PHN Field Collab</title>

<link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet"/>
<script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>

<link href="https://unpkg.com/@maplibre/maplibre-gl-draw@1.0.4/dist/maplibre-gl-draw.css" rel="stylesheet" crossorigin="anonymous"/>
<script src="https://unpkg.com/@maplibre/maplibre-gl-draw@1.0.4/dist/maplibre-gl-draw.js" crossorigin="anonymous"></script>

<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/exifr@7.1.3/dist/full.umd.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/yjs@13.6.18/dist/yjs.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/y-webrtc@10.6.3/dist/y-webrtc.min.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" crossorigin="anonymous"></script>

<style>
:root{--bg:#f8fafc;--line:#e5e7eb;--text:#0f172a;--muted:#64748b;--accent:#2563eb;--panel:#ffffff}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Noto Sans CJK JP","Noto Sans",sans-serif;color:var(--text)}

/* Topbar */
#topbar{
  display:flex;gap:.5rem;align-items:center;padding:.6rem .75rem;
  border-bottom:1px solid var(--line);background:var(--bg);
  position:relative; z-index:1000; /* â† UIã‚’æœ€å‰é¢ã« */
  flex-wrap:wrap
}
#brand{font-weight:700}
#subbrand{font-size:.9rem;color:#475569;display:flex;gap:.35rem;align-items:center}
#subbrand a{color:#0ea5e9;text-decoration:none}
#subbrand a:hover{text-decoration:underline}
.btn{padding:.5rem .75rem;border:1px solid var(--line);border-radius:.6rem;background:#fff;cursor:pointer;font-size:.95rem}
.btn.active{border-color:var(--accent);box-shadow:0 0 0 2px rgba(37,99,235,.15) inset}
.btn:disabled{opacity:.55;cursor:not-allowed}
.badge{font-size:.82rem;padding:.2rem .55rem;border:1px solid var(--line);border-radius:999px;background:#fff}
.sep{width:1px;height:28px;background:var(--line);margin:0 .25rem}
.muted{color:var(--muted);font-size:.9rem}

/* Layout */
/* Layout */
#map{
  position:absolute;
  inset:0 340px 0 0;
  transition:right .2s;
  z-index:0;              /* â† ã“ã“ã‚’ 0 ã«ã™ã‚‹ï¼ˆ1 ã«ãªã£ã¦ã„ãŸã‚‰ä¿®æ­£ï¼‰ */
}
/* ãƒˆãƒƒãƒ—ãƒãƒ¼ã®é«˜ã•ã«åˆã‚ã›ã¦ã€åœ°å›³/å³ãƒ‘ãƒãƒ«ã®ä½œæ¥­é ˜åŸŸã‚’ç¢ºä¿ */
#topbar{ height:64px; }

#layout{
  position: relative;
  height: calc(100% - 64px); /* ãƒˆãƒƒãƒ—ãƒãƒ¼åˆ†ã‚’å·®ã—å¼•ã */
}

/* å³ãƒ‘ãƒãƒ«ãŒãƒˆãƒƒãƒ—ãƒãƒ¼ã®ä¸‹ã‹ã‚‰å§‹ã¾ã‚‹ã‚ˆã†ã«ï¼ˆ#layout ã‚’åŸºæº–ã«ï¼‰ */
#side{ top:0; }
/* MapLibre ã®ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’æœ€èƒŒé¢ã«å›ºå®š */
.maplibregl-canvas,
.maplibregl-canvas-container{
  z-index:0 !important;
}


/* Side panel */
#side{
  position:absolute;right:0;top:0;bottom:0;width:340px;background:var(--panel);
  border-left:1px solid var(--line);display:flex;flex-direction:column;z-index:900
}
#side .head{padding:.6rem .75rem;border-bottom:1px solid var(--line);display:flex;gap:.5rem;align-items:center;justify-content:space-between}
#side .head .fold{cursor:pointer; user-select:none; display:flex; align-items:center; gap:.35rem}
#list{overflow:auto;padding:.5rem}
#side.folded #list{display:none} /* â† è¦‹å‡ºã—ã ã‘æ®‹ã™ */

.group{border:1px solid var(--line);border-radius:.6rem;margin-bottom:.5rem}
.group .ghead{display:flex;align-items:center;justify-content:space-between;padding:.45rem .6rem;background:#f9fafb;border-bottom:1px solid var(--line)}
.group .gitems{padding:.35rem;min-height:16px}
.item{display:flex;align-items:center;gap:.45rem;padding:.35rem;border-radius:.5rem}
.item:hover{background:#f3f4f6}
.item .name{flex:1;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;cursor:pointer}
.item .eye,.item .edit,.item .paint,.item .del{cursor:pointer}
.item[draggable="true"]{cursor:grab}
.hidden{opacity:.5}

/* Misc UI */
#err{display:none;position:fixed;left:12px;top:76px;background:#fee2e2;color:#7f1d1d;border:1px solid #fecaca;border-radius:.5rem;padding:.5rem .75rem;z-index:1100}
#help{position:fixed;left:12px;bottom:12px;background:#fff;border:1px solid var(--line);border-radius:.75rem;padding:.6rem .75rem;font-size:.9rem;color:var(--muted);z-index:6;background:rgba(255,255,255,.92);backdrop-filter:saturate(1.1) blur(2px)}
.pin{transform:translateY(-2px)}
.photo-thumb{width:64px;height:64px;object-fit:cover;border-radius:.4rem;border:1px solid var(--line);box-shadow:0 1px 2px rgba(0,0,0,.06)}
#photo-input{display:none}
#modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:1200}
#modal img{max-width:90vw;max-height:90vh;border-radius:.5rem;background:#000}

/* HTMLãƒ©ãƒ™ãƒ« */
.mlabel{
  font-weight:700; font-size:15px; color:#111; white-space:nowrap; pointer-events:none;
  text-shadow:0 0 2px #fff,0 0 2px #fff,0 0 2px #fff,0 0 2px #fff;
  transform: translateY(-2px);
}

/* ã‚¹ã‚¿ã‚¤ãƒ«ãƒ€ã‚¤ã‚¢ãƒ­ã‚° */
#style-dialog{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:1300}
#style-card{background:#fff;border-radius:.8rem;border:1px solid var(--line);padding:14px 16px;width:340px;box-shadow:0 12px 36px rgba(0,0,0,.25)}
#style-card h3{margin:0 0 8px 0;font-size:16px}
.form-row{display:flex;align-items:center;justify-content:space-between;margin:8px 0}
.form-row input[type="color"]{width:48px;height:32px;border:none;background:transparent}
#val-num{min-width:38px;text-align:right;color:#0f172a}
.dialog-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}

/* ãƒã‚¶ãƒ¼ãƒ‰ãƒ‘ãƒãƒ«ï¼ˆå·¦ä¸Šãƒ»æŠ˜ã‚Šç•³ã¿ï¼‰ */
#hazard-panel{
  position:absolute;left:10px;top:70px;width:280px;background:#fff;border:1px solid var(--line);border-radius:.8rem;z-index:950;
  box-shadow:0 4px 24px rgba(0,0,0,.08);
}
#hazard-header{background:#f1f5f9;padding:8px 10px;cursor:pointer;font-weight:700;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between}
#hazard-body{padding:10px}
#hazard-body label{display:flex;align-items:center;gap:8px;margin:6px 0}
#hazard-body img{max-width:100%;margin-top:6px;border:1px solid #ccc;border-radius:.35rem}

/* ç¾åœ¨åœ°ãƒ‰ãƒƒãƒˆ & ãƒ‘ãƒ«ã‚¹ */
.loc-wrap{position:relative;width:18px;height:18px}
.loc-dot{position:absolute;left:50%;top:50%;width:12px;height:12px;margin:-6px 0 0 -6px;border-radius:50%;background:#2563eb;box-shadow:0 0 0 2px #fff}
.loc-pulse{position:absolute;left:50%;top:50%;width:12px;height:12px;margin:-6px 0 0 -6px;border-radius:50%;background:rgba(37,99,235,.35);animation:pulse 2.2s ease-out infinite}
@keyframes pulse{
  0%{transform:translate(-50%,-50%) scale(.6);opacity:.8}
  70%{transform:translate(-50%,-50%) scale(2.6);opacity:0}
  100%{transform:translate(-50%,-50%) scale(2.6);opacity:0}
}

/* ä½œå›³ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼šè¦–èªæ€§UP */
.mapboxgl-canvas, .maplibregl-canvas{cursor:grab}
.maplibregl-draw_polygon .maplibregl-canvas,
.maplibregl-draw_line_string .maplibregl-canvas{
  cursor:url('data:image/svg+xml;utf8,\
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24">\
<text x="4" y="18" font-size="20" font-family="Arial" fill="black">+</text>\
</svg>') 12 12, crosshair;
}
.mapbox-gl-draw_polygon, .mapbox-gl-draw_line{
  stroke:#0f172a !important; stroke-width:3px !important; stroke-dasharray:3,2 !important;
}
.mapbox-gl-draw_polygon{ fill:rgba(15,23,42,.08) !important; }

/* ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ */
button, .btn, .item .name, .item .eye, .item .edit, .item .paint, .item .del, .ghead{cursor:pointer}
.maplibregl-ctrl-group button{cursor:pointer}

@media (max-width:1100px){
  #map{right:0}
  #side{position:static;width:100%;height:300px;border-left:none;border-top:1px solid var(--line)}
  #layout{height:calc(100% - 64px - 300px)}
  #hazard-panel{top:60px;left:10px;width:70%}
}
  /* === æœ€å‰é¢ã«æ¥ã‚‹ã¹ãUIã‚’ç¢ºå®Ÿã«æœ€å‰é¢ã¸ === */
#topbar,
#hazard-panel,
#style-dialog,
#modal {
  position: relative;
  z-index: 5000 !important;
}

/* === MapLibre ãŒç”Ÿæˆã™ã‚‹å…¨ãƒ¬ã‚¤ãƒ¤ã‚’æœ€èƒŒé¢ã¸å›ºå®šï¼ˆã‚¯ãƒªãƒƒã‚¯é®ã‚Šé˜²æ­¢ï¼‰=== */
#map,
#map .maplibregl-map,
#map .maplibregl-canvas,
#map .maplibregl-canvas-container,
#map .maplibregl-control-container {
  z-index: 0 !important;
}
#layout{ position:relative; height:calc(100% - 64px); }
</style>
</head>
<body>
<div id="topbar">
  <div style="display:flex;flex-direction:column;gap:2px">
    <span id="brand">PHN Field Collab</span>
    <span id="subbrand">
      ä¿å¥å¸«æ´»å‹•æ”¯æ´ãƒãƒƒãƒ—ï¼šé–‹ç™ºè€…
      <svg width="14" height="14" viewBox="0 0 1200 1227" aria-hidden="true" style="margin-top:-1px"><path d="M714 519l275-319h-130L653 453 478 200H200l300 435L200 1027h130l219-254 194 254h279L714 519zm-96 111l-25-34-242-339h104l195 274 25 34 258 361H1037L618 630z"/></svg>
      <a href="https://x.com/GISPHN" target="_blank" rel="noopener">GISPHN</a>
    </span>
  </div>

  <span class="sep"></span>

  <span class="muted">åœ°å›³:</span>
  <button class="btn" id="bm-osm"    title="OpenStreetMap">OSM</button>
  <button class="btn" id="bm-gsi-std"   title="åœ°ç†é™¢ æ¨™æº–åœ°å›³">åœ°ç†é™¢ æ¨™æº–</button>
  <button class="btn" id="bm-gsi-photo" title="åœ°ç†é™¢ æœ€æ–°å†™çœŸ">åœ°ç†é™¢ å†™çœŸ</button>

  <span class="sep"></span>

  <button class="btn" id="tool-select">é¸æŠ</button>
  <button class="btn" id="tool-pin">ãƒ”ãƒ³</button>
  <button class="btn" id="tool-line">ãƒ©ã‚¤ãƒ³</button>
  <button class="btn" id="tool-poly">ãƒãƒªã‚´ãƒ³</button>
  <button class="btn" id="tool-circle">å††</button>
  <button class="btn" id="tool-delete" title="å‰Šé™¤ã¯ãƒ¬ã‚¤ãƒ¤ä¸€è¦§ã‹ã‚‰">å‰Šé™¤</button>
  <button class="btn" id="tool-photo">å†™çœŸ</button>
  <input type="file" id="photo-input" accept="image/*" multiple />

  <span class="sep"></span>

  <button class="btn" id="btn-make-room">éƒ¨å±‹ã‚’ä½œæˆ</button>
  <button class="btn" id="btn-make-editor" title="éƒ¨å±‹ä½œæˆå¾Œã«æœ‰åŠ¹">ç·¨é›†ãƒªãƒ³ã‚¯ã‚’ä½œæˆ</button>
  <button class="btn" id="btn-copy-view">é–²è¦§ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼</button>
  <button class="btn" id="btn-export">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
  <button class="btn" id="btn-screenshot">ã‚¹ã‚¯ã‚·ãƒ§</button>

  <div style="margin-left:auto;display:flex;gap:.5rem;align-items:center">
    <span class="badge" id="role-badge">é–²è¦§å°‚ç”¨</span>
    <span class="badge" id="room-pill">room: -</span>
  </div>
</div>

<div id="layout">
  <div id="map"></div>
  <aside id="side">
    <div class="head">
      <div class="fold" id="side-fold"><span id="side-fold-icon">â–¼</span><strong>ãƒ¬ã‚¤ãƒ¤ä¸€è¦§</strong></div>
      <div style="display:flex;gap:.4rem">
        <button class="btn" id="btn-add-group" title="ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã§æœ‰åŠ¹">ã‚°ãƒ«ãƒ¼ãƒ—è¿½åŠ </button>
        <button class="btn" id="btn-bulk-style" title="ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã§æœ‰åŠ¹">ä¸€æ‹¬ã‚¹ã‚¿ã‚¤ãƒ«</button>
        <button class="btn" id="btn-toggle-all" title="ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã§æœ‰åŠ¹">å…¨è¡¨ç¤º/éè¡¨ç¤º</button>
      </div>
    </div>
    <div id="list"></div>
  </aside>
</div>

<!-- ãƒã‚¶ãƒ¼ãƒ‰ãƒãƒƒãƒ—ãƒ‘ãƒãƒ« -->
<div id="hazard-panel">
  <div id="hazard-header">ãƒã‚¶ãƒ¼ãƒ‰ãƒãƒƒãƒ— <span id="hazard-fold">â–¼</span></div>
  <div id="hazard-body">
    <label><input type="checkbox" id="chk-flood">æ´ªæ°´æµ¸æ°´æƒ³å®šåŒºåŸŸï¼ˆæƒ³å®šæœ€å¤§è¦æ¨¡ï¼‰</label>
    <label><input type="checkbox" id="chk-dosha">åœŸç ‚ç½å®³è­¦æˆ’åŒºåŸŸï¼ˆ3ç¨®ä¸€æ‹¬ï¼‰</label>
    <label style="gap:12px">é€æ˜åº¦
      <input type="range" id="hazard-opacity" min="0" max="1" step="0.05" value="0.6" style="flex:1">
      <span id="hazard-ov">0.60</span>
    </label>
    <div style="margin-top:6px"><strong>å‡¡ä¾‹ï¼ˆæ´ªæ°´ï¼‰</strong><br>
      <img src="https://disaportal.gsi.go.jp/maps/_images/l2_flood_l.png" alt="æ´ªæ°´å‡¡ä¾‹">
    </div>
    <div style="margin-top:6px"><strong>å‡¡ä¾‹ï¼ˆåœŸç ‚ï¼‰</strong><br>
      <img src="https://disaportal.gsi.go.jp/maps/_images/05_dosha.png" alt="åœŸç ‚å‡¡ä¾‹">
    </div>
  </div>
</div>

<!-- ã‚¹ã‚¿ã‚¤ãƒ«ãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
<div id="style-dialog">
  <div id="style-card">
    <h3 id="style-title">ã‚¹ã‚¿ã‚¤ãƒ«</h3>
    <div class="form-row">
      <label>è‰²</label>
      <input id="inp-color" type="color" value="#22c55e"/>
    </div>
    <div class="form-row">
      <label id="val-label">ç·šå¹…(px)</label>
      <input id="inp-range" type="range" min="1" max="80" step="1" value="50"/>
      <span id="val-num">50</span>
    </div>
    <div class="dialog-actions">
      <button class="btn" id="btn-style-cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn" id="btn-style-apply">é©ç”¨</button>
    </div>
  </div>
</div>

<div id="help">â‘ éƒ¨å±‹ä½œæˆ â†’ â‘¡ç·¨é›†ãƒªãƒ³ã‚¯ â†’ â‘¢é¸æŠ/ãƒ”ãƒ³/ãƒ©ã‚¤ãƒ³/ãƒãƒªã‚´ãƒ³/å††/å†™çœŸ â†’ â‘£ãƒªãƒ³ã‚¯é…å¸ƒ â†’ â‘¤ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ / ã‚¹ã‚¯ã‚·ãƒ§ã€‚</div>
<div id="err"></div>
<div id="modal" onclick="this.style.display='none'"><img id="modal-img" alt="photo"/></div>
<script>
window.addEventListener('DOMContentLoaded', () => {
  // ========= åŸºæœ¬ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =========
  const $ = (id)=>document.getElementById(id);
  const showErr = (m)=>{ const e=$('err'); e.textContent=m; e.style.display='block'; console.error(m); setTimeout(()=>e.style.display='none',7000); };
  // ã‚¯ãƒ­ã‚¹ã‚ªãƒªã‚¸ãƒ³èµ·å› ã® "Script error." ã‚‚æ‹¾ã†
  window.addEventListener('error', (ev)=>{
    const msg = ev?.error?.message || ev?.message || 'Script error.';
    const e=$('err'); e.textContent='JSã‚¨ãƒ©ãƒ¼: '+msg; e.style.display='block';
    setTimeout(()=>e.style.display='none',8000);
  });

  // ========= ãƒ©ã‚¤ãƒ–ãƒ©ãƒªæ¤œæŸ» =========
  if (typeof maplibregl === 'undefined') { showErr('MapLibreãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“'); return; }
  // Drawã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿è‡ªå‹•æ¤œå‡ºï¼ˆMaplibreç‰ˆ/Mapboxç‰ˆã©ã¡ã‚‰ã§ã‚‚å¯ï¼‰
  const DrawCtor = window.MaplibreDraw || window.MapLibreDraw || window.MapboxDraw;
  if (!DrawCtor) { showErr('MapLibre-GL-Draw ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“'); }

  // ========= URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆéƒ¨å±‹â†’ç·¨é›†ã®é †åºã‚’å¼·åˆ¶ï¼‰ =========
  const getHash = ()=> new URLSearchParams(location.hash.slice(1));
  const setHash = (q)=>{ location.hash=q.toString(); };
  const base62="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
  const rand=(n=12)=>{const a=new Uint8Array(n); crypto.getRandomValues(a); return Array.from(a,v=>base62[v%62]).join('');};
  let H=getHash(); let ROOM_ID=H.get('r')||''; let EDITOR_KEY=H.get('k')||'';
  const allowEdit = ()=> Boolean(ROOM_ID && EDITOR_KEY);

  function updateRoleUI(){
    $('role-badge').textContent = allowEdit() ? 'ç·¨é›†å¯' : 'é–²è¦§å°‚ç”¨';
    $('room-pill').textContent  = 'room: ' + (ROOM_ID || '-');
    // ç·¨é›†æ©Ÿèƒ½ã®æœ‰åŠ¹/ç„¡åŠ¹
    const editToolIds=['tool-pin','tool-line','tool-poly','tool-circle','tool-photo','btn-add-group','btn-bulk-style','btn-toggle-all'];
    editToolIds.forEach(id=>{ const el=$(id); if(el) el.disabled = !allowEdit(); });
    // éƒ¨å±‹ä½œæˆã¯å¸¸ã«å¯ã€ç·¨é›†ãƒªãƒ³ã‚¯ã¯éƒ¨å±‹ãŒã‚ã‚‹ã¨ãå¯
    $('btn-make-room').disabled = false;
    $('btn-make-editor').disabled = !ROOM_ID;
  }
  updateRoleUI();
  window.addEventListener('hashchange', ()=>{
    H=getHash(); ROOM_ID=H.get('r')||''; EDITOR_KEY=H.get('k')||'';
    updateRoleUI(); renderAll();
  });

  // ========= ã‚µã‚¤ãƒ‰ãƒ‘ãƒãƒ«æŠ˜ã‚ŠãŸãŸã¿ =========
  const sideEl=$('side');
  $('side-fold').onclick=()=>{
    sideEl.classList.toggle('folded');
    $('side-fold-icon').textContent = sideEl.classList.contains('folded') ? 'â–²' : 'â–¼';
  };

  // ========= åœ°å›³åˆæœŸåŒ– =========
  const EMPTY_STYLE={version:8,sources:{},layers:[]};
  let map;
  try{
    map = new maplibregl.Map({
      container:'map',
      style:EMPTY_STYLE,
      center:[135.79,34.51], zoom:8.2,
      attributionControl:false,
      preserveDrawingBuffer:true
    });
  }catch(e){ showErr('MapåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: '+e.message); return; }

  // ã‚«ãƒ¼ã‚½ãƒ«ï¼ˆãƒ‘ãƒ³æ™‚ã®è¦‹ãŸç›®ï¼‰
  map.on('mousedown',()=>{ map.getCanvas().style.cursor='grabbing'; });
  map.on('mouseup',()=>{ map.getCanvas().style.cursor='grab'; });

  // æ“¬ä¼¼3Dï¼ˆå³ãƒ‰ãƒ©ãƒƒã‚°å›è»¢ & ãƒ”ãƒƒãƒï¼‰
  map.dragRotate.enable(); map.touchPitch.enable();

  // ãƒ™ãƒ¼ã‚¹ãƒãƒƒãƒ—ï¼ˆé™°å½±èµ·ä¼å›³ã‚’æœ€ä¸‹å±¤ã€ãã®ä¸Šã«OSM/åœ°ç†é™¢ï¼‰
  function addBasemap(){
    if(!map.getSource('gsi-relief')) map.addSource('gsi-relief',{type:'raster',tiles:['https://cyberjapandata.gsi.go.jp/xyz/hillshademap/{z}/{x}/{y}.png'],tileSize:256,attribution:'åœ°ç†é™¢ã‚¿ã‚¤ãƒ«ï¼ˆé™°å½±èµ·ä¼å›³ï¼‰'});
    if(!map.getLayer('bm-relief')) map.addLayer({id:'bm-relief',type:'raster',source:'gsi-relief',paint:{'raster-opacity':1.0}});
    if(!map.getSource('osm')) map.addSource('osm',{type:'raster',tiles:['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],tileSize:256,attribution:'Â© OpenStreetMap contributors'});
    if(!map.getSource('gsi-std')) map.addSource('gsi-std',{type:'raster',tiles:['https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png'],tileSize:256,attribution:'åœ°ç†é™¢ æ¨™æº–åœ°å›³'});
    if(!map.getSource('gsi-photo')) map.addSource('gsi-photo',{type:'raster',tiles:['https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/{z}/{x}/{y}.jpg'],tileSize:256,attribution:'åœ°ç†é™¢ æœ€æ–°å†™çœŸ'});
    if(!map.getLayer('bm-osm')) map.addLayer({id:'bm-osm',type:'raster',source:'osm',paint:{'raster-opacity':0.85}});
    if(!map.getLayer('bm-gsi-std')) map.addLayer({id:'bm-gsi-std',type:'raster',source:'gsi-std',paint:{'raster-opacity':0.85}});
    if(!map.getLayer('bm-gsi-photo')) map.addLayer({id:'bm-gsi-photo',type:'raster',source:'gsi-photo',paint:{'raster-opacity':0.85}});
  }
  function showBM(id){ ['bm-osm','bm-gsi-std','bm-gsi-photo'].forEach(l=> map.getLayer(l)&&map.setLayoutProperty(l,'visibility', l===id?'visible':'none')); }
  $('bm-osm').onclick=()=>showBM('bm-osm');
  $('bm-gsi-std').onclick=()=>showBM('bm-gsi-std');
  $('bm-gsi-photo').onclick=()=>showBM('bm-gsi-photo');

  map.on('load', ()=>{
    addBasemap(); showBM('bm-osm');
    map.addControl(new maplibregl.AttributionControl({
      customAttribution:'Â© OpenStreetMap contributors | <a target="_blank" href="https://maps.gsi.go.jp/development/ichiran.html">åœ°ç†é™¢ã‚¿ã‚¤ãƒ«</a>'
    }), 'bottom-right');

    // åˆæœŸä½ç½®ï¼šç¾åœ¨åœ°â†’å¤±æ•—æ™‚ã¯å¥ˆè‰¯çœŒä»˜è¿‘
    if(navigator.geolocation){
      navigator.geolocation.getCurrentPosition(
        p=>map.jumpTo({center:[p.coords.longitude,p.coords.latitude],zoom:14}),
        _=>map.jumpTo({center:[135.79,34.51],zoom:8.2}),
        {enableHighAccuracy:true,timeout:7000}
      );
    }else map.jumpTo({center:[135.79,34.51],zoom:8.2});

    ensureHazardSources();
  });

  // ç¸®å°ºï¼†æ–¹è§’ï¼ˆå³ä¸Šï¼‰
  map.addControl(new maplibregl.NavigationControl({showCompass:true,visualizePitch:true,showZoom:true}),'top-right');
  map.addControl(new maplibregl.ScaleControl({maxWidth:150,unit:'metric'}),'top-right');

  // ç¾åœ¨åœ°ï¼ˆé’ä¸¸ï¼‹ç²¾åº¦å††ï¼‹ãƒ‘ãƒ«ã‚¹ï¼‰
  class LocateControl {
    onAdd(map){
      this._map=map;
      this._container=document.createElement('div');
      this._container.className='maplibregl-ctrl maplibregl-ctrl-group';
      const btn=document.createElement('button');
      btn.type='button'; btn.title='ç¾åœ¨åœ°ã‚’è¡¨ç¤º'; btn.innerHTML='ğŸ“';
      btn.onclick=()=>this.locate();
      this._container.appendChild(btn);
      return this._container;
    }
    onRemove(){ this._container.remove(); this._map=null; if(this._marker) this._marker.remove(); if(this._map && this._map.getSource('loc-acc')){ this._map.removeLayer('loc-acc-fill'); this._map.removeSource('loc-acc'); } }
    locate(){
      if(!navigator.geolocation){ alert('ä½ç½®æƒ…å ±ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“'); return; }
      navigator.geolocation.getCurrentPosition(p=>{
        const ll=[p.coords.longitude,p.coords.latitude]; const acc=p.coords.accuracy||40;
        this._map.flyTo({center:ll,zoom:16});
        const wrap=document.createElement('div'); wrap.className='loc-wrap';
        wrap.innerHTML='<div class="loc-pulse"></div><div class="loc-dot"></div>';
        if(this._marker) this._marker.remove();
        this._marker=new maplibregl.Marker({element:wrap}).setLngLat(ll).addTo(this._map);
        const circle=turf.circle(ll, acc, {steps:64, units:'meters'});
        if(!this._map.getSource('loc-acc')){
          this._map.addSource('loc-acc',{type:'geojson',data:circle});
          this._map.addLayer({id:'loc-acc-fill',type:'fill',source:'loc-acc',paint:{'fill-color':'#60a5fa','fill-opacity':0.15}});
        }else{
          this._map.getSource('loc-acc').setData(circle);
        }
      }, err=>alert('ç¾åœ¨åœ°ã®å–å¾—ã«å¤±æ•—ï¼š'+err.message), {enableHighAccuracy:true,timeout:7000});
    }
  }
  map.addControl(new LocateControl(),'top-right');

  // ========= ãƒã‚¶ãƒ¼ãƒ‰ =========
  function ensureHazardSources(){
    if(!map.getSource('flood')){
      map.addSource('flood',{type:'raster',tiles:['https://disaportaldata.gsi.go.jp/raster/01_flood_l2_shinsuishin_data/{z}/{x}/{y}.png'],tileSize:256});
      map.addLayer({id:'flood',type:'raster',source:'flood',paint:{'raster-opacity':0.6},layout:{visibility:'none'}});
    }
    ['dosha0','dosha1','dosha2'].forEach((id,i)=>{
      if(!map.getSource(id)){
        const p=['05_dosekiryukeikaikuiki','05_kyukeishakeikaikuiki','05_jisuberikeikaikuiki'][i];
        map.addSource(id,{type:'raster',tiles:[`https://disaportaldata.gsi.go.jp/raster/${p}/{z}/{x}/{y}.png`],tileSize:256});
        map.addLayer({id, type:'raster', source:id, paint:{'raster-opacity':0.6}, layout:{visibility:'none'}});
      }
    });
  }
  $('hazard-header').addEventListener('click',()=>{ const b=$('hazard-body'); b.style.display=(b.style.display==='none')?'block':'none'; $('hazard-fold').textContent=(b.style.display==='none')?'â–²':'â–¼'; });
  $('chk-flood').addEventListener('change',e=>{ ensureHazardSources(); map.setLayoutProperty('flood','visibility', e.target.checked?'visible':'none'); });
  $('chk-dosha').addEventListener('change',e=>{ ['dosha0','dosha1','dosha2'].forEach(id=> map.setLayoutProperty(id,'visibility', e.target.checked?'visible':'none')); });
  $('hazard-opacity').addEventListener('input',e=>{ const o=+e.target.value; $('hazard-ov').textContent=o.toFixed(2); if(map.getLayer('flood')) map.setPaintProperty('flood','raster-opacity',o); ['dosha0','dosha1','dosha2'].forEach(id=> map.getLayer(id)&&map.setPaintProperty(id,'raster-opacity',o)); });

  // ========= Draw & Feature =========
  let draw;
  try{
    draw = DrawCtor ? new DrawCtor({displayControlsDefault:false}) : null;
    if(draw) map.addControl(draw,'top-left');
  }catch(e){ showErr('DrawåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: '+e.message); }

  // è¿½åŠ æ™‚ã‚«ãƒ¼ã‚½ãƒ«ï¼ˆï¼‹ï¼‰
  function setCursorPlus(on){
    const dataURI = "url('data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2224%22 height=%2224%22><text x=%224%22 y=%2218%22 font-size=%2220%22 font-family=%22Arial%22 fill=%22black%22>+</text></svg>') 12 12, crosshair";
    map.getCanvas().style.cursor = on ? dataURI : 'grab';
  }

  // å…±æœ‰ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã¯ãƒ­ãƒ¼ã‚«ãƒ«é…åˆ—ï¼‰
  const hasY=!!(window.Y&&window.ywebrtc);
  const ydoc=hasY?new Y.Doc():null;
  const provider=hasY&&ROOM_ID?new ywebrtc.WebrtcProvider(ROOM_ID, ydoc):null;
  const yFeatures=hasY?ydoc.getArray('features'):null;
  const yGroups=hasY?ydoc.getArray('groupList'):null;
  const localFeatures=[]; 
  const localGroups=[{id:'__ungroup',name:'æœªåˆ†é¡',order:0,visible:true}];
  const featsArr = ()=> hasY?yFeatures.toArray():localFeatures;
  const setFeats = (arr)=>{ if(hasY){ yFeatures.delete(0,yFeatures.length); arr.forEach(f=>yFeatures.push([f])); } else { localFeatures.splice(0,localFeatures.length,...arr); } };
  const groupsArr= ()=> hasY?yGroups.toArray():localGroups;
  const setGroups=(arr)=>{ if(hasY){ yGroups.delete(0,yGroups.length); arr.forEach(g=>yGroups.push([g])); } else { localGroups.splice(0,localGroups.length,...arr); } };
  if(hasY && yGroups && yGroups.length===0) yGroups.push([{id:'__ungroup',name:'æœªåˆ†é¡',order:0,visible:true}]);

  // ç·¨é›†ã‚¬ãƒ¼ãƒ‰ä»˜ã CRUD
  const nowId=()=> 'id_'+Date.now().toString(36)+Math.random().toString(36).slice(2,7);
  function addF(f){ if(!allowEdit()) return alert('ã¾ãšã€Œéƒ¨å±‹ã‚’ä½œæˆã€â†’ã€Œç·¨é›†ãƒªãƒ³ã‚¯ã‚’ä½œæˆã€ã—ã¦ãã ã•ã„'); if(hasY) yFeatures.push([f]); else localFeatures.push(f); renderAll(); }
  function updF(id,fn){ if(!allowEdit()) return alert('ç·¨é›†ãƒªãƒ³ã‚¯ã‚’ä½œæˆã—ã¦ãã ã•ã„'); const a=featsArr(); const i=a.findIndex(x=>x.id===id); if(i<0)return; const n=structuredClone(a[i]); fn(n); a[i]=n; setFeats(a); renderAll(); }
  function delF(id){ if(!allowEdit()) return alert('ç·¨é›†ãƒªãƒ³ã‚¯ã‚’ä½œæˆã—ã¦ãã ã•ã„'); const a=featsArr(); const i=a.findIndex(x=>x.id===id); if(i<0)return; a.splice(i,1); setFeats(a); renderAll(); }

  // ãƒãƒ¼ã‚«ãƒ¼é¡
  const labelMarkers=new Map(), pinMarkers=new Map(), photoMarkers=new Map(), photosFull=new Map();
  function clearMarkers(){ labelMarkers.forEach(m=>m.remove()); labelMarkers.clear(); pinMarkers.forEach(m=>m.remove()); pinMarkers.clear(); photoMarkers.forEach(m=>m.remove()); photoMarkers.clear(); }
  function addLabelMarker(id, lngLat, text){ if(!text) return; const el=document.createElement('div'); el.className='mlabel'; el.textContent=String(text); labelMarkers.set(id,new maplibregl.Marker({element:el,anchor:'top'}).setLngLat(lngLat).addTo(map)); }
  function addPinMarker(f){ const color=f.properties?.styleColor||'#d00'; const size=Number(f.properties?.styleSize ?? 50); const el=document.createElement('div'); el.innerHTML=`<svg class="pin" width="${size}" height="${size}" viewBox="0 0 24 24" fill="${color}" stroke="#fff" stroke-width="1.5"><path d="M12 22s-6-5.33-6-10a6 6 0 1 1 12 0c0 4.67-6 10-6 10z"></path><circle cx="12" cy="10" r="2.8" fill="#fff"/></svg>`; pinMarkers.set(f.id,new maplibregl.Marker({element:el,anchor:'bottom'}).setLngLat(f.geometry.coordinates).addTo(map)); }
  function addPhotoMarker(f){ const el=document.createElement('div'); el.style.display='flex'; el.style.flexDirection='column'; el.style.alignItems='center'; const img=document.createElement('img'); img.src=f.properties.thumb; img.className='photo-thumb'; img.alt=f.properties.label||'photo'; el.appendChild(img); if(f.properties?.label){ const cap=document.createElement('div'); cap.textContent=f.properties.label; cap.style.fontSize='.8rem'; cap.style.marginTop='.2rem'; el.appendChild(cap); } img.onclick=()=>{ const full=photosFull.get(f.id)||f.properties.thumb; $('modal-img').src=full; $('modal').style.display='flex'; }; photoMarkers.set(f.id,new maplibregl.Marker({element:el,anchor:'bottom'}).setLngLat(f.geometry.coordinates).addTo(map)); }
  function labelCoordFor(f){ try{ if(f.geometry.type==='Point') return f.geometry.coordinates; if(f.geometry.type==='LineString') return turf.center(f).geometry.coordinates; return turf.centerOfMass(f).geometry.coordinates; }catch(_){ return null; } }
  function ensureGeomLayers(){
    if(!map.getSource('geom-src')) map.addSource('geom-src',{type:'geojson',data:{type:'FeatureCollection',features:[]}}); 
    if(!map.getLayer('geom-line')) map.addLayer({id:'geom-line',type:'line',source:'geom-src',filter:['==',['geometry-type'],'LineString'],paint:{'line-color':['coalesce',['get','styleColor'],'#2563eb'],'line-width':['coalesce',['get','styleWidth'],3]}});
    if(!map.getLayer('geom-fill')) map.addLayer({id:'geom-fill',type:'fill',source:'geom-src',filter:['==',['geometry-type'],'Polygon'],paint:{'fill-color':['coalesce',['get','styleColor'],'#22c55e'],'fill-opacity':0.2}});
    if(!map.getLayer('geom-outline')) map.addLayer({id:'geom-outline',type:'line',source:'geom-src',filter:['==',['geometry-type'],'Polygon'],paint:{'line-color':['coalesce',['get','styleColor'],'#15803d'],'line-width':['coalesce',['get','styleWidth'],2]}});
  }
  function renderAll(){
    const feats=featsArr(); clearMarkers(); ensureGeomLayers(); const geo=[];
    feats.forEach(f=>{
      if(f.properties?.visible===false) return;
      if(f.properties?.kind==='pin') addPinMarker(f);
      else if(f.properties?.kind==='photo') addPhotoMarker(f);
      else geo.push(f);
      if(f.properties?.label){ const p=labelCoordFor(f); if(p) addLabelMarker('lbl_'+f.id,p,f.properties.label); }
    });
    map.getSource('geom-src').setData({type:'FeatureCollection',features:geo});
    rebuildSidebar();
  }

  // ===== ãƒ„ãƒ¼ãƒ«ï¼ˆé¸æŠ/ãƒ”ãƒ³/ãƒ©ã‚¤ãƒ³/ãƒãƒª/å††/å†™çœŸï¼‰ =====
  let tool='select', pinHandler=null, circleState=null, moveHandler=null, clickHandler=null;
  function setTool(t){
    if(!allowEdit() && t!=='select'){ alert('ã¾ãšã€Œéƒ¨å±‹ã‚’ä½œæˆã€â†’ã€Œç·¨é›†ãƒªãƒ³ã‚¯ã‚’ä½œæˆã€ã—ã¦ãã ã•ã„'); t='select'; }
    tool=t;
    ['tool-select','tool-pin','tool-line','tool-poly','tool-circle','tool-photo'].forEach(id=>$(''+id).classList.remove('active'));
    $('tool-'+t).classList.add('active');
    setCursorPlus(t!=='select' && t!=='photo');
    if(t==='select') map.getCanvas().style.cursor='grab';

    if(pinHandler){ map.off('click', pinHandler); pinHandler=null; }
    if(moveHandler){ map.off('mousemove', moveHandler); moveHandler=null; }
    if(clickHandler){ map.off('click', clickHandler); clickHandler=null; }
    removeCirclePreview();

    if(!draw && (t==='line'||t==='poly')){ alert('æç”»ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“'); return; }

    if(t==='select'){ draw && draw.changeMode('simple_select'); return; }
    if(t==='line'){   draw.changeMode('draw_line_string'); return; }
    if(t==='poly'){   draw.changeMode('draw_polygon'); return; }
    if(t==='pin'){
      draw && draw.changeMode('simple_select');
      pinHandler=(e)=>{
        const [lon,lat]=e.lngLat.toArray();
        const label=prompt('ãƒ©ãƒ™ãƒ«ï¼ˆä»»æ„ï¼‰')||'';
        addF({type:'Feature',id:nowId(),geometry:{type:'Point',coordinates:[lon,lat]},
          properties:{kind:'pin',label,visible:true,lon,lat,styleColor:'#d00',styleSize:50}});
      };
      map.on('click', pinHandler);
      return;
    }
    if(t==='circle'){
      draw && draw.changeMode('simple_select');
      circleState={center:null};
      clickHandler=(e)=>{
        const pt=e.lngLat.toArray();
        if(!circleState.center){
          circleState.center=pt; addCirclePreview(pt,1);
        }else{
          const r_m=turf.distance(circleState.center, pt, {units:'kilometers'})*1000;
          const poly=turf.circle(circleState.center, r_m, {steps:64,units:'meters'});
          const label=prompt('ãƒ©ãƒ™ãƒ«ï¼ˆä»»æ„ï¼‰')||'';
          addF({type:'Feature',id:nowId(),geometry:poly.geometry,
            properties:{kind:'circle',label,visible:true,styleColor:'#22c55e',styleWidth:2,radius_m:Math.round(r_m)}});
          removeCirclePreview(); circleState=null; setTool('select');
        }
      };
      moveHandler=(e)=>{
        if(!circleState||!circleState.center) return;
        const r_m=turf.distance(circleState.center, e.lngLat.toArray(), {units:'kilometers'})*1000;
        updateCirclePreview(circleState.center, r_m);
      };
      map.on('click', clickHandler); map.on('mousemove', moveHandler);
      return;
    }
    if(t==='photo'){ $('photo-input').click(); return; }
  }
  ['select','pin','line','poly','circle','photo'].forEach(k=>{$('tool-'+k).onclick=()=>setTool(k);});
  setTool('select');

  // å††ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆæ¿ƒç·šï¼‹ç™½ç¸ï¼‰
  function addCirclePreview(center,r_m){
    const poly=turf.circle(center, r_m, {steps:64,units:'meters'});
    if(!map.getSource('circle-prev')) map.addSource('circle-prev',{type:'geojson',data:poly}); else map.getSource('circle-prev').setData(poly);
    if(!map.getLayer('circle-prev-line')){
      map.addLayer({id:'circle-prev-line',type:'line',source:'circle-prev',
        paint:{'line-color':'#0f172a','line-width':3,'line-dasharray':[3,2]}});
    }
    if(!map.getLayer('circle-prev-outline')){
      map.addLayer({id:'circle-prev-outline',type:'line',source:'circle-prev',
        paint:{'line-color':'#ffffff','line-width':5,'line-opacity':0.35}});
    }
  }
  function updateCirclePreview(center,r_m){ const poly=turf.circle(center, r_m, {steps:64,units:'meters'}); if(map.getSource('circle-prev')) map.getSource('circle-prev').setData(poly); }
  function removeCirclePreview(){ ['circle-prev-outline','circle-prev-line'].forEach(id=>{ if(map.getLayer(id)) map.removeLayer(id); }); if(map.getSource('circle-prev')) map.removeSource('circle-prev'); }

  // Draw å®Œäº†ï¼ˆãƒ©ã‚¤ãƒ³/ãƒãƒªã‚´ãƒ³ï¼‰
  map.on('draw.create',(e)=>{ const f=e.features?.[0]; if(!f) return; if(f.geometry.type==='Point'){ draw.delete(f.id); return; } const label=prompt('ãƒ©ãƒ™ãƒ«ï¼ˆä»»æ„ï¼‰')||''; const kind=(f.geometry.type==='LineString'?'line':'polygon'); addF({type:'Feature',id:nowId(),geometry:f.geometry,properties:{kind,label,visible:true,styleColor:(kind==='line')?'#2563eb':'#22c55e',styleWidth:3}}); draw.delete(f.id); });

  // å†™çœŸï¼ˆEXIFâ†’ç·¯åº¦çµŒåº¦ / ç„¡ã‘ã‚Œã°ã‚¯ãƒªãƒƒã‚¯ã§æŒ‡å®šï¼‰
  const pendingPhotos=[];
  $('photo-input').addEventListener('change', async ev=>{
    const files=Array.from(ev.target.files||[]); if(!files.length) return;
    for(const file of files){
      try{
        const meta=await exifr.parse(file).catch(()=>null);
        const url=URL.createObjectURL(file);
        const thumb=await createThumb(url,256);
        if(meta && meta.longitude!=null && meta.latitude!=null){
          const label=prompt('å†™çœŸã®ãƒ©ãƒ™ãƒ«ï¼ˆä»»æ„ï¼‰')||'';
          addF({type:'Feature',id:nowId(),geometry:{type:'Point',coordinates:[meta.longitude,meta.latitude]},properties:{kind:'photo',label,visible:true,thumb,url}});
        }else{
          pendingPhotos.push({url,thumb});
          alert('å†™çœŸã®ä½ç½®ã‚’åœ°å›³ä¸Šã§1å›ã‚¯ãƒªãƒƒã‚¯ã—ã¦æŒ‡å®šã—ã¦ãã ã•ã„ã€‚');
          const placeOnce=(e)=>{ const coords=e.lngLat.toArray(); const ph=pendingPhotos.shift(); const label=prompt('å†™çœŸã®ãƒ©ãƒ™ãƒ«ï¼ˆä»»æ„ï¼‰')||''; addF({type:'Feature',id:nowId(),geometry:{type:'Point',coordinates:coords},properties:{kind:'photo',label,visible:true,thumb:ph.thumb,url:ph.url}}); map.off('click',placeOnce); };
          map.on('click', placeOnce);
        }
      }catch{ showErr('å†™çœŸã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
    }
    ev.target.value='';
  });
  function createThumb(src,maxW){ return new Promise(res=>{ const img=new Image(); img.crossOrigin='anonymous'; img.onload=()=>{ const s=Math.min(1,maxW/img.width); const w=img.width*s, h=img.height*s; const c=document.createElement('canvas'); c.width=w; c.height=h; c.getContext('2d').drawImage(img,0,0,w,h); res(c.toDataURL('image/jpeg',0.75)); }; img.src=src; }); }

  // ========= ã‚°ãƒ«ãƒ¼ãƒ— & ã‚µã‚¤ãƒ‰ãƒãƒ¼ =========
  function ensureGroup(name){ const gl=groupsArr(); const ex=gl.find(g=>g.name===name); if(ex) return ex.id; const id='g_'+rand(8); const max=Math.max(0,...gl.map(g=>g.order||0)); const ng={id,name,order:max+1,visible:true}; setGroups([...gl,ng]); return id; }

  function rebuildSidebar(){
    const feats=featsArr();
    const gl=groupsArr();
    const list=$('list'); list.innerHTML='';

    const by=new Map(gl.map(g=>[g.id,[]]));
    feats.forEach(f=>{ const gid=f.properties?.group||'__ungroup'; if(!by.has(gid)) by.set(gid,[]); by.get(gid).push(f); });

    gl.sort((a,b)=>(a.order||0)-(b.order||0)).forEach(g=>{
      const wrap=document.createElement('div'); wrap.className='group'; wrap.dataset.gid=g.id;

      // group head
      const head=document.createElement('div'); head.className='ghead';
      const title=document.createElement('span'); title.textContent=g.name||'ã‚°ãƒ«ãƒ¼ãƒ—';

      const paint=document.createElement('span'); paint.textContent='ğŸ¨'; paint.title='ã“ã®ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä¸€æ‹¬ã‚¹ã‚¿ã‚¤ãƒ«';
      paint.onclick=()=>{ const ids=(by.get(g.id)||[]).map(f=>f.id); if(!ids.length) return alert('ã“ã®ã‚°ãƒ«ãƒ¼ãƒ—ã«ã¯ãƒ¬ã‚¤ãƒ¤ãŒã‚ã‚Šã¾ã›ã‚“'); openStyleDialogFor(ids,false,true); };

      const eye=document.createElement('span'); eye.textContent=g.visible===false?'ğŸ™ˆ':'ğŸ‘';
      eye.onclick=()=>{ const next=!(g.visible===false); g.visible=!next; setGroups(gl);
        const feats2=structuredClone(featsArr()).map(f=>{ if((f.properties?.group||'__ungroup')===g.id){ f.properties={...(f.properties||{}), visible:!next}; } return f; }); setFeats(feats2); };

      // ãƒ‰ãƒ­ãƒƒãƒ—ã§ã“ã®ã‚°ãƒ«ãƒ¼ãƒ—ã¸ç§»å‹•
      head.ondragover=ev=>ev.preventDefault();
      head.ondrop=ev=>{ ev.preventDefault(); const fid=ev.dataTransfer.getData('text/plain'); if(!fid) return; updF(fid,n=>{ n.properties.group=g.id; }); };

      head.appendChild(title); head.appendChild(paint); head.appendChild(eye);
      wrap.appendChild(head);

      // items
      const items=document.createElement('div'); items.className='gitems';
      (by.get(g.id)||[]).forEach(f=>{
        const it=document.createElement('div'); it.className='item'; it.draggable=true; it.dataset.fid=f.id;

        // DnDï¼šãƒ¬ã‚¤ãƒ¤â†’ãƒ¬ã‚¤ãƒ¤ï¼ˆé‡ã­ï¼‰ã§ä¸¡æ–¹æ–°ã‚°ãƒ«ãƒ¼ãƒ—
        it.ondragstart=(ev)=>{ ev.dataTransfer.setData('text/plain', f.id); };
        it.ondragover=(ev)=>ev.preventDefault();
        it.ondrop=(ev)=>{ ev.preventDefault(); const fromId=ev.dataTransfer.getData('text/plain'); if(!fromId || fromId===f.id) return; const name=prompt('æ–°ã—ã„ã‚°ãƒ«ãƒ¼ãƒ—å'); if(!name) return; moveToNewGroup([fromId, f.id], name); };

        const eye=document.createElement('span'); eye.className='eye'; eye.textContent=f.properties?.visible===false?'ğŸ™ˆ':'ğŸ‘';
        eye.onclick=(ev)=>{ ev.stopPropagation(); updF(f.id,n=>{ n.properties.visible=!n.properties.visible; }); };

        const nm=document.createElement('span'); nm.className='name'; nm.textContent=f.properties?.label||f.properties?.kind||'obj';
        nm.onclick=()=> zoomToFeature(f); // â† ãƒ¬ã‚¤ãƒ¤åã‚¯ãƒªãƒƒã‚¯ã§ã‚ºãƒ¼ãƒ 

        const edit=document.createElement('span'); edit.className='edit'; edit.textContent='âœï¸';
        edit.onclick=(ev)=>{ ev.stopPropagation(); if(!allowEdit()) return alert('ç·¨é›†ãƒªãƒ³ã‚¯ã‚’ä½œæˆã—ã¦ãã ã•ã„'); const v=prompt('ãƒ©ãƒ™ãƒ«ã‚’ç·¨é›†', f.properties?.label||''); if(v===null) return; updF(f.id,n=>{ n.properties.label=v; }); };

        const paintI=document.createElement('span'); paintI.className='paint'; paintI.textContent='ğŸ¨';
        paintI.onclick=(ev)=>{ ev.stopPropagation(); openStyleDialogFor([f.id], f.properties.kind==='pin'); };

        const del=document.createElement('span'); del.className='del'; del.textContent='ğŸ—‘';
        del.onclick=(ev)=>{ ev.stopPropagation(); if(!allowEdit()) return alert('ç·¨é›†ãƒªãƒ³ã‚¯ã‚’ä½œæˆã—ã¦ãã ã•ã„'); if(confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) delF(f.id); };

        it.appendChild(eye); it.appendChild(nm); it.appendChild(edit); it.appendChild(paintI); it.appendChild(del);
        items.appendChild(it);
      });

      wrap.appendChild(items);
      list.appendChild(wrap);
    });
  }

  function moveToNewGroup(ids,name){
    const gid=ensureGroup(name);
    const arr=structuredClone(featsArr()).map(f=>{ if(ids.includes(f.id)){ f.properties={...(f.properties||{}), group:gid, visible:(f.properties?.visible!==false)}; } return f; });
    setFeats(arr); rebuildSidebar();
  }

  function zoomToFeature(f){
    try{
      if(f.geometry.type==='Point'){
        map.flyTo({center:f.geometry.coordinates, zoom:17});
      }else{
        const b=turf.bbox(f);
        map.fitBounds([[b[0],b[1]],[b[2],b[3]]],{padding:60, maxZoom:18});
      }
    }catch(e){ console.warn('zoom failed', e); }
  }

  // è¿½åŠ ãƒœã‚¿ãƒ³ç¾¤
  $('btn-add-group').onclick=()=>{ if(!allowEdit()) return alert('ã¾ãšã€Œéƒ¨å±‹ã‚’ä½œæˆã€â†’ã€Œç·¨é›†ãƒªãƒ³ã‚¯ã‚’ä½œæˆã€ã—ã¦ãã ã•ã„'); const name=prompt('ã‚°ãƒ«ãƒ¼ãƒ—å'); if(!name) return; ensureGroup(name); rebuildSidebar(); };
  $('btn-bulk-style').onclick=()=>{ if(!allowEdit()) return alert('ç·¨é›†ãƒªãƒ³ã‚¯ã‚’ä½œæˆã—ã¦ãã ã•ã„'); const ids=featsArr().map(f=>f.id); if(!ids.length) return alert('å¯¾è±¡ã®ãƒ¬ã‚¤ãƒ¤ãŒã‚ã‚Šã¾ã›ã‚“'); openStyleDialogFor(ids,false,true); };
  $('btn-toggle-all').onclick=()=>{ if(!allowEdit()) return alert('ç·¨é›†ãƒªãƒ³ã‚¯ã‚’ä½œæˆã—ã¦ãã ã•ã„'); const feats=structuredClone(featsArr()); const anyHidden=feats.some(f=>f.properties?.visible===false); feats.forEach(f=>{ f.properties={...(f.properties||{}), visible:anyHidden}; }); setFeats(feats); };

  // ã‚¹ã‚¿ã‚¤ãƒ«ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ï¼ˆè¤‡æ•°IDå¯¾å¿œï¼‰
  let styleTarget=null;
  function openStyleDialogFor(ids, isPinExplicit=false){
    styleTarget={ids};
    const feats=featsArr(); const f=feats.find(x=>x.id===ids[0]);
    const isPin = isPinExplicit || (f && f.properties.kind==='pin');
    $('val-label').textContent=isPin?'å¤§ãã•(px)':'ç·šå¹…(px)';
    $('inp-range').min=1; $('inp-range').max=isPin?80:30;
    $('inp-range').value=isPin?(f?.properties.styleSize??50):(f?.properties.styleWidth??3);
    $('val-num').textContent=$('inp-range').value;
    $('inp-color').value=f?.properties.styleColor||'#22c55e';
    $('style-dialog').style.display='flex';
  }
  $('inp-range').addEventListener('input',()=>{ $('val-num').textContent=$('inp-range').value; });
  $('btn-style-cancel').onclick=()=>{ $('style-dialog').style.display='none'; styleTarget=null; };
  $('btn-style-apply').onclick=()=>{
    if(!styleTarget) return;
    const color=$('inp-color').value; const val=Number($('inp-range').value);
    styleTarget.ids.forEach(id=>{
      updF(id,n=>{
        n.properties.styleColor=color;
        if(n.properties.kind==='pin') n.properties.styleSize=val; else n.properties.styleWidth=val;
      });
    });
    $('style-dialog').style.display='none'; styleTarget=null;
  };

  // åˆæœŸæç”» & åŒæœŸ
  renderAll();
  if(hasY && yFeatures){ yFeatures.observe(()=>renderAll()); }

  // === ãƒªãƒ³ã‚¯ç™ºè¡Œï¼ˆéƒ¨å±‹â†’ç·¨é›†ã®é †åºã‚’å¼·åˆ¶ï¼‰ ===
  $('btn-make-room').onclick=()=>{
    const q=getHash();
    q.set('r', rand(12));
    q.delete('k'); // ç·¨é›†ã‚­ãƒ¼ã¯ã¾ã 
    setHash(q);    // ãƒªãƒ­ãƒ¼ãƒ‰ä¸è¦
    ROOM_ID = q.get('r'); EDITOR_KEY = '';
    updateRoleUI();
    alert('éƒ¨å±‹ã‚’ä½œæˆã—ã¾ã—ãŸã€‚æ¬¡ã«ã€Œç·¨é›†ãƒªãƒ³ã‚¯ã‚’ä½œæˆã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚');
  };
  $('btn-make-editor').onclick=()=>{
    const q=getHash();
    if(!q.get('r')){ alert('å…ˆã«ã€Œéƒ¨å±‹ã‚’ä½œæˆã€ã—ã¦ãã ã•ã„'); return; }
    q.set('k', rand(16));
    setHash(q);
    ROOM_ID = q.get('r'); EDITOR_KEY = q.get('k');
    updateRoleUI();
    navigator.clipboard.writeText(location.href).then(()=>alert('ç·¨é›†ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'));
  };
  $('btn-copy-view').onclick=()=>{
    const q=getHash();
    if(!q.get('r')) q.set('r', rand(12));
    q.delete('k'); q.delete('state');
    const url=location.origin+location.pathname+'#'+q.toString();
    navigator.clipboard.writeText(url).then(()=>alert('é–²è¦§ç”¨ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'));
  };

  // === ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆGeoJSONã‚’zipï¼‰ ===
  function pad2(n){return String(n).padStart(2,'0');}
  $('btn-export').onclick=()=>{
    const zip=new JSZip();
    const feats=featsArr();
    const points=feats.filter(f=>f.properties.kind==='pin'||f.properties.kind==='photo');
    const lines =feats.filter(f=>f.properties.kind==='line');
    const polys =feats.filter(f=>f.properties.kind==='polygon'||f.properties.kind==='circle');
    const t=new Date(); const stamp=`${t.getFullYear()}${pad2(t.getMonth()+1)}${pad2(t.getDate())}_${pad2(t.getHours())}${pad2(t.getMinutes())}${pad2(t.getSeconds())}`;
    zip.file(`points_${stamp}.geojson`,JSON.stringify({type:'FeatureCollection',features:points},null,2));
    zip.file(`lines_${stamp}.geojson`, JSON.stringify({type:'FeatureCollection',features:lines},null,2));
    zip.file(`polygons_${stamp}.geojson`,JSON.stringify({type:'FeatureCollection',features:polys},null,2));
    zip.generateAsync({type:'blob'}).then(b=>{
      const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download=`export_${stamp}.zip`; a.click();
    });
  };

  // === ã‚¹ã‚¯ã‚·ãƒ§ï¼ˆãƒˆãƒƒãƒ—/ä¸‹éƒ¨/ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆå«ã‚€ï¼‰ ===
  $('btn-screenshot').onclick=async()=>{
    try{
      const canvas=await html2canvas(document.body,{backgroundColor:'#fff',scale:2,useCORS:true});
      const a=document.createElement('a');
      a.href=canvas.toDataURL('image/png');
      a.download='screenshot_'+(new Date().toISOString().replace(/[:T\-]/g,'').slice(0,14))+'.png';
      a.click();
    }catch(e){ console.error(e); alert('ã‚¹ã‚¯ã‚·ãƒ§ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
  };

}); // DOMContentLoaded
</script>
</body>
</html>
