<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PHN Field Collab（Supabase公開FGB / 共同編集 / GPS / 市区町村フィルタ）</title>

  <!-- MapLibre & Draw CSS -->
  <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css">
  <link rel="stylesheet" href="https://unpkg.com/@mapbox/mapbox-gl-draw@1.5.0/dist/mapbox-gl-draw.css">

  <!-- UI 全体のスタイル（機能美寄り / 半透明パネル） -->
  <style>
    html, body, #map { height: 100%; width: 100%; margin: 0; padding: 0; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans JP", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
      color: #111827;
    }

    /* 上部ツールバー（簡易） */
    .topbar {
      position: absolute; left: 12px; right: 12px; top: 8px; z-index: 30;
      display: flex; align-items: center; gap: 8px; flex-wrap: wrap;
      pointer-events: none;
    }
    .chip {
      pointer-events: auto;
      padding: 6px 10px; border-radius: 10px; border: 1px solid #e5e7eb;
      background: rgba(255,255,255,0.9); backdrop-filter: blur(6px);
      font-size: 12px; font-weight: 700; cursor: default;
      user-select: none;
    }
    .chip.btn { cursor: pointer; background: #0ea5e9; color: #fff; }
    .chip.btn.secondary { background: #eef2ff; color: #111827; }

    /* 左のメインパネル（半透明） */
    .panel {
      position: absolute; left: 12px; top: 56px; width: 320px; max-height: calc(100% - 68px);
      padding: 12px; border-radius: 12px;
      background: rgba(255,255,255,0.86); backdrop-filter: blur(6px);
      box-shadow: 0 8px 28px rgba(0,0,0,0.12);
      overflow: auto; z-index: 20;
    }
    .panel h3 { margin: 0 0 8px; font-size: 16px; }
    .panel .group { margin: 10px 0; }
    .panel label { font-size: 13px; display:inline-flex; align-items:center; gap:6px; margin-right:10px; }
    .panel .row { display:flex; gap:8px; }
    .panel .row>* { flex: 1 1 0; }
    .panel input[type="text"], .panel select {
      width:100%; padding:8px 10px; border:1px solid #e5e7eb; border-radius:10px; background:#fff; font-size:13px;
    }
    .panel .btn {
      display:inline-block; padding:8px 12px; border-radius:10px; border:1px solid #e5e7eb;
      background:#0ea5e9; color:#fff; font-weight:700; cursor:pointer; text-align:center;
    }
    .panel .btn.secondary { background:#f3f4f6; color:#111827; }
    .panel .btn:disabled { opacity:.55; cursor:not-allowed; }

    /* 右のレイヤパネル（軽量） */
    .rightpane {
      position:absolute; right:12px; top:56px; width:280px; max-height: calc(100% - 68px);
      padding:10px; border-radius:12px; background: rgba(255,255,255,0.88); backdrop-filter: blur(6px);
      box-shadow: 0 8px 28px rgba(0,0,0,0.12); overflow:auto; z-index:20;
    }
    .rightpane h4 { margin: 0 0 6px; font-size: 14px; }

    /* 左下：Supabase 操作パネル */
    .supabox {
      position: absolute; left:12px; bottom:12px; z-index: 20;
      min-width: 250px; padding: 10px; border-radius: 12px;
      background: rgba(255,255,255,0.88); backdrop-filter: blur(6px);
      box-shadow: 0 8px 28px rgba(0,0,0,.12);
    }
    .supabox h4 { margin: 0 0 6px; font-size: 14px; font-weight: 800; }
    .supabox .row { display:flex; gap:6px; flex-wrap: wrap; margin-bottom:6px; }
    .supabox button {
      padding:6px 9px; border-radius:10px; border:1px solid #e5e7eb; background:#f8fafc; cursor:pointer; font-size:12px;
    }
    .supabox button:hover { background:#eef2ff; }
    .supabox .danger { background:#fee2e2; border-color:#fecaca; }
    .supabox .wfull { flex: 1 1 100%; }

    /* サジェスト */
    .suggest {
      position:absolute; width:calc(100% - 24px); max-height:220px; overflow:auto; z-index: 40;
      background:#fff; border:1px solid #e5e7eb; border-radius:10px; box-shadow: 0 10px 28px rgba(0,0,0,0.12);
      display:none;
    }
    .suggest-item { padding:8px 10px; cursor:pointer; }
    .suggest-item:hover { background:#f1f5f9; }

    /* トースト / エラー */
    .toast {
      position: fixed; right: 12px; bottom: 12px; z-index: 40;
      background: #ecfeff; border: 1px solid #a5f3fc; border-radius: 10px; padding: 10px 12px; font-size: 12px;
    }
    .toast.bad { background:#fee2e2; border-color:#fecaca; color:#7f1d1d; }
    .errbar {
      position:absolute; left:50%; transform:translateX(-50%); top:8px; z-index:50;
      background:#fee2e2; color:#7f1d1d; border:1px solid #fecaca; border-radius:10px; padding:8px 12px; display:none;
    }

    /* ポップアップ内容の整形 */
    .popup-list { margin:0; padding:0; list-style:none; font-size:12px; max-width:320px; }
    .popup-list li { border-bottom:1px solid #f1f5f9; padding:6px 0; }
    .popup-list li:last-child { border-bottom:none; }
    .popup-list b { display:inline-block; min-width:120px; color:#374151; }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- 上部バー（簡易） -->
  <div class="topbar">
    <div class="chip">PHN Field Collab</div>
    <div class="chip">ベース: OSM</div>
    <div class="chip btn" id="btnNewRoom">部屋を作成</div>
    <div class="chip btn secondary" id="btnShareEdit">編集リンク</div>
    <div class="chip btn secondary" id="btnShareView">閲覧リンク</div>
    <div class="chip btn secondary" id="btnExport">エクスポート</div>
    <div style="flex:1"></div>
    <div class="chip" id="roomLabel">room: -</div>
  </div>

  <!-- メイン（左）パネル -->
  <div class="panel" id="panel">
    <h3>ハザード / 避難データ</h3>

    <div class="group">
      <label><input type="checkbox" id="chkFlood"> 洪水浸水想定区域（想定最大規模）</label><br>
      <label><input type="checkbox" id="chkSediment"> 土砂災害警戒区域（3種一括）</label>
      <div style="font-size:12px; color:#6b7280; margin:4px 0 6px">
        ※ハザードはベースとして準備のみ（URL未設定の場合は無効）
      </div>
      <div class="row" style="align-items:center">
        <div style="font-size:12px; min-width:64px">透明度</div>
        <input type="range" id="hazOpacity" min="0" max="1" step="0.05" value="0.60" />
        <div id="hazOpacityVal" style="width:36px; text-align:right; font-size:12px">0.60</div>
      </div>
      <div style="font-size:12px; color:#6b7280">凡例（洪水 / 土砂）</div>
      <div><img src="l2_flood_l.png" style="max-width:100%; opacity:.85" alt="凡例(洪水)"></div>
      <div><img src="l2_sediment_l.png" style="max-width:100%; opacity:.85" alt="凡例(土砂)"></div>
    </div>

    <div class="group">
      <div>表示範囲：</div>
      <label><input type="radio" name="areaMode" value="all" checked> 日本全国</label>
      <label><input type="radio" name="areaMode" value="pref"> 都道府県で絞る</label>
      <label><input type="radio" name="areaMode" value="muni"> 市区町村で絞る</label>
    </div>

    <div class="group" id="prefRow" style="display:none">
      <div style="font-size:12px;margin-bottom:4px">都道府県（複数選択可 / Ctrl+クリック）</div>
      <select id="prefSelect" multiple size="7"></select>
    </div>

    <div class="group" id="muniRow" style="display:none; position:relative">
      <div style="font-size:12px;margin-bottom:4px">市区町村（複数選択可 / Ctrl+クリック）</div>
      <input id="qMuni" type="text" placeholder="例）奈良市、生駒市 / 東京都">
      <div class="suggest" id="suggest"></div>
      <div style="height:6px"></div>
      <select id="muniSelect" multiple size="10"></select>
    </div>

    <div class="group">
      <label><input type="checkbox" id="chkLabel" checked> ラベル</label>
      <select id="labelFieldSelect" style="margin-left:8px"></select>
    </div>

    <div class="group">
      <div class="row">
        <button class="btn" id="btnApply">表示を更新</button>
        <button class="btn secondary" id="btnReset">リセット</button>
      </div>
      <div style="font-size:12px; color:#6b7280; margin-top:6px">
        ※「表示を更新」を押すと選択条件で絞り込みます
      </div>
    </div>
  </div>

  <!-- 右パネル（ダミーのレイヤ一覧） -->
  <div class="rightpane">
    <h4>レイヤ一覧</h4>
    <div style="font-size:12px; color:#6b7280">（ここは必要に応じて拡張可能です）</div>
  </div>

  <!-- Supabase 操作 -->
  <div class="supabox">
    <h4>共同編集 / GPS</h4>
    <div class="row">
      <button class="wfull" onclick="window.__supaload()">図形を再読込</button>
      <button class="wfull" onclick="window.__supasave()">図形を保存</button>
    </div>
    <div class="row">
      <button onclick="window.__gpstart()">GPS開始</button>
      <button class="danger" onclick="window.__gpstop()">GPS停止</button>
      <button onclick="window.__gpshow()">軌跡表示</button>
    </div>
    <div class="row">
      <button class="wfull" onclick="(async()=>{const e=prompt('メールアドレス'); if(!e)return; await __supa.auth.signInWithOtp({ email:e }); alert('届いたメールのリンクを開いたらこの画面に戻ってください');})();">メールでログイン</button>
      <button class="wfull" onclick="__supa.auth.signOut().then(()=>alert('サインアウトしました'))">サインアウト</button>
    </div>
  </div>

  <!-- エラーバー -->
  <div id="err" class="errbar"></div>

  <!-- ライブラリ -->
  <script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>
  <script src="https://unpkg.com/@mapbox/mapbox-gl-draw@1.5.0/dist/mapbox-gl-draw.js"></script>
  <!-- Realtime（読み込めない環境でも他機能が止まらないよう存在チェック付き） -->
  <script src="https://cdn.jsdelivr.net/npm/yjs@13.6.8/dist/yjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/y-webrtc@10.3.5/dist/y-webrtc.min.js"></script>
  <!-- Supabase -->
  <script src="https://esm.sh/@supabase/supabase-js@2"></script>

  <script>
  /***********************************************************
   * ★★★ TODO 1：Supabase の Project URL / anon public key を貼る
   ***********************************************************/
  const SUPABASE_URL  = 'https://tdoxxwhkvdguyfrofnaw.supabase.co';   // ←置換
  const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRkb3h4d2hrdmRndXlmcm9mbmF3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0MTQ0NDQsImV4cCI6MjA3NDk5MDQ0NH0.h2ZnTGr0jml2V7SUvEaOSzjNXxKvCJuJryFEyEkrQQc';               // ←置換

  // Supabase クライアント
  window.__supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

  // ルームID（URLハッシュ #r=xxx で切替）
  window.__room = new URLSearchParams(location.hash.slice(1)).get('r') || 'default';
  document.getElementById('roomLabel').textContent = 'room: ' + __room;

  // ユーティリティ
  const $ = (id)=>document.getElementById(id);
  const toast = (m,bad=false)=>{ const el=document.createElement('div'); el.className='toast'+(bad?' bad':''); el.textContent=m; document.body.appendChild(el); setTimeout(()=>el.remove(),3000); };
  const showErr=(m)=>{ const e=$('err'); e.textContent=m; e.style.display='block'; setTimeout(()=>e.style.display='none',10000); };

  // 都道府県リスト
  const PREFS=["北海道","青森県","岩手県","宮城県","秋田県","山形県","福島県","茨城県","栃木県","群馬県","埼玉県","千葉県","東京都","神奈川県","新潟県","富山県","石川県","福井県","山梨県","長野県","岐阜県","静岡県","愛知県","三重県","滋賀県","京都府","大阪府","兵庫県","奈良県","和歌山県","鳥取県","島根県","岡山県","広島県","山口県","徳島県","香川県","愛媛県","高知県","福岡県","佐賀県","長崎県","熊本県","大分県","宮崎県","鹿児島県","沖縄県"];

  // 地図
  const map = new maplibregl.Map({
    container: 'map',
    style: {
      "version":8,
      "sources":{
        "osm":{"type":"raster","tiles":["https://tile.openstreetmap.org/{z}/{x}/{y}.png"],"tileSize":256,"attribution":"© OpenStreetMap contributors"}
      },
      "layers":[{"id":"osm","type":"raster","source":"osm"}]
    },
    center:[139.767,35.681], zoom:5.2
  });

  // Draw（既存描画機能を維持）
  const draw = new MapboxDraw({
    displayControlsDefault:false,
    controls:{ point:true, line_string:true, polygon:true, trash:true }
  });
  map.addControl(draw, 'top-right');

  // 共同編集（Yjs/WEbRTCが読み込めない環境でも他機能が動くように防御）
  const hasY = !!window.Y;
  const hasYw = !!(window.ywebrtc || window['y-webrtc']);
  if (hasY && hasYw) {
    // 必要に応じて Yjs 初期化（省略可能・雛形）
    // ここに collaborative editing の初期化を入れてもOK（未設定でも他機能は動作）
  } else {
    console.warn('Realtimeコラボは無効（Yjs/y-webrtcが読み込めないため）');
  }

  // パネル操作
  document.querySelectorAll('input[name="areaMode"]').forEach(r=>{
    r.addEventListener('change', ()=>{
      const v = document.querySelector('input[name="areaMode"]:checked').value;
      $('prefRow').style.display = (v==='pref'||v==='muni') ? '' : 'none';
      $('muniRow').style.display = (v==='muni') ? '' : 'none';
    });
  });
  $('btnReset').addEventListener('click', ()=>{
    document.querySelector('input[name="areaMode"][value="all"]').checked = true;
    $('prefRow').style.display='none'; $('muniRow').style.display='none';
    Array.from($('prefSelect').options).forEach(o=>o.selected=false);
    Array.from($('muniSelect').options).forEach(o=>o.selected=false);
    $('qMuni').value='';
    refresh();
  });
  $('hazOpacity').addEventListener('input', ()=> $('hazOpacityVal').textContent = Number($('hazOpacity').value).toFixed(2));

  // 部屋作成/共有リンク（簡易）
  $('btnNewRoom').onclick = ()=>{
    const r = prompt('新しいroom名を入力してください（英数字推奨）', 'room-' + Math.random().toString(36).slice(2,8));
    if(!r) return;
    location.hash = '#r=' + encodeURIComponent(r);
    location.reload();
  };
  $('btnShareEdit').onclick = ()=> prompt('編集リンク（このURLを共有）', location.href.replace(/#.*$/,'') + '#r=' + encodeURIComponent(__room));
  $('btnShareView').onclick = ()=> prompt('閲覧リンク（同じです）', location.href.replace(/#.*$/,'') + '#r=' + encodeURIComponent(__room));
  $('btnExport').onclick = ()=>{
    const fc = draw.getAll();
    const blob = new Blob([JSON.stringify(fc)], {type:'application/json'});
    const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='features.geojson'; a.click();
  };

  /* ----------------- ハザード（任意 / URLがあれば有効） ----------------- */
  // 必要ならURLを設定してください（空のままだとチェックは無効）
  const FLOOD_TILES = "https://disaportaldata.gsi.go.jp/raster/01_flood_l2_shinsuishin_data/{z}/{x}/{y}.png";     // 例: 'https://{s}.example.com/flood/{z}/{x}/{y}.png'
  const SEDIMENT_TILES = "";  // 例: 'https://{s}.example.com/sediment/{z}/{x}/{y}.png'

  function ensureHazardLayers() {
    const opa = Number($('hazOpacity').value);
    if (FLOOD_TILES && !map.getSource('haz-flood')) {
      map.addSource('haz-flood', {type:'raster', tiles:[FLOOD_TILES], tileSize:256});
      map.addLayer({id:'haz-flood', type:'raster', source:'haz-flood', paint:{'raster-opacity': opa}});
    }
    if (SEDIMENT_TILES && !map.getSource('haz-sed')) {
      map.addSource('haz-sed', {type:'raster', tiles:[SEDIMENT_TILES], tileSize:256});
      map.addLayer({id:'haz-sed', type:'raster', source:'haz-sed', paint:{'raster-opacity': opa}});
    }
  }
  function updateHazard() {
    const opa = Number($('hazOpacity').value);
    if (map.getLayer('haz-flood')) map.setPaintProperty('haz-flood','raster-opacity',opa);
    if (map.getLayer('haz-sed')) map.setPaintProperty('haz-sed','raster-opacity',opa);
    if (map.getLayer('haz-flood')) map.setLayoutProperty('haz-flood','visibility', $('chkFlood').checked ? 'visible' : 'none');
    if (map.getLayer('haz-sed')) map.setLayoutProperty('haz-sed','visibility', $('chkSediment').checked ? 'visible' : 'none');
  }
  $('chkFlood').addEventListener('change', ()=>{ ensureHazardLayers(); updateHazard(); });
  $('chkSediment').addEventListener('change', ()=>{ ensureHazardLayers(); updateHazard(); });
  $('hazOpacity').addEventListener('input', updateHazard);

  /* ----------------- FGB 読み込み（公開URL直読み・フォールバック実装） ----------------- */

  /**********************
   * ★★★ TODO 2：Supabase Storage の公開URLを貼る
   *  - 例）https://<project>.supabase.co/storage/v1/object/public/data/Designated_....fgb
   **********************/
  const FGB_URL_EMERGENCY = 'https://tdoxxwhkvdguyfrofnaw.supabase.co/storage/v1/object/public/data/Designated%20Emergency%20Evacuation%20Site.fgb'; // ←置換（先頭 e ）
  const FGB_URL_SHELTER   = 'https://tdoxxwhkvdguyfrofnaw.supabase.co/storage/v1/object/public/data/Designated%20Shelter%20for%20Evacuees.fgb';     // ←置換

  // FlatGeobuf ライブラリを堅牢に読み込む（jsDelivr → unpkg → UMD）
  async function loadFgbLib(){
    const tryUrls = [
      "https://cdn.jsdelivr.net/npm/flatgeobuf@3.27.4/dist/flatgeobuf-geojson.min.js",
      "https://unpkg.com/flatgeobuf@3.27.4/dist/flatgeobuf-geojson.min.js"
    ];
    for (const u of tryUrls) {
      try {
        const m = await import(/* @vite-ignore */ u);
        if (m && (m.deserialize || (m.default && m.default.deserialize))) {
          return m.deserialize || m.default.deserialize;
        }
      } catch(_) {}
    }
    await new Promise((res, rej)=>{
      const s = document.createElement('script');
      s.src = "https://cdn.jsdelivr.net/npm/flatgeobuf@3.27.4/dist/flatgeobuf-geojson.min.js";
      s.onload = res; s.onerror = ()=>{
        const s2 = document.createElement('script');
        s2.src = "https://unpkg.com/flatgeobuf@3.27.4/dist/flatgeobuf-geojson.min.js";
        s2.onload=res; s2.onerror=()=>rej(new Error('flatgeobufの読み込みに失敗（CDN到達不可）'));
        document.head.appendChild(s2);
      };
      document.head.appendChild(s);
    });
    if (window.flatgeobuf && window.flatgeobuf.deserialize) return window.flatgeobuf.deserialize;
    throw new Error('flatgeobufの読み込みに失敗（deserialize未検出）');
  }

  async function readFGB_fromURL(url){
    const head = await fetch(url, { headers:{'Range':'bytes=0-0'}, cache:'no-store' });
    if(!head.ok) throw new Error(`FGBヘッダ取得失敗 ${head.status} ${head.statusText}`);
    const ct = (head.headers.get('content-type')||'').toLowerCase();
    if (ct.includes('text/html')) throw new Error('FGB直リンクがHTMLを返しています（URL/公開設定/パスを確認）');
    const deserialize = await loadFgbLib();
    const feats=[]; for await (const f of deserialize(url)) feats.push(f);
    if(!feats.length) throw new Error('FGBの中身が空です');
    return feats;
  }

  // クリックで属性ポップアップ
  function bindClickPopup(layerId){
    map.on('click', layerId, (e)=>{
      if(!e.features?.length) return;
      const props = e.features[0].properties || {};
      const list = Object.entries(props).filter(([k])=>k!=='__label__');
      const html = `<ul class="popup-list">` + list.map(([k,v])=>`<li><b>${k}</b> ${String(v)}</li>`).join('') + `</ul>`;
      new maplibregl.Popup({offset:12}).setLngLat(e.lngLat).setHTML(html).addTo(map);
    });
    map.on('mouseenter', layerId, ()=> map.getCanvas().style.cursor='pointer');
    map.on('mouseleave', layerId, ()=> map.getCanvas().style.cursor='');
  }

  const MUNI_COL_CANDIDATES = ["都道府県名及び市町村名","都道府県及び市町村名"];
  const LABEL_CANDIDATES    = ["施設・場所名","住所","共通ID","NO"];
  let cacheEmergency=null, cacheShelter=null, COL_MUNI=null;

  // 表示適用
  function applyVisibility(){
    const visE = $('chkEmergency')?.checked ?? true;
    const visS = $('chkShelter')?.checked ?? true;
    map.setLayoutProperty('emg-circle','visibility', visE ? 'visible':'none');
    map.setLayoutProperty('shel-circle','visibility', visS ? 'visible':'none');
    const visL = $('chkLabel')?.checked ? 'visible' : 'none';
    if (map.getLayer('emg-label')) map.setLayoutProperty('emg-label','visibility', visL);
    if (map.getLayer('shel-label')) map.setLayoutProperty('shel-label','visibility', visL);
  }

  function fitToData(){
    const fc1 = map.getSource('emergency')?._data;
    const fc2 = map.getSource('shelter')?._data;
    if(!fc1 || !fc2) return;
    const all=[...fc1.features, ...fc2.features];
    if(!all.length) return;
    let minX=180,minY=90,maxX=-180,maxY=-90;
    all.forEach(f=>{ if(f.geometry.type!=='Point') return; const [x,y]=f.geometry.coordinates;
      if(x<minX)minX=x; if(y<minY)minY=y; if(x>maxX)maxX=x; if(y>maxY)maxY=y; });
    if(minX<maxX && minY<maxY) map.fitBounds([[minX,minY],[maxX,maxY]],{padding:40,maxZoom:13});
  }

  function refresh(){
    if(!cacheEmergency || !cacheShelter) return;
    const mode = document.querySelector('input[name="areaMode"]:checked').value;
    const prefs = new Set(Array.from($('prefSelect').selectedOptions).map(o=>o.value));
    const munis = new Set(Array.from($('muniSelect').selectedOptions).map(o=>o.value));
    const labelField = $('labelFieldSelect').value;

    const filterByArea = (fullName)=>{
      if (!fullName) return mode==='all';
      const pref = PREFS.find(p=>fullName.startsWith(p)) || "";
      const city = fullName.slice(pref.length).trim();
      if (mode==='all') return true;
      if (mode==='pref') return prefs.size===0 ? true : prefs.has(pref);
      if (mode==='muni'){
        if (munis.size===0 && prefs.size===0) return true;
        if (munis.size>0) return munis.has(`${pref} ${city}`);
        return prefs.has(pref);
      }
      return true;
    };
    const decorate=(f)=>{
      const p=f.properties||{};
      const label = (p[labelField] ?? p["施設・場所名"] ?? p["住所"] ?? p["共通ID"] ?? p["NO"] ?? "");
      return {...f, properties:{...p, __label__: String(label)}};
    };
    const emgFiltered = (cacheEmergency||[]).filter(f=>filterByArea(String(f.properties?.[COL_MUNI]||""))).map(decorate);
    const shlFiltered = (cacheShelter  ||[]).filter(f=>filterByArea(String(f.properties?.[COL_MUNI]||""))).map(decorate);

    map.getSource('emergency').setData({type:'FeatureCollection', features:emgFiltered});
    map.getSource('shelter').setData({type:'FeatureCollection', features:shlFiltered});

    applyVisibility(); fitToData();
    toast('表示を更新しました');
  }

  // サジェスト
  function hideSuggest(){ $('suggest').style.display='none'; $('suggest').innerHTML=''; }
  function updateSuggest(query){
    const q = String(query||'').trim();
    const chosenPrefs = new Set(Array.from($('prefSelect').selectedOptions).map(o=>o.value));
    const src = (chosenPrefs.size===0) ? window.__allMunicipalLabels : window.__allMunicipalLabels.filter(lbl=>chosenPrefs.has(lbl.split(" ")[0]));
    if(!q){ hideSuggest(); return; }
    const hits = src.filter(lbl=>lbl.includes(q)).slice(0,10);
    if(hits.length===0){ hideSuggest(); return; }
    $('suggest').innerHTML = hits.map(h=>`<div class="suggest-item" data-v="${h}">${h}</div>`).join("");
    $('suggest').style.display='block';
    Array.from($('suggest').children).forEach(div=>{
      div.addEventListener('click', ()=>{
        const val = div.getAttribute('data-v');
        const opt = Array.from($('muniSelect').options).find(o=>o.value===val);
        if(opt){ opt.selected=true; refresh(); }
        $('qMuni').value=''; hideSuggest();
      });
    });
  }

  // FGB 読み込み＆UI初期化
  async function initDriveFGB(){
    // ソース/レイヤ（初回のみ）
    if(!map.getSource('emergency')) map.addSource('emergency',{type:'geojson',data:{type:'FeatureCollection',features:[]}});
    if(!map.getSource('shelter'))   map.addSource('shelter',  {type:'geojson',data:{type:'FeatureCollection',features:[]}});
    if(!map.getLayer('emg-circle')) map.addLayer({id:'emg-circle',type:'circle',source:'emergency',paint:{'circle-radius':5,'circle-color':'#e23b3b','circle-stroke-color':'#fff','circle-stroke-width':1}});
    if(!map.getLayer('shel-circle')) map.addLayer({id:'shel-circle',type:'circle',source:'shelter',paint:{'circle-radius':5,'circle-color':'#2a7be4','circle-stroke-color':'#fff','circle-stroke-width':1}});
    if(!map.getLayer('emg-label'))   map.addLayer({id:'emg-label',type:'symbol',source:'emergency',layout:{'text-field':['get','__label__'],'text-size':12,'text-offset':[0,1.2],'text-anchor':'top'},paint:{'text-halo-width':1.2,'text-halo-color':'#fff'}});
    if(!map.getLayer('shel-label'))  map.addLayer({id:'shel-label',type:'symbol',source:'shelter',  layout:{'text-field':['get','__label__'],'text-size':12,'text-offset':[0,1.2],'text-anchor':'top'},paint:{'text-halo-width':1.2,'text-halo-color':'#fff'}});

    bindClickPopup('emg-circle'); bindClickPopup('shel-circle');

    // 都道府県セレクト
    PREFS.forEach(p=>{ const o=document.createElement('option'); o.value=p; o.textContent=p; $('prefSelect').appendChild(o); });
    $('prefSelect').addEventListener('change', renderMuniOptions);

    // FGB 読み込み
    try{
      const [emgFeats, shelFeats] = await Promise.all([
        readFGB_fromURL(FGB_URL_EMERGENCY),
        readFGB_fromURL(FGB_URL_SHELTER)
      ]);
      cacheEmergency = emgFeats; cacheShelter = shelFeats;

      // 列名推定
      const propKeys = new Set([...Object.keys(emgFeats[0]?.properties||{}), ...Object.keys(shelFeats[0]?.properties||{})]);
      COL_MUNI = MUNI_COL_CANDIDATES.find(k=>propKeys.has(k)) || null;
      if(!COL_MUNI) showErr('「都道府県名及び市町村名」列が見つかりません（COL_MUNI未設定）');

      // ラベル候補
      $('labelFieldSelect').innerHTML = '';
      const labels = LABEL_CANDIDATES.filter(k=>propKeys.has(k));
      (labels.length?labels:Array.from(propKeys)).forEach(k=>{
        const o=document.createElement('option'); o.value=k; o.textContent=k; $('labelFieldSelect').appendChild(o);
      });
      if($('labelFieldSelect').options.length) $('labelFieldSelect').value = $('labelFieldSelect').options[0].value;

      // 市区町村候補
      const uniq=(a)=>[...new Set(a)];
      const names = uniq([...emgFeats, ...shelFeats].map(f=>String(f.properties?.[COL_MUNI]||"").trim()).filter(Boolean));
      function splitPrefCity(full){ const pref=PREFS.find(p=>full.startsWith(p))||""; return {pref,city:full.slice(pref.length).trim()||full}; }
      window.__allMunicipalLabels = names.map(n=>{ const {pref,city}=splitPrefCity(n); return pref?`${pref} ${city||"(名称不明)"}`:n; })
                                         .sort((a,b)=>a.localeCompare(b,'ja'));
      renderMuniOptions();
      function renderMuniOptions(){
        const chosenPrefs = new Set(Array.from($('prefSelect').selectedOptions).map(o=>o.value));
        $('muniSelect').innerHTML = "";
        const list = (chosenPrefs.size===0) ? window.__allMunicipalLabels : window.__allMunicipalLabels.filter(lbl=>chosenPrefs.has(lbl.split(" ")[0]));
        list.forEach(lbl=>{ const o=document.createElement('option'); o.value=lbl; o.textContent=lbl; $('muniSelect').appendChild(o); });
        updateSuggest($('qMuni').value);
      }

      // イベント
      $('qMuni').addEventListener('input', ()=> updateSuggest($('qMuni').value));
      $('qMuni').addEventListener('blur', ()=> setTimeout(hideSuggest,150));
      $('qMuni').addEventListener('keydown', (ev)=>{ if(ev.key==='Enter'){ const val=$('qMuni').value; if(val){ updateSuggest(val); } }});
      $('chkLabel').addEventListener('change', applyVisibility);
      $('btnApply').addEventListener('click', refresh);

      // 初回表示
      refresh();
    }catch(e){
      showErr('FGBデータの読み込みに失敗：' + e.message);
    }
  }

  // 地図ロードで初期化
  map.on('load', ()=>{
    try{
      ensureHazardLayers(); updateHazard();
      // GeoJSONソース（空）を先に作っておく
      if(!map.getSource('emergency')) map.addSource('emergency',{type:'geojson',data:{type:'FeatureCollection',features:[]}});
      if(!map.getSource('shelter'))   map.addSource('shelter',  {type:'geojson',data:{type:'FeatureCollection',features:[]}});
      initDriveFGB();
    }catch(e){
      console.error(e); showErr('初期化エラー: ' + e.message);
    }
  });

  /* ----------------- Supabase 保存/読込 と GPS ロガー ----------------- */
  (function whenReady(){
    const ok = !!(window.map && window.draw && typeof draw.add === 'function');
    if(!ok) return setTimeout(whenReady, 200);
    window.__supaload = loadFeatures;
    window.__supasave = saveFeatures;
    window.__gpstart  = startGpsLog;
    window.__gpstop   = stopGpsLog;
    window.__gpshow   = showTracks;
  })();

  async function loadFeatures(){
    try{
      const { data, error } = await __supa.from('features').select('id,geojson').eq('room', __room).order('id');
      if(error) throw error;
      const feats = (data||[]).map(r=>r.geojson);
      if (feats.length){ draw.deleteAll(); draw.add({type:'FeatureCollection',features:feats}); }
      toast('図形を読み込みました（'+(feats.length||0)+'件）');
    }catch(e){ toast('読込失敗: '+e.message, true); }
  }
  async function saveFeatures(){
    try{
      const fc = draw.getAll();
      if(!fc.features?.length){ toast('保存する図形がありません', true); return; }
      const rows = fc.features.map(f=>({ room: __room, kind:(f.properties?.kind)||f.geometry?.type?.toLowerCase()||'feature', geojson:f, props:f.properties||{} }));
      const { error } = await __supa.from('features').insert(rows);
      if(error) throw error;
      toast('図形を保存しました');
    }catch(e){ toast('保存失敗: '+e.message, true); }
  }

  let watchId=null, currentTrackId=null;
  async function startGpsLog(name='フィールド調査'){
    if(!navigator.geolocation){ toast('位置情報が使えません', true); return; }
    const { data:tk, error:e1 } = await __supa.from('tracks').insert({ room: __room, name }).select().single();
    if(e1){ toast('トラック作成失敗: '+e1.message, true); return; }
    currentTrackId = tk.id;
    let last=null;
    watchId = navigator.geolocation.watchPosition(async pos=>{
      const { longitude:lon, latitude:lat, accuracy:acc, speed, heading } = pos.coords;
      const tiso = new Date(pos.timestamp).toISOString();
      if(last){
        const dx=Math.abs(lon-last.lon)*111320, dy=Math.abs(lat-last.lat)*110540;
        if(dx<10 && dy<10) return;
      }
      last={lon,lat};
      await __supa.from('track_points').insert({ track_id: currentTrackId, t:tiso, lon, lat, acc, speed, heading });
    }, err=>toast('GPSエラー: '+err.message, true), { enableHighAccuracy:true, maximumAge:1000, timeout:10000 });
    toast('GPSロガー開始');
  }
  function stopGpsLog(){
    if(watchId){ navigator.geolocation.clearWatch(watchId); watchId=null; }
    currentTrackId=null; toast('GPSロガー停止');
  }
  async function showTracks(){
    const { data: tracks } = await __supa.from('tracks').select('id').eq('room', __room);
    if(!tracks?.length){ toast('トラックがありません', true); return; }
    const ids = tracks.map(r=>r.id);
    const { data: pts } = await __supa.from('track_points').select('track_id,t,lon,lat').in('track_id', ids).order('t');
    const by=new Map(); (pts||[]).forEach(p=>{ if(!by.has(p.track_id)) by.set(p.track_id, []); by.get(p.track_id).push([p.lon,p.lat]); });
    const fc={ type:'FeatureCollection', features:[...by.entries()].map(([id,coords])=>({type:'Feature',properties:{id},geometry:{type:'LineString',coordinates:coords}})) };
    if(!map.getSource('tracks')) map.addSource('tracks',{type:'geojson',data:fc}); else map.getSource('tracks').setData(fc);
    if(!map.getLayer('tracks-line')) map.addLayer({id:'tracks-line',type:'line',source:'tracks',paint:{'line-color':'#ef4444','line-width':3}});
    toast('軌跡を表示しました');
  }
  </script>
</body>
</html>
