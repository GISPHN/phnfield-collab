<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>PHN Field Collab</title>

  <!-- MapLibre + Draw CSS -->
  <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css"/>
  <link rel="stylesheet" href="https://unpkg.com/@mapbox/mapbox-gl-draw@1.5.0/dist/mapbox-gl-draw.css"/>

  <style>
    html,body,#map{height:100%;width:100%;margin:0}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP","Hiragino Kaku Gothic ProN",Meiryo,sans-serif;color:#111827}

    /* ãƒˆãƒƒãƒ—ãƒãƒ¼ */
    .topbar{position:absolute;left:12px;right:12px;top:8px;z-index:30;display:flex;gap:8px;flex-wrap:wrap;pointer-events:none}
    .chip{pointer-events:auto;padding:6px 10px;border-radius:10px;border:1px solid #e5e7eb;background:rgba(255,255,255,.9);backdrop-filter:blur(6px);font-size:12px;font-weight:700}
    .chip.btn{cursor:pointer;background:#0ea5e9;color:#fff}
    .chip.btn.secondary{background:#eef2ff;color:#111827}

    /* å·¦ãƒ‘ãƒãƒ«ï¼ˆåŠé€æ˜ï¼‰ */
    .panel{position:absolute;left:12px;top:56px;width:340px;max-height:calc(100% - 68px);padding:12px;border-radius:12px;background:rgba(255,255,255,.86);backdrop-filter:blur(6px);box-shadow:0 8px 28px rgba(0,0,0,.12);overflow:auto;z-index:20}
    .panel h3{margin:0 0 8px;font-size:16px}
    .panel .group{margin:10px 0}
    .panel .row{display:flex;gap:8px}
    .panel .row>*{flex:1 1 0}
    .panel label{font-size:13px;display:inline-flex;align-items:center;gap:6px;margin:4px 8px 4px 0}
    .panel input[type="text"],.panel select{width:100%;padding:8px 10px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;font-size:13px}
    .panel .btn{display:inline-block;padding:8px 12px;border-radius:10px;border:1px solid #e5e7eb;background:#0ea5e9;color:#fff;font-weight:700;cursor:pointer;text-align:center}
    .panel .btn.secondary{background:#f3f4f6;color:#111827}
    .panel .btn:disabled{opacity:.55;cursor:not-allowed}

    /* å³ãƒ‘ãƒãƒ«ï¼ˆåŠé€æ˜ï¼‰ */
.rightpane{
  position:absolute; right:12px; top:56px;
  width:320px; max-height:calc(100% - 68px);
  padding:12px; border-radius:12px;
  background:rgba(255,255,255,.86); backdrop-filter:blur(6px);
  box-shadow:0 8px 28px rgba(0,0,0,.12); overflow:auto; z-index:20;
}
.rightpane h4{ margin:0 0 8px; font-size:16px; }


    /* å·¦ä¸‹ï¼šSupabase æ“ä½œ */
    .supabox{position:absolute;left:12px;bottom:12px;z-index:20;min-width:260px;padding:10px;border-radius:12px;background:rgba(255,255,255,.88);backdrop-filter:blur(6px);box-shadow:0 8px 28px rgba(0,0,0,.12)}
    .supabox h4{margin:0 0 6px;font-size:14px;font-weight:800}
    .supabox .row{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:6px}
    .supabox button{padding:6px 9px;border-radius:10px;border:1px solid #e5e7eb;background:#f8fafc;cursor:pointer;font-size:12px}
    .supabox button:hover{background:#eef2ff}
    .supabox .danger{background:#fee2e2;border-color:#fecaca}
    .supabox .wfull{flex:1 1 100%}

    /* ã‚µã‚¸ã‚§ã‚¹ãƒˆ */
    .suggest{position:absolute;width:calc(100% - 24px);max-height:220px;overflow:auto;z-index:40;background:#fff;border:1px solid #e5e7eb;border-radius:10px;box-shadow:0 10px 28px rgba(0,0,0,.12);display:none}
    .suggest-item{padding:8px 10px;cursor:pointer}
    .suggest-item:hover{background:#f1f5f9}

    /* ãƒˆãƒ¼ã‚¹ãƒˆ/ã‚¨ãƒ©ãƒ¼ */
    .toast{position:fixed;right:12px;bottom:12px;z-index:40;background:#ecfeff;border:1px solid #a5f3fc;border-radius:10px;padding:10px 12px;font-size:12px}
    .toast.bad{background:#fee2e2;border-color:#fecaca;color:#7f1d1d}
    .errbar{position:absolute;left:50%;transform:translateX(-50%);top:8px;z-index:50;background:#fee2e2;color:#7f1d1d;border:1px solid #fecaca;border-radius:10px;padding:8px 12px;display:none}

    /* ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—æ•´å½¢ */
    .popup-list{margin:0;padding:0;list-style:none;font-size:12px;max-width:340px}
    .popup-list li{border-bottom:1px solid #f1f5f9;padding:6px 0}
    .popup-list li:last-child{border-bottom:none}
    .popup-list b{display:inline-block;min-width:120px;color:#374151}
    /* --- æ—¢å­˜ãƒ‘ãƒãƒ«ã‚’å°‘ã—é€æ˜ã« --- */
.panel{ background:rgba(255,255,255,.80); }
.rightpane{ background:rgba(255,255,255,.82); }

/* --- ä¸Šéƒ¨ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆè¿½åŠ ãƒœã‚¿ãƒ³ã¨ã‚µãƒ–ãƒ„ãƒ¼ãƒ« --- */
#objToolbar{ display:flex; gap:6px; align-items:center; }
#objSubtools{ display:none; gap:6px; margin-left:8px; }
.chip.toggle-on{ background:#1e88e5; color:#fff; }
.tool{ padding:6px 10px; border-radius:8px; background:#fff; box-shadow:0 2px 8px rgba(0,0,0,.12); cursor:pointer; user-select:none; }
.tool.active{ outline:2px solid #1e88e5; }

/* --- å³å´ï¼šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ï¼ˆãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—å¯¾å¿œï¼‰ --- */
#objPanel{  position: static;  /* â† absolute ã‚’ã‚„ã‚ã‚‹ */
  width: auto;
  background: transparent;
  backdrop-filter: none;
  border-radius: 0;
  box-shadow: none;
  padding: 0;
}
#objList{ max-height:280px; overflow:auto; margin-top:6px; }
.objItem, .grpItem{
  background:#fff; border-radius:8px; padding:8px; margin:6px 0; box-shadow:0 1px 6px rgba(0,0,0,.08);
  display:flex; align-items:center; gap:8px;
}
.objItem.dragging, .grpItem.dragging{ opacity:.4; }
.objType{ width:22px; height:22px; border-radius:4px; display:inline-block; }
.type-point{ background:#1976d2; }
.type-line{  background:linear-gradient(90deg,#e53935 0 50%, transparent 0); border-bottom:3px solid #e53935; width:28px; }
.type-poly{  background:#43a047; opacity:.6; }
.type-circle{ background:#6d4c41; opacity:.6; border-radius:50%; }
.dropHint{ outline:2px dashed #1e88e5; }

/* ãƒ©ãƒ™ãƒ«å…¥åŠ›ã¨è‰²ãƒ»ã‚µã‚¤ã‚ºUI */
.inline{ display:flex; align-items:center; gap:6px; flex-wrap:wrap; }
.small{ font-size:12px; color:#666; }
input[type="color"]{ width:36px; height:26px; padding:0; border:none; background:transparent; }
input[type="number"]{ width:70px; }

/* --- ç¾åœ¨åœ°ãƒ‘ãƒ«ã‚¹ï¼ˆCSSã‚¢ãƒ‹ãƒ¡ï¼‰ --- */
.pulse{
  width:18px; height:18px; border-radius:50%; background:#2196f3; box-shadow:0 0 0 rgba(33,150,243,.4);
  animation:pulse 2s infinite;
  border:2px solid #fff;
}
@keyframes pulse{
  0%{ box-shadow:0 0 0 0 rgba(33,150,243,.4); }
  70%{ box-shadow:0 0 0 18px rgba(33,150,243,0); }
  100%{ box-shadow:0 0 0 0 rgba(33,150,243,0); }
}
/* è‡ªæ²»ä½“å€™è£œã®å‰é¢åŒ– */
.suggest{ position:absolute; z-index:9999; }
    
.small-creator{font-size:12px;color:#4b5563}
.small-creator .xicon{font-weight:700;margin-right:4px}
.floating{
  position:absolute; left:360px; top:80px; width:320px;
  background:rgba(255,255,255,.92); backdrop-filter:blur(8px);
  box-shadow:0 10px 32px rgba(0,0,0,.18); border-radius:12px; z-index:1000; padding:0;
}
.floatHeader{display:flex;align-items:center;gap:8px;padding:10px 12px;border-bottom:1px solid #e5e7eb;font-weight:700}
.floatHeader .sub{font-weight:400;color:#6b7280;margin-left:6px}
.floatHeader .handle{margin-left:auto;cursor:move}
.floatBody{padding:10px 12px}
.suggest{position:absolute;z-index:9999} /* å€™è£œã¯æœ€å‰é¢ */

.objItem{display:flex;align-items:center;gap:8px;padding:6px;border:1px solid #e5e7eb;border-radius:8px;margin:4px 0;background:rgba(255,255,255,.86);backdrop-filter:blur(4px)}
.objItem .objLabel{flex:1 1 auto;cursor:default}
.miniBtn{padding:4px 8px;border-radius:8px;border:none;background:#f3f4f6;cursor:pointer}
.miniBtn:hover{background:#e5e7eb}

  </style>
</head>
<body>
  <div id="map"></div>

  <!-- ãƒˆãƒƒãƒ—ãƒãƒ¼ -->
  <div class="topbar">
    <div class="chip" style="display:flex;flex-direction:column;align-items:flex-start">
  <div>PHN Field Collab</div>
  <div class="small-creator">
    ä½œæˆè€…ï¼š
    <a href="https://x.com/GISPHN" target="_blank" rel="noopener">
      <span class="xicon">ğ•</span> GISPHN
    </a>
  </div>
</div>
    <div class="chip">ãƒ™ãƒ¼ã‚¹:
      <select id="basemapSel" style="border:none;background:transparent;font-weight:700">
        <option value="osm">OSM</option>
        <option value="gsi_std">åœ°ç†é™¢ æ¨™æº–</option>
        <option value="gsi_pale">åœ°ç†é™¢ æ·¡è‰²</option>
        <option value="gsi_photo">åœ°ç†é™¢ å†™çœŸ</option>
      </select>
    </div>
    <div class="chip btn secondary" id="btnExport">æç”»ã‚’GeoJSONå‡ºåŠ›</div>

    <!-- ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆè¿½åŠ ï¼šãƒ¡ã‚¤ãƒ³ãƒœã‚¿ãƒ³ï¼‹ã‚µãƒ–ãƒ„ãƒ¼ãƒ« -->
<div id="objToolbar">
  <div id="btnObj" class="chip btn secondary">ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ</div>
  <div id="objSubtools">
    <div class="tool" data-mode="point">ãƒã‚¤ãƒ³ãƒˆ</div>
    <div class="tool" data-mode="line">ãƒ©ã‚¤ãƒ³</div>
    <div class="tool" data-mode="polygon">ãƒãƒªã‚´ãƒ³</div>
    <div class="tool" data-mode="circle">å††</div>
  </div>
</div>
    <div class="chip btn secondary" id="btnGPS">GPS</div>
    <div style="flex:1"></div>
    <div class="chip btn secondary" id="btnSignIn">ã‚µã‚¤ãƒ³ã‚¤ãƒ³ï¼ˆä¿å­˜/å…±åŒç·¨é›†ï¼‰</div>
<div class="chip" id="signinState" style="display:none">ä¿å­˜ON</div>
<div class="chip btn secondary" id="btnShare" style="display:none">å…±æœ‰ãƒªãƒ³ã‚¯</div>

  </div>

  <!-- å·¦ãƒ‘ãƒãƒ« -->
  <div class="panel" id="panel">
    <h3>ãƒ¬ã‚¤ãƒ¤ / èƒŒæ™¯åœ°å›³</h3>
ã€€ã€€<div class="group">
  <button class="btn" id="btnExtent">è¡¨ç¤ºç¯„å›²</button>
  <span style="font-size:12px;color:#6b7280;margin-left:6px">ï¼ˆå…¨ãƒ¬ã‚¤ãƒ¤å…±é€šï¼‰</span>
</div>

    <div class="group">
      <label><input type="checkbox" id="chkFlood"> æ´ªæ°´æµ¸æ°´æƒ³å®šåŒºåŸŸï¼ˆæƒ³å®šæœ€å¤§è¦æ¨¡ï¼‰</label><br>
      <label><input type="checkbox" id="chkSediment"> åœŸç ‚ç½å®³è­¦æˆ’åŒºåŸŸï¼ˆ3ãƒ¬ã‚¤ãƒ¤ä¸€æ‹¬ON/OFFï¼‰</label>
      <div class="row" style="align-items:center;margin-top:6px">
        <div style="font-size:12px;min-width:64px">é€æ˜åº¦</div>
        <input type="range" id="hazOpacity" min="0" max="1" step="0.05" value="0.60"/>
        <div id="hazOpacityVal" style="width:36px;text-align:right;font-size:12px">0.60</div>
      </div>
      <div style="font-size:12px;color:#6b7280;margin-top:6px">â€»ãƒã‚¶ãƒ¼ãƒ‰ã®ã‚¿ã‚¤ãƒ«URLã‚’è¨­å®šã—ã¦ã„ãªã„å ´åˆã¯ç„¡åŠ¹</div>
      <div style="font-size:12px;color:#6b7280;margin-top:4px">å‡¡ä¾‹ï¼ˆä¾‹ç¤ºç”»åƒã‚’å¿…è¦ã«å¿œã˜å·®æ›¿ï¼‰</div>
      <img src="l2_flood_l.png" style="max-width:100%;opacity:.85" alt="å‡¡ä¾‹(æ´ªæ°´)">
      <img src="l2_sediment_l.png" style="max-width:100%;opacity:.85" alt="å‡¡ä¾‹(åœŸç ‚)">
    </div>

    <div class="group">
      <div>é¿é›£æ–½è¨­ï¼ˆFGBï¼‰:</div>
      <label><input type="checkbox" id="chkEmergency"> æŒ‡å®š<strong>ç·Šæ€¥é¿é›£å ´æ‰€</strong>ï¼ˆèµ¤ï¼‰</label>
      <label><input type="checkbox" id="chkShelter"> æŒ‡å®š<strong>é¿é›£æ‰€</strong>ï¼ˆé’ï¼‰</label><br>
      <label><input type="checkbox" id="chkLabel"> ãƒ©ãƒ™ãƒ«ã‚’è¡¨ç¤º</label>
      <div class="row" style="margin-top:6px">
  <button class="btn secondary" id="btnScopeEmergency" title="ç·Šæ€¥é¿é›£å ´æ‰€ã®ã¿ç¯„å›²æŒ‡å®š">å€‹åˆ¥ç¯„å›²ï¼ˆç·Šæ€¥ï¼‰</button>
  <button class="btn secondary" id="btnScopeShelter"   title="æŒ‡å®šé¿é›£æ‰€ã®ã¿ç¯„å›²æŒ‡å®š">å€‹åˆ¥ç¯„å›²ï¼ˆé¿é›£æ‰€ï¼‰</button>
</div>

    </div>
<!-- â–¼ è¡¨ç¤ºç¯„å›²ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ‘ãƒãƒ«ï¼ˆãƒ‰ãƒ©ãƒƒã‚°å¯ï¼‰ â–¼ -->
<div id="extentPanel" class="floating" style="display:none">
  <div class="floatHeader">è¡¨ç¤ºç¯„å›² <span class="sub" id="extentScopeNote">(å…¨ãƒ¬ã‚¤ãƒ¤)</span>
    <span class="handle" title="ãƒ‰ãƒ©ãƒƒã‚°ã§ç§»å‹•">â£¿</span>
  </div>
  <div class="floatBody">

    <div class="group">
      <div>è¡¨ç¤ºç¯„å›²ï¼š</div>
      <label><input type="radio" name="areaMode" value="all" checked> æ—¥æœ¬å…¨å›½</label>
      <label><input type="radio" name="areaMode" value="pref"> éƒ½é“åºœçœŒ</label>
      <label><input type="radio" name="areaMode" value="muni"> å¸‚åŒºç”ºæ‘</label>
    </div>

    <div class="group" id="prefRow" style="display:none">
      <div style="font-size:12px;margin-bottom:4px">éƒ½é“åºœçœŒï¼ˆè¤‡æ•°é¸æŠå¯ / Ctrl+ã‚¯ãƒªãƒƒã‚¯ï¼‰</div>
      <select id="prefSelect" multiple size="7"></select>
    </div>

    <div class="group" id="muniRow" style="display:none;position:relative">
      <div style="font-size:12px;margin-bottom:4px">å¸‚åŒºç”ºæ‘ï¼ˆè¤‡æ•°é¸æŠå¯ / Ctrl+ã‚¯ãƒªãƒƒã‚¯ï¼‰</div>
      <input id="qMuni" type="text" placeholder="ä¾‹ï¼‰å¥ˆè‰¯å¸‚ã€ç”Ÿé§’å¸‚ / æ±äº¬éƒ½"/>
      <div class="suggest" id="suggest"></div>
      <div style="height:6px"></div>
      <select id="muniSelect" multiple size="10" style="display:none"></select>
    </div>

    <div class="group">
      <div style="font-size:12px;margin-bottom:4px">ãƒ©ãƒ™ãƒ«ã«ä½¿ã†ã‚«ãƒ©ãƒ </div>
      <select id="labelFieldSelect"></select>
    </div>

    <div class="group">
      <div class="row">
        <button class="btn" id="btnApply">é©å¿œ</button>
        <button class="btn secondary" id="btnReset">ãƒªã‚»ãƒƒãƒˆ</button>
      </div>
      <div style="font-size:12px;color:#6b7280;margin-top:6px">â€»ã€Œé©å¿œã€ã§çµã‚Šè¾¼ã¿ã‚’åæ˜ ã—ã¾ã™</div>
          <div class="row" style="margin-top:10px">
      <button class="btn" id="btnExtentApply">é©å¿œ</button>
      <button class="btn secondary" id="btnExtentOK">OK</button>
    </div>
  </div>
</div>
<!-- â–² è¡¨ç¤ºç¯„å›²ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ‘ãƒãƒ« â–² -->

    </div>
  </div>

  <!-- å³ãƒ‘ãƒãƒ« -->
  <div class="rightpane">
<div id="objPanel">
  <div class="inline small" style="margin-bottom:6px">
    <strong>ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§</strong>
    <span style="margin-left:auto"></span>
    <label><input type="radio" name="styleScope" value="single" checked> å€‹åˆ¥</label>
    <label><input type="radio" name="styleScope" value="group"> ã‚°ãƒ«ãƒ¼ãƒ—</label>
    <label><input type="radio" name="styleScope" value="all"> å…¨ä½“</label>
  </div>
  <div id="objList"></div>
</div>

 </div>
<!-- ==== /Object List Panel ==== -->


  <!-- å·¦ä¸‹ï¼šSupabase æ“ä½œ -->
  <div class="supabox" style="display:none">
    <h4>å…±åŒç·¨é›† / GPS</h4>
    <div class="row">
      <button class="wfull" onclick="window.__supaload()">å›³å½¢ã‚’å†èª­è¾¼</button>
      <button class="wfull" onclick="window.__supasave()">å›³å½¢ã‚’ä¿å­˜</button>
    </div>
    <div class="row">
      <button onclick="window.__gpstart()">GPSé–‹å§‹</button>
      <button class="danger" onclick="window.__gpstop()">GPSåœæ­¢</button>
      <button onclick="window.__gpshow()">è»Œè·¡è¡¨ç¤º</button>
    </div>
    <div class="row">
      <button class="wfull" onclick="(async()=>{const e=prompt('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹');if(!e)return;await __supa.auth.signInWithOtp({email:e});alert('å±Šã„ãŸãƒ¡ãƒ¼ãƒ«ã®ãƒªãƒ³ã‚¯ã‚’é–‹ã„ãŸã‚‰ã“ã®ç”»é¢ã«æˆ»ã£ã¦ãã ã•ã„');})();">ãƒ¡ãƒ¼ãƒ«ã§ãƒ­ã‚°ã‚¤ãƒ³</button>
      <button class="wfull" onclick="__supa.auth.signOut().then(()=>alert('ã‚µã‚¤ãƒ³ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ'))">ã‚µã‚¤ãƒ³ã‚¢ã‚¦ãƒˆ</button>
    </div>
  </div>

  <div id="err" class="errbar"></div>

  <!-- ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
  <script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>
  <script src="https://unpkg.com/@mapbox/mapbox-gl-draw@1.5.0/dist/mapbox-gl-draw.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js"></script>

  <script>
  /*************** â˜…â˜…â˜… TODO 1ï¼šSupabase ã® Project URL / anon public key ***************/
  const SUPABASE_URL  = 'https://tdoxxwhkvdguyfrofnaw.supabase.co';   // â†ç½®æ›
  const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRkb3h4d2hrdmRndXlmcm9mbmF3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0MTQ0NDQsImV4cCI6MjA3NDk5MDQ0NH0.h2ZnTGr0jml2V7SUvEaOSzjNXxKvCJuJryFEyEkrQQc';                // â†ç½®æ›

  // Supabase ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼ˆUMD ã§ window.supabase ãŒç”Ÿãˆã‚‹å‰æï¼‰
  try {
    if (!window.supabase) throw new Error('Supabase SDK (UMD) ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
    window.__supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
  } catch (e) {
    console.error(e);
    // å…±åŒç·¨é›†/GPSç³»ãŒä½¿ãˆãªã„ã¨ãã§ã‚‚åœ°å›³ã¯å‹•ã‹ã™ãŸã‚ã®ãƒ€ãƒŸãƒ¼
    window.__supa = {
      from(){ return { select:async()=>({}), insert:async()=>({}), in:async()=>({}), eq:async()=>({}), order:async()=>({}), single:async()=>({}) }; },
      auth:{ signInWithOtp:async()=>({}), signOut:async()=>({}) }
    };
    // å¤±æ•—ã¯ç”»é¢ã«ã‚‚å‡ºã™
    setTimeout(()=>{ const b=document.createElement('div'); b.className='toast bad'; b.textContent='Supabase ã®åˆæœŸåŒ–ã«å¤±æ•—ï¼ˆå…±åŒç·¨é›†/GPSã¯ç„¡åŠ¹ã§ã™ãŒåœ°å›³ã¯å‹•ãã¾ã™ï¼‰'; document.body.appendChild(b); setTimeout(()=>b.remove(), 5000); }, 1000);
  }
  // â–²â–²â–² ã“ã“ã¾ã§ç½®æ›
  window.__room = new URLSearchParams(location.hash.slice(1)).get('r') || 'default';

  // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
  const $ = (id)=>document.getElementById(id);
  const toast=(m,bad=false)=>{const el=document.createElement('div');el.className='toast'+(bad?' bad':'');el.textContent=m;document.body.appendChild(el);setTimeout(()=>el.remove(),3000);}
  const showErr=(m)=>{const e=$('err');e.textContent=m;e.style.display='block';setTimeout(()=>e.style.display='none',10000);}

  // éƒ½é“åºœçœŒ
  const PREFS=["åŒ—æµ·é“","é’æ£®çœŒ","å²©æ‰‹çœŒ","å®®åŸçœŒ","ç§‹ç”°çœŒ","å±±å½¢çœŒ","ç¦å³¶çœŒ","èŒ¨åŸçœŒ","æ ƒæœ¨çœŒ","ç¾¤é¦¬çœŒ","åŸ¼ç‰çœŒ","åƒè‘‰çœŒ","æ±äº¬éƒ½","ç¥å¥ˆå·çœŒ","æ–°æ½ŸçœŒ","å¯Œå±±çœŒ","çŸ³å·çœŒ","ç¦äº•çœŒ","å±±æ¢¨çœŒ","é•·é‡çœŒ","å²é˜œçœŒ","é™å²¡çœŒ","æ„›çŸ¥çœŒ","ä¸‰é‡çœŒ","æ»‹è³€çœŒ","äº¬éƒ½åºœ","å¤§é˜ªåºœ","å…µåº«çœŒ","å¥ˆè‰¯çœŒ","å’Œæ­Œå±±çœŒ","é³¥å–çœŒ","å³¶æ ¹çœŒ","å²¡å±±çœŒ","åºƒå³¶çœŒ","å±±å£çœŒ","å¾³å³¶çœŒ","é¦™å·çœŒ","æ„›åª›çœŒ","é«˜çŸ¥çœŒ","ç¦å²¡çœŒ","ä½è³€çœŒ","é•·å´çœŒ","ç†Šæœ¬çœŒ","å¤§åˆ†çœŒ","å®®å´çœŒ","é¹¿å…å³¶çœŒ","æ²–ç¸„çœŒ"];

  /*************** ãƒ™ãƒ¼ã‚¹ãƒãƒƒãƒ—ï¼ˆOSM & åœ°ç†é™¢ã‚¿ã‚¤ãƒ«ï¼‰ ***************/
  const BASE_SOURCES = {
    osm: { type:'raster', tiles:["https://tile.openstreetmap.org/{z}/{x}/{y}.png"], tileSize:256, attribution:"Â© OpenStreetMap" },
    gsi_std:   { type:'raster', tiles:["https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png"], tileSize:256, attribution:"Â© GSI" },
    gsi_pale:  { type:'raster', tiles:["https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png"], tileSize:256, attribution:"Â© GSI" },
    gsi_photo: { type:'raster', tiles:["https://cyberjapandata.gsi.go.jp/xyz/ort/{z}/{x}/{y}.jpg"], tileSize:256, attribution:"Â© GSI" }
  };

  const map = new maplibregl.Map({
    container:'map',
    style:{ version:8, sources:{ base: BASE_SOURCES.osm }, layers:[{id:'base',type:'raster',source:'base'}] },
    center:[139.767,35.681], zoom:5.2
  });
// ç¸®å°ºãƒãƒ¼
map.addControl(new maplibregl.ScaleControl({maxWidth:140, unit:'metric'}), 'bottom-left');

// ç¾åœ¨åœ°ï¼ˆMapLibre çµ„ã¿è¾¼ã¿ï¼‰
const geo = new maplibregl.GeolocateControl({ positionOptions:{ enableHighAccuracy:true }, trackUserLocation:true, showUserHeading:true });
map.addControl(geo, 'bottom-left');
  document.getElementById('btnGPS')?.addEventListener('click', ()=> geo.trigger());
  let pulse;
geo.on('geolocate', (pos)=>{
  const { longitude, latitude } = pos.coords;
  if(!pulse){
    const el=document.createElement('div');
    el.className='pulse';
    pulse=new maplibregl.Marker({element:el, anchor:'center'});
  }
  pulse.setLngLat([longitude, latitude]).addTo(map);
});


$('basemapSel').addEventListener('change', ()=>{
  const key = $('basemapSel').value;
  // æ—¢å­˜ã®baseã‚’å¤–ã™
  if (map.getLayer('base')) map.removeLayer('base');
  if (map.getSource('base')) map.removeSource('base');

  // æ–°ã—ã„sourceã‚’è¿½åŠ 
  map.addSource('base', BASE_SOURCES[key]);

  // ã„ã¡ã°ã‚“ä¸‹ã«å·®ã—è¾¼ã‚€ï¼ˆã»ã‹ã®ãƒ¬ã‚¤ãƒ¤ã‚’è¦†ã‚ãªã„ï¼‰
  const first = map.getStyle().layers[0]?.id;
  map.addLayer({ id:'base', type:'raster', source:'base' }, first);
});


  /*************** Drawï¼ˆãƒã‚¤ãƒ³ãƒˆ/ãƒ©ã‚¤ãƒ³/ãƒãƒªã‚´ãƒ³ + å††ãƒ„ãƒ¼ãƒ«ï¼‰ ***************/
const draw = new MapboxDraw({
  displayControlsDefault:false,
  controls:{} // â† ã™ã¹ã¦UIéè¡¨ç¤º
});
// map.addControl(draw,'top-right'); â† è¿½åŠ ã—ãªã„

  /*************** ãƒã‚¶ãƒ¼ãƒ‰ï¼ˆæ´ªæ°´=1ã€åœŸç ‚=3ã¾ã¨ã‚ï¼‰ ***************/
  // â˜… å¿…è¦ã«å¿œã˜ã¦URLã‚’è¨­å®šï¼ˆç©ºãªã‚‰è‡ªå‹•ç„¡åŠ¹ï¼‰
  const FLOOD_TILES = "https://disaportaldata.gsi.go.jp/raster/01_flood_l2_shinsuishin_data/{z}/{x}/{y}.png"; // ä¾‹: 'https://{s}.example.com/flood/{z}/{x}/{y}.png'
  const SEDIMENT_TILES = [
    "https://disaportaldata.gsi.go.jp/raster/05_dosekiryukeikaikuiki/{z}/{x}/{y}.png", //"ä¾‹: 'https://{s}.example.com/sediment/debrisflow/{z}/{x}/{y}.png'
    "https://disaportaldata.gsi.go.jp/raster/05_kyukeishakeikaikuiki/{z}/{x}/{y}.png", // ä¾‹: 'https://{s}.example.com/sediment/steepslope/{z}/{x}/{y}.png'
    "https://disaportaldata.gsi.go.jp/raster/05_jisuberikeikaikuiki/{z}/{x}/{y}.png"  // ä¾‹: 'https://{s}.example.com/sediment/landslide/{z}/{x}/{y}.png'
  ];
  const HAZ_FLOOD_SOURCE_ID="haz-flood", HAZ_FLOOD_LAYER_ID="haz-flood";
  const HAZ_SED_SOURCE_IDS=["haz-sed-0","haz-sed-1","haz-sed-2"];
  const HAZ_SED_LAYER_IDS =["haz-sed-0","haz-sed-1","haz-sed-2"];

  function ensureHazardLayers(){
    const opa=Number($('hazOpacity').value||0.6);
    if(FLOOD_TILES && !map.getSource(HAZ_FLOOD_SOURCE_ID)){
      map.addSource(HAZ_FLOOD_SOURCE_ID,{type:'raster',tiles:[FLOOD_TILES],tileSize:256});
    }
    if(FLOOD_TILES && !map.getLayer(HAZ_FLOOD_LAYER_ID)){
      map.addLayer({id:HAZ_FLOOD_LAYER_ID,type:'raster',source:HAZ_FLOOD_SOURCE_ID,paint:{'raster-opacity':opa}});
    }
    SEDIMENT_TILES.forEach((url,i)=>{
      if(!url) return;
      if(!map.getSource(HAZ_SED_SOURCE_IDS[i])){
        map.addSource(HAZ_SED_SOURCE_IDS[i],{type:'raster',tiles:[url],tileSize:256});
      }
      if(!map.getLayer(HAZ_SED_LAYER_IDS[i])){
        map.addLayer({id:HAZ_SED_LAYER_IDS[i],type:'raster',source:HAZ_SED_SOURCE_IDS[i],paint:{'raster-opacity':opa}});
      }
    });
  }
  function updateHazard(){
    const opa=Number($('hazOpacity').value||0.6);
    $('hazOpacityVal').textContent=opa.toFixed(2);
    if(map.getLayer(HAZ_FLOOD_LAYER_ID)){
      map.setPaintProperty(HAZ_FLOOD_LAYER_ID,'raster-opacity',opa);
      map.setLayoutProperty(HAZ_FLOOD_LAYER_ID,'visibility',$('chkFlood').checked?'visible':'none');
    }
    HAZ_SED_LAYER_IDS.forEach(lid=>{
      if(!map.getLayer(lid)) return;
      map.setPaintProperty(lid,'raster-opacity',opa);
      map.setLayoutProperty(lid,'visibility',$('chkSediment').checked?'visible':'none');
    });
  }
  $('chkFlood').addEventListener('change',()=>{ensureHazardLayers();updateHazard();});
  $('chkSediment').addEventListener('change',()=>{ensureHazardLayers();updateHazard();});
  $('hazOpacity').addEventListener('input',updateHazard);

  /*************** â˜…â˜…â˜… TODO 2ï¼šFGBï¼ˆå…¬é–‹URLï¼‰ã‚’è²¼ã‚‹ ***************/
  // Supabase Storage ã® Public URL ã‚’ãã®ã¾ã¾è²¼ã£ã¦ãã ã•ã„ï¼ˆç½²åURLã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰
  const FGB_URL_EMERGENCY='https://tdoxxwhkvdguyfrofnaw.supabase.co/storage/v1/object/public/data/Designated%20Emergency%20Evacuation%20Site.fgb'; // â†ç½®æ›ï¼ˆå…ˆé ­ eï¼‰
  const FGB_URL_SHELTER  ='https://tdoxxwhkvdguyfrofnaw.supabase.co/storage/v1/object/public/data/Designated%20Shelter%20for%20Evacuees.fgb';     // â†ç½®æ›

// è‡ªå·±ãƒ›ã‚¹ãƒˆã—ãŸ flatgeobuf ã‚’ â€œå¿…ãšæœ€åˆã«â€ èª­ã¿ã«ã„ã
const LOCAL_FGB_LIB = './flatgeobuf-geojson.min.js';

/**
 * flatgeobuf ã® GeoJSON ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¶ï¼ˆdeserializeï¼‰ã‚’ç¢ºå®Ÿã«èª­ã¿è¾¼ã‚€ã€‚
 * 1) è‡ªå·±ãƒ›ã‚¹ãƒˆï¼ˆLOCAL_FGB_LIBï¼‰
 * 2) jsDelivr
 * 3) unpkg
 * ãã‚Œã§ã‚‚ãƒ€ãƒ¡ãªã‚‰ã‚¨ãƒ©ãƒ¼ã€‚
 */
async function loadFgbLib() {
  if (window.flatgeobuf?.deserialize) return window.flatgeobuf.deserialize;

  const candidates = [
    LOCAL_FGB_LIB,
    'https://cdn.jsdelivr.net/npm/flatgeobuf@3.27.4/dist/flatgeobuf-geojson.min.js',
    'https://unpkg.com/flatgeobuf@3.27.4/dist/flatgeobuf-geojson.min.js'
  ];

  for (const url of candidates) {
    try {
      await new Promise((resolve, reject) => {
        const s = document.createElement('script');
        s.src = url;
        s.async = true;
        s.onload = resolve;
        s.onerror = () => reject(new Error('failed: ' + url));
        document.head.appendChild(s);
      });
      if (window.flatgeobuf?.deserialize) {
        return window.flatgeobuf.deserialize;
      }
    } catch (e) {
      console.warn('[flatgeobuf] load failed ->', e.message);
    }
  }
  throw new Error('flatgeobufã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ï¼ˆè‡ªå·±ãƒ›ã‚¹ãƒˆ/CDNã¨ã‚‚ä¸å¯ï¼‰');
}

/**
 * FGB ã‚’ URL ã‹ã‚‰èª­ã¿ã€GeoJSON Feature[] ã‚’è¿”ã™ã€‚
 * - å…ˆé ­1ãƒã‚¤ãƒˆ Range å–å¾—ã§ HTMLèª¤é…ä¿¡ã‚’æ¤œçŸ¥
 * - loadFgbLib() ã‚’é€šã—ã¦è‡ªå·±ãƒ›ã‚¹ãƒˆ/ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ç¢ºå®Ÿã«ãƒ­ãƒ¼ãƒ‰
 */
/**
 * FGB ã‚’ URL ã‹ã‚‰èª­ã¿ã€GeoJSON Feature[] ã‚’è¿”ã™ã€‚
 * 1) ã¾ãš URL ã‚’ãã®ã¾ã¾æ¸¡ã—ã¦ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°è§£æï¼ˆRangeï¼‰ã‚’è©¦ã™
 * 2) å¤±æ•—ã—ãŸã‚‰å…¨é‡ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ â†’ Uint8Array ã§ãƒ‘ãƒ¼ã‚¹ï¼ˆç¢ºå®Ÿï¼‰
 */
async function readFGB_fromURL(url) {
  const deserialize = await loadFgbLib();

  // --- ã¾ãšã¯ç°¡æ˜“ãƒã‚§ãƒƒã‚¯ï¼ˆHTML èª¤é…ä¿¡é˜²æ­¢ï¼‰ ---
  try {
    const head = await fetch(url, { headers: { 'Range': 'bytes=0-0' }, cache: 'no-store' });
    if (!head.ok) throw new Error(`FGBãƒ˜ãƒƒãƒ€å–å¾—å¤±æ•— ${head.status} ${head.statusText}`);
    const ct = (head.headers.get('content-type') || '').toLowerCase();
    if (ct.includes('text/html')) {
      throw new Error('FGBç›´ãƒªãƒ³ã‚¯ãŒHTMLã‚’è¿”ã—ã¦ã„ã¾ã™ï¼ˆURL/å…¬é–‹è¨­å®š/ãƒ‘ã‚¹ã‚’ç¢ºèªï¼‰');
    }
  } catch (e) {
    // ãƒ˜ãƒƒãƒ€å–å¾—ãŒãƒ€ãƒ¡ã§ã‚‚å¾Œæ®µã®ã€Œå…¨é‡å–å¾—ã€ã§æ•‘ãˆã‚‹ã®ã§ç¶šè¡Œ
    console.warn('[FGB] head check skip ->', e.message);
  }

  // --- (A) URL ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã§ãƒ‘ãƒ¼ã‚¹ï¼ˆæˆåŠŸã™ã‚Œã°æœ€é€Ÿï¼‰ ---
  try {
    const featsA = [];
    for await (const f of deserialize(url)) featsA.push(f);
    if (featsA.length) return featsA;
  } catch (e) {
    console.warn('[FGB] stream parse failed, fallback to full download ->', e.message);
    // ä¾‹ã®ã€ŒCannot destructure property 'minX' of 'r' as it is undefinedã€ã‚‚ã“ã“ã«æ¥ã¾ã™
  }

  // --- (B) ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šå…¨é‡ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ã‹ã‚‰ãƒ‘ãƒ¼ã‚¹ï¼ˆç¢ºå®Ÿï¼‰ ---
  const resp = await fetch(url, { cache: 'no-store' });
  if (!resp.ok) throw new Error(`FGBãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¤±æ•— ${resp.status} ${resp.statusText}`);
  const buf = await resp.arrayBuffer();
  const featsB = [];
  for await (const f of deserialize(new Uint8Array(buf))) featsB.push(f);
  if (!featsB.length) throw new Error('FGBã®ä¸­èº«ãŒç©ºã§ã™');
  return featsB;
}

  // ã‚¯ãƒªãƒƒã‚¯ã§å±æ€§ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—
  function bindClickPopup(layerId){
    map.on('click', layerId, (e)=>{
      const f=e.features?.[0]; if(!f) return;
      const props=f.properties||{};
      const html='<ul class="popup-list">'+Object.entries(props).filter(([k])=>k!=='__label__')
        .map(([k,v])=>`<li><b>${k}</b> ${String(v)}</li>`).join('')+'</ul>';
      new maplibregl.Popup({offset:12}).setLngLat(e.lngLat).setHTML(html).addTo(map);
    });
    map.on('mouseenter', layerId, ()=> map.getCanvas().style.cursor='pointer');
    map.on('mouseleave', layerId, ()=> map.getCanvas().style.cursor='');
  }

  const MUNI_COL_CANDIDATES=["éƒ½é“åºœçœŒååŠã³å¸‚ç”ºæ‘å","éƒ½é“åºœçœŒåŠã³å¸‚ç”ºæ‘å"];
  const LABEL_CANDIDATES   =["æ–½è¨­ãƒ»å ´æ‰€å","ä½æ‰€","å…±é€šID","NO"];
  let cacheEmergency=null, cacheShelter=null, COL_MUNI=null;

function applyVisibility(){
  const ev = $('chkEmergency').checked ? 'visible' : 'none';
  const sv = $('chkShelter').checked  ? 'visible' : 'none';
  if(map.getLayer('emg-circle'))  map.setLayoutProperty('emg-circle','visibility', ev);
  if(map.getLayer('shel-circle')) map.setLayoutProperty('shel-circle','visibility', sv);
  const lv = $('chkLabel').checked ? 'visible' : 'none';
  if(map.getLayer('emg-label'))   map.setLayoutProperty('emg-label','visibility',  (ev==='visible' ? lv : 'none'));
  if(map.getLayer('shel-label'))  map.setLayoutProperty('shel-label','visibility', (sv==='visible' ? lv : 'none'));
}

  function fitToData(){
    const fc1=map.getSource('emergency')._data;
    const fc2=map.getSource('shelter')._data;
    const all=[...fc1.features,...fc2.features]; if(!all.length) return;
    let minX=180,minY=90,maxX=-180,maxY=-90;
    all.forEach(f=>{ if(f.geometry.type!=='Point') return; const [x,y]=f.geometry.coordinates;
      if(x<minX)minX=x;if(y<minY)minY=y;if(x>maxX)maxX=x;if(y>maxY)maxY=y;});
    if(minX<maxX&&minY<maxY) map.fitBounds([[minX,minY],[maxX,maxY]],{padding:40,maxZoom:13});
  }
  function refresh(){
    if(!cacheEmergency||!cacheShelter) return;
    const mode=document.querySelector('input[name="areaMode"]:checked').value;
    const prefs=new Set(Array.from($('prefSelect').selectedOptions).map(o=>o.value));
    const munis=new Set(Array.from($('muniSelect').selectedOptions).map(o=>o.value));
    const labelField=$('labelFieldSelect').value;

    const getScopeFor = (key)=> (window._scopeLayer?.[key] || window._scopeGlobal);
const filterByArea = (sc)=>(fullName)=>{
  if(!fullName) return sc.mode==='all';
  const pref=PREFS.find(p=>fullName.startsWith(p))||"";
  const city=fullName.slice(pref.length).trim();
  if(sc.mode==='all') return true;
  if(sc.mode==='pref') return sc.prefs.length===0 ? true : sc.prefs.includes(pref);
  if(sc.mode==='muni'){
    if(sc.munis.length===0 && sc.prefs.length===0) return true;
    if(sc.munis.length>0) return sc.munis.includes(`${pref} ${city}`);
    return sc.prefs.includes(pref);
  }
  return true;
};
const decorateWith=(labelField)=>(f)=>{
  const p=f.properties||{};
  const label=(p[labelField]??p["æ–½è¨­ãƒ»å ´æ‰€å"]??p["ä½æ‰€"]??p["å…±é€šID"]??p["NO"]??"");
  return {...f,properties:{...p,__label__:String(label)}};
};
const scopeE = getScopeFor('emergency');
const scopeS = getScopeFor('shelter');
const emgFiltered=(cacheEmergency||[]).filter(f=>filterByArea(scopeE)(String(f.properties?.[COL_MUNI]||""))).map(decorateWith(scopeE.labelField));
const shlFiltered=(cacheShelter  ||[]).filter(f=>filterByArea(scopeS)(String(f.properties?.[COL_MUNI]||""))).map(decorateWith(scopeS.labelField));


    map.getSource('emergency').setData({type:'FeatureCollection',features:emgFiltered});
    map.getSource('shelter').setData({type:'FeatureCollection',features:shlFiltered});
    applyVisibility(); fitToData(); toast('é©å¿œ');
  }

  function hideSuggest(){ $('suggest').style.display='none'; $('suggest').innerHTML=''; }
  function updateSuggest(query){
    const q=String(query||'').trim();
    const chosenPrefs=new Set(Array.from($('prefSelect').selectedOptions).map(o=>o.value));
    const src=(chosenPrefs.size===0)?window.__allMunicipalLabels:window.__allMunicipalLabels.filter(lbl=>chosenPrefs.has(lbl.split(" ")[0]));
    if(!q){hideSuggest();return;}
    const hits=src.filter(lbl=>lbl.includes(q)).slice(0,5);
    if(hits.length===0){hideSuggest();return;}
    $('suggest').innerHTML=hits.map(h=>`<div class="suggest-item" data-v="${h}">${h}</div>`).join("");
    $('suggest').style.display='block';
    Array.from($('suggest').children).forEach(div=>{
      div.addEventListener('click',()=>{
        const val=div.getAttribute('data-v');
        const opt=Array.from($('muniSelect').options).find(o=>o.value===val);
        if(opt){opt.selected=true;refresh();}
        $('qMuni').value=''; hideSuggest();
      });
    });
  }

  async function initFGB(){
    // ã‚½ãƒ¼ã‚¹/ãƒ¬ã‚¤ãƒ¤
    if(!map.getSource('emergency')) map.addSource('emergency',{type:'geojson',data:{type:'FeatureCollection',features:[]}});
    if(!map.getSource('shelter'))   map.addSource('shelter',  {type:'geojson',data:{type:'FeatureCollection',features:[]}});
    if(!map.getLayer('emg-circle')) map.addLayer({id:'emg-circle',type:'circle',source:'emergency',layout:{ visibility:'none' },paint:{'circle-radius':5,'circle-color':'#e23b3b','circle-stroke-color':'#fff','circle-stroke-width':1}});
    if(!map.getLayer('shel-circle')) map.addLayer({id:'shel-circle',type:'circle',source:'shelter',layout:{ visibility:'none' },paint:{'circle-radius':5,'circle-color':'#2a7be4','circle-stroke-color':'#fff','circle-stroke-width':1}});
    if(!map.getLayer('emg-label'))   map.addLayer({id:'emg-label',type:'symbol',source:'emergency',layout:{ visibility:'none','text-field':['get','__label__'],'text-size':12,'text-offset':[0,1.2],'text-anchor':'top'},paint:{'text-halo-width':1.2,'text-halo-color':'#fff'}
});
    if(!map.getLayer('shel-label'))  map.addLayer({id:'shel-label',type:'symbol',source:'shelter',  layout:{ visibility:'none','text-field':['get','__label__'],'text-size':12,'text-offset':[0,1.2],'text-anchor':'top'},paint:{'text-halo-width':1.2,'text-halo-color':'#fff'}});
    bindClickPopup('emg-circle'); bindClickPopup('shel-circle');
    // â† ã“ã‚Œã‚’è¿½åŠ ï¼ˆãƒ©ãƒ™ãƒ«/ãƒ¬ã‚¤ãƒ¤ã®è¡¨ç¤ºåˆ‡æ›¿ï¼‰
['chkEmergency','chkShelter','chkLabel'].forEach(id=>{
  $(id).addEventListener('change', applyVisibility);
});

    // UI
    document.querySelectorAll('input[name="areaMode"]').forEach(r=>{
      r.addEventListener('change',()=>{
        const v=document.querySelector('input[name="areaMode"]:checked').value;
        $('prefRow').style.display=(v==='pref'||v==='muni')?'':'none';
        $('muniRow').style.display=(v==='muni')?'':'none';
      });
    });
    $('btnReset').addEventListener('click',()=>{
      document.querySelector('input[name="areaMode"][value="all"]').checked=true;
      $('prefRow').style.display='none'; $('muniRow').style.display='none';
      Array.from($('prefSelect').options).forEach(o=>o.selected=false);
      Array.from($('muniSelect').options).forEach(o=>o.selected=false);
      $('qMuni').value=''; refresh();

    });
    ['chkEmergency','chkShelter','chkLabel'].forEach(id=>$(id).addEventListener('change',applyVisibility));
    $('btnApply').addEventListener('click',refresh);
    // è¡¨ç¤ºç¯„å›²ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ï¼ˆå…¨ä½“ï¼å€‹åˆ¥ï¼‰
const extentPanel = $('extentPanel');
$('btnExtent').onclick = ()=>{ extentPanel.dataset.scope=''; $('extentScopeNote').textContent='(å…¨ãƒ¬ã‚¤ãƒ¤)'; extentPanel.style.display='block'; };
$('btnScopeEmergency').onclick = ()=>{ extentPanel.dataset.scope='emergency'; $('extentScopeNote').textContent='(ç·Šæ€¥ã®ã¿)'; extentPanel.style.display='block'; };
$('btnScopeShelter'  ).onclick = ()=>{ extentPanel.dataset.scope='shelter';  $('extentScopeNote').textContent='(é¿é›£æ‰€ã®ã¿)'; extentPanel.style.display='block'; };
$('btnExtentOK').onclick = ()=>{ extentPanel.style.display='none'; };
$('btnExtentApply').onclick = ()=>{ refresh(); };

// ãƒ‰ãƒ©ãƒƒã‚°ç§»å‹•
(function(){
  const header=extentPanel.querySelector('.handle');
  let sx=0,sy=0,left=0,top=0,dragging=false;
  header.addEventListener('pointerdown',e=>{dragging=true;sx=e.clientX;sy=e.clientY;const r=extentPanel.getBoundingClientRect();left=r.left;top=r.top;header.setPointerCapture(e.pointerId);});
  header.addEventListener('pointermove',e=>{if(!dragging)return;const dx=e.clientX-sx,dy=e.clientY-sy;extentPanel.style.left=(left+dx)+'px';extentPanel.style.top=(top+dy)+'px';});
  header.addEventListener('pointerup',()=>{dragging=false;});
})();


    // éƒ½é“åºœçœŒã‚»ãƒ¬ã‚¯ãƒˆ
    PREFS.forEach(p=>{const o=document.createElement('option');o.value=p;o.textContent=p;$('prefSelect').appendChild(o);});
    $('prefSelect').addEventListener('change',renderMuniOptions);

    // FGB èª­ã¿è¾¼ã¿
    try{
      const [emgFeats,shelFeats]=await Promise.all([
        readFGB_fromURL(FGB_URL_EMERGENCY),
        readFGB_fromURL(FGB_URL_SHELTER)
      ]);
      cacheEmergency=emgFeats; cacheShelter=shelFeats;

      const propKeys=new Set([...Object.keys(emgFeats[0]?.properties||{}),...Object.keys(shelFeats[0]?.properties||{})]);
      COL_MUNI=MUNI_COL_CANDIDATES.find(k=>propKeys.has(k))||null;
      if(!COL_MUNI) showErr('ã€Œéƒ½é“åºœçœŒååŠã³å¸‚ç”ºæ‘åã€åˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆCOL_MUNIæœªè¨­å®šï¼‰');

      // ãƒ©ãƒ™ãƒ«å€™è£œ
      $('labelFieldSelect').innerHTML='';
      const labels=LABEL_CANDIDATES.filter(k=>propKeys.has(k));
      (labels.length?labels:Array.from(propKeys)).forEach(k=>{
        const o=document.createElement('option');o.value=k;o.textContent=k;$('labelFieldSelect').appendChild(o);
      });
      if($('labelFieldSelect').options.length) $('labelFieldSelect').value=$('labelFieldSelect').options[0].value;

      // å¸‚åŒºç”ºæ‘å€™è£œ
      const uniq=a=>[...new Set(a)];
      const names=uniq([...emgFeats,...shelFeats].map(f=>String(f.properties?.[COL_MUNI]||"").trim()).filter(Boolean));
      function splitPrefCity(full){const pref=PREFS.find(p=>full.startsWith(p))||"";return {pref,city:full.slice(pref.length).trim()||full};}
      window.__allMunicipalLabels=names.map(n=>{const {pref,city}=splitPrefCity(n);return pref?`${pref} ${city||"(åç§°ä¸æ˜)"}`:n;}).sort((a,b)=>a.localeCompare(b,'ja'));
      function renderMuniOptions(){
        const chosenPrefs=new Set(Array.from($('prefSelect').selectedOptions).map(o=>o.value));
        $('muniSelect').innerHTML="";
        const list=(chosenPrefs.size===0)?window.__allMunicipalLabels:window.__allMunicipalLabels.filter(lbl=>chosenPrefs.has(lbl.split(" ")[0]));
        list.forEach(lbl=>{const o=document.createElement('option');o.value=lbl;o.textContent=lbl;$('muniSelect').appendChild(o);});
        updateSuggest($('qMuni').value);
      }
      window.renderMuniOptions=renderMuniOptions;
      $('qMuni').addEventListener('input',()=>updateSuggest($('qMuni').value));
      $('qMuni').addEventListener('blur',()=>setTimeout(hideSuggest,150));
      $('qMuni').addEventListener('keydown',(ev)=>{if(ev.key==='Enter'){const val=$('qMuni').value;if(val){updateSuggest(val);}}});
      renderMuniOptions();

      // åˆå›æç”»
      refresh();
    }catch(e){
      showErr('FGBãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ï¼š'+e.message);
    }
  }

  /*************** éƒ¨å±‹ãƒ»å…±æœ‰ãƒ»ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ ***************/
$('btnExport').onclick=()=>{
  const fc = window.userFC || {type:'FeatureCollection',features:[]};
  const blob=new Blob([JSON.stringify(fc)],{type:'application/json'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='features.geojson';
  a.click();
};

  /*************** Supabaseï¼šå›³å½¢ä¿å­˜/èª­è¾¼ + GPS ***************/
  (function whenReady(){
    const ok=!!(window.map&&window.draw&&typeof draw.add==='function');
    if(!ok) return setTimeout(whenReady,200);
    window.__supaload=loadFeatures;
    window.__supasave=saveFeatures;
    window.__gpstart =startGpsLog;
    window.__gpstop  =stopGpsLog;
    window.__gpshow  =showTracks;
  })();

  async function loadFeatures(){
    try{
      const {data,error}=await __supa.from('features').select('id,geojson').eq('room',__room).order('id');
      if(error) throw error;
      const feats=(data||[]).map(r=>r.geojson);
      if(feats.length){draw.deleteAll();draw.add({type:'FeatureCollection',features:feats});}
      toast('å›³å½¢ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼ˆ'+(feats.length||0)+'ä»¶ï¼‰');
    }catch(e){toast('èª­è¾¼å¤±æ•—: '+e.message,true);}
  }
  async function saveFeatures(){
    try{
      const fc=draw.getAll();
      if(!fc.features?.length){toast('ä¿å­˜ã™ã‚‹å›³å½¢ãŒã‚ã‚Šã¾ã›ã‚“',true);return;}
      const rows=fc.features.map(f=>({room:__room,kind:(f.properties?.kind)||f.geometry?.type?.toLowerCase()||'feature',geojson:f,props:f.properties||{}}));
      const {error}=await __supa.from('features').insert(rows);
      if(error) throw error;
      toast('å›³å½¢ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
    }catch(e){toast('ä¿å­˜å¤±æ•—: '+e.message,true);}
  }

  let watchId=null,currentTrackId=null;
  async function startGpsLog(name='ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰èª¿æŸ»'){
    if(!navigator.geolocation){toast('ä½ç½®æƒ…å ±ãŒä½¿ãˆã¾ã›ã‚“',true);return;}
    const {data:tk,error:e1}=await __supa.from('tracks').insert({room:__room,name}).select().single();
    if(e1){toast('ãƒˆãƒ©ãƒƒã‚¯ä½œæˆå¤±æ•—: '+e1.message,true);return;}
    currentTrackId=tk.id;
    let last=null;
    watchId=navigator.geolocation.watchPosition(async pos=>{
      const {longitude:lon,latitude:lat,accuracy:acc,speed,heading}=pos.coords;
      const tiso=new Date(pos.timestamp).toISOString();
      if(last){
        const dx=Math.abs(lon-last.lon)*111320, dy=Math.abs(lat-last.lat)*110540;
        if(dx<10&&dy<10) return;
      }
      last={lon,lat};
      await __supa.from('track_points').insert({track_id:currentTrackId,t:tiso,lon,lat,acc,speed,heading});
    }, err=>toast('GPSã‚¨ãƒ©ãƒ¼: '+err.message,true), {enableHighAccuracy:true,maximumAge:1000,timeout:10000});
    toast('GPSãƒ­ã‚¬ãƒ¼é–‹å§‹');
  }
  function stopGpsLog(){ if(watchId){navigator.geolocation.clearWatch(watchId);watchId=null;} currentTrackId=null; toast('GPSãƒ­ã‚¬ãƒ¼åœæ­¢'); }
  async function showTracks(){
    const {data:tracks}=await __supa.from('tracks').select('id').eq('room',__room);
    if(!tracks?.length){toast('ãƒˆãƒ©ãƒƒã‚¯ãŒã‚ã‚Šã¾ã›ã‚“',true);return;}
    const ids=tracks.map(r=>r.id);
    const {data:pts}=await __supa.from('track_points').select('track_id,t,lon,lat').in('track_id',ids).order('t');
    const by=new Map(); (pts||[]).forEach(p=>{if(!by.has(p.track_id))by.set(p.track_id,[]);by.get(p.track_id).push([p.lon,p.lat]);});
    const fc={type:'FeatureCollection',features:[...by.entries()].map(([id,coords])=>({type:'Feature',properties:{id},geometry:{type:'LineString',coordinates:coords}}))};
    if(!map.getSource('tracks')) map.addSource('tracks',{type:'geojson',data:fc}); else map.getSource('tracks').setData(fc);
    if(!map.getLayer('tracks-line')) map.addLayer({id:'tracks-line',type:'line',source:'tracks',paint:{'line-color':'#ef4444','line-width':3}});
    toast('è»Œè·¡ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ');
  }

  /*************** åœ°å›³ãƒ­ãƒ¼ãƒ‰ï¼šä¸€æ‹¬åˆæœŸåŒ– ***************/
  map.on('load',()=>{
    /* ==== basemap & controlsï¼ˆé™°å½±èµ·ä¼å›³ï¼‹GSIãƒ¬ã‚¤ãƒ¤ï¼‰ ==== */
// é™°å½±èµ·ä¼å›³ï¼ˆã„ã¡ã°ã‚“ä¸‹ï¼‰
if (!map.getSource('hillshade')) {
  map.addSource('hillshade', {
    type:'raster',
    tiles:['https://cyberjapandata.gsi.go.jp/xyz/hillshademap/{z}/{x}/{y}.png'],
    tileSize:256,
    attribution:'<a href="https://maps.gsi.go.jp/development/ichiran.html" target="_blank">GSI</a>'
  });
  const first = map.getStyle().layers[0]?.id;
  map.addLayer({ id:'hillshade', type:'raster', source:'hillshade', paint:{ 'raster-opacity':0.55 } }, first);
}
// åœ°ç†é™¢ æ¨™æº–/å†™çœŸï¼ˆå°‘ã—é€æ˜ï¼‰
if (!map.getSource('gsi-std')) {
  map.addSource('gsi-std', { type:'raster', tiles:['https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png'], tileSize:256 });
  map.addLayer({ id:'gsi-std', type:'raster', source:'gsi-std', layout:{ visibility:'none' }, paint:{ 'raster-opacity':0.85 } });
}
if (!map.getSource('gsi-photo')) {
  map.addSource('gsi-photo', { type:'raster', tiles:['https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/{z}/{x}/{y}.jpg'], tileSize:256 });
  map.addLayer({ id:'gsi-photo', type:'raster', source:'gsi-photo', layout:{ visibility:'none' }, paint:{ 'raster-opacity':0.85 } });
}

    try{
      // ãƒã‚¶ãƒ¼ãƒ‰
      ensureHazardLayers(); updateHazard();

      // FGB
      initFGB();

      // å…±æœ‰è¡¨ç¤º
    }catch(e){
      console.error(e); showErr('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: '+e.message);
    }

/* ==== /basemap & controls ==== */
/* ==== user objects layers ==== */
// ãƒ¦ãƒ¼ã‚¶ãƒ¼å›³å½¢ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ï¼‰
window.userFC = { type:'FeatureCollection', features:[] };
if (!map.getSource('user-src')){
  map.addSource('user-src', { type:'geojson', data:window.userFC });

  const pinSvg = `data:image/svg+xml;utf8,` + encodeURIComponent(
    `<svg xmlns="http://www.w3.org/2000/svg" width="28" height="40" viewBox="0 0 24 34">
      <path fill="#e53935" d="M12 0C5.9 0 1 4.9 1 11c0 7.9 9.3 22.3 10 23.4.1.2.3.3.5.3s.4-.1.5-.3c.7-1.1 10-15.5 10-23.4C23 4.9 18.1 0 12 0z"/><circle cx="12" cy="11" r="4.5" fill="#fff"/></svg>`
  );
  if (!map.hasImage('pin')) map.loadImage(pinSvg, (err,img)=>{ if(!err && !map.hasImage('pin')) map.addImage('pin', img, { pixelRatio:2 }); });

  map.addLayer({ id:'user-point', type:'symbol', source:'user-src',
    filter:['==',['get','_type'],'point'],
    layout:{ 'icon-image':'pin','icon-anchor':'bottom','icon-size':1,
      'text-field':['coalesce',['get','label'],''],'text-size':['coalesce',['get','labelSize'],12],
      'text-anchor':'top','text-offset':[0,-0.6],'text-allow-overlap':true },
    paint:{ 'text-color':['coalesce',['get','labelColor'],'#1f2d3d'],'text-halo-color':'#fff','text-halo-width':2 }
  });
  map.addLayer({ id:'user-line', type:'line', source:'user-src',
    filter:['==',['get','_type'],'line'],
    paint:{ 'line-color':['coalesce',['get','lineColor'],'#e53935'],'line-width':['coalesce',['get','lineWidth'],2],'line-dasharray':[2,2] }
  });
  map.addLayer({ id:'user-poly-fill', type:'fill', source:'user-src',
    filter:['in',['get','_type'],['literal',['polygon','circle']]],
    paint:{ 'fill-color':['coalesce',['get','fillColor'],'#43a047'],'fill-opacity':['coalesce',['get','fillOpacity'],0.5] }
  });
  map.addLayer({ id:'user-poly-line', type:'line', source:'user-src',
    filter:['in',['get','_type'],['literal',['polygon','circle']]],
    paint:{ 'line-color':['coalesce',['get','lineColor'],'#2e7d32'],'line-width':['coalesce',['get','lineWidth'],2] }
  });

  map.addSource('user-temp', { type:'geojson', data:{ type:'FeatureCollection', features:[] }});
  map.addLayer({ id:'user-temp-line', type:'line', source:'user-temp',
    paint:{ 'line-color':'#1976d2','line-width':2,'line-dasharray':[1,1] }});
  map.addLayer({ id:'user-temp-fill', type:'fill', source:'user-temp',
    paint:{ 'fill-color':'#1976d2','fill-opacity':0.2 }});
}
/* ==== /user objects layers ==== */

  });
  </script>
  <script>
/* ==== object tools & list ==== */
let addMode=null, tempCoords=[], circleCenter=null;
const setTemp = fc => map.getSource('user-temp').setData(fc || {type:'FeatureCollection',features:[]});
const pushFeature = f => { window.userFC.features.push(f); map.getSource('user-src').setData(window.userFC); refreshObjList(); };

// ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼šãƒ¡ã‚¤ãƒ³ãƒœã‚¿ãƒ³ â†’ ã‚µãƒ–ãƒ„ãƒ¼ãƒ«é–‹é–‰
document.getElementById('btnObj').addEventListener('click', ()=>{
  const sub=document.getElementById('objSubtools');
  const now=sub.style.display==='flex';
  sub.style.display = now ? 'none' : 'flex';
  document.getElementById('btnObj').classList.toggle('toggle-on', !now);
  if (now){ addMode=null; setTemp(); document.querySelectorAll('#objSubtools .tool').forEach(t=>t.classList.remove('active')); }
});
// å„ãƒ„ãƒ¼ãƒ«é¸æŠ
document.querySelectorAll('#objSubtools .tool').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('#objSubtools .tool').forEach(t=>t.classList.remove('active'));
    btn.classList.add('active'); addMode=btn.dataset.mode; tempCoords=[]; circleCenter=null; setTemp();
  });
});

// ãƒãƒƒãƒ—æ“ä½œ
map.on('click', (e)=>{
  if (!addMode) return;
  if (addMode==='point'){
    const label = document.getElementById('uiLabel')?.value || '';
    pushFeature({ type:'Feature', properties:{ _type:'point', label }, geometry:{ type:'Point', coordinates:[e.lngLat.lng,e.lngLat.lat] }});
    return; // é€£ç¶šè¿½åŠ 
  }
  if (addMode==='circle'){
    if (!circleCenter){ circleCenter=[e.lngLat.lng,e.lngLat.lat]; }
    else{
      const rKm=turf.distance(circleCenter,[e.lngLat.lng,e.lngLat.lat],{units:'kilometers'});
      const poly=turf.circle(circleCenter,rKm,{steps:64,units:'kilometers'});
      pushFeature({ type:'Feature', properties:{ _type:'circle', label:document.getElementById('uiLabel')?.value||'' }, geometry:poly.geometry });
      setTemp(); circleCenter=null;
    }
    return;
  }
  const p=[e.lngLat.lng,e.lngLat.lat]; tempCoords.push(p); drawTemp();
});
map.on('mousemove',(e)=>{
  if (!addMode) return;
  if (addMode==='circle' && circleCenter){
    const rKm=turf.distance(circleCenter,[e.lngLat.lng,e.lngLat.lat],{units:'kilometers'});
    const poly=turf.circle(circleCenter,rKm,{steps:64,units:'kilometers'});
    setTemp({ type:'FeatureCollection', features:[{ type:'Feature', properties:{}, geometry:poly.geometry }] });
    return;
  }
  if ((addMode==='line'||addMode==='polygon') && tempCoords.length){
    const coords=tempCoords.concat([[e.lngLat.lng,e.lngLat.lat]]);
    const feat = (addMode==='line')
      ? { type:'Feature', properties:{}, geometry:{ type:'LineString', coordinates:coords } }
      : { type:'Feature', properties:{}, geometry:{ type:'Polygon', coordinates:[ coords.concat([tempCoords[0]]) ] } };
    setTemp({ type:'FeatureCollection', features:[feat] });
  }
});
map.on('dblclick',(e)=>{
  if (!addMode) return;
  if (addMode==='line' && tempCoords.length>=2){
    pushFeature({ type:'Feature', properties:{ _type:'line', label:document.getElementById('uiLabel')?.value||'' },
      geometry:{ type:'LineString', coordinates: tempCoords.concat([[e.lngLat.lng,e.lngLat.lat]]) } });
    tempCoords=[]; setTemp();
  }else if (addMode==='polygon' && tempCoords.length>=2){
    const coords=tempCoords.concat([[e.lngLat.lng,e.lngLat.lat]]);
    // å§‹ç‚¹ã«å¸ç€
    const p0=map.project(tempCoords[0]), pN=map.project([e.lngLat.lng,e.lngLat.lat]);
    if (Math.hypot(p0.x-pN.x,p0.y-pN.y)<15) coords[coords.length-1]=tempCoords[0];
    pushFeature({ type:'Feature', properties:{ _type:'polygon', label:document.getElementById('uiLabel')?.value||'' },
      geometry:{ type:'Polygon', coordinates:[ coords.concat([coords[0]]) ] } });
    tempCoords=[]; setTemp();
  }
});
function drawTemp(){
  if (!tempCoords.length) return setTemp();
  const feat=(addMode==='line')
    ? { type:'Feature', properties:{}, geometry:{ type:'LineString', coordinates:tempCoords } }
    : { type:'Feature', properties:{}, geometry:{ type:'Polygon', coordinates:[ tempCoords.concat([tempCoords[0]]) ] } };
  setTemp({ type:'FeatureCollection', features:[feat] });
}

// å³ãƒ‘ãƒãƒ«ï¼šãƒªã‚¹ãƒˆï¼†ã‚°ãƒ«ãƒ¼ãƒ—ï¼†ã‚¹ã‚¿ã‚¤ãƒ«
const objList=document.getElementById('objList');
const scopeRadios=[...document.querySelectorAll('input[name="styleScope"]')];
function getId(f){ return f.id || (f.id=Math.random().toString(36).slice(2)); }
function findFeatureById(fid){ return window.userFC.features.find(f=>getId(f)===fid); }
function removeFeature(f){ const i=window.userFC.features.indexOf(f); if(i>-1){ userFC.features.splice(i,1); map.getSource('user-src').setData(window.userFC); refreshObjList(); } }

function refreshObjList(){
  objList.innerHTML='';
  const groups={}, orphans=[];
  for (const f of window.userFC.features){ const g=f.properties._group; g ? (groups[g]??=({id:g,items:[]})).items.push(f) : orphans.push(f); }
  orphans.forEach(f=> objList.appendChild(makeObjItem(f)));
  Object.values(groups).forEach(g=>{
    const box=document.createElement('div'); box.className='grpItem'; box.draggable=true; box.dataset.gid=g.id;
    box.innerHTML=`<div class="objType type-poly"></div><strong>ã‚°ãƒ«ãƒ¼ãƒ—</strong>`;
    const wrap=document.createElement('div'); wrap.style.marginTop='4px'; g.items.forEach(f=> wrap.appendChild(makeObjItem(f)));
    box.appendChild(wrap); addDnD(box,'group'); objList.appendChild(box);
  });
}
function makeObjItem(f){
  const el=document.createElement('div'); el.className='objItem'; el.draggable=true; el.dataset.fid=getId(f);
  const typ=f.properties._type;
  const icon=document.createElement('div'); icon.className='objType type-'+typ;

  // ãƒ©ãƒ™ãƒ«ï¼šãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§ç·¨é›†
  const label=document.createElement('span'); label.className='objLabel';
  label.textContent=f.properties.label||'(ç„¡é¡Œ)';
  label.title='ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§ãƒ©ãƒ™ãƒ«ç·¨é›†';
  label.ondblclick=()=>{
    const nv=prompt('ãƒ©ãƒ™ãƒ«ã‚’å…¥åŠ›', f.properties.label||'');
    if(nv===null) return;
    f.properties.label=nv.trim();
    label.textContent=f.properties.label||'(ç„¡é¡Œ)';
    map.getSource('user-src').setData(window.userFC);
  };

  // ğŸ¨ ã‚¹ã‚¿ã‚¤ãƒ«ç·¨é›†ãƒãƒƒãƒ—
  const styBtn=document.createElement('button'); styBtn.className='miniBtn'; styBtn.textContent='ğŸ¨';
  styBtn.title='è‰²/å¤ªã•/é€æ˜åº¦';
  styBtn.onclick=(e)=>{
    e.stopPropagation();
    const p=document.createElement('div');
    p.className='floating'; p.style.left=(e.clientX-140)+'px'; p.style.top=(e.clientY-40)+'px';
    p.innerHTML=`
      <div class="floatHeader">ã‚¹ã‚¿ã‚¤ãƒ«<span class="handle">â£¿</span></div>
      <div class="floatBody">
        <div class="row"><label>ç·šè‰² <input type="color" id="stLine" value="${f.properties.stroke||'#1f2d3d'}"></label></div>
        <div class="row"><label>ç·šå¹… <input type="number" id="stWidth" value="${f.properties.strokeWidth||2}" min="1" max="12"></label></div>
        <div class="row"><label>å¡—è‰² <input type="color" id="stFill" value="${f.properties.fill||'#1f78b4'}"></label></div>
        <div class="row"><label>ä¸é€æ˜åº¦ <input type="number" id="stFillOp" value="${f.properties.fillOpacity??0.3}" min="0" max="1" step="0.05"></label></div>
        <div class="row" style="margin-top:8px">
          <button class="btn" id="stApply">é©å¿œ</button>
          <button class="btn secondary" id="stClose">é–‰ã˜ã‚‹</button>
        </div>
      </div>`;
    document.body.appendChild(p);
    // ãƒ‰ãƒ©ãƒƒã‚°
    (function(h= p.querySelector('.handle')){let sx,sy,L=p.offsetLeft,T=p.offsetTop,D=false;
      h.addEventListener('pointerdown',e=>{D=true;sx=e.clientX;sy=e.clientY;h.setPointerCapture(e.pointerId);});
      h.addEventListener('pointermove',e=>{if(!D)return; p.style.left=(L+e.clientX-sx)+'px';p.style.top=(T+e.clientY-sy)+'px';});
      h.addEventListener('pointerup',()=>{D=false;L=p.offsetLeft;T=p.offsetTop;});
    })();
    p.querySelector('#stApply').onclick=()=>{
      const g=f.properties;
      g.stroke = p.querySelector('#stLine').value;
      g.strokeWidth = Number(p.querySelector('#stWidth').value)||2;
      g.fill = p.querySelector('#stFill').value;
      g.fillOpacity = Number(p.querySelector('#stFillOp').value)||0.3;
      map.getSource('user-src').setData(window.userFC);
    };
    p.querySelector('#stClose').onclick=()=> p.remove();
  };

  const del=document.createElement('button'); del.className='miniBtn'; del.textContent='å‰Šé™¤'; del.onclick=()=>removeFeature(f);

  el.append(icon,label,styBtn,del);
  addDnD(el,'feature');
  return el;
}

// åˆæœŸæç”»
refreshObjList();
/* ==== /object tools & list ==== */
</script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
  // â˜…ã“ã“ã«ã‚ãªãŸã®è¨­å®šã‚’å…¥ã‚Œã¦ãã ã•ã„
  const SUPABASE_URL = '';        // ä¾‹: 'https://xxxxx.supabase.co'
  const SUPABASE_ANON_KEY = '';   // anon public key
  let sb = null, sbUser = null;

  (async function initAuth(){
    if(!SUPABASE_URL || !SUPABASE_ANON_KEY) return; // æœªè¨­å®šãªã‚‰ä½•ã‚‚ã—ãªã„
    sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const { data:{ user } } = await sb.auth.getUser();
    sbUser = user || null;
    updateSignUI();
    if(sbUser) await loadUserData();
  })();

  function updateSignUI(){
    if(!sb) return;
    $('btnSignIn').style.display = sbUser ? 'none' : '';
    $('signinState').style.display = sbUser ? '' : 'none';
    $('btnShare').style.display = sbUser ? '' : 'none';
  }

  $('btnSignIn')?.addEventListener('click', async ()=>{
    const email = prompt('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    if(!email || !sb) return;
    const { error } = await sb.auth.signInWithOtp({ email, options:{ emailRedirectTo: location.href }});
    if(error) alert('é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: '+error.message);
    else alert('ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚å±Šã„ãŸãƒªãƒ³ã‚¯ã‹ã‚‰é–‹ã„ã¦ãã ã•ã„ã€‚');
  });

  $('btnShare')?.addEventListener('click', async ()=>{
    if(!sbUser) return;
    // ã‚·ãƒ³ãƒ—ãƒ«ã«ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼å›ºæœ‰URLã€ã‚’å…±æœ‰ï¼ˆ?uid=ï¼‰
    const url = new URL(location.href);
    url.searchParams.set('uid', sbUser.id);
    await navigator.clipboard.writeText(url.toString());
    alert('å…±æœ‰ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
  });

  async function loadUserData(){
    try{
      const uid = new URL(location.href).searchParams.get('uid') || sbUser?.id;
      if(!uid) return;
      const { data, error } = await sb.from('user_maps').select('data').eq('user_id', uid).single();
      if(error || !data) return;
      if(data.data?.features){
        window.userFC = data.data;
        if(map.getSource('user-src')) map.getSource('user-src').setData(window.userFC);
        refreshObjList?.();
      }
    }catch(e){ console.warn('loadUserData', e); }
  }

  // å¤‰æ›´ã®ãŸã³è‡ªå‹•ä¿å­˜
  async function autoSave(){
    if(!sb || !sbUser) return;
    try{
      const rec = { user_id: sbUser.id, data: window.userFC, updated_at: new Date().toISOString() };
      await sb.from('user_maps').upsert(rec, { onConflict:'user_id' });
    }catch(e){ console.warn('autosave', e); }
  }
  // æ—¢å­˜ã® pushFeature / removeFeature ãªã©ã®æœ«å°¾ã§ autoSave() ã‚’å‘¼ã³ã¾ã™
  const _push = window.pushFeature;
  window.pushFeature = (f)=>{ _push(f); autoSave(); };
  const _rm = window.removeFeature;
  window.removeFeature = (f)=>{ _rm(f); autoSave(); };
</script>

</body>
</html>
