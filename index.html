<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>PHN Field Collab</title>

  <!-- MapLibre + Draw CSS -->
  <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css"/>
  <link rel="stylesheet" href="https://unpkg.com/@mapbox/mapbox-gl-draw@1.5.0/dist/mapbox-gl-draw.css"/>

  <style>
    html,body,#map{height:100%;width:100%;margin:0}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP","Hiragino Kaku Gothic ProN",Meiryo,sans-serif;color:#111827}

    /* „Éà„ÉÉ„Éó„Éê„Éº */
    .topbar{position:absolute;left:12px;right:12px;top:8px;z-index:30;display:flex;gap:8px;flex-wrap:wrap;pointer-events:none}
    .chip{pointer-events:auto;padding:6px 10px;border-radius:10px;border:1px solid #e5e7eb;background:rgba(255,255,255,.9);backdrop-filter:blur(6px);font-size:12px;font-weight:700}
    .chip.btn{cursor:pointer;background:#0ea5e9;color:#fff}
    .chip.btn.secondary{background:#eef2ff;color:#111827}
    #btnSurvey{position:relative;display:inline-flex;align-items:center;gap:6px}
    .recBadge{display:inline-flex;align-items:center;justify-content:center;padding:1px 6px;border-radius:6px;font-size:11px;font-weight:700;background:rgba(255,255,255,.9);color:#dc2626;border:1px solid rgba(220,38,38,.25)}
    .recBadge.recBlink{animation:recBlink 1s steps(2,start) infinite}
    .recBadge.paused{animation:none;color:#111827;background:#fde68a;border-color:#fbbf24}
    @keyframes recBlink{0%,49%{opacity:1}50%,100%{opacity:.2}}

    /* Â∑¶„Éë„Éç„É´ÔºàÂçäÈÄèÊòéÔºâ */
    .panel{position:absolute;left:12px;top:56px;width:340px;max-height:calc(100% - 68px);padding:12px;border-radius:12px;background:rgba(255,255,255,.86);backdrop-filter:blur(6px);box-shadow:0 8px 28px rgba(0,0,0,.12);overflow:auto;z-index:20}
    .panel h3{margin:0 0 8px;font-size:16px}
    .panel .group{margin:10px 0}
    .panel .row{display:flex;gap:8px}
    .panel .row>*{flex:1 1 0}
    .layerRow{display:flex;align-items:center;gap:8px;margin:6px 0}
    .layerRow label{flex:1}
    .layerActions{display:flex;gap:4px}
    .panel label{font-size:13px;display:inline-flex;align-items:center;gap:6px;margin:4px 8px 4px 0}
    .panel input[type="text"],.panel select{width:100%;padding:8px 10px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;font-size:13px}
    .panel .btn{display:inline-block;padding:8px 12px;border-radius:10px;border:1px solid #e5e7eb;background:#0ea5e9;color:#fff;font-weight:700;cursor:pointer;text-align:center}
    .panel .btn.secondary{background:#f3f4f6;color:#111827}
    .panel .btn:disabled{opacity:.55;cursor:not-allowed}

    /* Âè≥„Éë„Éç„É´ÔºàÂçäÈÄèÊòéÔºâ */
.rightpane{
  position:absolute; right:12px; top:56px;
  width:320px; max-height:calc(100% - 68px);
  padding:12px; border-radius:12px;
  background:rgba(255,255,255,.86); backdrop-filter:blur(6px);
  box-shadow:0 8px 28px rgba(0,0,0,.12); overflow:auto; z-index:20;
}
.rightpane h4{ margin:0 0 8px; font-size:16px; }


    /* Â∑¶‰∏ãÔºöSupabase Êìç‰Ωú */
    .supabox{position:absolute;left:12px;bottom:12px;z-index:20;min-width:260px;padding:10px;border-radius:12px;background:rgba(255,255,255,.88);backdrop-filter:blur(6px);box-shadow:0 8px 28px rgba(0,0,0,.12)}
    .supabox h4{margin:0 0 6px;font-size:14px;font-weight:800}
    .supabox .row{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:6px}
    .supabox button{padding:6px 9px;border-radius:10px;border:1px solid #e5e7eb;background:#f8fafc;cursor:pointer;font-size:12px}
    .supabox button:hover{background:#eef2ff}
    .supabox .danger{background:#fee2e2;border-color:#fecaca}
    .supabox .wfull{flex:1 1 100%}

    /* „Çµ„Ç∏„Çß„Çπ„Éà */
    .suggest{position:absolute;width:calc(100% - 24px);max-height:220px;overflow:auto;z-index:40;background:#fff;border:1px solid #e5e7eb;border-radius:10px;box-shadow:0 10px 28px rgba(0,0,0,.12);display:none}
    .suggest-item{padding:8px 10px;cursor:pointer}
    .suggest-item:hover{background:#f1f5f9}

    /* „Éà„Éº„Çπ„Éà/„Ç®„É©„Éº */
    .toast{position:fixed;right:12px;bottom:12px;z-index:40;background:#ecfeff;border:1px solid #a5f3fc;border-radius:10px;padding:10px 12px;font-size:12px}
    .toast.bad{background:#fee2e2;border-color:#fecaca;color:#7f1d1d}
    .errbar{position:absolute;left:50%;transform:translateX(-50%);top:8px;z-index:50;background:#fee2e2;color:#7f1d1d;border:1px solid #fecaca;border-radius:10px;padding:8px 12px;display:none}

    /* „Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóÊï¥ÂΩ¢ */
    .popup-list{margin:0;padding:0;list-style:none;font-size:12px;max-width:340px}
    .popup-list li{border-bottom:1px solid #f1f5f9;padding:6px 0}
    .popup-list li:last-child{border-bottom:none}
    .popup-list b{display:inline-block;min-width:120px;color:#374151}
    .note-popup{font-size:12px;line-height:1.4;max-width:240px}
    .note-popup div{margin:2px 0}
    /* --- Êó¢Â≠ò„Éë„Éç„É´„ÇíÂ∞ë„ÅóÈÄèÊòé„Å´ --- */
.panel{ background:rgba(255,255,255,.80); }
.rightpane{ background:rgba(255,255,255,.82); }
.cursor-crosshair{cursor:crosshair!important;}

/* --- ‰∏äÈÉ®„ÅÆ„Ç™„Éñ„Ç∏„Çß„ÇØ„ÉàËøΩÂä†„Éú„Çø„É≥„Å®„Çµ„Éñ„ÉÑ„Éº„É´ --- */
#objToolbar{ display:flex; gap:6px; align-items:center; pointer-events:auto; position:relative; flex-shrink:0; }
#btnObj{ display:inline-flex; align-items:center; justify-content:center; white-space:nowrap; }
#objSubtools{ display:none; gap:6px; margin-left:8px; pointer-events:auto; }
.chip.toggle-on{ background:#1e88e5; color:#fff; }
.tool{ padding:6px 10px; border-radius:8px; background:#fff; box-shadow:0 2px 8px rgba(0,0,0,.12); cursor:pointer; user-select:none; pointer-events:auto; }
.tool.active{ outline:2px solid #1e88e5; }

/* --- Âè≥ÂÅ¥Ôºö„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà‰∏ÄË¶ßÔºà„Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„ÉóÂØæÂøúÔºâ --- */
#objPanel{  position: static;  /* ‚Üê absolute „Çí„ÇÑ„ÇÅ„Çã */
  width: auto;
  background: transparent;
  backdrop-filter: none;
  border-radius: 0;
  box-shadow: none;
  padding: 0;
}
#objList{ max-height:280px; overflow:auto; margin-top:6px; }
.objItem, .grpItem{
  background:#fff; border-radius:8px; padding:8px; margin:6px 0; box-shadow:0 1px 6px rgba(0,0,0,.08);
  display:flex; align-items:center; gap:8px;
}
.objItem.dragging, .grpItem.dragging{ opacity:.4; }
.objType{
  width:24px; height:24px; border-radius:6px; display:flex; align-items:center; justify-content:center;
  position:relative; font-size:14px; color:#1f2937;
}
.objType::before{ content:''; }
.objType.type-point::before{
  content:'‚öë';
  font-size:16px;
  color:var(--icon-line-color,#1976d2);
  transform:translateY(-1px);
}
.objType.type-line::before{
  position:absolute;
  left:3px; right:3px; top:50%;
  content:'';
  border-top:3px solid var(--icon-line-color,#e53935);
  border-radius:2px;
}
.objType.type-poly::before{
  content:'';
  width:16px; height:16px;
  background:var(--icon-fill-color,#43a047);
  border:2px solid var(--icon-stroke-color,#2e7d32);
  border-radius:3px;
  box-sizing:border-box;
}
.objType.type-circle::before{
  content:'';
  width:16px; height:16px;
  background:var(--icon-fill-color,#6d4c41);
  border:2px solid var(--icon-stroke-color,#4e342e);
  border-radius:50%;
  box-sizing:border-box;
}
.objType.type-group::before{
  content:'üóÇÔ∏è';
  font-size:15px;
}
.dropHint{ outline:2px dashed #1e88e5; }

.objLabelWrap{ flex:1 1 auto; min-width:0; }
.objLabelText{ display:block; cursor:text; font-size:13px; }
.objLabelText.empty{ color:#9ca3af; font-style:italic; }
.objActions{ display:flex; gap:4px; align-items:center; }
.iconBtn{
  border:none; background:transparent; cursor:pointer; padding:2px 4px; border-radius:6px;
  font-size:16px; line-height:1; transition:background .2s;
}
.iconBtn:hover{ background:#e5e7eb; }
.iconBtn.danger:hover{ background:#fee2e2; }
.grpHeader{ display:flex; align-items:center; gap:8px; width:100%; }
.grpChildren{ margin-top:6px; padding-left:28px; display:flex; flex-direction:column; }
.labelInlineInput{
  width:100%; padding:4px 6px; border:1px solid #d1d5db; border-radius:6px; font-size:13px;
  box-sizing:border-box;
}
.polyInlineEditor{ display:flex; flex-direction:column; gap:4px; margin-top:6px; }
.polyInlineEditor input{ padding:4px 6px; border:1px solid #d1d5db; border-radius:6px; font-size:13px; }
.polyInlineEditor .btnRow{ display:flex; gap:6px; justify-content:flex-end; }
.polyInlineEditor button{ padding:4px 10px; border-radius:6px; border:1px solid #d1d5db; background:#f3f4f6; cursor:pointer; font-size:12px; }
.polyInlineEditor button.primary{ background:#1e88e5; color:#fff; border-color:#1e88e5; }

/* „É©„Éô„É´ÂÖ•Âäõ„Å®Ëâ≤„Éª„Çµ„Ç§„Ç∫UI */
.inline{ display:flex; align-items:center; gap:6px; flex-wrap:wrap; }
.small{ font-size:12px; color:#666; }
input[type="color"]{ width:36px; height:26px; padding:0; border:none; background:transparent; }
input[type="number"]{ width:70px; }

/* --- ÁèæÂú®Âú∞„Éë„É´„ÇπÔºàCSS„Ç¢„Éã„É°Ôºâ --- */
.pulse{
  width:18px; height:18px; border-radius:50%; background:#2196f3; box-shadow:0 0 0 rgba(33,150,243,.4);
  animation:pulse 2s infinite;
  border:2px solid #fff;
}
@keyframes pulse{
  0%{ box-shadow:0 0 0 0 rgba(33,150,243,.4); }
  70%{ box-shadow:0 0 0 18px rgba(33,150,243,0); }
  100%{ box-shadow:0 0 0 0 rgba(33,150,243,0); }
}
/* Ëá™Ê≤ª‰ΩìÂÄôË£ú„ÅÆÂâçÈù¢Âåñ */
.suggest{ position:absolute; z-index:9999; }
    
.small-creator{font-size:12px;color:#4b5563}
.small-creator .xicon{font-weight:700;margin-right:4px}
.floating{
  position:fixed; left:50%; top:50%; transform:translate(-50%,-50%);
  width:340px;
  background:rgba(255,255,255,.92); backdrop-filter:blur(8px);
  box-shadow:0 10px 32px rgba(0,0,0,.18); border-radius:12px; z-index:1000; padding:0;
}
.floating .group{margin:10px 0;}
.floating .row{display:flex;gap:8px;flex-wrap:wrap;}
.floating .btn{display:inline-block;padding:8px 12px;border-radius:10px;border:1px solid #e5e7eb;background:#0ea5e9;color:#fff;font-weight:700;cursor:pointer;text-align:center;}
.floating .btn.secondary{background:#f3f4f6;color:#111827;}
.floating .btn.danger{background:#fee2e2;border-color:#fecaca;color:#7f1d1d;}
.floating .btn:disabled{opacity:.55;cursor:not-allowed;}
.floating .btn.toggle-active{background:#2563eb;color:#fff;}
.floatHeader{display:flex;align-items:center;gap:8px;padding:10px 12px;border-bottom:1px solid #e5e7eb;font-weight:700}
.floatHeader .sub{font-weight:400;color:#6b7280;margin-left:6px}
.floatHeader .handle{margin-left:auto;cursor:move}
.floatBody{padding:10px 12px}
.suggest{position:absolute;z-index:9999} /* ÂÄôË£ú„ÅØÊúÄÂâçÈù¢ */

.labelBubble{
  position:absolute;
  z-index:60;
  min-width:220px;
  max-width:280px;
  padding:10px 12px;
  border-radius:10px;
  background:rgba(255,255,255,.95);
  box-shadow:0 10px 28px rgba(0,0,0,.18);
  border:1px solid rgba(148,163,184,.45);
  display:none;
  pointer-events:auto;
  transform:translate(-50%,-100%);
}
.labelBubble::after{
  content:"";
  position:absolute;
  left:50%;
  bottom:-8px;
  transform:translateX(-50%);
  border-width:8px 8px 0 8px;
  border-style:solid;
  border-color:rgba(255,255,255,.95) transparent transparent transparent;
}
.labelBubbleTitle{
  font-size:13px;
  font-weight:700;
  margin-bottom:6px;
}
.labelBubbleActions{
  display:flex;
  gap:6px;
  margin-top:8px;
}
.labelBubble input[type="text"]{
  width:100%;
  padding:6px 8px;
  border:1px solid #d1d5db;
  border-radius:8px;
  font-size:13px;
  box-sizing:border-box;
}
.labelBubble .btn{
  padding:6px 10px;
  font-size:12px;
}

.objItem{display:flex;align-items:center;gap:8px;padding:6px;border:1px solid #e5e7eb;border-radius:8px;margin:4px 0;background:rgba(255,255,255,.86);backdrop-filter:blur(4px)}
.objItem .objLabel{flex:1 1 auto;cursor:default}
.miniBtn{padding:4px 8px;border-radius:8px;border:none;background:#f3f4f6;cursor:pointer}
.miniBtn:hover{background:#e5e7eb}

    .panelToggle{
      position:fixed;
      width:42px;height:42px;
      background:rgba(15,23,42,.55);
      border:none;border-radius:12px;
      display:none;align-items:center;justify-content:center;
      z-index:25;cursor:pointer;
      transition:background .2s ease,transform .3s ease;
      backdrop-filter:blur(4px);
    }
    .panelToggle:focus-visible{outline:2px solid #38bdf8;outline-offset:2px}
    .panelToggle:hover{background:rgba(15,23,42,.7)}
    .panelToggle::after{
      content:"";
      width:14px;height:14px;
      border:2px solid rgba(255,255,255,.9);
      border-left:none;border-top:none;
      transform:rotate(-45deg);
      pointer-events:none;
    }
    .panelToggle-left{
      clip-path:polygon(0 50%,100% 0,100% 100%);
      padding-left:6px;
    }
    .panelToggle-left::after{transform:translateX(2px) rotate(-45deg)}
    .panelToggle-left[aria-expanded="true"]{transform:scaleX(-1)}
    .panelToggle-bottom{
      clip-path:polygon(50% 0,0 100%,100% 100%);
      padding-bottom:6px;
    }
    .panelToggle-bottom::after{transform:translateY(2px) rotate(45deg)}
    .panelToggle-bottom[aria-expanded="true"]::after{transform:translateY(-4px) rotate(-135deg)}

    @media (max-width:1200px){
      .panel{width:300px;padding:10px}
      .rightpane{width:280px;padding:10px}
      .chip{padding:6px 8px;font-size:11px}
    }

    @media (max-width:1024px){
      .topbar{position:fixed;top:8px;left:8px;right:8px;gap:6px;flex-wrap:nowrap;overflow-x:auto;padding-bottom:4px;pointer-events:auto}
      .topbar::-webkit-scrollbar{display:none}
      .chip{flex-shrink:0}
      #objToolbar{gap:4px}
      #objSubtools{gap:4px}
      #objSubtools.mobile-subtools{
        position:fixed;
        left:50%;
        transform:translate(-50%,0);
        margin-left:0;
        flex-wrap:wrap;
        justify-content:center;
        padding:8px 12px;
        background:rgba(15,23,42,.86);
        border-radius:14px;
        box-shadow:0 16px 40px rgba(15,23,42,.28);
        width:min(90vw,360px);
        max-height:70vh;
        overflow:auto;
        z-index:60;
        gap:8px;
        top:var(--obj-subtools-top,120px);
      }
      #objSubtools.mobile-subtools .tool{
        flex:0 1 auto;
        text-align:center;
        font-weight:600;
        padding:7px 12px;
        border-radius:10px;
        background:#fff;
        box-shadow:none;
        min-width:68px;
      }
      #objSubtools.mobile-subtools .tool.active{
        background:#2563eb;
        color:#fff;
      }
      #surveyPanel.mobile-pop{
        width:min(90vw,360px);
        max-height:70vh;
        overflow:auto;
        left:50%;
        transform:translate(-50%,0);
        top:var(--survey-panel-top,120px);
      }
      #surveyPanel.mobile-pop .floatBody{
        max-height:calc(70vh - 52px);
        overflow:auto;
      }
      .panel{position:fixed;left:0;top:72px;width:min(320px,80vw);max-height:65vh;padding:12px;border-radius:0 12px 12px 0;transform:translateX(-110%);opacity:0;pointer-events:none;transition:transform .3s ease,opacity .3s ease}
      .panel h3{font-size:15px}
      .panel label,.panel input[type="text"],.panel select{font-size:12px}
      .panel .btn{padding:6px 10px;font-size:12px}
      .panel.is-open{transform:translateX(0);opacity:1;pointer-events:auto}
      .rightpane{position:fixed;left:12px;right:12px;bottom:0;top:auto;width:auto;max-height:60vh;padding:12px;border-radius:12px 12px 0 0;transform:translateY(100%);opacity:0;pointer-events:none;transition:transform .3s ease,opacity .3s ease}
      .rightpane h4{font-size:15px}
      .rightpane.is-open{transform:translateY(0);opacity:1;pointer-events:auto}
      .supabox{position:fixed;left:12px;right:12px;bottom:12px;min-width:0;padding:10px}
      .supabox .row{justify-content:flex-start}
      .panelToggle{display:flex}
      .panelToggle-left{top:78px;left:8px}
      .panelToggle-bottom{bottom:16px;left:50%;transform:translateX(-50%)}
    }

    @media (max-width:768px){
      body{font-size:14px}
      .panel{max-height:62vh;width:min(300px,82vw)}
      .panelToggle-left{top:74px}
      .rightpane{left:8px;right:8px;max-height:65vh;padding:10px}
      .supabox{left:8px;right:8px;padding:10px}
      .floating{width:min(320px,calc(100% - 24px))}
      .floating .floatBody{max-height:60vh;overflow:auto}
    }

    @media (max-width:540px){
      .chip{font-size:10px}
      .panel{width:min(280px,84vw);max-height:60vh}
      .rightpane{max-height:68vh;padding:10px}
      .supabox{padding:8px}
      .floating{width:calc(100% - 24px)}
    }

  </style>
</head>
<body>
  <div id="map"></div>

  <!-- „Éà„ÉÉ„Éó„Éê„Éº -->
  <div class="topbar">
    <div class="chip" style="display:flex;flex-direction:column;align-items:flex-start">
  <div>PHN Field Collab</div>
  <div class="small-creator">
    ‰ΩúÊàêËÄÖÔºö
    <a href="https://x.com/GISPHN" target="_blank" rel="noopener">
      <span class="xicon">ùïè</span> GISPHN
    </a>
  </div>
</div>
    <div class="chip">„Éô„Éº„Çπ:
      <select id="basemapSel" style="border:none;background:transparent;font-weight:700">
        <option value="osm">OSM</option>
        <option value="gsi_std">Âú∞ÁêÜÈô¢ Ê®ôÊ∫ñ</option>
        <option value="gsi_photo">Âú∞ÁêÜÈô¢ ÂÜôÁúü</option>
      </select>
    </div>
    <div class="chip btn secondary" id="btnExport">ÊèèÁîª„ÇíGeoJSONÂá∫Âäõ</div>

    <!-- „Ç™„Éñ„Ç∏„Çß„ÇØ„ÉàËøΩÂä†Ôºö„É°„Ç§„É≥„Éú„Çø„É≥Ôºã„Çµ„Éñ„ÉÑ„Éº„É´ -->
<div id="objToolbar">
  <div id="btnObj" class="chip btn secondary">„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà</div>
  <div id="objSubtools">
    <div class="tool" data-mode="point">„Éù„Ç§„É≥„Éà</div>
    <div class="tool" data-mode="line">„É©„Ç§„É≥</div>
    <div class="tool" data-mode="polygon">„Éù„É™„Ç¥„É≥</div>
    <div class="tool" data-mode="circle">ÂÜÜ</div>
  </div>
</div>
    <div class="chip btn secondary" id="btnSurvey">Âú∞Âå∫Ë∏èÊüª<span id="surveyRecBadge" class="recBadge" style="display:none">REC</span></div>
    <div style="flex:1"></div>
    <div class="chip btn secondary" id="btnSignIn">„Çµ„Ç§„É≥„Ç§„É≥Ôºà‰øùÂ≠ò/ÂÖ±ÂêåÁ∑®ÈõÜÔºâ</div>
<div class="chip" id="signinState" style="display:none">‰øùÂ≠òON</div>
<div class="chip btn secondary" id="btnShare" style="display:none">ÂÖ±Êúâ„É™„É≥„ÇØ</div>

  </div>

  <div id="surveyPanel" class="floating" style="display:none">
    <div class="floatHeader">Âú∞Âå∫Ë∏èÊüª
      <span class="handle" title="„Éâ„É©„ÉÉ„Ç∞„ÅßÁßªÂãï">‚£ø</span>
    </div>
    <div class="floatBody">
      <div class="group" style="display:flex;flex-wrap:wrap;gap:8px">
        <button class="btn" id="surveyStartBtn">Ë®òÈå≤ÈñãÂßã</button>
        <button class="btn secondary" id="surveyAddHereBtn">„Ç≥„Ç≥„ÅßËøΩÂä†</button>
        <button class="btn secondary" id="surveyAddManualBtn">ÊâãÂãïËøΩÂä†</button>
        <button class="btn secondary" id="surveyEditBtn">‰øÆÊ≠£</button>
        <button class="btn secondary" id="surveyToggleLabelBtn">„É©„Éô„É´Ë°®Á§∫</button>
        <button class="btn secondary" id="surveyPauseBtn">‰∏ÄÊôÇÂÅúÊ≠¢</button>
        <button class="btn danger" id="surveyFinishBtn">ÂÆå‰∫Ü</button>
      </div>
      <div id="surveyStatus" class="small" style="margin-top:6px;color:#4b5563"></div>
      <div id="surveyFinishPanel" style="display:none;margin-top:12px"></div>
    </div>
  </div>

  <div id="surveyNotePanel" class="floating" style="display:none">
    <div class="floatHeader">„É°„É¢ÂÖ•Âäõ
      <span class="handle" title="„Éâ„É©„ÉÉ„Ç∞„ÅßÁßªÂãï">‚£ø</span>
    </div>
    <div class="floatBody">
      <div class="group">
        <input type="text" id="surveyNoteLine1" placeholder="„É©„Éô„É´1"/>
        <input type="text" id="surveyNoteLine2" placeholder="„É©„Éô„É´2" style="margin-top:8px"/>
      </div>
      <div class="group">
        <button class="btn secondary" id="surveyCapBtn">CAP„Çø„Ç∞</button>
        <div id="surveyCapSelectWrap" style="display:none;margin-top:8px">
          <select id="surveyCapSelect" style="width:100%"></select>
        </div>
      </div>
      <div class="group" id="surveyNoteMoveWrap" style="display:none">
        <button class="btn secondary" id="surveyNoteMoveBtn">‰ΩçÁΩÆ„ÇíÂ§âÊõ¥</button>
      </div>
      <div class="group">
        <div class="row">
          <button class="btn" id="surveyNoteConfirm">OK</button>
          <button class="btn secondary" id="surveyNoteCancel">„Ç≠„É£„É≥„Çª„É´</button>
        </div>
      </div>
    </div>
  </div>

  <button class="panelToggle panelToggle-left" id="panelToggle" aria-label="„É¨„Ç§„É§ / ËÉåÊôØÂú∞Âõ≥„Éë„Éç„É´„ÇíÈñãÈñâ" aria-controls="panel" aria-expanded="false"></button>
  <button class="panelToggle panelToggle-bottom" id="objectToggle" aria-label="„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà‰∏ÄË¶ß„Éë„Éç„É´„ÇíÈñãÈñâ" aria-controls="objectDrawer" aria-expanded="false"></button>

  <!-- Â∑¶„Éë„Éç„É´ -->
  <div class="panel" id="panel">
    <h3>„É¨„Ç§„É§ / ËÉåÊôØÂú∞Âõ≥</h3>
    <div class="group">
      <button class="btn" id="btnExtent">‰∏ÄÊã¨Ë°®Á§∫ÁØÑÂõ≤</button>
      <span style="font-size:12px;color:#6b7280;margin-left:6px">ÔºàÂÖ®„É¨„Ç§„É§„Å´ÈÅ©Áî®Ôºâ</span>
    </div>

    <div class="group">
      <div class="layerRow">
        <label><input type="checkbox" id="chkFlood"> Ê¥™Ê∞¥Êµ∏Ê∞¥ÊÉ≥ÂÆöÂå∫ÂüüÔºàÊÉ≥ÂÆöÊúÄÂ§ßË¶èÊ®°Ôºâ</label>
      </div>
      <div class="layerRow">
        <label><input type="checkbox" id="chkSediment"> ÂúüÁ†ÇÁÅΩÂÆ≥Ë≠¶ÊàíÂå∫ÂüüÔºà3„É¨„Ç§„É§‰∏ÄÊã¨ON/OFFÔºâ</label>
      </div>
      <div class="row" style="align-items:center;margin-top:6px">
        <div style="font-size:12px;min-width:64px">ÈÄèÊòéÂ∫¶</div>
        <input type="range" id="hazOpacity" min="0" max="1" step="0.05" value="0.60"/>
        <div id="hazOpacityVal" style="width:36px;text-align:right;font-size:12px">0.60</div>
      </div>
      <div style="font-size:12px;color:#6b7280;margin-top:6px">‚Äª„Éè„Ç∂„Éº„Éâ„ÅÆ„Çø„Ç§„É´URL„ÇíË®≠ÂÆö„Åó„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØÁÑ°Âäπ</div>
      <div style="font-size:12px;color:#6b7280;margin-top:4px">Âá°‰æãÔºà‰æãÁ§∫ÁîªÂÉè„ÇíÂøÖË¶Å„Å´Âøú„ÅòÂ∑ÆÊõøÔºâ</div>
<!-- <img src="l2_flood_l.png" style="max-width:100%;opacity:.85" alt="Âá°‰æã(Ê¥™Ê∞¥)"> -->
<!-- <img src="l2_sediment_l.png" style="max-width:100%;opacity:.85" alt="Âá°‰æã(ÂúüÁ†Ç)"> -->

    </div>

    <div class="group">
      <div>ÂåªÁôÇÊ©üÈñ¢ÔºàAPIÔºâ:</div>
      <div class="layerRow">
        <label><input type="checkbox" id="chkMedical"> ÂåªÁôÇÊ©üÈñ¢</label>
        <div class="layerActions">
          <button class="miniBtn" data-layer="medical" data-action="scope">Ë°®Á§∫ÁØÑÂõ≤</button>
          <button class="miniBtn" data-layer="medical" data-action="label">„É©„Éô„É´</button>
        </div>
      </div>
      <div id="medicalStatus" class="small" style="margin-left:26px;display:none;color:#64748b"></div>
    </div>

    <div class="group">
      <div>ÈÅøÈõ£ÊñΩË®≠ÔºàFGBÔºâ:</div>
      <div class="layerRow">
        <label><input type="checkbox" id="chkEmergency"> ÊåáÂÆö<strong>Á∑äÊÄ•ÈÅøÈõ£Â†¥ÊâÄ</strong>ÔºàËµ§Ôºâ</label>
        <div class="layerActions">
          <button class="miniBtn" data-layer="emergency" data-action="scope">Ë°®Á§∫ÁØÑÂõ≤</button>
          <button class="miniBtn" data-layer="emergency" data-action="label">„É©„Éô„É´</button>
        </div>
      </div>
      <div class="layerRow">
        <label><input type="checkbox" id="chkShelter"> ÊåáÂÆö<strong>ÈÅøÈõ£ÊâÄ</strong>ÔºàÈùíÔºâ</label>
        <div class="layerActions">
          <button class="miniBtn" data-layer="shelter" data-action="scope">Ë°®Á§∫ÁØÑÂõ≤</button>
          <button class="miniBtn" data-layer="shelter" data-action="label">„É©„Éô„É´</button>
        </div>
      </div>

    </div>
<!-- ‚ñº Ë°®Á§∫ÁØÑÂõ≤„Éï„É≠„Éº„ÉÜ„Ç£„É≥„Ç∞„Éë„Éç„É´Ôºà„Éâ„É©„ÉÉ„Ç∞ÂèØÔºâ ‚ñº -->
<div id="extentPanel" class="floating" style="display:none">
  <div class="floatHeader">Ë°®Á§∫ÁØÑÂõ≤ <span class="sub" id="extentScopeNote">(ÂÖ®„É¨„Ç§„É§)</span>
    <span class="handle" title="„Éâ„É©„ÉÉ„Ç∞„ÅßÁßªÂãï">‚£ø</span>
  </div>
  <div class="floatBody">

    <div class="group">
      <div>Ë°®Á§∫ÁØÑÂõ≤Ôºö</div>
      <label><input type="radio" name="areaMode" value="all" checked> Êó•Êú¨ÂÖ®ÂõΩ</label>
      <label><input type="radio" name="areaMode" value="pref"> ÈÉΩÈÅìÂ∫úÁúå</label>
      <label><input type="radio" name="areaMode" value="muni"> Â∏ÇÂå∫Áî∫Êùë</label>
    </div>

    <div class="group" id="prefRow" style="display:none">
      <div style="font-size:12px;margin-bottom:4px">ÈÉΩÈÅìÂ∫úÁúåÔºàË§áÊï∞ÈÅ∏ÊäûÂèØ / Ctrl+„ÇØ„É™„ÉÉ„ÇØÔºâ</div>
      <select id="prefSelect" multiple size="7"></select>
    </div>

    <div class="group" id="muniRow" style="display:none;position:relative">
      <div style="font-size:12px;margin-bottom:4px">Â∏ÇÂå∫Áî∫ÊùëÔºàË§áÊï∞ÈÅ∏ÊäûÂèØ / Ctrl+„ÇØ„É™„ÉÉ„ÇØÔºâ</div>
      <input id="qMuni" type="text" placeholder="‰æãÔºâÂ•àËâØÂ∏Ç„ÄÅÁîüÈßíÂ∏Ç / Êù±‰∫¨ÈÉΩ"/>
      <div class="suggest" id="suggest"></div>
      <div style="height:6px"></div>
      <select id="muniSelect" multiple size="10" style="display:none"></select>
    </div>

      <div class="group">
        <div class="row">
          <button class="btn" id="btnExtentConfirm">OK</button>
          <button class="btn secondary" id="btnExtentCancel">„Ç≠„É£„É≥„Çª„É´</button>
        </div>
        <div style="font-size:12px;color:#6b7280;margin-top:6px">‚ÄªË®≠ÂÆö„ÅØOK„ÅßÂèçÊò†„Åï„Çå„Åæ„Åô</div>
  </div>
</div>
<!-- ‚ñ≤ Ë°®Á§∫ÁØÑÂõ≤„Éï„É≠„Éº„ÉÜ„Ç£„É≥„Ç∞„Éë„Éç„É´ ‚ñ≤ -->

<!-- ‚ñº „É©„Éô„É´ÈÅ∏Êäû„Éë„Éç„É´ ‚ñº -->
<div id="labelPanel" class="floating" style="display:none">
  <div class="floatHeader">„É©„Éô„É´ÈÅ∏Êäû <span class="sub" id="labelScopeNote"></span>
    <span class="handle" title="„Éâ„É©„ÉÉ„Ç∞„ÅßÁßªÂãï">‚£ø</span>
  </div>
  <div class="floatBody">
    <div class="group">
      <div style="font-size:12px;margin-bottom:4px">Ë°®Á§∫„Åô„Çã„Ç´„É©„É†</div>
      <select id="labelFieldList"></select>
    </div>
    <div class="group">
      <div class="row">
        <button class="btn" id="btnLabelConfirm">OK</button>
        <button class="btn secondary" id="btnLabelCancel">„Ç≠„É£„É≥„Çª„É´</button>
      </div>
      <div style="font-size:12px;color:#6b7280;margin-top:6px">‚Äª„Äå„Å™„Åó„Äç„ÇíÈÅ∏Êäû„Åô„Çã„Å®„É©„Éô„É´„ÇíÈùûË°®Á§∫„Å´„Åó„Åæ„Åô</div>
    </div>
  </div>
</div>
<!-- ‚ñ≤ „É©„Éô„É´ÈÅ∏Êäû„Éë„Éç„É´ ‚ñ≤ -->

<!-- ‚ñº „Éù„É™„Ç¥„É≥ „É©„Éô„É´ÂÖ•Âäõ„Éë„Éç„É´ ‚ñº -->
<div id="polygonLabelPanel" class="floating" style="display:none">
  <div class="floatHeader">„Éù„É™„Ç¥„É≥ „É©„Éô„É´
    <span class="handle" title="„Éâ„É©„ÉÉ„Ç∞„ÅßÁßªÂãï">‚£ø</span>
  </div>
  <div class="floatBody">
    <div class="group">
      <input type="text" id="polyLabelInput1" placeholder="„É©„Éô„É´1"/>
      <input type="text" id="polyLabelInput2" placeholder="„É©„Éô„É´2" style="margin-top:8px"/>
    </div>
    <div class="group">
      <div class="row">
        <button class="btn" id="polyLabelConfirm">OK</button>
        <button class="btn secondary" id="polyLabelCancel">„Ç≠„É£„É≥„Çª„É´</button>
      </div>
    </div>
  </div>
</div>
<!-- ‚ñ≤ „Éù„É™„Ç¥„É≥ „É©„Éô„É´ÂÖ•Âäõ„Éë„Éç„É´ ‚ñ≤ -->

    </div>
  </div>

  <!-- ‚ñº „Ç™„Éñ„Ç∏„Çß„ÇØ„Éà „É©„Éô„É´ÂÖ•Âäõ„Éê„Éñ„É´ ‚ñº -->
  <div id="simpleLabelPanel" class="labelBubble" style="display:none">
    <div class="labelBubbleTitle" id="simpleLabelTitle">„É©„Éô„É´ÂÖ•Âäõ</div>
    <input type="text" id="simpleLabelInput" placeholder="„É©„Éô„É´"/>
    <div class="labelBubbleActions">
      <button class="btn" id="simpleLabelConfirm">OK</button>
      <button class="btn secondary" id="simpleLabelCancel">„Ç≠„É£„É≥„Çª„É´</button>
    </div>
  </div>
  <!-- ‚ñ≤ „Ç™„Éñ„Ç∏„Çß„ÇØ„Éà „É©„Éô„É´ÂÖ•Âäõ„Éê„Éñ„É´ ‚ñ≤ -->

  <!-- Âè≥„Éë„Éç„É´ -->
  <div class="rightpane" id="objectDrawer">
<div id="objPanel">
  <div class="inline small" style="margin-bottom:6px; align-items:center;">
    <strong>„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà‰∏ÄË¶ß</strong>
    <span style="margin-left:auto"></span>
    <button class="iconBtn" id="objListPalette" title="„Åô„Åπ„Å¶„ÅÆ„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÅÆËâ≤„ÇÑÂ§ß„Åç„Åï„ÇíÂ§âÊõ¥">üé®</button>
    <button class="iconBtn danger" id="objListTrash" title="„Åô„Åπ„Å¶„ÅÆ„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÇíÂâäÈô§">üóëÔ∏è</button>
  </div>
  <div id="objList"></div>
</div>

 </div>
<!-- ==== /Object List Panel ==== -->


  <!-- Â∑¶‰∏ãÔºöSupabase Êìç‰Ωú -->
  <div class="supabox" style="display:none">
    <h4>ÂÖ±ÂêåÁ∑®ÈõÜ / GPS</h4>
    <div class="row">
      <button class="wfull" onclick="window.__supaload()">Âõ≥ÂΩ¢„ÇíÂÜçË™≠Ëæº</button>
      <button class="wfull" onclick="window.__supasave()">Âõ≥ÂΩ¢„Çí‰øùÂ≠ò</button>
    </div>
    <div class="row">
      <button onclick="window.__gpstart()">GPSÈñãÂßã</button>
      <button class="danger" onclick="window.__gpstop()">GPSÂÅúÊ≠¢</button>
      <button onclick="window.__gpshow()">ËªåË∑°Ë°®Á§∫</button>
    </div>
    <div class="row">
      <button class="wfull" onclick="(async()=>{const e=prompt('„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ');if(!e)return;await __supa.auth.signInWithOtp({email:e});alert('Â±ä„ÅÑ„Åü„É°„Éº„É´„ÅÆ„É™„É≥„ÇØ„ÇíÈñã„ÅÑ„Åü„Çâ„Åì„ÅÆÁîªÈù¢„Å´Êàª„Å£„Å¶„Åè„Å†„Åï„ÅÑ');})();">„É°„Éº„É´„Åß„É≠„Ç∞„Ç§„É≥</button>
      <button class="wfull" onclick="__supa.auth.signOut().then(()=>alert('„Çµ„Ç§„É≥„Ç¢„Ç¶„Éà„Åó„Åæ„Åó„Åü'))">„Çµ„Ç§„É≥„Ç¢„Ç¶„Éà</button>
    </div>
  </div>

  <div id="err" class="errbar"></div>

  <!-- „É©„Ç§„Éñ„É©„É™ -->
  <script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>
  <script src="https://unpkg.com/@mapbox/mapbox-gl-draw@1.5.0/dist/mapbox-gl-draw.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js"></script>

  <script>
  /*************** ‚òÖ‚òÖ‚òÖ TODO 1ÔºöSupabase „ÅÆ Project URL / anon public key ***************/
  const SUPABASE_URL  = 'https://tdoxxwhkvdguyfrofnaw.supabase.co';   // ‚ÜêÁΩÆÊèõ
  const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRkb3h4d2hrdmRndXlmcm9mbmF3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0MTQ0NDQsImV4cCI6MjA3NDk5MDQ0NH0.h2ZnTGr0jml2V7SUvEaOSzjNXxKvCJuJryFEyEkrQQc';                // ‚ÜêÁΩÆÊèõ

  // Supabase „ÇØ„É©„Ç§„Ç¢„É≥„ÉàÔºàUMD „Åß window.supabase „ÅåÁîü„Åà„ÇãÂâçÊèêÔºâ
  try {
    if (!window.supabase) throw new Error('Supabase SDK (UMD) „ÅåË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
    window.__supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
  } catch (e) {
    console.error(e);
    // ÂÖ±ÂêåÁ∑®ÈõÜ/GPSÁ≥ª„Åå‰Ωø„Åà„Å™„ÅÑ„Å®„Åç„Åß„ÇÇÂú∞Âõ≥„ÅØÂãï„Åã„Åô„Åü„ÇÅ„ÅÆ„ÉÄ„Éü„Éº
    window.__supa = {
      from(){ return { select:async()=>({}), insert:async()=>({}), in:async()=>({}), eq:async()=>({}), order:async()=>({}), single:async()=>({}) }; },
      auth:{ signInWithOtp:async()=>({}), signOut:async()=>({}) }
    };
    // Â§±Êïó„ÅØÁîªÈù¢„Å´„ÇÇÂá∫„Åô
    setTimeout(()=>{ const b=document.createElement('div'); b.className='toast bad'; b.textContent='Supabase „ÅÆÂàùÊúüÂåñ„Å´Â§±ÊïóÔºàÂÖ±ÂêåÁ∑®ÈõÜ/GPS„ÅØÁÑ°Âäπ„Åß„Åô„ÅåÂú∞Âõ≥„ÅØÂãï„Åç„Åæ„ÅôÔºâ'; document.body.appendChild(b); setTimeout(()=>b.remove(), 5000); }, 1000);
  }
  // ‚ñ≤‚ñ≤‚ñ≤ „Åì„Åì„Åæ„ÅßÁΩÆÊèõ
  window.__room = new URLSearchParams(location.hash.slice(1)).get('r') || 'default';
(function(){
  const STATUS_EL = document.getElementById('medicalStatus');
  const CHK = document.getElementById('chkMedical');

  // „É¨„Ç§„É§/„ÇΩ„Éº„Çπ„ÅÆID„Çí‰∏ÄÂÖÉÁÆ°ÁêÜ
  const MEDICAL_SOURCE_ID   = 'medical';
  const MEDICAL_LAYER_POINT = 'med-circle';
  const MEDICAL_LAYER_LABEL = 'med-label';

  function setStatus(msg, isError=false){
    if(!STATUS_EL) return;
    STATUS_EL.style.display = msg ? 'block' : 'none';
    STATUS_EL.textContent = msg || '';
    STATUS_EL.style.color = isError ? '#b91c1c' : '#64748b';
  }

  function waitForMap(timeoutMs=10000){
    return new Promise((resolve, reject)=>{
      const start = Date.now();
      (function poll(){
        if (window.map && typeof map.getBounds==='function') return resolve(map);
        if (Date.now()-start > timeoutMs) return reject(new Error('map not ready'));
        setTimeout(poll, 120);
      })();
    });
  }

  // ---- ÂåªÁôÇ„É¨„Ç§„É§„ÅÆ‰ΩúÊàê/ÂâäÈô§/Ë°®Á§∫ ----
  function ensureMedicalLayers(){
    if(!map.getSource(MEDICAL_SOURCE_ID)){
      map.addSource(MEDICAL_SOURCE_ID, { type:'geojson', data:{type:'FeatureCollection',features:[]} });
    }
    if(!map.getLayer(MEDICAL_LAYER_POINT)){
      map.addLayer({
        id: MEDICAL_LAYER_POINT, type:'circle', source: MEDICAL_SOURCE_ID,
        paint:{
          'circle-radius': 6,
          'circle-color': '#e11d48',
          'circle-stroke-color': '#fff',
          'circle-stroke-width': 1
        }
      });
    }
    if(!map.getLayer(MEDICAL_LAYER_LABEL)){
      map.addLayer({
        id: MEDICAL_LAYER_LABEL, type:'symbol', source: MEDICAL_SOURCE_ID,
        layout:{
          'text-field': ['coalesce', ['get','P04_002_ja'], ['get','P04_003_ja'], '' ],
          'text-size': 12, 'text-offset':[0,1.1], 'text-anchor':'top'
        },
        paint:{ 'text-color':'#111827','text-halo-color':'#fff','text-halo-width':1.2 }
      });
    }
  }

  function removeMedicalFromMap(){
    try{
      if(map.getLayer(MEDICAL_LAYER_LABEL)) map.removeLayer(MEDICAL_LAYER_LABEL);
      if(map.getLayer(MEDICAL_LAYER_POINT)) map.removeLayer(MEDICAL_LAYER_POINT);
      if(map.getSource(MEDICAL_SOURCE_ID))  map.removeSource(MEDICAL_SOURCE_ID);
    }catch(_){}
  }

  function showMedicalOnMap(fc){
    const safe = (fc && fc.type==='FeatureCollection' && Array.isArray(fc.features))
      ? fc : { type:'FeatureCollection', features:[] };
    ensureMedicalLayers();
    map.getSource(MEDICAL_SOURCE_ID).setData(safe);
    // ÂèØË¶ñÁä∂ÊÖã„ÅØ„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„Å´ÂêåÊúü
    const vis = (document.getElementById('chkMedical')?.checked) ? 'visible' : 'none';
    map.setLayoutProperty(MEDICAL_LAYER_POINT, 'visibility', vis);
    map.setLayoutProperty(MEDICAL_LAYER_LABEL, 'visibility', vis);
  }

  async function fetchMedicalForMap(){
    setStatus('ÂåªÁôÇÊ©üÈñ¢„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠...');
    await waitForMap();

    const b = map.getBounds();
    const bbox = `${b.getWest()},${b.getSouth()},${b.getEast()},${b.getNorth()}`;
    const z = Math.round(map.getZoom()) || 14;

    // Supabase Edge Functions (HTTP)
    const fnUrl = (String(SUPABASE_URL||'').replace(/\/$/,'') + '/functions/v1/medical-proxy');
    const url = `${fnUrl}?bbox=${encodeURIComponent(bbox)}&z=${z}`;

    const res = await fetch(url, { method:'GET' });
    if(!res.ok){
      const txt = await res.text().catch(()=>'(no body)');
      throw new Error(`medical-proxy ${res.status}: ${txt}`);
    }
    const fc = await res.json();
    if(!fc || fc.type!=='FeatureCollection') throw new Error('‰∏çÊ≠£„Å™„É¨„Çπ„Éù„É≥„ÇπÂΩ¢Âºè');

    showMedicalOnMap(fc);
    setStatus('');
    return fc;
  }

  // „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„ÇπÊìç‰Ωú
  if(CHK){
    CHK.addEventListener('change', async ()=>{
      if(CHK.checked){
        try{ await fetchMedicalForMap(); }catch(e){ setStatus('Ë™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: '+(e.message||e), true); }
      }else{
        setStatus('');
        removeMedicalFromMap();
      }
    });
  }

  // Âú∞Âõ≥ÁßªÂãï„ÅßÂÜçÂèñÂæóÔºàÁ∞°Êòì„Éá„Éê„Ç¶„É≥„ÇπÔºâ
  let _debTimer=null;
  function onMapMoveEnd(){
    if(!CHK || !CHK.checked) return;
    if(_debTimer) clearTimeout(_debTimer);
    _debTimer = setTimeout(()=>{ fetchMedicalForMap().catch(()=>{}); _debTimer=null; }, 600);
  }

  (async ()=>{
    try{
      await waitForMap();
      map.on('moveend', onMapMoveEnd);
    }catch(_){}
  })();
})();


  // „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£
  const $ = (id)=>document.getElementById(id);
  const toast=(m,bad=false)=>{const el=document.createElement('div');el.className='toast'+(bad?' bad':'');el.textContent=m;document.body.appendChild(el);setTimeout(()=>el.remove(),3000);}
  const showErr=(m)=>{const e=$('err');e.textContent=m;e.style.display='block';setTimeout(()=>e.style.display='none',10000);}
  const showFloatingPanel=(panel)=>{ panel.style.display='block'; panel.style.left='50%'; panel.style.top='50%'; panel.style.transform='translate(-50%,-50%)'; };
  const makeDraggable=(panel)=>{
    const header=panel.querySelector('.handle');
    if(!header) return;
    let dragging=false,sx=0,sy=0,left=0,top=0;
    header.addEventListener('pointerdown',e=>{
      dragging=true; sx=e.clientX; sy=e.clientY;
      const rect=panel.getBoundingClientRect();
      panel.style.transform='none';
      panel.style.left=rect.left+'px';
      panel.style.top=rect.top+'px';
      left=rect.left; top=rect.top;
      header.setPointerCapture(e.pointerId);
    });
    header.addEventListener('pointermove',e=>{
      if(!dragging) return;
      const dx=e.clientX-sx, dy=e.clientY-sy;
      panel.style.left=(left+dx)+'px';
      panel.style.top=(top+dy)+'px';
    });
    header.addEventListener('pointerup',()=>{dragging=false;});
  };
  const centerPanel=(panel)=>{ if(panel) showFloatingPanel(panel); };

  const layerPanel=$('panel');
  const objectDrawer=$('objectDrawer');
  const panelToggleBtn=$('panelToggle');
  const objectToggleBtn=$('objectToggle');
  const mobilePanelQuery=window.matchMedia('(max-width: 1024px)');
  const topbarEl=document.querySelector('.topbar');

  (function ensureSingleMedicalLayerEntry(){
    const inputs=document.querySelectorAll('#panel input#chkMedical');
    inputs.forEach((input,idx)=>{
      if(idx===0) return;
      const group=input.closest('.group');
      if(group){
        group.remove();
      }else{
        input.remove();
      }
    });
  })();

  const syncPanelToggleState=()=>{
    if(panelToggleBtn) panelToggleBtn.setAttribute('aria-expanded', layerPanel?.classList.contains('is-open') ? 'true' : 'false');
    if(objectToggleBtn) objectToggleBtn.setAttribute('aria-expanded', objectDrawer?.classList.contains('is-open') ? 'true' : 'false');
  };

  const closeResponsivePanel=(panel)=>{ panel?.classList.remove('is-open'); };

  panelToggleBtn?.addEventListener('click',()=>{
    const willOpen=layerPanel?.classList.toggle('is-open');
    if(willOpen){
      closeResponsivePanel(objectDrawer);
    }
    syncPanelToggleState();
  });

  objectToggleBtn?.addEventListener('click',()=>{
    const willOpen=objectDrawer?.classList.toggle('is-open');
    if(willOpen){
      closeResponsivePanel(layerPanel);
    }
    syncPanelToggleState();
  });

  const handleResponsivePanels=()=>{
    if(!mobilePanelQuery.matches){
      closeResponsivePanel(layerPanel);
      closeResponsivePanel(objectDrawer);
    }
    syncPanelToggleState();
  };

  if(typeof mobilePanelQuery.addEventListener==='function'){
    mobilePanelQuery.addEventListener('change',handleResponsivePanels);
  }else if(typeof mobilePanelQuery.addListener==='function'){
    mobilePanelQuery.addListener(handleResponsivePanels);
  }
  window.addEventListener('orientationchange',handleResponsivePanels);
  handleResponsivePanels();

  const simpleLabelPanel=$('simpleLabelPanel');
  const simpleLabelInput=$('simpleLabelInput');
  const simpleLabelTitle=$('simpleLabelTitle');
  const SIMPLE_LABEL_EVENTS=['move','moveend','zoom','rotate','pitch'];
  let simpleLabelContext={ feature:null,isNew:false,resumeMode:null,onApply:null,anchor:null,positionMode:'anchor' };
  function computeSimpleLabelAnchor(feature){
    if(!feature?.geometry) return null;
    const geom=feature.geometry;
    try{
      if(geom.type==='Point' && Array.isArray(geom.coordinates)){
        return geom.coordinates.slice();
      }
      if(Array.isArray(geom.coordinates)){
        if(!geom.coordinates.length) return null;
        const bbox=turf.bbox(feature);
        const midLng=(bbox[0]+bbox[2])/2;
        const topLat=bbox[3];
        return [midLng, topLat];
      }
    }catch(err){
      console.warn('computeSimpleLabelAnchor', err);
    }
    return null;
  }
  function updateSimpleLabelPosition(){
    if(!simpleLabelPanel || simpleLabelPanel.style.display==='none') return;
    if(simpleLabelContext.positionMode==='center'){
      simpleLabelPanel.style.left='50%';
      simpleLabelPanel.style.top='50%';
      simpleLabelPanel.style.transform='translate(-50%,-50%)';
      return;
    }
    const anchor=simpleLabelContext.anchor;
    if(!anchor) return;
    if(typeof map==='undefined' || !map || typeof map.project!=='function') return;
    const pt=map.project(anchor);
    const offset=12;
    simpleLabelPanel.style.left=`${pt.x}px`;
    simpleLabelPanel.style.top=`${pt.y - offset}px`;
    simpleLabelPanel.style.transform='translate(-50%,-100%)';
  }
  function attachSimpleLabelPosition(){
    if(typeof map==='undefined' || !map) return;
    SIMPLE_LABEL_EVENTS.forEach(evt=>map.on(evt, updateSimpleLabelPosition));
    window.addEventListener('resize', updateSimpleLabelPosition);
  }
  function detachSimpleLabelPosition(){
    if(typeof map!=='undefined' && map){
      SIMPLE_LABEL_EVENTS.forEach(evt=>map.off(evt, updateSimpleLabelPosition));
    }
    window.removeEventListener('resize', updateSimpleLabelPosition);
  }
  function openSimpleLabelEditor(feature,{resumeMode=null,isNew=false,onApply=null,title='„É©„Éô„É´ÂÖ•Âäõ'}={}){
    detachSimpleLabelPosition();
    simpleLabelContext={ feature, isNew, resumeMode, onApply, anchor:null, positionMode:'anchor' };
    if(simpleLabelTitle) simpleLabelTitle.textContent=title;
    if(simpleLabelInput) simpleLabelInput.value=feature?.properties?.label||'';
    simpleLabelContext.anchor=computeSimpleLabelAnchor(feature);
    if(simpleLabelPanel){
      if(simpleLabelContext.anchor){
        simpleLabelContext.positionMode='anchor';
        simpleLabelPanel.style.display='block';
        updateSimpleLabelPosition();
        attachSimpleLabelPosition();
      }else{
        simpleLabelContext.positionMode='center';
        simpleLabelPanel.style.display='block';
        updateSimpleLabelPosition();
      }
    }
    if(simpleLabelInput){
      simpleLabelInput.focus();
      simpleLabelInput.select();
    }
  }
  function closeSimpleLabel(apply){
    const ctx=simpleLabelContext;
    if(simpleLabelPanel) simpleLabelPanel.style.display='none';
    detachSimpleLabelPosition();
    if(!ctx.feature){
      simpleLabelContext={ feature:null,isNew:false,resumeMode:null,onApply:null,anchor:null,positionMode:'anchor' };
      return;
    }
    if(apply){
      ctx.feature.properties=ctx.feature.properties||{};
      const labelVal=simpleLabelInput ? simpleLabelInput.value.trim() : '';
      ctx.feature.properties.label=labelVal;
      ensureDefaultStyle(ctx.feature);
      if(typeof ctx.onApply==='function'){
        ctx.onApply(ctx.feature);
      }else if(ctx.isNew){
        if(typeof window.pushFeature==='function') window.pushFeature(ctx.feature);
        else if(window.userFC && Array.isArray(window.userFC.features)){ window.userFC.features.push(ctx.feature); }
        if(typeof syncUserFeatures==='function' && typeof window.pushFeature!=='function') syncUserFeatures();
      }else{
        if(typeof syncUserFeatures==='function') syncUserFeatures();
      }
    }
    if(ctx.resumeMode && typeof activateTool==='function') activateTool(ctx.resumeMode);
    simpleLabelContext={ feature:null,isNew:false,resumeMode:null,onApply:null,anchor:null,positionMode:'anchor' };
    if(typeof updateMapCursor==='function') updateMapCursor();
  }
  $('simpleLabelConfirm')?.addEventListener('click',()=>closeSimpleLabel(true));
  $('simpleLabelCancel')?.addEventListener('click',()=>closeSimpleLabel(false));
  simpleLabelInput?.addEventListener('keydown',ev=>{ if(ev.key==='Enter'){ ev.preventDefault(); closeSimpleLabel(true); } });
  window.openSimpleLabelEditor=openSimpleLabelEditor;

  const STYLE_DEFAULTS={
    point:{ labelColor:'#000000', labelSize:12 },
    line:{ lineColor:'#e53935', lineWidth:2, labelColor:'#000000', labelSize:12 },
    polygon:{ fillColor:'#43a047', fillOpacity:0.5, lineColor:'#2e7d32', lineWidth:2, labelColor:'#000000', labelSize:12 },
    circle:{ fillColor:'#6d4c41', fillOpacity:0.5, lineColor:'#4e342e', lineWidth:2, labelColor:'#000000', labelSize:12 }
  };
  function ensureDefaultStyle(feature){
    if(!feature || typeof feature!=='object') return;
    feature.properties=feature.properties||{};
    const props=feature.properties;
    const typ=props._type;
    if(!typ || !STYLE_DEFAULTS[typ]) return;
    const defaults=STYLE_DEFAULTS[typ];
    Object.keys(defaults).forEach(key=>{
      if(!(key in props)) props[key]=defaults[key];
    });
    if(typ==='polygon' || typ==='circle'){
      if(!('fillColor' in props)) props.fillColor=defaults.fillColor;
      if(!('fillOpacity' in props)) props.fillOpacity=defaults.fillOpacity;
    }
    if(typ==='line' || typ==='polygon' || typ==='circle'){
      if(!('lineColor' in props)) props.lineColor=defaults.lineColor;
      if(!('lineWidth' in props)) props.lineWidth=defaults.lineWidth;
    }
    // Êóß„Éó„É≠„Éë„ÉÜ„Ç£„Å®„ÅÆ‰∫íÊèõ
    if('lineColor' in props) props.stroke=props.lineColor;
    if('lineWidth' in props) props.strokeWidth=props.lineWidth;
    if('fillColor' in props) props.fill=props.fillColor;
    if('fillOpacity' in props) props.fillOpacity=Number(props.fillOpacity);
    if('labelSize' in props) props.labelSize=Number(props.labelSize)||defaults.labelSize;
  }

  function computeLabelCoordinates(feature){
    if(!feature?.geometry) return null;
    const typ=feature?.properties?._type;
    try{
      if(typ==='line'){
        if(feature.geometry.type==='LineString'){
          const len=turf.length(feature,{units:'kilometers'});
          if(len>0){
            const mid=turf.along(feature,len/2,{units:'kilometers'});
            if(mid?.geometry?.coordinates) return mid.geometry.coordinates;
          }
        }
        const center=turf.centerOfMass(feature);
        if(center?.geometry?.coordinates) return center.geometry.coordinates;
      }else if(typ==='polygon' || typ==='circle'){
        const center=turf.centerOfMass(feature);
        if(center?.geometry?.coordinates) return center.geometry.coordinates;
      }
    }catch(err){ console.warn('label coordinate error', err); }
    if(feature.geometry.type==='Point' && Array.isArray(feature.geometry.coordinates)){
      return feature.geometry.coordinates;
    }
    if(feature.geometry.type==='LineString' && Array.isArray(feature.geometry.coordinates) && feature.geometry.coordinates.length){
      return feature.geometry.coordinates[Math.floor(feature.geometry.coordinates.length/2)];
    }
    if((feature.geometry.type==='Polygon' || feature.geometry.type==='MultiLineString') && Array.isArray(feature.geometry.coordinates?.[0]) && feature.geometry.coordinates[0].length){
      return feature.geometry.coordinates[0][0];
    }
    return null;
  }

  function buildLabelFeature(feature){
    const typ=feature?.properties?._type;
    if(!typ || typ==='point') return null;
    const props=feature.properties||{};
    const labelColor=props.labelColor || (STYLE_DEFAULTS[typ]?.labelColor ?? '#000000');
    const rawSize=Number(props.labelSize);
    const labelSize=Number.isFinite(rawSize) ? rawSize : (STYLE_DEFAULTS[typ]?.labelSize ?? 12);
    let labelText='';
    if(typ==='polygon'){
      const line1=(props.label1||'').trim();
      const line2=(props.label2||'').trim();
      labelText=[line1,line2].filter(Boolean).join('\n');
      if(!labelText){
        labelText=(props.label||'').trim();
        labelText=labelText.replace(' / ','\n');
      }
    }else{
      labelText=(props.label||'').trim();
    }
    if(!labelText) return null;
    const coords=computeLabelCoordinates(feature);
    if(!coords) return null;
    return {
      type:'Feature',
      properties:{
        _labelType:typ,
        labelText,
        labelColor,
        labelSize
      },
      geometry:{ type:'Point', coordinates:coords }
    };
  }

  function buildUserLabelCollection(fc=window.userFC){
    const features=[];
    if(fc?.features?.length){
      fc.features.forEach(f=>{
        try{
          ensureDefaultStyle(f);
          const labelFeature=buildLabelFeature(f);
          if(labelFeature) features.push(labelFeature);
        }catch(err){ console.warn('build label feature failed', err); }
      });
    }
    return { type:'FeatureCollection', features };
  }

  function syncUserLabelSource(){
    window.userLabelFC=buildUserLabelCollection();
    if(map?.getSource('user-labels')){
      map.getSource('user-labels').setData(window.userLabelFC);
    }
  }

  const polygonLabelPanel=$('polygonLabelPanel');
  makeDraggable(polygonLabelPanel);
  let polygonLabelTarget=null;
  let polygonResumeMode=null;
  let polygonIsNew=false;
  let polygonPreviewFeature=null;
  function showPolygonPreview(feature){
    if(!feature?.geometry) return;
    polygonPreviewFeature=feature;
    try{
      const src=map?.getSource?.('user-temp');
      if(src){
        src.setData({ type:'FeatureCollection', features:[feature] });
      }
      if(map?.getLayer?.('user-temp-fill')){
        map.setLayoutProperty('user-temp-fill','visibility','visible');
      }
    }catch(err){ console.warn('showPolygonPreview', err); }
  }
  function clearPolygonPreview(){
    if(!polygonPreviewFeature) return;
    polygonPreviewFeature=null;
    try{
      const src=map?.getSource?.('user-temp');
      if(src){
        src.setData({ type:'FeatureCollection', features:[] });
      }
      if(map?.getLayer?.('user-temp-fill')){
        const vis=(addMode==='polygon'||addMode==='circle')?'visible':'none';
        map.setLayoutProperty('user-temp-fill','visibility',vis);
      }
    }catch(err){ console.warn('clearPolygonPreview', err); }
  }
  function openPolygonLabelEditor(feature,{resumeMode=null,isNew=false}={}){
    polygonLabelTarget=feature;
    polygonResumeMode=resumeMode;
    polygonIsNew=isNew;
    if(isNew) showPolygonPreview(feature);
    if(feature){
      const props=feature.properties||{};
      $('polyLabelInput1').value=props.label1||'';
      $('polyLabelInput2').value=props.label2||'';
    }
    centerPanel(polygonLabelPanel);
    requestAnimationFrame(()=>{
      const input=$('polyLabelInput1');
      if(input){ input.focus(); input.select(); }
    });
  }
  function closePolygonLabel(apply){
    if(polygonLabelTarget && apply){
      const l1=$('polyLabelInput1').value.trim();
      const l2=$('polyLabelInput2').value.trim();
      polygonLabelTarget.properties=polygonLabelTarget.properties||{};
      polygonLabelTarget.properties.label1=l1;
      polygonLabelTarget.properties.label2=l2;
      polygonLabelTarget.properties.label=[l1,l2].filter(Boolean).join(' / ');
      const polyProps=polygonLabelTarget.properties;
      if(!('fillColor' in polyProps)) polyProps.fillColor='#43a047';
      if(!('fillOpacity' in polyProps)) polyProps.fillOpacity=0.5;
      if(!('lineColor' in polyProps)) polyProps.lineColor='#2e7d32';
      if(!('lineWidth' in polyProps)) polyProps.lineWidth=2;
      ensureDefaultStyle(polygonLabelTarget);
      clearPolygonPreview();
      if(polygonIsNew){
        if(typeof window.pushFeature==='function') window.pushFeature(polygonLabelTarget);
        else if(window.userFC && Array.isArray(window.userFC.features)){ window.userFC.features.push(polygonLabelTarget); if(typeof syncUserFeatures==='function') syncUserFeatures(); }
      }else{
        if(typeof syncUserFeatures==='function') syncUserFeatures();
      }
    }else{
      clearPolygonPreview();
    }
    polygonLabelTarget=null;
    polygonIsNew=false;
    if(polygonLabelPanel) polygonLabelPanel.style.display='none';
    if(polygonResumeMode && typeof activateTool==='function') activateTool(polygonResumeMode);
    polygonResumeMode=null;
    if(typeof updateMapCursor==='function') updateMapCursor();
  }
  $('polyLabelConfirm')?.addEventListener('click',()=>closePolygonLabel(true));
  $('polyLabelCancel')?.addEventListener('click',()=>closePolygonLabel(false));
  window.openPolygonLabelEditor=openPolygonLabelEditor;

  const STORAGE_KEYS={
    userObjects:'phnfc_user_objects_v1',
    surveyNotes:'phnfc_survey_notes_v1'
  };
  function loadStoredUserFC(){
    if(!window.localStorage) return null;
    try{
      const raw=localStorage.getItem(STORAGE_KEYS.userObjects);
      if(!raw) return null;
      const parsed=JSON.parse(raw);
      if(parsed && parsed.type==='FeatureCollection' && Array.isArray(parsed.features)){
        return parsed;
      }
    }catch(err){ console.warn('loadStoredUserFC', err); }
    return null;
  }
  function saveUserFCToStorage(fc){
    if(!window.localStorage) return;
    try{
      localStorage.setItem(STORAGE_KEYS.userObjects, JSON.stringify(fc));
    }catch(err){ console.warn('saveUserFCToStorage', err); }
  }
  let storedUserFC=loadStoredUserFC();
  window.userFC = storedUserFC || { type:'FeatureCollection', features:[] };
  if(!window.userFC.features) window.userFC.features=[];
  if(!window.userFC.groups || typeof window.userFC.groups!=='object') window.userFC.groups={};
  if(typeof window.userFC._groupSeq!=='number') window.userFC._groupSeq=1;
  window.userFC.features.forEach(f=>{ try{ ensureDefaultStyle(f); }catch(_){} });
  window.userLabelFC = buildUserLabelCollection(window.userFC);

  // ÈÉΩÈÅìÂ∫úÁúå
  const PREFS=["ÂåóÊµ∑ÈÅì","ÈùíÊ£ÆÁúå","Â≤©ÊâãÁúå","ÂÆÆÂüéÁúå","ÁßãÁî∞Áúå","Â±±ÂΩ¢Áúå","Á¶èÂ≥∂Áúå","Ëå®ÂüéÁúå","Ê†ÉÊú®Áúå","Áæ§È¶¨Áúå","ÂüºÁéâÁúå","ÂçÉËëâÁúå","Êù±‰∫¨ÈÉΩ","Á•ûÂ•àÂ∑ùÁúå","Êñ∞ÊΩüÁúå","ÂØåÂ±±Áúå","Áü≥Â∑ùÁúå","Á¶è‰∫ïÁúå","Â±±Ê¢®Áúå","Èï∑ÈáéÁúå","Â≤êÈòúÁúå","ÈùôÂ≤°Áúå","ÊÑõÁü•Áúå","‰∏âÈáçÁúå","ÊªãË≥ÄÁúå","‰∫¨ÈÉΩÂ∫ú","Â§ßÈò™Â∫ú","ÂÖµÂ∫´Áúå","Â•àËâØÁúå","ÂíåÊ≠åÂ±±Áúå","È≥•ÂèñÁúå","Â≥∂Ê†πÁúå","Â≤°Â±±Áúå","Â∫ÉÂ≥∂Áúå","Â±±Âè£Áúå","Âæ≥Â≥∂Áúå","È¶ôÂ∑ùÁúå","ÊÑõÂ™õÁúå","È´òÁü•Áúå","Á¶èÂ≤°Áúå","‰ΩêË≥ÄÁúå","Èï∑Â¥éÁúå","ÁÜäÊú¨Áúå","Â§ßÂàÜÁúå","ÂÆÆÂ¥éÁúå","ÈπøÂÖêÂ≥∂Áúå","Ê≤ñÁ∏ÑÁúå"];
  const PREF_CODE_MAP={
    'ÂåóÊµ∑ÈÅì':'01','ÈùíÊ£ÆÁúå':'02','Â≤©ÊâãÁúå':'03','ÂÆÆÂüéÁúå':'04','ÁßãÁî∞Áúå':'05','Â±±ÂΩ¢Áúå':'06','Á¶èÂ≥∂Áúå':'07',
    'Ëå®ÂüéÁúå':'08','Ê†ÉÊú®Áúå':'09','Áæ§È¶¨Áúå':'10','ÂüºÁéâÁúå':'11','ÂçÉËëâÁúå':'12','Êù±‰∫¨ÈÉΩ':'13','Á•ûÂ•àÂ∑ùÁúå':'14',
    'Êñ∞ÊΩüÁúå':'15','ÂØåÂ±±Áúå':'16','Áü≥Â∑ùÁúå':'17','Á¶è‰∫ïÁúå':'18','Â±±Ê¢®Áúå':'19','Èï∑ÈáéÁúå':'20','Â≤êÈòúÁúå':'21',
    'ÈùôÂ≤°Áúå':'22','ÊÑõÁü•Áúå':'23','‰∏âÈáçÁúå':'24','ÊªãË≥ÄÁúå':'25','‰∫¨ÈÉΩÂ∫ú':'26','Â§ßÈò™Â∫ú':'27','ÂÖµÂ∫´Áúå':'28',
    'Â•àËâØÁúå':'29','ÂíåÊ≠åÂ±±Áúå':'30','È≥•ÂèñÁúå':'31','Â≥∂Ê†πÁúå':'32','Â≤°Â±±Áúå':'33','Â∫ÉÂ≥∂Áúå':'34','Â±±Âè£Áúå':'35',
    'Âæ≥Â≥∂Áúå':'36','È¶ôÂ∑ùÁúå':'37','ÊÑõÂ™õÁúå':'38','È´òÁü•Áúå':'39','Á¶èÂ≤°Áúå':'40','‰ΩêË≥ÄÁúå':'41','Èï∑Â¥éÁúå':'42',
    'ÁÜäÊú¨Áúå':'43','Â§ßÂàÜÁúå':'44','ÂÆÆÂ¥éÁúå':'45','ÈπøÂÖêÂ≥∂Áúå':'46','Ê≤ñÁ∏ÑÁúå':'47'
  };
  const MUNICIPAL_CODE_FIELDS=[
    'ÂÖ®ÂõΩÂú∞ÊñπÂÖ¨ÂÖ±Âõ£‰Ωì„Ç≥„Éº„Éâ','ÂÖ®ÂõΩÂú∞ÊñπÂÖ¨ÂÖ±Âõ£‰Ωì„Ç≥„Éº„Éâ(Âπ≥Êàê27Âπ¥)','ÂÖ®ÂõΩÂú∞ÊñπÂÖ¨ÂÖ±Âõ£‰Ωì„Ç≥„Éº„ÉâÔºàÂπ≥Êàê27Âπ¥Ôºâ','ÂÖ®ÂõΩÂú∞ÊñπÂÖ¨ÂÖ±Âõ£‰Ωì„Ç≥„Éº„Éâ(‰ª§Âíå2Âπ¥)',
    'ÂÖ®ÂõΩÂú∞ÊñπÂÖ¨ÂÖ±Âõ£‰Ωì„Ç≥„Éº„ÉâÔºà‰ª§Âíå2Âπ¥Ôºâ','ÂÖ®ÂõΩÂú∞ÊñπÂÖ¨ÂÖ±Âõ£‰Ωì„Ç≥„Éº„Éâ_Âπ≥Êàê27Âπ¥','ÂÖ®ÂõΩÂú∞ÊñπÂÖ¨ÂÖ±Âõ£‰Ωì„Ç≥„Éº„Éâ_‰ª§Âíå2Âπ¥','ÂÖ®ÂõΩÂú∞ÊñπÂÖ¨ÂÖ±Âõ£‰Ωì„Ç≥„Éº„Éâ2015',
    'ÂÖ®ÂõΩÂú∞ÊñπÂÖ¨ÂÖ±Âõ£‰Ωì„Ç≥„Éº„Éâ2020','ÂÖ®ÂõΩÂú∞ÊñπÂÖ¨ÂÖ±Âõ£‰Ωì„Ç≥„Éº„Éâ_2015','ÂÖ®ÂõΩÂú∞ÊñπÂÖ¨ÂÖ±Âõ£‰Ωì„Ç≥„Éº„Éâ_2020','Â∏ÇÂå∫Áî∫Êùë„Ç≥„Éº„Éâ','Â∏ÇÁî∫Êùë„Ç≥„Éº„Éâ',
    'ÈÉΩÈÅìÂ∫úÁúåÂ∏ÇÂå∫Áî∫Êùë„Ç≥„Éº„Éâ','LGCODE','LG_CODE','JCODE','N03_007','N03_007_2','P34_003','P35_001','P35_002'
  ];
  const PREF_PART_CODE_FIELDS=['ÈÉΩÈÅìÂ∫úÁúå„Ç≥„Éº„Éâ','ÈÅìÂ∫úÁúå„Ç≥„Éº„Éâ','Áúå„Ç≥„Éº„Éâ','ÊîØÂ∫Å„Ç≥„Éº„ÉâÔºàÈÉΩÈÅìÂ∫úÁúåÔºâ','PrefCode','pref_cd','P34_001','P05_001','N03_001'];
  const CITY_PART_CODE_FIELDS=['Â∏ÇÂå∫Áî∫Êùë„Ç≥„Éº„Éâ','Â∏ÇÁî∫Êùë„Ç≥„Éº„Éâ','Â∏ÇÂå∫Áî∫ÊùëÁï™Âè∑','CityCode','city_cd','P34_002','P05_002','N03_003'];
  const BRANCH_CODE_FIELDS=['Ë°åÊîøÂå∫Âüü„Ç≥„Éº„Éâ','Ë°åÊîøÂå∫„Ç≥„Éº„Éâ','ÊîØÊâÄ„Ç≥„Éº„Éâ','ÊûùÁï™','N03_004','N03_007','BranchCode'];
  const municipalIndex=new Map();

  /*************** „Éô„Éº„Çπ„Éû„ÉÉ„ÉóÔºàOSM & Âú∞ÁêÜÈô¢„Çø„Ç§„É´Ôºâ ***************/
  const BASE_SOURCES = {
    osm: { type:'raster', tiles:["https://tile.openstreetmap.org/{z}/{x}/{y}.png"], tileSize:256, attribution:"¬© OpenStreetMap" },
    gsi_std:   { type:'raster', tiles:["https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png"], tileSize:256, attribution:"¬© GSI" },
    gsi_photo: { type:'raster', tiles:["https://cyberjapandata.gsi.go.jp/xyz/ort/{z}/{x}/{y}.jpg"], tileSize:256, attribution:"¬© GSI" }
  };
  const BASE_OPACITY = 0.75;

// Èô∞ÂΩ±ÔºàÂ∏∏„Å´‰∏ÄÁï™‰∏ãÔºâ + „Éô„Éº„ÇπÔºàÂ∞ë„ÅóÈÄèÈÅéÔºâ
const HILLSHADE_SOURCE = { type:'raster', tiles:["https://cyberjapandata.gsi.go.jp/xyz/hillshademap/{z}/{x}/{y}.png"], tileSize:256, attribution:"¬© GSI" };

const map = new maplibregl.Map({
  container:'map',
  style:{
    version:8,
    glyphs:'https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf',
    sources:{
      hillshade: HILLSHADE_SOURCE,
      base: BASE_SOURCES.osm
    },
    layers:[
      { id:'hillshade', type:'raster', source:'hillshade', paint:{ 'raster-opacity': 1.0 } },
      { id:'base',      type:'raster', source:'base',      paint:{ 'raster-opacity': BASE_OPACITY } }
    ]
  },
  center:[139.767,35.681], zoom:5.2
});

// Á∏ÆÂ∞∫„Éê„Éº
map.addControl(new maplibregl.ScaleControl({maxWidth:140, unit:'metric'}), 'bottom-left');

map.on('styledata', ensureUserPointFlagIcon);

// ÁèæÂú®Âú∞ÔºàMapLibre ÁµÑ„ÅøËæº„ÅøÔºâ
const geoControl = new maplibregl.GeolocateControl({ positionOptions:{ enableHighAccuracy:true }, trackUserLocation:true, showUserHeading:true });
map.addControl(geoControl, 'bottom-left');
  let pulse;
geoControl.on('geolocate', (pos)=>{
  const { longitude, latitude } = pos.coords;
  surveyState.currentPosition=pos;
  if(!pulse){
    const el=document.createElement('div');
    el.className='pulse';
    el.style.pointerEvents='none';
    el.style.cursor='inherit';
    pulse=new maplibregl.Marker({element:el, anchor:'center'});
  }
  pulse.setLngLat([longitude, latitude]).addTo(map);
});
// „Çπ„Çø„Ç§„É´„É≠„Éº„ÉâÂæå„Å´ÂåªÁôÇÊ©üÈñ¢„É¨„Ç§„É§„ÇíÂÖà„Å´Áî®ÊÑè
map.on('load', () => {
  try {
    ensureMedicalLayers();
    updateLayerVisibility(); // „ÉÅ„Çß„ÉÉ„ÇØÁä∂ÊÖã„ÇíÂèçÊò†
    ensureOverlayOrder();    // ‚Üê „Åì„Çå„ÇíËøΩÂä†
  } catch(e) { console.warn(e); }
});

// Âú∞Âõ≥Êìç‰Ωú„ÅßÂåªÁôÇÊ©üÈñ¢„ÇíÂÜçÂèñÂæó
['moveend','zoomend','dragend'].forEach(ev=>{
  map.on(ev, () => {
    if ($('chkMedical')?.checked) refreshMedicalLayer();
  });
});

// --- ÂåªÁôÇ„É¨„Ç§„É§ID„Çí‰∏ÄÂ∫¶„Å†„ÅëÂÆöÁæ© ---
const MEDICAL_SOURCE_ID  = 'medical';
const MEDICAL_LAYER_POINT = 'med-circle';
const MEDICAL_LAYER_LABEL = 'med-label';

// --- Ë°®Á§∫È†ÜÔºà‰∏ä„Å´Ë°å„Åè„Åª„Å©‰∏ä„Å´Êèè„ÅèÔºâ ---
const overlayLayerOrder = [
  'user-temp-fill','user-temp-line',
  'user-poly-fill','user-poly-line','user-line','user-line-label','user-poly-label','user-circle-label',
  'user-point-emoji','user-point-label',
  MEDICAL_LAYER_POINT, MEDICAL_LAYER_LABEL,
  'emg-circle','emg-label',
  'shel-circle','shel-label',
  'survey-track-line','survey-track-points',
  'survey-notes-icon','survey-notes-label'
];

function ensureOverlayOrder(){
  overlayLayerOrder.forEach(id => { if (map.getLayer(id)) map.moveLayer(id); });
}


function ensureSurveyFlagIcon(){
  if(typeof map==='undefined' || !map || typeof map.hasImage!=='function') return;
  if(map.hasImage('survey-flag')) return;
  const size=64;
  const canvas=document.createElement('canvas');
  canvas.width=size;
  canvas.height=size;
  const ctx=canvas.getContext('2d');
  if(!ctx) return;
  ctx.clearRect(0,0,size,size);
  // pole shadow
  ctx.fillStyle='rgba(15,23,42,0.12)';
  ctx.beginPath();
  ctx.ellipse(size*0.22, size*0.84, size*0.12, size*0.04, 0, 0, Math.PI*2);
  ctx.fill();
  // pole
  ctx.fillStyle='#1f2937';
  ctx.fillRect(size*0.18, size*0.16, size*0.08, size*0.68);
  // flag cloth
  ctx.fillStyle='#ef4444';
  ctx.beginPath();
  ctx.moveTo(size*0.26, size*0.2);
  ctx.lineTo(size*0.78, size*0.32);
  ctx.lineTo(size*0.26, size*0.44);
  ctx.closePath();
  ctx.fill();
  try{
    const data=ctx.getImageData(0,0,size,size);
    map.addImage('survey-flag', { width:size, height:size, data:data.data }, { pixelRatio:2 });
  }catch(err){
    if(!(err && typeof err.message==='string' && err.message.includes('already exists'))){
      console.warn('ensureSurveyFlagIcon', err);
    }
  }
}

function ensureUserPointFlagIcon(){
  if(typeof map==='undefined' || !map || typeof map.hasImage!=='function') return;
  if(map.hasImage('user-point-flag')) return;
  const baseSize=64;
  const ratio=Math.max(1, Math.min(3, window.devicePixelRatio||1));
  const canvas=document.createElement('canvas');
  canvas.width=baseSize*ratio;
  canvas.height=baseSize*ratio;
  const ctx=canvas.getContext('2d');
  if(!ctx) return;
  ctx.scale(ratio,ratio);
  ctx.clearRect(0,0,baseSize,baseSize);
  ctx.textAlign='center';
  ctx.textBaseline='middle';
  ctx.font=`${Math.round(baseSize*0.78)}px "Noto Color Emoji","Segoe UI Emoji","Apple Color Emoji",system-ui`;
  ctx.fillText('üö©', baseSize/2, baseSize/2 + baseSize*0.04);
  try{
    const data=ctx.getImageData(0,0,canvas.width,canvas.height);
    map.addImage('user-point-flag',{width:canvas.width,height:canvas.height,data:data.data},{pixelRatio:ratio});
  }catch(err){
    if(!(err && typeof err.message==='string' && err.message.includes('already exists'))){
      console.warn('ensureUserPointFlagIcon', err);
    }
  }
}


$('basemapSel').addEventListener('change', ()=>{
  const key = $('basemapSel').value;

  // Êó¢Â≠ò„ÅÆ base „ÇíÂ§ñ„Åô
  if (map.getLayer('base')) map.removeLayer('base');
  if (map.getSource('base')) map.removeSource('base');

  // Êñ∞„Åó„ÅÑ source „ÇíÁî®ÊÑè
  map.addSource('base', BASE_SOURCES[key]);

  // hillshade „ÅÆ„ÄåÁõ¥‰∏ä„Äç„Å´ÁΩÆ„ÅèÔºàÔºùÈô∞ÂΩ±„ÅØÂ∏∏„Å´‰∏ã„ÄÅ„Éô„Éº„Çπ„ÅØ„Åù„ÅÆ‰∏ä„Å´Êù•„ÇãÔºâ
  const layers = map.getStyle().layers.map(l=>l.id);
  // hillshade „Çà„Çä‰∏ä„Å´ÁΩÆ„Åç„Åü„ÅÑ„ÅÆ„Åß„ÄÅhillshade„ÅÆ‚ÄúÊ¨°‚Äù„ÅÆ„É¨„Ç§„É§„Çí before „Å´ÊåáÂÆö
  const idxHill = layers.indexOf('hillshade');
  const beforeId = (idxHill >= 0 && layers[idxHill+1]) ? layers[idxHill+1] : undefined;

  map.addLayer({ id:'base', type:'raster', source:'base', paint:{'raster-opacity':BASE_OPACITY} }, beforeId);
  ensureOverlayOrder();
});

  /*************** DrawÔºà„Éù„Ç§„É≥„Éà/„É©„Ç§„É≥/„Éù„É™„Ç¥„É≥ + ÂÜÜ„ÉÑ„Éº„É´Ôºâ ***************/
const draw = new MapboxDraw({
  displayControlsDefault:false,
  controls:{} // ‚Üê „Åô„Åπ„Å¶UIÈùûË°®Á§∫
});
// map.addControl(draw,'top-right'); ‚Üê ËøΩÂä†„Åó„Å™„ÅÑ

  /*************** „Éè„Ç∂„Éº„ÉâÔºàÊ¥™Ê∞¥=1„ÄÅÂúüÁ†Ç=3„Åæ„Å®„ÇÅÔºâ ***************/
  // ‚òÖ ÂøÖË¶Å„Å´Âøú„Åò„Å¶URL„ÇíË®≠ÂÆöÔºàÁ©∫„Å™„ÇâËá™ÂãïÁÑ°ÂäπÔºâ
  const FLOOD_TILES = "https://disaportaldata.gsi.go.jp/raster/01_flood_l2_shinsuishin_data/{z}/{x}/{y}.png"; // ‰æã: 'https://{s}.example.com/flood/{z}/{x}/{y}.png'
  const SEDIMENT_TILES = [
    "https://disaportaldata.gsi.go.jp/raster/05_dosekiryukeikaikuiki/{z}/{x}/{y}.png", //"‰æã: 'https://{s}.example.com/sediment/debrisflow/{z}/{x}/{y}.png'
    "https://disaportaldata.gsi.go.jp/raster/05_kyukeishakeikaikuiki/{z}/{x}/{y}.png", // ‰æã: 'https://{s}.example.com/sediment/steepslope/{z}/{x}/{y}.png'
    "https://disaportaldata.gsi.go.jp/raster/05_jisuberikeikaikuiki/{z}/{x}/{y}.png"  // ‰æã: 'https://{s}.example.com/sediment/landslide/{z}/{x}/{y}.png'
  ];
  const HAZ_FLOOD_SOURCE_ID="haz-flood", HAZ_FLOOD_LAYER_ID="haz-flood";
  const HAZ_SED_SOURCE_IDS=["haz-sed-0","haz-sed-1","haz-sed-2"];
  const HAZ_SED_LAYER_IDS =["haz-sed-0","haz-sed-1","haz-sed-2"];

// „Åì„Åì„ÅØ ensureHazardLayers „ÅÆÂ§ñÔºà„Éà„ÉÉ„Éó„É¨„Éô„É´Ôºâ„Å´ÁΩÆ„ÅÑ„Å¶„Åè„Å†„Åï„ÅÑ
function ensureHazardLayers(){
  const opa = Number(document.getElementById('hazOpacity').value || 0.6);

  // Ê¥™Ê∞¥
  const HAZ_FLOOD_SOURCE_ID = "haz-flood";
  const HAZ_FLOOD_LAYER_ID  = "haz-flood";
  if (FLOOD_TILES && !map.getSource(HAZ_FLOOD_SOURCE_ID)) {
    map.addSource(HAZ_FLOOD_SOURCE_ID, { type:'raster', tiles:[FLOOD_TILES], tileSize:256 });
  }
  if (FLOOD_TILES && !map.getLayer(HAZ_FLOOD_LAYER_ID)) {
    map.addLayer({ id:HAZ_FLOOD_LAYER_ID, type:'raster', source:HAZ_FLOOD_SOURCE_ID,
      paint:{ 'raster-opacity': opa } });
  }

  // ÂúüÁ†ÇÔºà3„É¨„Ç§„É§Ôºâ
  const HAZ_SED_SOURCE_IDS = ["haz-sed-0","haz-sed-1","haz-sed-2"];
  const HAZ_SED_LAYER_IDS  = ["haz-sed-0","haz-sed-1","haz-sed-2"];
  SEDIMENT_TILES.forEach((url,i)=>{
    if(!url) return;
    if(!map.getSource(HAZ_SED_SOURCE_IDS[i])){
      map.addSource(HAZ_SED_SOURCE_IDS[i], { type:'raster', tiles:[url], tileSize:256 });
    }
    if(!map.getLayer(HAZ_SED_LAYER_IDS[i])){
      map.addLayer({ id:HAZ_SED_LAYER_IDS[i], type:'raster',
        source:HAZ_SED_SOURCE_IDS[i],
        paint:{ 'raster-opacity': opa } });
    }
  });
}

  function updateHazard(){
    const opa=Number($('hazOpacity').value||0.6);
    $('hazOpacityVal').textContent=opa.toFixed(2);
    if(map.getLayer(HAZ_FLOOD_LAYER_ID)){
      map.setPaintProperty(HAZ_FLOOD_LAYER_ID,'raster-opacity',opa);
      map.setLayoutProperty(HAZ_FLOOD_LAYER_ID,'visibility',$('chkFlood').checked?'visible':'none');
    }
    HAZ_SED_LAYER_IDS.forEach(lid=>{
      if(!map.getLayer(lid)) return;
      map.setPaintProperty(lid,'raster-opacity',opa);
      map.setLayoutProperty(lid,'visibility',$('chkSediment').checked?'visible':'none');
    });
  }
  $('chkFlood').addEventListener('change',()=>{ensureHazardLayers();updateHazard();});
  $('chkSediment').addEventListener('change',()=>{ensureHazardLayers();updateHazard();});
  $('hazOpacity').addEventListener('input',updateHazard);

  /*************** ‚òÖ‚òÖ‚òÖ TODO 2ÔºöFGBÔºàÂÖ¨ÈñãURLÔºâ„ÇíË≤º„Çã ***************/
  // Supabase Storage „ÅÆ Public URL „Çí„Åù„ÅÆ„Åæ„ÅæË≤º„Å£„Å¶„Åè„Å†„Åï„ÅÑÔºàÁΩ≤ÂêçURL„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„ÇìÔºâ
  const FGB_URL_EMERGENCY='https://tdoxxwhkvdguyfrofnaw.supabase.co/storage/v1/object/public/data/Designated%20Emergency%20Evacuation%20Site.fgb'; // ‚ÜêÁΩÆÊèõÔºàÂÖàÈ†≠ eÔºâ
  const FGB_URL_SHELTER  ='https://tdoxxwhkvdguyfrofnaw.supabase.co/storage/v1/object/public/data/Designated%20Shelter%20for%20Evacuees.fgb';     // ‚ÜêÁΩÆÊèõ

// Ëá™Â∑±„Éõ„Çπ„Éà„Åó„Åü flatgeobuf „Çí ‚ÄúÂøÖ„ÅöÊúÄÂàù„Å´‚Äù Ë™≠„Åø„Å´„ÅÑ„Åè
const LOCAL_FGB_LIB = './flatgeobuf-geojson.min.js';

/**
 * flatgeobuf „ÅÆ GeoJSON „Éá„Ç∑„É™„Ç¢„É©„Ç§„Ç∂ÔºàdeserializeÔºâ„ÇíÁ¢∫ÂÆü„Å´Ë™≠„ÅøËæº„ÇÄ„ÄÇ
 * 1) Ëá™Â∑±„Éõ„Çπ„ÉàÔºàLOCAL_FGB_LIBÔºâ
 * 2) jsDelivr
 * 3) unpkg
 * „Åù„Çå„Åß„ÇÇ„ÉÄ„É°„Å™„Çâ„Ç®„É©„Éº„ÄÇ
 */
async function loadFgbLib() {
  if (window.flatgeobuf?.deserialize) return window.flatgeobuf.deserialize;

  const candidates = [
    LOCAL_FGB_LIB,
    'https://cdn.jsdelivr.net/npm/flatgeobuf@3.27.4/dist/flatgeobuf-geojson.min.js',
    'https://unpkg.com/flatgeobuf@3.27.4/dist/flatgeobuf-geojson.min.js'
  ];

  for (const url of candidates) {
    try {
      await new Promise((resolve, reject) => {
        const s = document.createElement('script');
        s.src = url;
        s.async = true;
        s.onload = resolve;
        s.onerror = () => reject(new Error('failed: ' + url));
        document.head.appendChild(s);
      });
      if (window.flatgeobuf?.deserialize) {
        return window.flatgeobuf.deserialize;
      }
    } catch (e) {
      console.warn('[flatgeobuf] load failed ->', e.message);
    }
  }
  throw new Error('flatgeobuf„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±ÊïóÔºàËá™Â∑±„Éõ„Çπ„Éà/CDN„Å®„ÇÇ‰∏çÂèØÔºâ');
}

/**
 * FGB „Çí URL „Åã„ÇâË™≠„Åø„ÄÅGeoJSON Feature[] „ÇíËøî„Åô„ÄÇ
 * - ÂÖàÈ†≠1„Éê„Ç§„Éà Range ÂèñÂæó„Åß HTMLË™§ÈÖç‰ø°„ÇíÊ§úÁü•
 * - loadFgbLib() „ÇíÈÄö„Åó„Å¶Ëá™Â∑±„Éõ„Çπ„Éà/„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ„Åß„É©„Ç§„Éñ„É©„É™„ÇíÁ¢∫ÂÆü„Å´„É≠„Éº„Éâ
 */
/**
 * FGB „Çí URL „Åã„ÇâË™≠„Åø„ÄÅGeoJSON Feature[] „ÇíËøî„Åô„ÄÇ
 * 1) „Åæ„Åö URL „Çí„Åù„ÅÆ„Åæ„ÅæÊ∏°„Åó„Å¶„Çπ„Éà„É™„Éº„Éü„É≥„Ç∞Ëß£ÊûêÔºàRangeÔºâ„ÇíË©¶„Åô
 * 2) Â§±Êïó„Åó„Åü„ÇâÂÖ®Èáè„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ ‚Üí Uint8Array „Åß„Éë„Éº„ÇπÔºàÁ¢∫ÂÆüÔºâ
 */
async function readFGB_fromURL(url) {
  const deserialize = await loadFgbLib();

  // --- „Åæ„Åö„ÅØÁ∞°Êòì„ÉÅ„Çß„ÉÉ„ÇØÔºàHTML Ë™§ÈÖç‰ø°Èò≤Ê≠¢Ôºâ ---
  try {
    const head = await fetch(url, { headers: { 'Range': 'bytes=0-0' }, cache: 'no-store' });
    if (!head.ok) throw new Error(`FGB„Éò„ÉÉ„ÉÄÂèñÂæóÂ§±Êïó ${head.status} ${head.statusText}`);
    const ct = (head.headers.get('content-type') || '').toLowerCase();
    if (ct.includes('text/html')) {
      throw new Error('FGBÁõ¥„É™„É≥„ÇØ„ÅåHTML„ÇíËøî„Åó„Å¶„ÅÑ„Åæ„ÅôÔºàURL/ÂÖ¨ÈñãË®≠ÂÆö/„Éë„Çπ„ÇíÁ¢∫Ë™çÔºâ');
    }
  } catch (e) {
    // „Éò„ÉÉ„ÉÄÂèñÂæó„Åå„ÉÄ„É°„Åß„ÇÇÂæåÊÆµ„ÅÆ„ÄåÂÖ®ÈáèÂèñÂæó„Äç„ÅßÊïë„Åà„Çã„ÅÆ„ÅßÁ∂öË°å
    console.warn('[FGB] head check skip ->', e.message);
  }

  // --- (A) URL „Çπ„Éà„É™„Éº„Éü„É≥„Ç∞„Åß„Éë„Éº„ÇπÔºàÊàêÂäü„Åô„Çå„Å∞ÊúÄÈÄüÔºâ ---
  try {
    const featsA = [];
    for await (const f of deserialize(url)) featsA.push(f);
    if (featsA.length) return featsA;
  } catch (e) {
    console.warn('[FGB] stream parse failed, fallback to full download ->', e.message);
    // ‰æã„ÅÆ„ÄåCannot destructure property 'minX' of 'r' as it is undefined„Äç„ÇÇ„Åì„Åì„Å´Êù•„Åæ„Åô
  }

  // --- (B) „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºöÂÖ®Èáè„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Å¶„Åã„Çâ„Éë„Éº„ÇπÔºàÁ¢∫ÂÆüÔºâ ---
  const resp = await fetch(url, { cache: 'no-store' });
  if (!resp.ok) throw new Error(`FGB„ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÂ§±Êïó ${resp.status} ${resp.statusText}`);
  const buf = await resp.arrayBuffer();
  const featsB = [];
  for await (const f of deserialize(new Uint8Array(buf))) featsB.push(f);
  if (!featsB.length) throw new Error('FGB„ÅÆ‰∏≠Ë∫´„ÅåÁ©∫„Åß„Åô');
  return featsB;
}

  // „ÇØ„É™„ÉÉ„ÇØ„ÅßÂ±ûÊÄß„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó
  function bindClickPopup(layerId){
    map.on('click', layerId, (e)=>{
      const f=e.features?.[0]; if(!f) return;
      const props=f.properties||{};
      const html='<ul class="popup-list">'+Object.entries(props).filter(([k])=>k!=='__label__')
        .map(([k,v])=>`<li><b>${k}</b> ${String(v)}</li>`).join('')+'</ul>';
      new maplibregl.Popup({offset:12}).setLngLat(e.lngLat).setHTML(html).addTo(map);
    });
    map.on('mouseenter', layerId, ()=> map.getCanvas().style.cursor='pointer');
    map.on('mouseleave', layerId, ()=> map.getCanvas().style.cursor='');
  }

  const MUNI_COL_CANDIDATES=["ÈÉΩÈÅìÂ∫úÁúåÂêçÂèä„Å≥Â∏ÇÁî∫ÊùëÂêç","ÈÉΩÈÅìÂ∫úÁúåÂèä„Å≥Â∏ÇÁî∫ÊùëÂêç"];
  const LABEL_CANDIDATES   =["ÊñΩË®≠„ÉªÂ†¥ÊâÄÂêç","‰ΩèÊâÄ","ÂÖ±ÈÄöID","NO"];
  const DEFAULT_MED_LABEL='P04_003_ja';
  const CAP_TAGS=[
    '1.Ë°åÊîø„Å®ÊîøÊ≤ª','2.‰∫∫Âè£Áµ±Ë®à','3.Ê≠¥Âè≤„ÄÅÊ∞ëÊóèÊÄß„ÄÅ‰æ°ÂÄ§Ë¶≥','4.Áâ©ÁêÜÁöÑÁí∞Â¢É','5.‰øùÂÅ•ÂåªÁôÇ„Å®Á§æ‰ºöÁ¶èÁ•â','6.ÁµåÊ∏à','7.‰∫§ÈÄö„Å®ÂÆâÂÖ®','8.ÊïôËÇ≤„Éª„É¨„ÇØ„É™„Ç®„Éº„Ç∑„Éß„É≥','9.ÊÉÖÂ†±„Å®„Ç≥„Éü„É•„Éã„Ç±„Éº„Ç∑„Éß„É≥'
  ];
  const escapeXml=(str)=>String(str??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&apos;').replace(/\r?\n/g,'&#10;');
  const escapeHtml=(str)=>String(str??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
  const toNumericString=(value)=>{
    if(value===undefined||value===null) return '';
    const str=String(value).trim();
    if(!str) return '';
    const digits=str.replace(/\D+/g,'');
    return digits;
  };
  const splitPrefCityLabel=(full)=>{
    const text=String(full||'').trim();
    if(!text) return {pref:'',city:''};
    const pref=PREFS.find(p=>text.startsWith(p))||'';
    const city=pref?text.slice(pref.length).trim():text;
    return {pref,city};
  };
  const canonicalMuniLabel=(full)=>{
    const {pref,city}=splitPrefCityLabel(full);
    if(pref && city) return `${pref} ${city}`.trim();
    if(pref) return pref;
    return city;
  };
  const normalizeMunicipalCode=(code)=>{
    const digits=toNumericString(code);
    if(!digits) return '';
    if(digits.length<=4) return digits.padStart(5,'0');
    if(digits.length===5) return digits;
    return digits.padStart(6,'0');
  };
  const deriveMunicipalCode=(props={})=>{
    for(const field of MUNICIPAL_CODE_FIELDS){
      if(!(field in props)) continue;
      const normalized=normalizeMunicipalCode(props[field]);
      if(normalized) return normalized;
    }
    let prefDigits='';
    for(const field of PREF_PART_CODE_FIELDS){
      if(!(field in props)) continue;
      const digits=toNumericString(props[field]);
      if(digits){ prefDigits=digits.padStart(2,'0'); break; }
    }
    if(!prefDigits) return '';
    let cityDigits='';
    for(const field of CITY_PART_CODE_FIELDS){
      if(!(field in props)) continue;
      const digits=toNumericString(props[field]);
      if(digits){ cityDigits=digits.padStart(3,'0'); break; }
    }
    if(!cityDigits) return '';
    let branch='';
    for(const field of BRANCH_CODE_FIELDS){
      if(!(field in props)) continue;
      const digits=toNumericString(props[field]);
      if(digits){ branch=digits.padStart(1,'0'); break; }
    }
    const combined=`${prefDigits}${cityDigits}${branch}`;
    if(branch){
      return combined.slice(0,6).padStart(6,'0');
    }
    return combined.slice(0,5).padStart(5,'0');
  };
  function buildMunicipalIndex(features,labelField){
    municipalIndex.clear();
    if(!labelField) return;
    (features||[]).forEach(feat=>{
      const props=feat?.properties||{};
      const rawLabel=String(props[labelField]||'').trim();
      if(!rawLabel) return;
      const canonical=canonicalMuniLabel(rawLabel);
      if(!canonical) return;
      const {pref,city}=splitPrefCityLabel(canonical);
      const code=deriveMunicipalCode(props);
      const existing=municipalIndex.get(canonical);
      if(existing){
        if(!existing.code && code) existing.code=code;
      }else{
        municipalIndex.set(canonical,{pref,city,code:code||''});
      }
    });
  }
  const getMunicipalEntry=(label)=>{
    const canonical=canonicalMuniLabel(label);
    if(!canonical){
      return {pref:'',city:'',code:''};
    }
    const stored=municipalIndex.get(canonical);
    if(stored){
      return {pref:stored.pref,city:stored.city,code:stored.code||''};
    }
    const {pref,city}=splitPrefCityLabel(canonical);
    return {pref,city,code:''};
  };
  let cacheEmergency=null, cacheShelter=null, COL_MUNI=null;
  const medicalCache=new Map();
  let lastMedicalFeatures=[];
  let currentMedicalKey=null;
  let layerScopeGlobal={ mode:'all', prefs:[], munis:[] };
  const SCOPE_LABELS={ global:'(ÂÖ®„É¨„Ç§„É§)', emergency:'(Á∑äÊÄ•ÈÅøÈõ£Â†¥ÊâÄ)', shelter:'(ÈÅøÈõ£ÊâÄ)', medical:'(ÂåªÁôÇÊ©üÈñ¢)' };
  const layerScopeOverrides={ emergency:null, shelter:null, medical:null };
  const layerLabelFields={ emergency:null, shelter:null, medical:DEFAULT_MED_LABEL };
  const layerColumns={ emergency:[], shelter:[], medical:[] };
  let medicalAbortController=null;
  let currentScopeTarget='global';
  const surveyState={
    panelVisible:false,
    recording:false,
    paused:false,
    watchId:null,
    trackPoints:[],
    notes:[],
    manualMode:false,
    editMode:false,
    labelsVisible:false,
    awaitingMove:false,
    movingNote:null,
    pendingNote:null,
    lastRecordTs:0,
    totalDistance:0,
    currentPosition:null,
    recordStartTs:null,
    recordStartJst:'',
    recordStartIso:''
  };
  let surveyNoteContext={ note:null, isNew:false };

  const surveyPanelEl=$('surveyPanel');
  const surveyNotePanelEl=$('surveyNotePanel');
  const surveyStatusEl=$('surveyStatus');
  const surveyFinishEl=$('surveyFinishPanel');
  const surveyCapBtn=$('surveyCapBtn');
  const surveyCapSelect=$('surveyCapSelect');
  const surveyCapWrap=$('surveyCapSelectWrap');
  const surveyNoteMoveWrap=$('surveyNoteMoveWrap');
  const surveyRecBadge=$('surveyRecBadge');
  const medicalStatusEl=$('medicalStatus');
  function setMedicalStatus(message,{error=false,loading=false}={}){
    if(!medicalStatusEl) return;
    if(!message){
      medicalStatusEl.style.display='none';
      medicalStatusEl.textContent='';
      medicalStatusEl.style.color='#64748b';
      return;
    }
    medicalStatusEl.textContent=message;
    medicalStatusEl.style.display='block';
    if(error){
      medicalStatusEl.style.color='#dc2626';
    }else if(loading){
      medicalStatusEl.style.color='#0ea5e9';
    }else{
      medicalStatusEl.style.color='#64748b';
    }
  }
  async function resolveSupabaseAccessToken(){
    if(!window.__supa?.auth?.getSession) return null;
    try{
      const { data, error } = await window.__supa.auth.getSession();
      if(error){
        console.warn('[medical] getSession error ->', error);
        return null;
      }
      return data?.session?.access_token || null;
    }catch(err){
      console.warn('[medical] getSession failed ->', err);
      return null;
    }
  }
  window.__surveyNotePopup=null;
  makeDraggable(surveyPanelEl);
  makeDraggable(surveyNotePanelEl);
  let lastSurveyPanelTop=null;
  function positionSurveyPanel({force=false}={}){
    if(!surveyPanelEl || surveyPanelEl.style.display==='none') return;
    const btn=$('btnSurvey');
    const btnRect=btn?.getBoundingClientRect?.();
    const anchorRect=topbarEl?.getBoundingClientRect?.() || btnRect;
    if(mobilePanelQuery.matches){
      surveyPanelEl.classList.add('mobile-pop');
      surveyPanelEl.style.removeProperty('left');
      surveyPanelEl.style.removeProperty('top');
      const desiredTop=((anchorRect?.bottom) ?? (btnRect?.bottom) ?? 72) + 12;
      const applyPosition=()=>{
        if(!surveyPanelEl || surveyPanelEl.style.display==='none') return;
        const panelHeight=surveyPanelEl.offsetHeight||0;
        const maxTop=Math.max(12, window.innerHeight - panelHeight - 12);
        const clampedTop=Math.min(Math.max(desiredTop, 12), maxTop);
        if(!force && lastSurveyPanelTop!==null && Math.abs(lastSurveyPanelTop-clampedTop)<1) return;
        surveyPanelEl.style.setProperty('--survey-panel-top', `${Math.round(clampedTop)}px`);
        lastSurveyPanelTop=clampedTop;
      };
      requestAnimationFrame(applyPosition);
    }else{
      surveyPanelEl.classList.remove('mobile-pop');
      surveyPanelEl.style.removeProperty('--survey-panel-top');
      surveyPanelEl.style.transform='none';
      lastSurveyPanelTop=null;
      if(anchorRect){
        surveyPanelEl.style.left=`${anchorRect.left}px`;
        surveyPanelEl.style.top=`${anchorRect.bottom+8}px`;
      }
    }
  }
  function showSurveyPanel(){
    const btn=$('btnSurvey');
    if(mobilePanelQuery.matches && btn && typeof btn.scrollIntoView==='function'){
      btn.scrollIntoView({ behavior:'smooth', block:'nearest', inline:'center' });
    }
    surveyPanelEl.style.display='block';
    positionSurveyPanel({force:true});
  }
  surveyCapSelect.innerHTML='';
  const noneOpt=document.createElement('option'); noneOpt.value=''; noneOpt.textContent='ÈÅ∏Êäû„Åó„Å™„ÅÑ'; surveyCapSelect.appendChild(noneOpt);
  CAP_TAGS.forEach(tag=>{ const opt=document.createElement('option'); opt.value=tag; opt.textContent=tag; surveyCapSelect.appendChild(opt); });
  const surveyButtons={
    start:$('surveyStartBtn'),
    addHere:$('surveyAddHereBtn'),
    addManual:$('surveyAddManualBtn'),
    edit:$('surveyEditBtn'),
    toggleLabel:$('surveyToggleLabelBtn'),
    pause:$('surveyPauseBtn'),
    finish:$('surveyFinishBtn')
  };
  updateCapButtonText();

  const toJst=(ts)=>{
    const pad=n=>String(n).padStart(2,'0');
    const jst=new Date(ts + 9*60*60*1000);
    const y=jst.getUTCFullYear();
    const m=pad(jst.getUTCMonth()+1);
    const d=pad(jst.getUTCDate());
    const hh=pad(jst.getUTCHours());
    const mm=pad(jst.getUTCMinutes());
    const ss=pad(jst.getUTCSeconds());
    return { timeJst:`${y}-${m}-${d} ${hh}:${mm}:${ss}`, timeIso:`${y}-${m}-${d}T${hh}:${mm}:${ss}+09:00` };
  };
  const formatJstForFilename=(ts)=>{
    const pad=n=>String(n).padStart(2,'0');
    const jst=new Date(ts + 9*60*60*1000);
    const y=jst.getUTCFullYear();
    const m=pad(jst.getUTCMonth()+1);
    const d=pad(jst.getUTCDate());
    const hh=pad(jst.getUTCHours());
    const mm=pad(jst.getUTCMinutes());
    const ss=pad(jst.getUTCSeconds());
    return `${y}${m}${d}${hh}${mm}${ss}`;
  };
  const createBlankSurveyNote=({lon,lat,position=null})=>{
    const hasTimestamp=position && typeof position.timestamp==='number' && Number.isFinite(position.timestamp);
    const baseTs=hasTimestamp ? position.timestamp : Date.now();
    const {timeJst,timeIso}=toJst(baseTs);
    const altitude=position?.coords?.altitude;
    const ele=(typeof altitude==='number' && Number.isFinite(altitude))?Number(altitude):null;
    return {
      id:'note-'+Date.now(),
      lon,
      lat,
      text1:'',
      text2:'',
      capTag:'',
      labelText:'',
      ele,
      timeJst,
      timeIso
    };
  };
  const buildNoteLabel=(note)=>{
    const lines=[];
    if(note.text1) lines.push(note.text1);
    if(note.text2) lines.push(note.text2);
    if(note.capTag) lines.push(`[${note.capTag}]`);
    return lines.join('\n');
  };
  function loadStoredSurveyNotes(){
    if(!window.localStorage) return [];
    try{
      const raw=localStorage.getItem(STORAGE_KEYS.surveyNotes);
      if(!raw) return [];
      const parsed=JSON.parse(raw);
      if(Array.isArray(parsed)){
        return parsed.map(n=>{
          const rawEle=typeof n.ele==='string'?n.ele.trim():n.ele;
          const eleValue=(rawEle!==undefined && rawEle!==null && rawEle!=='') && Number.isFinite(Number(rawEle)) ? Number(rawEle) : null;
          return {
            id:n.id||('note-'+Date.now()+Math.random().toString(36).slice(2)),
            lon:Number(n.lon),
            lat:Number(n.lat),
            text1:n.text1||'',
            text2:n.text2||'',
            capTag:n.capTag||'',
            labelText:n.labelText || buildNoteLabel(n),
            ele:eleValue,
            timeIso:typeof n.timeIso==='string' ? n.timeIso : '',
            timeJst:typeof n.timeJst==='string' ? n.timeJst : ''
          };
        }).map(n=>{
          if(!n.timeIso || !n.timeJst){
            const fallback=toJst(Date.now());
            n.timeIso=n.timeIso||fallback.timeIso;
            n.timeJst=n.timeJst||fallback.timeJst;
          }
          return n;
        });
      }
    }catch(err){ console.warn('loadStoredSurveyNotes', err); }
    return [];
  }
  function saveSurveyNotesToStorage(notes){
    if(!window.localStorage) return;
    try{
      localStorage.setItem(STORAGE_KEYS.surveyNotes, JSON.stringify(notes));
    }catch(err){ console.warn('saveSurveyNotesToStorage', err); }
  }
  const storedSurveyNotes=loadStoredSurveyNotes();
  if(storedSurveyNotes.length){
    surveyState.notes=storedSurveyNotes;
    saveSurveyNotesToStorage(surveyState.notes);
  }
  function updateCapButtonText(){
    const val=surveyCapSelect.value;
    surveyCapBtn.textContent = val ? `CAP„Çø„Ç∞: ${val}` : 'CAP„Çø„Ç∞';
  }
  function updateSurveyRecIndicator(){
    if(!surveyRecBadge) return;
    if(!surveyState.recording){
      surveyRecBadge.style.display='none';
      surveyRecBadge.classList.remove('recBlink','paused');
      return;
    }
    surveyRecBadge.style.display='inline-flex';
    if(surveyState.paused){
      surveyRecBadge.textContent='‚è∏';
      surveyRecBadge.classList.remove('recBlink');
      surveyRecBadge.classList.add('paused');
    }else{
      surveyRecBadge.textContent='REC';
      surveyRecBadge.classList.add('recBlink');
      surveyRecBadge.classList.remove('paused');
    }
  }
  function updateSurveyStatus(){
    const parts=[];
    parts.push(surveyState.recording ? (surveyState.paused?'Ë®òÈå≤‰∏ÄÊôÇÂÅúÊ≠¢':'Ë®òÈå≤‰∏≠') : 'ÂÅúÊ≠¢‰∏≠');
    parts.push(`„Éù„Ç§„É≥„Éà: ${surveyState.trackPoints.length}`);
    parts.push(`Ë∑ùÈõ¢: ${surveyState.totalDistance.toFixed(1)} m`);
    parts.push(`„É°„É¢: ${surveyState.notes.length}`);
    surveyStatusEl.textContent=parts.join(' / ');
    surveyButtons.pause.disabled=!surveyState.recording;
    surveyButtons.pause.textContent=surveyState.paused?'ÂÜçÈñã ‚è∏Ô∏è‰∏ÄÊôÇÂÅúÊ≠¢‰∏≠':'‰∏ÄÊôÇÂÅúÊ≠¢';
    updateSurveyRecIndicator();
  }
  function updateSurveyTrackSource(){
    const src=map.getSource('survey-track'); if(!src) return;
    const features=[];
    if(surveyState.trackPoints.length>=2){
      features.push({type:'Feature',properties:{kind:'line'},geometry:{type:'LineString',coordinates:surveyState.trackPoints.map(p=>[p.lon,p.lat])}});
    }
    surveyState.trackPoints.forEach(p=>{
      features.push({type:'Feature',properties:{kind:'point',time:p.timeJst,distance:p.distance},geometry:{type:'Point',coordinates:[p.lon,p.lat]}});
    });
    src.setData({type:'FeatureCollection',features});
  }
  function updateSurveyNotesSource(){
    const src=map.getSource('survey-notes'); if(!src) return;
    const features=surveyState.notes.map(n=>({
      type:'Feature',
      properties:{ id:n.id, labelText:n.labelText, text1:n.text1, text2:n.text2, capTag:n.capTag },
      geometry:{ type:'Point', coordinates:[n.lon,n.lat] }
    }));
    src.setData({type:'FeatureCollection',features});
    if(map.getLayer('survey-notes-label')){
      map.setLayoutProperty('survey-notes-label','visibility', (surveyState.labelsVisible && features.length)?'visible':'none');
    }
  }
  function resetSurveyData(){
    surveyState.trackPoints=[];
    surveyState.notes=[];
    surveyState.totalDistance=0;
    surveyState.lastRecordTs=0;
    surveyState.recordStartTs=null;
    surveyState.recordStartJst='';
    surveyState.recordStartIso='';
    surveyState.awaitingMove=false;
    surveyState.movingNote=null;
    surveyState.manualMode=false;
    surveyNoteContext={note:null,isNew:false};
    surveyButtons.addManual.classList.remove('toggle-active');
    updateSurveyTrackSource();
    updateSurveyNotesSource();
    updateSurveyStatus();
    saveSurveyNotesToStorage(surveyState.notes);
    if(typeof updateMapCursor==='function') updateMapCursor();
    if(window.__surveyNotePopup){ window.__surveyNotePopup.remove(); window.__surveyNotePopup=null; }
  }
  function ensureSurveyWatch(){
    if(!navigator.geolocation){ toast('‰ΩçÁΩÆÊÉÖÂ†±„Åå‰Ωø„Åà„Åæ„Åõ„Çì',true); return false; }
    if(surveyState.watchId) return true;
    surveyState.watchId = navigator.geolocation.watchPosition(handleSurveyPosition, err=>toast('‰ΩçÁΩÆÊÉÖÂ†±„Ç®„É©„Éº: '+err.message,true), {enableHighAccuracy:true,maximumAge:1000,timeout:10000});
    return true;
  }
  function handleSurveyPosition(pos){
    surveyState.currentPosition=pos;
    if(!surveyState.recording || surveyState.paused) return;
    const now=Date.now();
    if(surveyState.trackPoints.length>0 && now - surveyState.lastRecordTs < 5000) return;
    surveyState.lastRecordTs=now;
    addTrackPoint(pos);
  }
  function addTrackPoint(pos){
    const {longitude:lon, latitude:lat, altitude} = pos.coords;
    const ts=pos.timestamp||Date.now();
    const {timeJst,timeIso}=toJst(ts);
    if(!surveyState.recordStartTs){
      surveyState.recordStartTs=ts;
      surveyState.recordStartJst=timeJst;
      surveyState.recordStartIso=timeIso;
    }
    const point={ id:'trk-'+ts, lon, lat, ele:altitude ?? 0, timeJst, timeIso, distance:0 };
    if(surveyState.trackPoints.length){
      const last=surveyState.trackPoints[surveyState.trackPoints.length-1];
      const dist=turf.distance([last.lon,last.lat],[lon,lat],{units:'kilometers'})*1000;
      surveyState.totalDistance+=dist;
      point.distance=Number(surveyState.totalDistance.toFixed(1));
    }else{
      surveyState.totalDistance=0;
      point.distance=0;
    }
    surveyState.trackPoints.push(point);
    updateSurveyTrackSource();
    updateSurveyStatus();
  }
  function openSurveyNoteForm(note,{isNew=false}={}){
    surveyNoteContext={note,isNew};
    $('surveyNoteLine1').value=note.text1||'';
    $('surveyNoteLine2').value=note.text2||'';
    surveyCapSelect.value=note.capTag||'';
    updateCapButtonText();
    surveyCapWrap.style.display='none';
    surveyNoteMoveWrap.style.display=isNew?'none':'';
    showFloatingPanel(surveyNotePanelEl);
  }
  function finalizeSurveyNote(apply){
    const ctx=surveyNoteContext;
    if(!ctx.note){ surveyNotePanelEl.style.display='none'; return; }
    if(apply){
      ctx.note.text1=$('surveyNoteLine1').value.trim();
      ctx.note.text2=$('surveyNoteLine2').value.trim();
      ctx.note.capTag=surveyCapSelect.value||'';
      ctx.note.labelText=buildNoteLabel(ctx.note);
      if(ctx.isNew){
        ctx.note.id=ctx.note.id || ('note-'+Date.now());
        surveyState.notes.push(ctx.note);
      }
      updateSurveyNotesSource();
      updateSurveyStatus();
      saveSurveyNotesToStorage(surveyState.notes);
      if(window.__surveyNotePopup){ window.__surveyNotePopup.remove(); window.__surveyNotePopup=null; }
    }
    surveyNoteContext={note:null,isNew:false};
    surveyNotePanelEl.style.display='none';
  }
  function beginMoveNote(){
    if(!surveyNoteContext.note) return;
    surveyNoteContext.note.text1=$('surveyNoteLine1').value.trim();
    surveyNoteContext.note.text2=$('surveyNoteLine2').value.trim();
    surveyNoteContext.note.capTag=surveyCapSelect.value||'';
    surveyNoteContext.note.labelText=buildNoteLabel(surveyNoteContext.note);
    surveyState.awaitingMove=true;
    surveyState.movingNote=surveyNoteContext.note;
    surveyNoteContext={note:null,isNew:false};
    surveyNotePanelEl.style.display='none';
    toast('Êñ∞„Åó„ÅÑ‰ΩçÁΩÆ„ÇíÂú∞Âõ≥‰∏ä„Åß„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
    if(typeof updateMapCursor==='function') updateMapCursor();
  }
  function handleSurveyMapClick(e){
    if(surveyState.awaitingMove && surveyState.movingNote){
      surveyState.movingNote.lon=e.lngLat.lng;
      surveyState.movingNote.lat=e.lngLat.lat;
      surveyState.movingNote.labelText=buildNoteLabel(surveyState.movingNote);
      surveyState.awaitingMove=false;
      surveyState.movingNote=null;
      updateSurveyNotesSource();
      toast('‰ΩçÁΩÆ„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü');
      updateSurveyStatus();
      saveSurveyNotesToStorage(surveyState.notes);
      if(window.__surveyNotePopup){ window.__surveyNotePopup.remove(); window.__surveyNotePopup=null; }
      if(typeof updateMapCursor==='function') updateMapCursor();
      return true;
    }
    if(surveyState.manualMode){
      surveyState.manualMode=false;
      surveyButtons.addManual.classList.remove('toggle-active');
      const note=createBlankSurveyNote({ lon:e.lngLat.lng, lat:e.lngLat.lat });
      openSurveyNoteForm(note,{isNew:true});
      if(window.__surveyNotePopup){ window.__surveyNotePopup.remove(); window.__surveyNotePopup=null; }
      if(typeof updateMapCursor==='function') updateMapCursor();
      return true;
    }
    return false;
  }
  function openSurveyFinishPrompt(){
    surveyFinishEl.innerHTML=`<div style="margin-bottom:8px">Ë®òÈå≤„ÇíÁµÇ‰∫Ü„Åó„Åæ„Åô„ÅãÔºü</div>
    <div class="row">
      <button class="btn" id="surveyFinishConfirm">ÁµÇ‰∫Ü</button>
      <button class="btn secondary" id="surveyFinishResume">ÂÜçÈñã</button>
    </div>`;
    surveyFinishEl.style.display='block';
    $('surveyFinishConfirm').onclick=()=>{
      surveyState.recording=false;
      surveyState.paused=false;
      updateSurveyStatus();
      surveyFinishEl.innerHTML=`<div style="margin-bottom:8px">Âá∫Âäõ„Éª‰øùÂ≠ò„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
      <div class="group">
        <div class="row">
          <button class="btn" id="surveyExportGpx">GPX„ÇíÂá∫Âäõ</button>
          <button class="btn secondary" id="surveySaveBtn">‰øùÂ≠ò</button>
        </div>
        <div class="row">
          <button class="btn danger" id="surveyDiscardBtn">Ë®òÈå≤„ÇíÁ†¥Ê£Ñ</button>
        </div>
      </div>`;
      $('surveyExportGpx').onclick=exportSurveyGpx;
      $('surveySaveBtn').onclick=saveSurveyData;
      $('surveyDiscardBtn').onclick=discardSurveyData;
    };
    $('surveyFinishResume').onclick=()=>{ surveyFinishEl.style.display='none'; };
  }
  function exportSurveyGpx(){
    if(!surveyState.trackPoints.length){ toast('Âá∫Âäõ„Åô„ÇãË®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì',true); return; }
    let gpx=`<?xml version="1.0" encoding="UTF-8"?>\n`;
    gpx+=`<gpx version="1.1" creator="PHN Field Collab" xmlns="http://www.topografix.com/GPX/1/1">\n`;
    gpx+=`  <trk>\n    <name>District Survey Track</name>\n    <trkseg>\n`;
    surveyState.trackPoints.forEach(p=>{
      const eleVal = (p.ele ?? 0);
      const distVal = Number.isFinite(p.distance) ? p.distance : 0;
      gpx+=`      <trkpt lat="${p.lat}" lon="${p.lon}"><ele>${eleVal}</ele><time>${escapeXml(p.timeIso)}</time>`;
      const exts=[];
      if(p.timeJst) exts.push(`<time_jst>${escapeXml(p.timeJst)}</time_jst>`);
      exts.push(`<distance_m>${escapeXml(distVal)}</distance_m>`);
      if(exts.length) gpx+=`<extensions>${exts.join('')}</extensions>`;
      gpx+='</trkpt>\n';
    });
    gpx+=`    </trkseg>\n  </trk>\n`;
    const noteFallbackTime=toJst(Date.now());
    surveyState.notes.forEach((n,idx)=>{
      const label1=n.text1||'';
      const label2=n.text2||'';
      const capTag=n.capTag||'';
      const waypointId=idx+1;
      const eleRaw=typeof n.ele==='number' ? n.ele : Number(n.ele);
      const eleVal=Number.isFinite(eleRaw) ? eleRaw : 0;
      const noteTimeIso=(n.timeIso && typeof n.timeIso==='string') ? n.timeIso : noteFallbackTime.timeIso;
      const noteTimeJst=(n.timeJst && typeof n.timeJst==='string') ? n.timeJst : noteFallbackTime.timeJst;
      const noteExt=[`<label1>${escapeXml(label1)}</label1>`,`<label2>${escapeXml(label2)}</label2>`];
      if(capTag) noteExt.push(`<capTag>${escapeXml(capTag)}</capTag>`);
      if(noteTimeJst) noteExt.push(`<time_jst>${escapeXml(noteTimeJst)}</time_jst>`);
      gpx+=`  <wpt lat="${n.lat}" lon="${n.lon}"><name></name><desc></desc><WayPoint_id>${escapeXml(waypointId)}</WayPoint_id><ele>${escapeXml(eleVal)}</ele><time>${escapeXml(noteTimeIso)}</time><extensions>${noteExt.join('')}</extensions></wpt>\n`;
    });
    gpx+='</gpx>';
    const blob=new Blob([gpx],{type:'application/gpx+xml'});
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob);
    let fileNameTs=surveyState.recordStartTs;
    if(!fileNameTs && surveyState.recordStartIso){
      const parsed=Date.parse(surveyState.recordStartIso);
      if(!Number.isNaN(parsed)) fileNameTs=parsed;
    }
    if(!fileNameTs && surveyState.trackPoints.length){
      const parsed=Date.parse(surveyState.trackPoints[0].timeIso);
      if(!Number.isNaN(parsed)) fileNameTs=parsed;
    }
    if(!fileNameTs) fileNameTs=Date.now();
    const fileNameBase=formatJstForFilename(fileNameTs);
    a.download=`${fileNameBase}_phn_field_collab.gpx`;
    a.click();
    surveyFinishEl.style.display='none';
    toast('GPX„ÇíÂá∫Âäõ„Åó„Åæ„Åó„Åü');
  }
  async function saveSurveyData(){
    if(!surveyState.trackPoints.length && !surveyState.notes.length){ toast('‰øùÂ≠ò„Åô„ÇãË®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì',true); return; }
    try{
      const payload={ track:surveyState.trackPoints, notes:surveyState.notes };
      const { error } = await __supa.from('district_surveys').insert({ room:__room, payload });
      if(error) throw error;
      toast('‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
    }catch(err){ toast('‰øùÂ≠ò„Å´Â§±Êïó: '+err.message,true); }
    surveyFinishEl.style.display='none';
  }
  function discardSurveyData(){
    surveyState.recording=false;
    surveyState.paused=false;
    resetSurveyData();
    surveyFinishEl.style.display='none';
    toast('Ë®òÈå≤„ÇíÁ†¥Ê£Ñ„Åó„Åæ„Åó„Åü');
  }

  $('btnSurvey').addEventListener('click',()=>{
    surveyState.panelVisible=!surveyState.panelVisible;
    $('btnSurvey').classList.toggle('toggle-on',surveyState.panelVisible);
    if(surveyState.panelVisible){
      showSurveyPanel();
      surveyFinishEl.style.display='none';
      ensureSurveyWatch();
    }else{
      surveyPanelEl.style.display='none';
      surveyPanelEl.classList.remove('mobile-pop');
      surveyPanelEl.style.removeProperty('--survey-panel-top');
      lastSurveyPanelTop=null;
      surveyFinishEl.style.display='none';
      surveyState.manualMode=false;
      surveyButtons.addManual.classList.remove('toggle-active');
      surveyState.editMode=false;
      surveyButtons.edit.classList.remove('toggle-active');
      surveyState.awaitingMove=false;
      surveyState.movingNote=null;
      if(typeof updateMapCursor==='function') updateMapCursor();
      if(window.__surveyNotePopup){ window.__surveyNotePopup.remove(); window.__surveyNotePopup=null; }
    }
  });
  surveyButtons.start.addEventListener('click',()=>{
    resetSurveyData();
    if(!ensureSurveyWatch()) return;
    const startTs=Date.now();
    const {timeJst:recordStartJst,timeIso:recordStartIso}=toJst(startTs);
    surveyState.recordStartTs=startTs;
    surveyState.recordStartJst=recordStartJst;
    surveyState.recordStartIso=recordStartIso;
    surveyState.recording=true;
    surveyState.paused=false;
    toast('Ë®òÈå≤„ÇíÈñãÂßã„Åó„Åæ„Åó„Åü');
    surveyFinishEl.style.display='none';
    updateSurveyStatus();
    geoControl.trigger();
  });
  surveyButtons.addHere.addEventListener('click',()=>{
    if(!surveyState.currentPosition){ toast('ÁèæÂú®Âú∞„ÅåÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì',true); ensureSurveyWatch(); return; }
    const { longitude:lon, latitude:lat } = surveyState.currentPosition.coords;
    const note=createBlankSurveyNote({ lon, lat, position:surveyState.currentPosition });
    openSurveyNoteForm(note,{isNew:true});
  });
  surveyButtons.addManual.addEventListener('click',()=>{
    surveyState.manualMode=!surveyState.manualMode;
    surveyButtons.addManual.classList.toggle('toggle-active',surveyState.manualMode);
    if(surveyState.manualMode){ toast('ËøΩÂä†„Åô„Çã‰ΩçÁΩÆ„ÇíÂú∞Âõ≥‰∏ä„Åß„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); surveyState.awaitingMove=false; }
    if(typeof updateMapCursor==='function') updateMapCursor();
    if(window.__surveyNotePopup){ window.__surveyNotePopup.remove(); window.__surveyNotePopup=null; }
  });
  surveyButtons.edit.addEventListener('click',()=>{
    surveyState.editMode=!surveyState.editMode;
    surveyButtons.edit.classList.toggle('toggle-active',surveyState.editMode);
    toast(surveyState.editMode?'‰øÆÊ≠£„É¢„Éº„ÉâÔºö„É°„É¢„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶Á∑®ÈõÜ':'‰øÆÊ≠£„É¢„Éº„Éâ„ÇíÁµÇ‰∫Ü„Åó„Åæ„Åó„Åü');
    if(!surveyState.editMode){ surveyState.awaitingMove=false; surveyState.movingNote=null; }
    if(window.__surveyNotePopup){ window.__surveyNotePopup.remove(); window.__surveyNotePopup=null; }
  });
  surveyButtons.toggleLabel.addEventListener('click',()=>{
    surveyState.labelsVisible=!surveyState.labelsVisible;
    updateSurveyNotesSource();
    surveyButtons.toggleLabel.textContent=surveyState.labelsVisible?'„É©„Éô„É´ÈùûË°®Á§∫':'„É©„Éô„É´Ë°®Á§∫';
  });
  surveyButtons.pause.addEventListener('click',()=>{
    if(!surveyState.recording) { toast('Ë®òÈå≤ÈñãÂßãÂæå„Å´‰∏ÄÊôÇÂÅúÊ≠¢„Åß„Åç„Åæ„Åô',true); return; }
    surveyState.paused=!surveyState.paused;
    toast(surveyState.paused?'Ë®òÈå≤„Çí‰∏ÄÊôÇÂÅúÊ≠¢„Åó„Åæ„Åó„Åü':'Ë®òÈå≤„ÇíÂÜçÈñã„Åó„Åæ„Åó„Åü');
    updateSurveyStatus();
  });
  surveyButtons.finish.addEventListener('click',openSurveyFinishPrompt);
  surveyCapBtn.addEventListener('click',()=>{
    surveyCapWrap.style.display = surveyCapWrap.style.display==='none' ? '' : 'none';
  });
  surveyCapSelect.addEventListener('change',updateCapButtonText);
  $('surveyNoteConfirm').addEventListener('click',()=>finalizeSurveyNote(true));
  $('surveyNoteCancel').addEventListener('click',()=>finalizeSurveyNote(false));
  $('surveyNoteMoveBtn').addEventListener('click',beginMoveNote);
  updateSurveyStatus();


function updateLayerVisibility(){
  // ÂåªÁôÇÊ©üÈñ¢
const medVis = $('chkMedical')?.checked ? 'visible' : 'none';
if (map.getLayer(MEDICAL_LAYER_POINT)) map.setLayoutProperty(MEDICAL_LAYER_POINT, 'visibility', medVis);
// „É©„Éô„É´„ÅØ„Äå„É©„Éô„É´„ÄçË®≠ÂÆö„ÅåÊúâÂäπ„Å™Â†¥Âêà„ÅÆ„ÅøË°®Á§∫„Åó„Åü„ÅÑ„Å™„Çâ„ÄÅÊó¢Â≠ò„ÅÆ layerLabelFields.medical „Çí‰Ωø„ÅÜ
const medLabelVis = (medVis==='visible' && (layerLabelFields.medical ?? 'P04_002_ja')) ? 'visible' : 'visible';
if (map.getLayer(MEDICAL_LAYER_LABEL)) map.setLayoutProperty(MEDICAL_LAYER_LABEL, 'visibility', medLabelVis);

  const ev = $('chkEmergency').checked ? 'visible' : 'none';
  const sv = $('chkShelter').checked  ? 'visible' : 'none';
  const mv = $('chkMedical')?.checked ? 'visible' : 'none';
  if(map.getLayer('emg-circle'))  map.setLayoutProperty('emg-circle','visibility', ev);
  if(map.getLayer('shel-circle')) map.setLayoutProperty('shel-circle','visibility', sv);
  if(map.getLayer(MEDICAL_LAYER_POINT)) map.setLayoutProperty(MEDICAL_LAYER_POINT,'visibility', mv||'none');
  const evLabel = (ev==='visible' && layerLabelFields.emergency) ? 'visible' : 'none';
  const svLabel = (sv==='visible' && layerLabelFields.shelter) ? 'visible' : 'none';
  const mvLabel = (mv==='visible' && layerLabelFields.medical) ? 'visible' : 'none';
  if(map.getLayer('emg-label'))   map.setLayoutProperty('emg-label','visibility', evLabel);
  if(map.getLayer('shel-label'))  map.setLayoutProperty('shel-label','visibility', svLabel);
  if(map.getLayer(MEDICAL_LAYER_LABEL)) map.setLayoutProperty(MEDICAL_LAYER_LABEL,'visibility', mvLabel||'none');
}

  function computeFeatureBounds(features){
    let minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity;
    (features||[]).forEach(f=>{
      const geom=f?.geometry;
      if(!geom || geom.type!=='Point') return;
      const coords=Array.isArray(geom.coordinates)?geom.coordinates:[];
      if(coords.length<2) return;
      const x=Number(coords[0]);
      const y=Number(coords[1]);
      if(!Number.isFinite(x)||!Number.isFinite(y)) return;
      if(x<minX) minX=x;
      if(y<minY) minY=y;
      if(x>maxX) maxX=x;
      if(y>maxY) maxY=y;
    });
    if(minX===Infinity || minY===Infinity || maxX===-Infinity || maxY===-Infinity) return null;
    if(minX===maxX && minY===maxY) return [[minX,minY],[maxX,maxY]];
    return [[minX,minY],[maxX,maxY]];
  }
  function fitToFeatures(features){
    const bounds=computeFeatureBounds(features);
    if(bounds && bounds[0] && bounds[1] && map?.fitBounds){
      map.fitBounds(bounds,{padding:40,maxZoom:13});
    }
    return bounds;
  }
  function cloneScope(src){
    return { mode:src.mode, prefs:[...src.prefs], munis:[...src.munis] };
  }
  function getScopeFor(layer){
    return layerScopeOverrides[layer] ? cloneScope(layerScopeOverrides[layer]) : cloneScope(layerScopeGlobal);
  }
  function filterByScope(scope, feature){
    if(!COL_MUNI) return true;
    const fullName = String(feature.properties?.[COL_MUNI]||'');
    if(scope.mode==='all') return true;
    const {pref,city}=splitPrefCityLabel(fullName);
    if(scope.mode==='pref'){
      if(scope.prefs.length===0) return true;
      return scope.prefs.includes(pref);
    }
    if(scope.mode==='muni'){
      if(scope.munis.length>0) return scope.munis.includes(`${pref} ${city}`);
      if(scope.prefs.length>0) return scope.prefs.includes(pref);
      return true;
    }
    return true;
  }
  function decorateFeature(f,labelField){
    const props={...(f.properties||{})};
    props.__label__ = labelField ? String(props[labelField]??'') : '';
    return {...f,properties:props};
  }
  const EMPTY_FC={type:'FeatureCollection',features:[]};
  function normalizeScope(scope){
    const mode=scope?.mode||'all';
    const prefs=Array.isArray(scope?.prefs)?Array.from(new Set(scope.prefs.filter(Boolean))).sort((a,b)=>a.localeCompare(b,'ja')):[];
    const rawMunis=Array.isArray(scope?.munis)?scope.munis.filter(Boolean):[];
    const muniMap=new Map();
    rawMunis.forEach(label=>{
      const canonical=canonicalMuniLabel(label);
      if(!canonical || muniMap.has(canonical)) return;
      const entry=getMunicipalEntry(label);
      muniMap.set(canonical,{ label:canonical, pref:entry.pref, city:entry.city, code:entry.code||'' });
    });
    const muniEntries=Array.from(muniMap.values()).sort((a,b)=>a.label.localeCompare(b.label,'ja'));
    const munis=muniEntries.map(entry=>entry.label);
    const prefSet=new Set(prefs);
    muniEntries.forEach(entry=>{ if(entry.pref) prefSet.add(entry.pref); });
    const prefNames=Array.from(prefSet).sort((a,b)=>a.localeCompare(b,'ja'));
    const prefCodes=prefNames.map(name=>PREF_CODE_MAP[name]).filter(Boolean);
    const prefCodeNums=prefCodes.map(code=>Number(code)).filter(num=>Number.isFinite(num));
    const muniNames=Array.from(new Set(muniEntries.map(entry=>entry.city).filter(Boolean))).sort((a,b)=>a.localeCompare(b,'ja'));
    const muniCodes=Array.from(new Set(muniEntries.map(entry=>entry.code).filter(Boolean)));
    const muniCodeNums=Array.from(new Set(muniEntries.map(entry=>{
      const digits=entry.code && entry.code.trim?entry.code.trim():entry.code;
      const num=Number(digits);
      return Number.isFinite(num)?num:null;
    }).filter(num=>num!==null)));
    const municipalities=muniEntries.map(entry=>({ pref:entry.pref, city:entry.city, code:entry.code||'' }));
    return { mode, prefs, munis, prefNames, prefCodes, prefCodeNums, muniNames, muniCodes, muniCodeNums, municipalities };
  }
  function scopeKey(scope){
    return JSON.stringify(normalizeScope(scope));
  }

  function applyMedicalData(fc,{updateStatus=false}={}){
    if(!map.getSource(MEDICAL_SOURCE_ID)){
      lastMedicalFeatures=[];
      return [];
    }
    const feats=Array.isArray(fc?.features)?fc.features:[];
    const cols=new Set(layerColumns.medical);
    feats.forEach(f=>Object.keys(f?.properties||{}).forEach(k=>cols.add(k)));
    layerColumns.medical=Array.from(cols).sort((a,b)=>a.localeCompare(b,'ja'));
    if(layerLabelFields.medical && !layerColumns.medical.includes(layerLabelFields.medical)){
      layerLabelFields.medical=null;
    }
    if(!layerLabelFields.medical && layerColumns.medical.includes(DEFAULT_MED_LABEL)){
      layerLabelFields.medical=DEFAULT_MED_LABEL;
    }
    const labelField=layerLabelFields.medical;
    const decorated=feats.map(f=>decorateFeature(f,labelField));
    lastMedicalFeatures=decorated;
    map.getSource(MEDICAL_SOURCE_ID).setData({type:'FeatureCollection',features:decorated});
    if(updateStatus){
      const count=feats.length||0;
      setMedicalStatus(`Ë°®Á§∫‰ª∂Êï∞: ${count.toLocaleString()}‰ª∂`);
    }
    return decorated;
  }

  const toFiniteNumber=(value)=>{
    if(typeof value==='number') return Number.isFinite(value)?value:NaN;
    if(typeof value==='string'){
      const trimmed=value.trim();
      if(!trimmed) return NaN;
      const num=Number(trimmed);
      return Number.isFinite(num)?num:NaN;
    }
    return NaN;
  };
  const normalizeMedicalCoordinate=(coords)=>{
    if(!Array.isArray(coords) || coords.length<2) return null;
    const lon=toFiniteNumber(coords[0]);
    const lat=toFiniteNumber(coords[1]);
    if(!Number.isFinite(lon) || !Number.isFinite(lat)) return null;
    return [lon,lat];
  };
  const normalizeMedicalFeature=(feature)=>{
    if(!feature || typeof feature!=='object') return null;
    const geom=feature.geometry;
    if(!geom) return null;
    if(geom.type==='Point'){
      const coords=normalizeMedicalCoordinate(geom.coordinates);
      if(!coords) return null;
      const props=(feature.properties && typeof feature.properties==='object' && !Array.isArray(feature.properties))?feature.properties:{};
      return {...feature,geometry:{type:'Point',coordinates:coords},properties:props};
    }
    if(geom.type==='MultiPoint'){
      const list=Array.isArray(geom.coordinates)?geom.coordinates:[];
      for(const item of list){
        const coords=normalizeMedicalCoordinate(item);
        if(coords){
          const props=(feature.properties && typeof feature.properties==='object' && !Array.isArray(feature.properties))?feature.properties:{};
          return {...feature,geometry:{type:'Point',coordinates:coords},properties:props};
        }
      }
    }
    return null;
  };
  function normalizeMedicalResponse(data){
    let fc=null;
    if(data?.type==='FeatureCollection') fc=data;
    else if(data?.data?.type==='FeatureCollection') fc=data.data;
    else if(Array.isArray(data?.features)) fc={type:'FeatureCollection',features:data.features};
    else if(Array.isArray(data)) fc={type:'FeatureCollection',features:data};
    if(!fc) fc={...EMPTY_FC};
    const features=Array.isArray(fc.features)?fc.features:[];
    const normalized=[];
    features.forEach(feat=>{
      const norm=normalizeMedicalFeature(feat);
      if(norm) normalized.push(norm);
    });
    return {type:'FeatureCollection',features:normalized};
  }

      let fc=null;
      if(window.__supa?.functions?.invoke){
        try{
          fc=await tryInvoke();
        }catch(err){
          if(err.name==='AbortError') throw err;
          console.warn('[medical] invoke failed ->', err);
        }
      }
      if(!fc){
        fc={...EMPTY_FC};
      }
      medicalCache.set(key,fc);
      return fc;
    }catch(err){
      if(err.name==='AbortError'){
        return null;
      }
      console.warn('[medical] fetch failed ->', err);
      const msg=String(err.message||'');
      if(msg.includes('401')||msg.includes('403')){
        setMedicalStatus('ÂåªÁôÇÊ©üÈñ¢„Éá„Éº„Çø„Å∏„ÅÆ„Ç¢„ÇØ„Çª„Çπ„ÅåÊãíÂê¶„Åï„Çå„Åæ„Åó„Åü',{error:true});
        return null;
      }else{
        if(err.name==='TypeError'){
          setMedicalStatus('ÈÄö‰ø°„Ç®„É©„ÉºÔºöÂåªÁôÇÊ©üÈñ¢„Éá„Éº„Çø„ÇíÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì',{error:true});
        }else{
          setMedicalStatus('Ë™≠Ëæº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü',{error:true});
        }
      }
      return null;
    }finally{
      if(medicalAbortController===controller){
        medicalAbortController=null;
      }
    }
  }

  async function refreshMedicalLayer(){
    if(!map.getSource(MEDICAL_SOURCE_ID)){
      lastMedicalFeatures=[];
      return [];
    }
    const scope=getScopeFor('medical');
    const key=scopeKey(scope);
    const shouldLoad=$('chkMedical')?.checked;
    if(!shouldLoad){
      if(medicalAbortController){
        medicalAbortController.abort();
      }
      setMedicalStatus('');
      lastMedicalFeatures=[];
      map.getSource(MEDICAL_SOURCE_ID).setData(EMPTY_FC);
      return [];
    }
    let fc=medicalCache.get(key);
    const needsFetch=!fc || currentMedicalKey!==key;
    if(needsFetch){
      fc=await fetchMedicalData(scope,key);
      if(fc===null){
        if(!medicalCache.has(key)){
          lastMedicalFeatures=[];
        }
        return [];
      }
      currentMedicalKey=key;
    }
    const decorated=applyMedicalData(fc,{updateStatus:true});
    return Array.isArray(decorated)?decorated:[];
  }

  async function refreshLayers(showToast=false){
    try{
      const featuresForFit=[];
      if(cacheEmergency && map.getSource('emergency')){
        const scopeE=getScopeFor('emergency');
        const emgFiltered=(cacheEmergency||[]).filter(f=>filterByScope(scopeE,f)).map(f=>decorateFeature(f,layerLabelFields.emergency));
        map.getSource('emergency').setData({type:'FeatureCollection',features:emgFiltered});
        if(emgFiltered.length) featuresForFit.push(...emgFiltered);
      }
      if(cacheShelter && map.getSource('shelter')){
        const scopeS=getScopeFor('shelter');
        const shlFiltered=(cacheShelter||[]).filter(f=>filterByScope(scopeS,f)).map(f=>decorateFeature(f,layerLabelFields.shelter));
        map.getSource('shelter').setData({type:'FeatureCollection',features:shlFiltered});
        if(shlFiltered.length) featuresForFit.push(...shlFiltered);
      }
      const medicalFeatures=await refreshMedicalLayer();
      if(Array.isArray(medicalFeatures) && medicalFeatures.length){
        featuresForFit.push(...medicalFeatures);
      }
      updateLayerVisibility();
      const bounds=fitToFeatures(featuresForFit);
      if(showToast) toast('Ë°®Á§∫ÁØÑÂõ≤„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü');
      return bounds;
    }catch(err){
      console.error('refreshLayers',err);
      toast('„É¨„Ç§„É§„Éº„ÅÆÊõ¥Êñ∞„Å´Â§±Êïó: '+err.message,true);
      return null;
    }
  }

  if(window.__supa?.auth?.onAuthStateChange){
    window.__supa.auth.onAuthStateChange((event,session)=>{
      const token=session?.access_token || null;
      if(!token || event==='SIGNED_OUT'){
        medicalCache.clear();
        currentMedicalKey=null;
        layerColumns.medical=[];
        layerLabelFields.medical=DEFAULT_MED_LABEL;
        lastMedicalFeatures=[];
        if(map && map.getSource && map.getSource(MEDICAL_SOURCE_ID)){
          map.getSource(MEDICAL_SOURCE_ID).setData(EMPTY_FC);
        }
        if($('chkMedical')?.checked){
          refreshMedicalLayer();
        }else{
          setMedicalStatus('');
        }
      }else if(token && (event==='SIGNED_IN' || event==='TOKEN_REFRESHED' || event==='USER_UPDATED')){
        medicalCache.clear();
        currentMedicalKey=null;
        lastMedicalFeatures=[];
        if($('chkMedical')?.checked){
          refreshMedicalLayer();
        }
      }
    });
  }

  function hideSuggest(){ $('suggest').style.display='none'; $('suggest').innerHTML=''; }
  function updateSuggest(query){
    const q=String(query||'').trim();
    const chosenPrefs=new Set(Array.from($('prefSelect').selectedOptions).map(o=>o.value));
    const src=(chosenPrefs.size===0)?window.__allMunicipalLabels:window.__allMunicipalLabels.filter(lbl=>{
      const {pref}=splitPrefCityLabel(lbl);
      return pref?chosenPrefs.has(pref):false;
    });
    if(!q){hideSuggest();return;}
    const hits=src.filter(lbl=>lbl.includes(q)).slice(0,5);
    if(hits.length===0){hideSuggest();return;}
    $('suggest').innerHTML=hits.map(h=>`<div class="suggest-item" data-v="${h}">${h}</div>`).join("");
    $('suggest').style.display='block';
    Array.from($('suggest').children).forEach(div=>{
      div.addEventListener('click',()=>{
        const val=div.getAttribute('data-v');
        const opt=Array.from($('muniSelect').options).find(o=>o.value===val);
        if(opt){opt.selected=true;}
        $('qMuni').value=''; hideSuggest();
      });
    });
  }

  async function initFGB(){
    // „ÇΩ„Éº„Çπ/„É¨„Ç§„É§
    if(!map.getSource('emergency')) map.addSource('emergency',{type:'geojson',data:{type:'FeatureCollection',features:[]}});
    if(!map.getSource('shelter'))   map.addSource('shelter',  {type:'geojson',data:{type:'FeatureCollection',features:[]}});
    if(!map.getLayer('emg-circle')) map.addLayer({id:'emg-circle',type:'circle',source:'emergency',layout:{ visibility:'none' },paint:{'circle-radius':5,'circle-color':'#e23b3b','circle-stroke-color':'#fff','circle-stroke-width':1}});
    if(!map.getLayer('shel-circle')) map.addLayer({id:'shel-circle',type:'circle',source:'shelter',layout:{ visibility:'none' },paint:{'circle-radius':5,'circle-color':'#2a7be4','circle-stroke-color':'#fff','circle-stroke-width':1}});
    if(!map.getSource(MEDICAL_SOURCE_ID)) map.addSource(MEDICAL_SOURCE_ID,{type:'geojson',data:{type:'FeatureCollection',features:[]}});
    if(!map.getLayer('emg-label'))   map.addLayer({id:'emg-label',type:'symbol',source:'emergency',layout:{ visibility:'none','text-field':['get','__label__'],'text-size':12,'text-offset':[0,1.2],'text-anchor':'top'},paint:{'text-halo-width':1.2,'text-halo-color':'#fff'}
});
    if(!map.getLayer('shel-label'))  map.addLayer({id:'shel-label',type:'symbol',source:'shelter',  layout:{ visibility:'none','text-field':['get','__label__'],'text-size':12,'text-offset':[0,1.2],'text-anchor':'top'},paint:{'text-halo-width':1.2,'text-halo-color':'#fff'}});
    if(!map.getLayer(MEDICAL_LAYER_POINT)) map.addLayer({id:MEDICAL_LAYER_POINT,type:'circle',source:MEDICAL_SOURCE_ID,layout:{ visibility:'none' },paint:{'circle-radius':5,'circle-color':'#0f766e','circle-stroke-color':'#fff','circle-stroke-width':1}});
    if(!map.getLayer(MEDICAL_LAYER_LABEL)) map.addLayer({id:MEDICAL_LAYER_LABEL,type:'symbol',source:MEDICAL_SOURCE_ID,layout:{ visibility:'none','text-field':['get','__label__'],'text-size':12,'text-offset':[0,1.2],'text-anchor':'top','text-allow-overlap':false},paint:{'text-halo-width':1.2,'text-halo-color':'#fff','text-color':'#0f172a'}});
    bindClickPopup('emg-circle'); bindClickPopup('shel-circle'); bindClickPopup(MEDICAL_LAYER_POINT);
      ['chkEmergency','chkShelter','chkMedical'].forEach(id => {
  $(id)?.addEventListener('change', () => {
    // „Éè„Ç∂„Éº„ÉâÔºàFGBÔºâ„ÅØË°®Á§∫ÂàáÊõø„Å†„Åë
    if (id === 'chkEmergency' || id === 'chkShelter') {
      updateLayerVisibility();
      return;
    }
    // ÂåªÁôÇÊ©üÈñ¢„ÉÅ„Çß„ÉÉ„ÇØÔºöON„Å™„ÇâÂèñÂæó„ÉªÊèèÁîª„ÄÅOFF„Å™„ÇâÊ∂àÂéª
    if (id === 'chkMedical') {
      if ($('chkMedical').checked) {
        refreshMedicalLayer();
      } else {
        setMedicalStatus('');
        updateLayerVisibility();
        const src = map.getSource('medical');
        if (src) src.setData({ type:'FeatureCollection', features:[] });
      }
    }
  });
});


      const extentPanel = $('extentPanel');
      function loadScopeToUI(scope){
        const radio=document.querySelector(`input[name="areaMode"][value="${scope.mode}"]`);
        if(radio) radio.checked=true;
        $('prefRow').style.display=(scope.mode==='pref'||scope.mode==='muni')?'':'none';
        $('muniRow').style.display=(scope.mode==='muni')?'':'none';
        Array.from($('prefSelect').options).forEach(o=>o.selected=scope.prefs.includes(o.value));
        if(typeof window.renderMuniOptions==='function') window.renderMuniOptions();
        Array.from($('muniSelect').options).forEach(o=>o.selected=scope.munis.includes(o.value));
      }
      function readScopeFromUI(){
        const mode=document.querySelector('input[name="areaMode"]:checked').value;
        const prefs=Array.from($('prefSelect').selectedOptions).map(o=>o.value);
        const munis=Array.from($('muniSelect').selectedOptions).map(o=>o.value);
        return { mode, prefs, munis };
      }
      function openExtentPanel(target){
        currentScopeTarget=target;
        const note = SCOPE_LABELS[target] || SCOPE_LABELS.global;
        $('extentScopeNote').textContent=note;
        const scope = target==='global' ? layerScopeGlobal : (layerScopeOverrides[target] || layerScopeGlobal);
        loadScopeToUI(scope);
        $('qMuni').value='';
        hideSuggest();
        centerPanel(extentPanel);
      }
      $('btnExtent').addEventListener('click',()=>openExtentPanel('global'));
      document.querySelectorAll('.miniBtn[data-action="scope"]').forEach(btn=>{
        btn.addEventListener('click',()=>openExtentPanel(btn.dataset.layer));
      });
      $('btnExtentCancel').onclick=()=>{ extentPanel.style.display='none'; };
      $('btnExtentConfirm').onclick=async()=>{
        const scope=readScopeFromUI();
        if(currentScopeTarget==='global') layerScopeGlobal=scope; else layerScopeOverrides[currentScopeTarget]=scope;
        extentPanel.style.display='none';
        const bounds=await refreshLayers(true);
        if(!bounds){
          const fallbackFeatures=[];
          if(cacheEmergency){
            const scopeE=getScopeFor('emergency');
            fallbackFeatures.push(...(cacheEmergency||[]).filter(f=>filterByScope(scopeE,f)));
          }
          if(cacheShelter){
            const scopeS=getScopeFor('shelter');
            fallbackFeatures.push(...(cacheShelter||[]).filter(f=>filterByScope(scopeS,f)));
          }
          if(Array.isArray(lastMedicalFeatures) && lastMedicalFeatures.length){
            const effectiveMedicalScope=getScopeFor('medical');
            const effectiveKey=scopeKey(effectiveMedicalScope);
            if(currentMedicalKey===effectiveKey){
              fallbackFeatures.push(...lastMedicalFeatures);
            }
          }
          if(fallbackFeatures.length){
            fitToFeatures(fallbackFeatures);
          }
        }
      };

      (function(){
        const header=extentPanel.querySelector('.handle');
        let sx=0,sy=0,left=0,top=0,dragging=false;
        if(!header) return;
        header.addEventListener('pointerdown',e=>{
          dragging=true; sx=e.clientX; sy=e.clientY;
          const rect=extentPanel.getBoundingClientRect();
          extentPanel.style.transform='none';
          extentPanel.style.left=rect.left+'px';
          extentPanel.style.top=rect.top+'px';
          left=rect.left; top=rect.top;
          header.setPointerCapture(e.pointerId);
        });
        header.addEventListener('pointermove',e=>{
          if(!dragging)return;
          const dx=e.clientX-sx, dy=e.clientY-sy;
          extentPanel.style.left=(left+dx)+'px';
          extentPanel.style.top=(top+dy)+'px';
        });
        header.addEventListener('pointerup',()=>{dragging=false;});
      })();

      const labelPanel=$('labelPanel');
      const labelList=$('labelFieldList');
      let currentLabelTarget='emergency';
      function openLabelPanel(layer){
        if(!layerColumns[layer] || layerColumns[layer].length===0){ toast('„Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÂæå„Å´Âà©Áî®„Åß„Åç„Åæ„Åô',true); return; }
        currentLabelTarget=layer;
        $('labelScopeNote').textContent = SCOPE_LABELS[layer] || '';
        labelList.innerHTML='';
        const cols=['__none__', ...layerColumns[layer]];
        cols.forEach(col=>{
          const opt=document.createElement('option');
          opt.value=col;
          opt.textContent=col==='__none__'?'Ë°®Á§∫„Åó„Å™„ÅÑ':col;
          labelList.appendChild(opt);
        });
        labelList.value=layerLabelFields[layer] || '__none__';
        centerPanel(labelPanel);
      }
      document.querySelectorAll('.miniBtn[data-action="label"]').forEach(btn=>{
        btn.addEventListener('click',()=>openLabelPanel(btn.dataset.layer));
      });
      $('btnLabelCancel').onclick=()=>{ labelPanel.style.display='none'; };
      $('btnLabelConfirm').onclick=()=>{
        const val=labelList.value;
        layerLabelFields[currentLabelTarget]=(val==='__none__')?null:val;
        labelPanel.style.display='none';
        refreshLayers();
      };
      (function(){
        const header=labelPanel.querySelector('.handle');
        let sx=0,sy=0,left=0,top=0,dragging=false;
        if(!header) return;
        header.addEventListener('pointerdown',e=>{
          dragging=true;sx=e.clientX;sy=e.clientY;
          const rect=labelPanel.getBoundingClientRect();
          labelPanel.style.transform='none';
          labelPanel.style.left=rect.left+'px';
          labelPanel.style.top=rect.top+'px';
          left=rect.left;top=rect.top;
          header.setPointerCapture(e.pointerId);
        });
        header.addEventListener('pointermove',e=>{
          if(!dragging)return;
          const dx=e.clientX-sx,dy=e.clientY-sy;
          labelPanel.style.left=(left+dx)+'px';
          labelPanel.style.top=(top+dy)+'px';
        });
        header.addEventListener('pointerup',()=>{dragging=false;});
      })();

      // ÈÉΩÈÅìÂ∫úÁúå„Çª„É¨„ÇØ„Éà
      PREFS.forEach(p=>{const o=document.createElement('option');o.value=p;o.textContent=p;$('prefSelect').appendChild(o);});

    // FGB Ë™≠„ÅøËæº„Åø
    try{
      const [emgFeats,shelFeats]=await Promise.all([
        readFGB_fromURL(FGB_URL_EMERGENCY),
        readFGB_fromURL(FGB_URL_SHELTER)
      ]);
      cacheEmergency=emgFeats; cacheShelter=shelFeats;

        const propKeys=new Set([...Object.keys(emgFeats[0]?.properties||{}),...Object.keys(shelFeats[0]?.properties||{})]);
        COL_MUNI=MUNI_COL_CANDIDATES.find(k=>propKeys.has(k))||null;
        if(!COL_MUNI) showErr('„ÄåÈÉΩÈÅìÂ∫úÁúåÂêçÂèä„Å≥Â∏ÇÁî∫ÊùëÂêç„ÄçÂàó„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„ÇìÔºàCOL_MUNIÊú™Ë®≠ÂÆöÔºâ');

        buildMunicipalIndex([...emgFeats,...shelFeats],COL_MUNI);

        // „É©„Éô„É´ÂÄôË£ú
        const emCols=new Set();
        emgFeats.forEach(f=>Object.keys(f.properties||{}).forEach(k=>emCols.add(k)));
        const shCols=new Set();
        shelFeats.forEach(f=>Object.keys(f.properties||{}).forEach(k=>shCols.add(k)));
        layerColumns.emergency=[...emCols].sort();
        layerColumns.shelter=[...shCols].sort();
        layerLabelFields.emergency=null;
        layerLabelFields.shelter=null;

      // Â∏ÇÂå∫Áî∫ÊùëÂÄôË£ú
      const uniq=a=>[...new Set(a)];
      const names=uniq([...emgFeats,...shelFeats].map(f=>canonicalMuniLabel(f.properties?.[COL_MUNI]||"")).filter(Boolean));
      window.__allMunicipalLabels=names.map(n=>{const {pref,city}=splitPrefCityLabel(n);return pref?`${pref} ${city||"(ÂêçÁß∞‰∏çÊòé)"}`:n;}).sort((a,b)=>a.localeCompare(b,'ja'));
      function renderMuniOptions(){
        const chosenPrefs=new Set(Array.from($('prefSelect').selectedOptions).map(o=>o.value));
        $('muniSelect').innerHTML="";
        const list=(chosenPrefs.size===0)?window.__allMunicipalLabels:window.__allMunicipalLabels.filter(lbl=>{
          const {pref}=splitPrefCityLabel(lbl);
          return pref?chosenPrefs.has(pref):false;
        });
        list.forEach(lbl=>{const o=document.createElement('option');o.value=lbl;o.textContent=lbl;$('muniSelect').appendChild(o);});
        updateSuggest($('qMuni').value);
      }
      window.renderMuniOptions=renderMuniOptions;
      $('prefSelect').addEventListener('change', renderMuniOptions);
      $('qMuni').addEventListener('input',()=>updateSuggest($('qMuni').value));
      $('qMuni').addEventListener('blur',()=>setTimeout(hideSuggest,150));
      $('qMuni').addEventListener('keydown',(ev)=>{if(ev.key==='Enter'){const val=$('qMuni').value;if(val){updateSuggest(val);}}});
        renderMuniOptions();

        // ÂàùÂõûÊèèÁîª
        refreshLayers();
    }catch(e){
      showErr('FGB„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±ÊïóÔºö'+e.message);
    }
  }

  /*************** ÈÉ®Â±ã„ÉªÂÖ±Êúâ„Éª„Ç®„ÇØ„Çπ„Éù„Éº„Éà ***************/
$('btnExport').onclick=()=>{
  const fc = window.userFC || {type:'FeatureCollection',features:[]};
  const blob=new Blob([JSON.stringify(fc)],{type:'application/json'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='features.geojson';
  a.click();
};

  /*************** SupabaseÔºöÂõ≥ÂΩ¢‰øùÂ≠ò/Ë™≠Ëæº + GPS ***************/
  (function whenReady(){
    const ok=!!(window.map&&window.draw&&typeof draw.add==='function');
    if(!ok) return setTimeout(whenReady,200);
    window.__supaload=loadFeatures;
    window.__supasave=saveFeatures;
    window.__gpstart =startGpsLog;
    window.__gpstop  =stopGpsLog;
    window.__gpshow  =showTracks;
  })();

  async function loadFeatures(){
    try{
      const {data,error}=await __supa.from('features').select('id,geojson').eq('room',__room).order('id');
      if(error) throw error;
      const feats=(data||[]).map(r=>r.geojson);
      if(feats.length){draw.deleteAll();draw.add({type:'FeatureCollection',features:feats});}
      toast('Âõ≥ÂΩ¢„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„ÅüÔºà'+(feats.length||0)+'‰ª∂Ôºâ');
    }catch(e){toast('Ë™≠ËæºÂ§±Êïó: '+e.message,true);}
  }
  async function saveFeatures(){
    try{
      const fc=draw.getAll();
      if(!fc.features?.length){toast('‰øùÂ≠ò„Åô„ÇãÂõ≥ÂΩ¢„Åå„ÅÇ„Çä„Åæ„Åõ„Çì',true);return;}
      const rows=fc.features.map(f=>({room:__room,kind:(f.properties?.kind)||f.geometry?.type?.toLowerCase()||'feature',geojson:f,props:f.properties||{}}));
      const {error}=await __supa.from('features').insert(rows);
      if(error) throw error;
      toast('Âõ≥ÂΩ¢„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
    }catch(e){toast('‰øùÂ≠òÂ§±Êïó: '+e.message,true);}
  }

  let watchId=null,currentTrackId=null;
  async function startGpsLog(name='„Éï„Ç£„Éº„É´„ÉâË™øÊüª'){
    if(!navigator.geolocation){toast('‰ΩçÁΩÆÊÉÖÂ†±„Åå‰Ωø„Åà„Åæ„Åõ„Çì',true);return;}
    const {data:tk,error:e1}=await __supa.from('tracks').insert({room:__room,name}).select().single();
    if(e1){toast('„Éà„É©„ÉÉ„ÇØ‰ΩúÊàêÂ§±Êïó: '+e1.message,true);return;}
    currentTrackId=tk.id;
    let last=null;
    watchId=navigator.geolocation.watchPosition(async pos=>{
      const {longitude:lon,latitude:lat,accuracy:acc,speed,heading}=pos.coords;
      const tiso=new Date(pos.timestamp).toISOString();
      if(last){
        const dx=Math.abs(lon-last.lon)*111320, dy=Math.abs(lat-last.lat)*110540;
        if(dx<10&&dy<10) return;
      }
      last={lon,lat};
      await __supa.from('track_points').insert({track_id:currentTrackId,t:tiso,lon,lat,acc,speed,heading});
    }, err=>toast('GPS„Ç®„É©„Éº: '+err.message,true), {enableHighAccuracy:true,maximumAge:1000,timeout:10000});
    toast('GPS„É≠„Ç¨„ÉºÈñãÂßã');
  }
  function stopGpsLog(){ if(watchId){navigator.geolocation.clearWatch(watchId);watchId=null;} currentTrackId=null; toast('GPS„É≠„Ç¨„ÉºÂÅúÊ≠¢'); }
  async function showTracks(){
    const {data:tracks}=await __supa.from('tracks').select('id').eq('room',__room);
    if(!tracks?.length){toast('„Éà„É©„ÉÉ„ÇØ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì',true);return;}
    const ids=tracks.map(r=>r.id);
    const {data:pts}=await __supa.from('track_points').select('track_id,t,lon,lat').in('track_id',ids).order('t');
    const by=new Map(); (pts||[]).forEach(p=>{if(!by.has(p.track_id))by.set(p.track_id,[]);by.get(p.track_id).push([p.lon,p.lat]);});
    const fc={type:'FeatureCollection',features:[...by.entries()].map(([id,coords])=>({type:'Feature',properties:{id},geometry:{type:'LineString',coordinates:coords}}))};
    if(!map.getSource('tracks')) map.addSource('tracks',{type:'geojson',data:fc}); else map.getSource('tracks').setData(fc);
    if(!map.getLayer('tracks-line')) map.addLayer({id:'tracks-line',type:'line',source:'tracks',paint:{'line-color':'#ef4444','line-width':3}});
    toast('ËªåË∑°„ÇíË°®Á§∫„Åó„Åæ„Åó„Åü');
  }

  /*************** Âú∞Âõ≥„É≠„Éº„ÉâÔºö‰∏ÄÊã¨ÂàùÊúüÂåñ ***************/
  map.on('load', async ()=>{
    /* ==== basemap & controlsÔºàÈô∞ÂΩ±Ëµ∑‰ºèÂõ≥ÔºãGSI„É¨„Ç§„É§Ôºâ ==== */
// Èô∞ÂΩ±Ëµ∑‰ºèÂõ≥Ôºà„ÅÑ„Å°„Å∞„Çì‰∏ãÔºâ
if (!map.getSource('hillshade')) {
  map.addSource('hillshade', {
    type:'raster',
    tiles:['https://cyberjapandata.gsi.go.jp/xyz/hillshademap/{z}/{x}/{y}.png'],
    tileSize:256,
    attribution:'<a href="https://maps.gsi.go.jp/development/ichiran.html" target="_blank">GSI</a>'
  });
  const first = map.getStyle().layers[0]?.id;
  map.addLayer({ id:'hillshade', type:'raster', source:'hillshade', paint:{ 'raster-opacity':0.45 } }, first);
}
// Âú∞ÁêÜÈô¢ Ê®ôÊ∫ñ/ÂÜôÁúüÔºàÂ∞ë„ÅóÈÄèÊòéÔºâ
if (!map.getSource('gsi-std')) {
  map.addSource('gsi-std', { type:'raster', tiles:['https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png'], tileSize:256 });
  map.addLayer({ id:'gsi-std', type:'raster', source:'gsi-std', layout:{ visibility:'none' }, paint:{ 'raster-opacity':0.75 } });
}
if (!map.getSource('gsi-photo')) {
  map.addSource('gsi-photo', { type:'raster', tiles:['https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/{z}/{x}/{y}.jpg'], tileSize:256 });
  map.addLayer({ id:'gsi-photo', type:'raster', source:'gsi-photo', layout:{ visibility:'none' }, paint:{ 'raster-opacity':0.75 } });
}

    try{
      // „Éè„Ç∂„Éº„Éâ
      ensureHazardLayers(); updateHazard();

      // FGB
      initFGB();

      // ÂÖ±ÊúâË°®Á§∫
    }catch(e){
      console.error(e); showErr('ÂàùÊúüÂåñ„Ç®„É©„Éº: '+e.message);
    }

/* ==== /basemap & controls ==== */
/* ==== user objects layers ==== */
// „É¶„Éº„Ç∂„ÉºÂõ≥ÂΩ¢Ôºà„Ç∞„É≠„Éº„Éê„É´Ôºâ
if (!map.getSource('user-src')){
  map.addSource('user-src', { type:'geojson', data:window.userFC });
  if(!map.getSource('user-labels')){
    map.addSource('user-labels', { type:'geojson', data:window.userLabelFC || {type:'FeatureCollection',features:[]} });
  }

  ensureUserPointFlagIcon();
  map.addLayer({ id:'user-point-emoji', type:'symbol', source:'user-src',
    filter:['==',['get','_type'],'point'],
    layout:{ 'icon-image':'user-point-flag','icon-size':0.5,'icon-anchor':'bottom','icon-offset':[0,-4],'icon-allow-overlap':true },
    paint:{}
  });
  map.addLayer({ id:'user-point-label', type:'symbol', source:'user-src',
    filter:['==',['get','_type'],'point'],
    layout:{ 'text-field':['coalesce',['get','label'],''],'text-size':['+', ['coalesce',['get','labelSize'],12], 5],
      'text-anchor':'top','text-offset':[0,0.7],'text-allow-overlap':true },
    paint:{ 'text-color':['coalesce',['get','labelColor'],'#000000'],'text-halo-color':'#fff','text-halo-width':1.6 }
  });
  map.addLayer({ id:'user-line', type:'line', source:'user-src',
    filter:['==',['get','_type'],'line'],
    layout:{ 'line-cap':'round','line-join':'round' },
    paint:{ 'line-color':['coalesce',['get','lineColor'],'#e53935'],'line-width':['coalesce',['get','lineWidth'],2] }
  });
  map.addLayer({ id:'user-line-label', type:'symbol', source:'user-labels',
    filter:['==',['get','_labelType'],'line'],
    layout:{ 'symbol-placement':'point','text-field':['coalesce',['get','labelText'],''],
      'text-size':['+', ['coalesce',['get','labelSize'],12], 5],
      'text-anchor':'center','text-offset':[0,0],'text-allow-overlap':false },
    paint:{ 'text-color':['coalesce',['get','labelColor'],'#000000'],'text-halo-color':'#fff','text-halo-width':1.6 }
  });
  map.addLayer({ id:'user-poly-fill', type:'fill', source:'user-src',
    filter:['in',['get','_type'],['literal',['polygon','circle']]],
    paint:{ 'fill-color':['coalesce',['get','fillColor'],'#43a047'],'fill-opacity':['coalesce',['get','fillOpacity'],0.5] }
  });
  map.addLayer({ id:'user-poly-line', type:'line', source:'user-src',
    filter:['in',['get','_type'],['literal',['polygon','circle']]],
    paint:{ 'line-color':['coalesce',['get','lineColor'],'#2e7d32'],'line-width':['coalesce',['get','lineWidth'],2] }
  });
  map.addLayer({ id:'user-poly-label', type:'symbol', source:'user-labels',
    filter:['==',['get','_labelType'],'polygon'],
    layout:{
      'text-field':['coalesce',['get','labelText'],''],
      'text-size':['+', ['coalesce',['get','labelSize'],12], 5],
      'text-anchor':'center',
      'text-offset':[0,0],
      'text-justify':'center',
      'text-allow-overlap':false
    },
    paint:{ 'text-color':['coalesce',['get','labelColor'],'#000000'],'text-halo-color':'#fff','text-halo-width':1.6 }
  });
  map.addLayer({ id:'user-circle-label', type:'symbol', source:'user-labels',
    filter:['==',['get','_labelType'],'circle'],
    layout:{
      'text-field':['coalesce',['get','labelText'],''],
      'text-size':['+', ['coalesce',['get','labelSize'],12], 5],
      'text-anchor':'center',
      'text-offset':[0,0],
      'text-justify':'center',
      'text-allow-overlap':false
    },
    paint:{ 'text-color':['coalesce',['get','labelColor'],'#000000'],'text-halo-color':'#fff','text-halo-width':1.6 }
  });

  map.addSource('user-temp', { type:'geojson', data:{ type:'FeatureCollection', features:[] }});
  map.addLayer({ id:'user-temp-line', type:'line', source:'user-temp',
    paint:{ 'line-color':'#1976d2','line-width':2,'line-dasharray':[1,1] }});
  map.addLayer({ id:'user-temp-fill', type:'fill', source:'user-temp',
    layout:{ 'visibility':'none' },
    paint:{ 'fill-color':'#1976d2','fill-opacity':0.2 }});

  map.addSource('survey-track', { type:'geojson', data:{ type:'FeatureCollection', features:[] }});
  map.addLayer({ id:'survey-track-line', type:'line', source:'survey-track',
    filter:['==',['get','kind'],'line'],
    paint:{ 'line-color':'#ef4444','line-width':3,'line-opacity':0.85 }});
  map.addLayer({ id:'survey-track-points', type:'circle', source:'survey-track',
    filter:['==',['get','kind'],'point'],
    paint:{ 'circle-radius':4,'circle-color':'#1d4ed8','circle-stroke-color':'#fff','circle-stroke-width':1 } });

  map.addSource('survey-notes', { type:'geojson', data:{ type:'FeatureCollection', features:[] }});
  ensureSurveyFlagIcon();
  map.addLayer({ id:'survey-notes-icon', type:'symbol', source:'survey-notes',
    layout:{
      'icon-image':'survey-flag',
      'icon-size':1.2,
      'icon-anchor':'bottom',
      'icon-allow-overlap':true,
      'icon-offset':[0,-4]
    }
  });
  map.addLayer({ id:'survey-notes-label', type:'symbol', source:'survey-notes',
    layout:{ 'text-field':['get','labelText'],'text-size':17,'text-anchor':'top','text-offset':[0,0.45],'text-allow-overlap':true,'visibility':'none' },
    paint:{ 'text-color':'#000000','text-halo-color':'#fff','text-halo-width':1.6 } });
  ensureOverlayOrder();
}
/* ==== /user objects layers ==== */

  updateSurveyNotesSource();
  updateSurveyStatus();

  });
  </script>
  <script>
/* ==== object tools & list ==== */
let addMode=null, tempCoords=[], circleCenter=null;
const objToolbarBtn=document.getElementById('btnObj');
const objSubtools=document.getElementById('objSubtools');
const objToolbar=document.getElementById('objToolbar');
let lastObjSubtoolsTop=null;
function updateObjSubtoolsLayout({force=false}={}){
  if(!objSubtools) return;
  const isOpen=objSubtools.style.display==='flex';
  if(!isOpen || !mobilePanelQuery.matches){
    if(force || !mobilePanelQuery.matches){
      objSubtools.classList.remove('mobile-subtools');
      objSubtools.style.removeProperty('--obj-subtools-top');
      lastObjSubtoolsTop=null;
    }
    return;
  }
  objSubtools.classList.add('mobile-subtools');
  const btnRect=objToolbarBtn?.getBoundingClientRect?.();
  const anchorRect=topbarEl?.getBoundingClientRect?.() || btnRect;
  const desiredTop=((anchorRect?.bottom) ?? (btnRect?.bottom) ?? 72) + 12;
  requestAnimationFrame(()=>{
    if(!objSubtools || objSubtools.style.display!=='flex') return;
    const panelHeight=objSubtools.offsetHeight||0;
    const maxTop=Math.max(12, window.innerHeight - panelHeight - 12);
    const clampedTop=Math.min(Math.max(desiredTop, 12), maxTop);
    if(!force && lastObjSubtoolsTop!==null && Math.abs(lastObjSubtoolsTop-clampedTop)<1) return;
    objSubtools.style.setProperty('--obj-subtools-top', `${Math.round(clampedTop)}px`);
    lastObjSubtoolsTop=clampedTop;
  });
}
const syncObjToolbar=open=>{
  if(!objToolbarBtn || !objSubtools) return;
  if(open){
    objSubtools.style.display='flex';
    if(mobilePanelQuery.matches){
      objSubtools.classList.add('mobile-floating');
      objSubtools.style.marginLeft='0';
      if(typeof objToolbarBtn.scrollIntoView==='function'){
        objToolbarBtn.scrollIntoView({ behavior:'smooth', block:'nearest', inline:'center' });
      }
      positionObjSubtools();
    }else{
      objSubtools.classList.remove('mobile-floating');
      objSubtools.style.marginLeft='8px';
      objSubtools.style.removeProperty('--obj-subtool-top');
    }
  }else{
    objSubtools.style.display='none';
    objSubtools.classList.remove('mobile-floating');
    objSubtools.style.removeProperty('--obj-subtool-top');
    objSubtools.style.marginLeft=mobilePanelQuery.matches?'0':'8px';
  }
  objToolbarBtn.classList.toggle('toggle-on', !!open);
  objToolbar?.classList.toggle('is-open', !!open);
  if(open){
    if(mobilePanelQuery.matches && typeof objToolbarBtn.scrollIntoView==='function'){
      objToolbarBtn.scrollIntoView({ behavior:'smooth', block:'nearest', inline:'center' });
    }
    updateObjSubtoolsLayout({force:true});
  }else{
    objSubtools.classList.remove('mobile-subtools');
    objSubtools.style.removeProperty('--obj-subtools-top');
    lastObjSubtoolsTop=null;
  }
};
const handleResponsiveLayoutChange=()=>{
  updateObjSubtoolsLayout({force:true});
  positionSurveyPanel({force:true});
};
if(typeof mobilePanelQuery.addEventListener==='function'){
  mobilePanelQuery.addEventListener('change', handleResponsiveLayoutChange);
}else if(typeof mobilePanelQuery.addListener==='function'){
  mobilePanelQuery.addListener(handleResponsiveLayoutChange);
}
const handleViewportChange=()=>{
  updateObjSubtoolsLayout({force:true});
  positionSurveyPanel({force:true});
};
window.addEventListener('resize', handleViewportChange);
window.addEventListener('orientationchange', handleViewportChange);
updateObjSubtoolsLayout({force:true});
const setTemp = fc => map.getSource('user-temp').setData(fc || {type:'FeatureCollection',features:[]});
function syncUserFeatures({refreshList=true}={}){
  ensureGroupStore();
  cleanupGroupStore();
  if(map.getSource('user-src')) map.getSource('user-src').setData(window.userFC);
  syncUserLabelSource();
  if(refreshList) refreshObjList();
  else updateObjListItems();
  saveUserFCToStorage(window.userFC);
  if(typeof autoSave==='function') autoSave();
}
const pushFeature = f => {
  ensureDefaultStyle(f);
  window.userFC.features.push(f);
  syncUserFeatures();
};
window.pushFeature = pushFeature;
function updateMapCursor(){
  const canvas=map.getCanvas();
  const shouldCross = !!addMode || surveyState.manualMode || surveyState.awaitingMove;
  canvas.style.cursor = shouldCross ? 'crosshair' : '';
  canvas.classList.toggle('cursor-crosshair', shouldCross);
}
function activateTool(mode){
  addMode=mode;
  tempCoords=[]; circleCenter=null; setTemp();
  if(map && map.getLayer('user-temp-fill')){
    const vis=(mode==='polygon'||mode==='circle')?'visible':'none';
    try{ map.setLayoutProperty('user-temp-fill','visibility',vis); }catch(_){ }
  }
  document.querySelectorAll('#objSubtools .tool').forEach(t=>t.classList.toggle('active', !!mode && t.dataset.mode===mode));
  if(mode){
    syncObjToolbar(true);
  }else{
    syncObjToolbar(false);
  }
  if(mode==='line' || mode==='polygon' || mode==='circle') map.doubleClickZoom.disable();
  else map.doubleClickZoom.enable();
  updateMapCursor();
}

// „Ç™„Éñ„Ç∏„Çß„ÇØ„ÉàÔºö„É°„Ç§„É≥„Éú„Çø„É≥ ‚Üí „Çµ„Éñ„ÉÑ„Éº„É´ÈñãÈñâ
objToolbarBtn?.addEventListener('click', (evt)=>{
  evt?.preventDefault?.();
  evt?.stopPropagation?.();
  if(!objSubtools) return;
  const isOpen=objSubtools.style.display==='flex';
  const nextOpen=!isOpen;
  syncObjToolbar(nextOpen);
  if(!nextOpen){
    activateTool(null);
  }
});
// ÂêÑ„ÉÑ„Éº„É´ÈÅ∏Êäû
document.querySelectorAll('#objSubtools .tool').forEach(btn=>{
  btn.addEventListener('click', (evt)=>{
    evt?.preventDefault?.();
    evt?.stopPropagation?.();
    activateTool(btn.dataset.mode);
  });
});

// „Éû„ÉÉ„ÉóÊìç‰Ωú
map.on('click', (e)=>{
  if(handleSurveyMapClick(e)) return;
  if (!addMode) return;
  if (addMode==='point'){
    const feature={ type:'Feature', properties:{ _type:'point' }, geometry:{ type:'Point', coordinates:[e.lngLat.lng,e.lngLat.lat] }};
    activateTool(null);
    openSimpleLabelEditor(feature,{ resumeMode:'point', isNew:true, title:'„Éù„Ç§„É≥„Éà „É©„Éô„É´' });
    return;
  }
  if (addMode==='circle'){
    if (!circleCenter){ circleCenter=[e.lngLat.lng,e.lngLat.lat]; setTemp(); }
    return;
  }
  const p=[e.lngLat.lng,e.lngLat.lat]; tempCoords.push(p); drawTemp();
});
map.on('mousemove',(e)=>{
  if (!addMode) return;
  if (addMode==='circle' && circleCenter){
    const rKm=turf.distance(circleCenter,[e.lngLat.lng,e.lngLat.lat],{units:'kilometers'});
    const poly=turf.circle(circleCenter,rKm,{steps:64,units:'kilometers'});
    setTemp({ type:'FeatureCollection', features:[{ type:'Feature', properties:{}, geometry:poly.geometry }] });
    return;
  }
  if ((addMode==='line'||addMode==='polygon') && tempCoords.length){
    const coords=tempCoords.concat([[e.lngLat.lng,e.lngLat.lat]]);
    const feat = (addMode==='line')
      ? { type:'Feature', properties:{}, geometry:{ type:'LineString', coordinates:coords } }
      : { type:'Feature', properties:{}, geometry:{ type:'Polygon', coordinates:[ coords.concat([tempCoords[0]]) ] } };
    setTemp({ type:'FeatureCollection', features:[feat] });
  }
});
map.on('dblclick',(e)=>{
  if (!addMode) return;
  e.preventDefault();
  if (addMode==='line' && tempCoords.length>=2){
    const coords=tempCoords.slice();
    const feature={ type:'Feature', properties:{ _type:'line' },
      geometry:{ type:'LineString', coordinates: coords } };
    tempCoords=[]; setTemp();
    activateTool(null);
    openSimpleLabelEditor(feature,{ resumeMode:'line', isNew:true, title:'„É©„Ç§„É≥ „É©„Éô„É´' });
    return;
  }
  if (addMode==='polygon' && tempCoords.length>=3){
    const coords=tempCoords.slice();
    const first=coords[0];
    const last=coords[coords.length-1];
    const p0=map.project(first), pN=map.project(last);
    if (Math.hypot(p0.x-pN.x,p0.y-pN.y)<15) coords[coords.length-1]=first;
    const feature={ type:'Feature', properties:{ _type:'polygon' },
      geometry:{ type:'Polygon', coordinates:[ coords.concat([coords[0]]) ] } };
    tempCoords=[]; setTemp();
    activateTool(null);
    openPolygonLabelEditor(feature,{resumeMode:'polygon',isNew:true});
    return;
  }
  if (addMode==='circle' && circleCenter){
    const edge=[e.lngLat.lng,e.lngLat.lat];
    const rKm=turf.distance(circleCenter,edge,{units:'kilometers'});
    if(!Number.isFinite(rKm) || rKm===0){
      circleCenter=null; setTemp();
      activateTool('circle');
      return;
    }
    const poly=turf.circle(circleCenter,rKm,{steps:64,units:'kilometers'});
    const feature={ type:'Feature', properties:{ _type:'circle' }, geometry:poly.geometry };
    circleCenter=null; setTemp();
    activateTool(null);
    openSimpleLabelEditor(feature,{ resumeMode:'circle', isNew:true, title:'ÂÜÜ „É©„Éô„É´' });
  }
});
function drawTemp(){
  if (!tempCoords.length) return setTemp();
  const feat=(addMode==='line')
    ? { type:'Feature', properties:{}, geometry:{ type:'LineString', coordinates:tempCoords } }
    : { type:'Feature', properties:{}, geometry:{ type:'Polygon', coordinates:[ tempCoords.concat([tempCoords[0]]) ] } };
  setTemp({ type:'FeatureCollection', features:[feat] });
}

map.on('click','survey-notes-icon',(e)=>{
  const f=e.features?.[0];
  if(!f) return;
  const note=surveyState.notes.find(n=>n.id===f.properties?.id);
  if(!note) return;
  if(surveyState.editMode){
    if(window.__surveyNotePopup){ window.__surveyNotePopup.remove(); window.__surveyNotePopup=null; }
    openSurveyNoteForm(note,{isNew:false});
    return;
  }
  if(window.__surveyNotePopup){ window.__surveyNotePopup.remove(); }
  const rows=[];
  if(note.text1) rows.push(`<div><strong>„É©„Éô„É´1:</strong> ${escapeHtml(note.text1)}</div>`);
  if(note.text2) rows.push(`<div><strong>„É©„Éô„É´2:</strong> ${escapeHtml(note.text2)}</div>`);
  if(note.capTag) rows.push(`<div><strong>CAP:</strong> ${escapeHtml(note.capTag)}</div>`);
  if(!rows.length) rows.push('<div>(ÂÜÖÂÆπ„Å™„Åó)</div>');
  const html=`<div class="note-popup">${rows.join('')}</div>`;
  window.__surveyNotePopup=new maplibregl.Popup({offset:18}).setLngLat([note.lon,note.lat]).setHTML(html).addTo(map);
});
map.on('mouseenter','survey-notes-icon',()=>{
  if((typeof surveyState!=='undefined' && (surveyState.manualMode||surveyState.awaitingMove)) || addMode){
    return;
  }
  map.getCanvas().style.cursor='pointer';
});
map.on('mouseleave','survey-notes-icon',()=>{ if(typeof updateMapCursor==='function') updateMapCursor(); else map.getCanvas().style.cursor=''; });

// Âè≥„Éë„Éç„É´Ôºö„É™„Çπ„ÉàÔºÜ„Ç∞„É´„Éº„ÉóÔºÜ„Çπ„Çø„Ç§„É´
const objList=document.getElementById('objList');
const objListPaletteBtn=document.getElementById('objListPalette');
const objListTrashBtn=document.getElementById('objListTrash');

function getId(f){ return f.id || (f.id=Math.random().toString(36).slice(2)); }
function findFeatureById(fid){ return window.userFC.features.find(f=>getId(f)===fid); }

function ensureGroupStore(){
  if(!window.userFC) window.userFC={ type:'FeatureCollection', features:[], groups:{}, _groupSeq:1 };
  if(!Array.isArray(window.userFC.features)) window.userFC.features=[];
  if(!window.userFC.groups || typeof window.userFC.groups!=='object') window.userFC.groups={};
  if(typeof window.userFC._groupSeq!=='number') window.userFC._groupSeq=1;
  return window.userFC.groups;
}
function cleanupEmptyGroup(groupId){
  if(!groupId) return;
  const groups=ensureGroupStore();
  const exists=window.userFC.features.some(f=>f?.properties?._group===groupId);
  if(!exists) delete groups[groupId];
}
function cleanupGroupStore(){
  const groups=ensureGroupStore();
  const used=new Set();
  window.userFC.features.forEach(f=>{
    const gid=f?.properties?._group;
    if(gid) used.add(gid);
  });
  Object.keys(groups).forEach(id=>{ if(!used.has(id)) delete groups[id]; });
}
function nextGroupName(){
  ensureGroupStore();
  const seq=window.userFC._groupSeq||1;
  window.userFC._groupSeq=seq+1;
  return `„Ç∞„É´„Éº„Éó${seq}`;
}
function getGroupMeta(id){
  const groups=ensureGroupStore();
  if(!groups[id]) groups[id]={id,name:nextGroupName()};
  if(!groups[id].name) groups[id].name=nextGroupName();
  return groups[id];
}
function createGroupFromFeatures(features,{name}={}){
  const groups=ensureGroupStore();
  const uniq=[];
  features.forEach(f=>{ if(f && f.properties && !uniq.includes(f)) uniq.push(f); });
  if(!uniq.length) return null;
  const id='grp_'+Math.random().toString(36).slice(2);
  const groupName=name || nextGroupName();
  groups[id]={id,name:groupName};
  const touched=new Set();
  uniq.forEach(f=>{
    const prev=f.properties._group;
    f.properties._group=id;
    if(prev && prev!==id) touched.add(prev);
  });
  touched.forEach(cleanupEmptyGroup);
  return id;
}
function assignFeatureToGroup(feature,groupId){
  if(!feature) return;
  getGroupMeta(groupId);
  const prev=feature.properties?._group;
  feature.properties._group=groupId;
  if(prev && prev!==groupId) cleanupEmptyGroup(prev);
}
function mergeGroups(aId,bId){
  if(!aId || !bId || aId===bId) return null;
  const groups=ensureGroupStore();
  const features=window.userFC.features.filter(f=>f?.properties?._group===aId || f?.properties?._group===bId);
  const name=[groups[aId]?.name, groups[bId]?.name].filter(Boolean).join(' + ') || nextGroupName();
  const newId=createGroupFromFeatures(features,{name});
  cleanupEmptyGroup(aId);
  cleanupEmptyGroup(bId);
  return newId;
}
function ungroupFeature(feature){
  if(!feature?.properties) return;
  const prev=feature.properties._group;
  if(prev){
    delete feature.properties._group;
    cleanupEmptyGroup(prev);
  }
}
function ungroupGroup(groupId){
  if(!groupId) return;
  window.userFC.features.forEach(f=>{
    if(f?.properties?._group===groupId) delete f.properties._group;
  });
  cleanupEmptyGroup(groupId);
}

const dragState={ type:null, featureId:null, groupId:null };

function clearDropHints(){
  document.querySelectorAll('.dropHint').forEach(el=>el.classList.remove('dropHint'));
  objList?.classList.remove('dropHint');
}
function clearDragState(){
  dragState.type=null;
  dragState.featureId=null;
  dragState.groupId=null;
  clearDropHints();
}

function addDnD(el,{type,feature,groupId}){
  if(!el) return;
  el.addEventListener('dragstart',e=>{
    if(type==='feature' && feature){
      dragState.type='feature';
      dragState.featureId=getId(feature);
      dragState.groupId=feature.properties?._group||null;
    }else if(type==='group' && groupId){
      dragState.type='group';
      dragState.groupId=groupId;
    }
    el.classList.add('dragging');
    try{ e.dataTransfer?.setData('text/plain', dragState.type||''); }catch(_){ }
  });
  el.addEventListener('dragend',()=>{
    el.classList.remove('dragging');
    clearDragState();
  });
  el.addEventListener('dragover',e=>{
    if(!dragState.type) return;
    if(type==='feature'){
      if(dragState.type==='feature' && feature && dragState.featureId===getId(feature)) return;
      e.preventDefault();
      el.classList.add('dropHint');
    }else if(type==='group'){
      if(dragState.type==='group' && dragState.groupId===groupId) return;
      e.preventDefault();
      el.classList.add('dropHint');
    }
  });
  el.addEventListener('dragleave',()=>{
    el.classList.remove('dropHint');
  });
  el.addEventListener('drop',e=>{
    if(!dragState.type) return;
    e.preventDefault();
    e.stopPropagation();
    el.classList.remove('dropHint');
    let changed=false;
    if(type==='feature' && feature){
      if(dragState.type==='feature'){
        if(dragState.featureId!==getId(feature)){
          const draggedFeature=findFeatureById(dragState.featureId);
          if(draggedFeature){
            if(feature.properties?._group){
              assignFeatureToGroup(draggedFeature, feature.properties._group);
            }else{
              createGroupFromFeatures([draggedFeature, feature]);
            }
            changed=true;
          }
        }
      }else if(dragState.type==='group' && dragState.groupId){
        const features=window.userFC.features.filter(f=>f?.properties?._group===dragState.groupId);
        features.push(feature);
        createGroupFromFeatures(features);
        cleanupEmptyGroup(dragState.groupId);
        changed=true;
      }
    }else if(type==='group' && groupId){
      if(dragState.type==='feature'){
        const draggedFeature=findFeatureById(dragState.featureId);
        if(draggedFeature){
          assignFeatureToGroup(draggedFeature, groupId);
          changed=true;
        }
      }else if(dragState.type==='group' && dragState.groupId && dragState.groupId!==groupId){
        mergeGroups(dragState.groupId, groupId);
        changed=true;
      }
    }
    if(changed) syncUserFeatures();
    clearDragState();
  });
}

function getFeatureLabelText(f){
  if(!f?.properties) return '';
  if(f.properties._type==='polygon'){
    const l1=(f.properties.label1||'').trim();
    const l2=(f.properties.label2||'').trim();
    return [l1,l2].filter(Boolean).join(' / ');
  }
  return (f.properties.label||'').trim();
}

function startSimpleLabelInlineEdit(feature,labelSpan){
  if(!feature || !labelSpan) return;
  if(labelSpan.dataset.editing==='1') return;
  labelSpan.dataset.editing='1';
  const original=getFeatureLabelText(feature);
  const input=document.createElement('input');
  input.type='text';
  input.className='labelInlineInput';
  input.value=feature.properties?.label||'';
  labelSpan.replaceWith(input);
  input.focus();
  input.select();
  const finish=(apply)=>{
    if(apply){
      feature.properties=feature.properties||{};
      feature.properties.label=input.value.trim();
      ensureDefaultStyle(feature);
      syncUserFeatures({refreshList:false});
      const next=getFeatureLabelText(feature);
      labelSpan.textContent=next || '(ÁÑ°È°å)';
      labelSpan.classList.toggle('empty', !next);
    }else{
      labelSpan.textContent=original || '(ÁÑ°È°å)';
      labelSpan.classList.toggle('empty', !original);
    }
    if(input.parentElement) input.replaceWith(labelSpan);
    delete labelSpan.dataset.editing;
  };
  input.addEventListener('blur',()=>finish(true));
  input.addEventListener('keydown',e=>{
    if(e.key==='Enter'){ e.preventDefault(); finish(true); }
    else if(e.key==='Escape'){ e.preventDefault(); finish(false); }
  });
}

function startPolygonInlineEdit(feature,labelWrap,labelSpan){
  if(!feature || !labelWrap || !labelSpan) return;
  if(labelWrap.querySelector('.polyInlineEditor')) return;
  const editor=document.createElement('div');
  editor.className='polyInlineEditor';
  const input1=document.createElement('input');
  input1.type='text';
  input1.value=feature.properties?.label1||'';
  const input2=document.createElement('input');
  input2.type='text';
  input2.value=feature.properties?.label2||'';
  const btnRow=document.createElement('div');
  btnRow.className='btnRow';
  const ok=document.createElement('button');
  ok.textContent='OK';
  ok.className='primary';
  const cancel=document.createElement('button');
  cancel.textContent='„Ç≠„É£„É≥„Çª„É´';
  btnRow.append(ok,cancel);
  editor.append(input1,input2,btnRow);
  labelSpan.style.display='none';
  labelWrap.appendChild(editor);
  input1.focus();
  input1.select();
  const restore=()=>{
    if(editor.parentElement) editor.remove();
    labelSpan.style.display='';
    const text=getFeatureLabelText(feature);
    labelSpan.textContent=text || '(ÁÑ°È°å)';
    labelSpan.classList.toggle('empty', !text);
  };
  const apply=()=>{
    feature.properties=feature.properties||{};
    feature.properties.label1=input1.value.trim();
    feature.properties.label2=input2.value.trim();
    feature.properties.label=[feature.properties.label1,feature.properties.label2].filter(Boolean).join(' / ');
    ensureDefaultStyle(feature);
    syncUserFeatures({refreshList:false});
    restore();
  };
  ok.addEventListener('click',apply);
  cancel.addEventListener('click',restore);
  editor.addEventListener('keydown',e=>{
    if(e.key==='Enter'){ e.preventDefault(); apply(); }
    else if(e.key==='Escape'){ e.preventDefault(); restore(); }
  });
}

function fallbackStyleValue(features,prop){
  for(const f of features){
    const typ=f?.properties?._type;
    if(typ && STYLE_DEFAULTS[typ] && STYLE_DEFAULTS[typ][prop]!==undefined){
      return STYLE_DEFAULTS[typ][prop];
    }
  }
  if(prop==='lineColor') return '#e53935';
  if(prop==='fillColor') return '#43a047';
  if(prop==='fillOpacity') return 0.5;
  if(prop==='lineWidth') return 2;
  if(prop==='labelColor') return '#000000';
  if(prop==='labelSize') return 12;
  return '';
}
function gatherStyleValue(features,prop){
  let first=true; let val;
  for(const f of features){
    const cur=f?.properties?.[prop];
    if(first){ val=cur; first=false; }
    else if(val!==cur){ val=undefined; break; }
  }
  if(val===undefined || val===null || val==='') return fallbackStyleValue(features,prop);
  return val;
}
function applyStyleToFeatures(features,style){
  features.forEach(f=>{
    if(!f?.properties) return;
    const typ=f.properties._type;
    if(style.lineColor!==undefined && (typ==='line'||typ==='polygon'||typ==='circle')){
      f.properties.lineColor=style.lineColor;
      f.properties.stroke=style.lineColor;
    }
    if(style.lineWidth!==undefined && (typ==='line'||typ==='polygon'||typ==='circle')){
      let width=Number(style.lineWidth);
      if(!Number.isFinite(width)) width=fallbackStyleValue([f],'lineWidth');
      width=Math.max(1, Math.min(60, width));
      f.properties.lineWidth=width;
      f.properties.strokeWidth=width;
    }
    if(style.fillColor!==undefined && (typ==='polygon'||typ==='circle')){
      f.properties.fillColor=style.fillColor;
      f.properties.fill=style.fillColor;
    }
    if(style.fillOpacity!==undefined && (typ==='polygon'||typ==='circle')){
      let op=Number(style.fillOpacity);
      if(!Number.isFinite(op)) op=fallbackStyleValue([f],'fillOpacity');
      op=Math.max(0, Math.min(1, op));
      f.properties.fillOpacity=op;
    }
    if(style.labelColor!==undefined){
      f.properties.labelColor=style.labelColor;
    }
    if(style.labelSize!==undefined){
      let size=Number(style.labelSize);
      if(!Number.isFinite(size)) size=fallbackStyleValue([f],'labelSize');
      size=Math.max(8, Math.min(60, size));
      f.properties.labelSize=size;
    }
    ensureDefaultStyle(f);
  });
  syncUserFeatures({refreshList:false});
}
function openStyleEditor(features,{title='„Çπ„Çø„Ç§„É´Ë®≠ÂÆö'}={}){
  const targets=features.filter(f=>f && f.properties);
  if(!targets.length) return;
  const panel=document.createElement('div');
  panel.className='floating';
  panel.style.minWidth='260px';
  const header=document.createElement('div');
  header.className='floatHeader';
  const titleEl=document.createElement('div');
  titleEl.textContent=title;
  header.appendChild(titleEl);
  const handle=document.createElement('span');
  handle.className='handle';
  handle.textContent='‚£ø';
  handle.title='„Éâ„É©„ÉÉ„Ç∞„ÅßÁßªÂãï';
  header.appendChild(handle);
  const body=document.createElement('div');
  body.className='floatBody';
  panel.append(header,body);
  document.body.appendChild(panel);
  makeDraggable(panel);

  const hasPoint=targets.some(f=>f.properties?._type==='point');
  const hasLine=targets.some(f=>f.properties?._type==='line');
  const hasPolygon=targets.some(f=>f.properties?._type==='polygon');
  const hasCircle=targets.some(f=>f.properties?._type==='circle');

  const inputs={};
  const fields=[];
  if(hasLine || hasPolygon || hasCircle){
    fields.push({key:'lineColor', type:'color', label:'Á∑öËâ≤'});
    fields.push({key:'lineWidth', type:'number', label:'Á∑öÂπÖ', min:1, max:20, step:1});
  }
  if(hasPolygon || hasCircle){
    fields.push({key:'fillColor', type:'color', label:'Â°óËâ≤'});
    fields.push({key:'fillOpacity', type:'number', label:'Â°ó„Çä‰∏çÈÄèÊòéÂ∫¶', min:0, max:1, step:0.05});
  }
  if(hasPoint || hasLine || hasPolygon || hasCircle){
    fields.push({key:'labelColor', type:'color', label:'„É©„Éô„É´Ëâ≤'});
    fields.push({key:'labelSize', type:'number', label:'ÊñáÂ≠ó„Çµ„Ç§„Ç∫', min:8, max:48, step:1});
  }

  fields.forEach(field=>{
    const row=document.createElement('div');
    row.className='row';
    const label=document.createElement('label');
    label.textContent=field.label+' ';
    const input=document.createElement('input');
    input.type=field.type;
    if(field.type==='color'){
      input.value=String(gatherStyleValue(targets, field.key) || fallbackStyleValue(targets, field.key));
    }else{
      input.value=String(gatherStyleValue(targets, field.key));
      if(field.min!==undefined) input.min=field.min;
      if(field.max!==undefined) input.max=field.max;
      if(field.step!==undefined) input.step=field.step;
    }
    label.appendChild(input);
    row.appendChild(label);
    body.appendChild(row);
    inputs[field.key]=input;
  });

  const btnRow=document.createElement('div');
  btnRow.className='row';
  btnRow.style.marginTop='8px';
  const applyBtn=document.createElement('button');
  applyBtn.className='btn';
  applyBtn.textContent='ÈÅ©Áî®';
  const closeBtn=document.createElement('button');
  closeBtn.className='btn secondary';
  closeBtn.textContent='Èñâ„Åò„Çã';
  btnRow.append(applyBtn,closeBtn);
  body.appendChild(btnRow);

  applyBtn.addEventListener('click',()=>{
    const style={};
    if(inputs.lineColor) style.lineColor=inputs.lineColor.value;
    if(inputs.lineWidth) style.lineWidth=Number(inputs.lineWidth.value);
    if(inputs.fillColor) style.fillColor=inputs.fillColor.value;
    if(inputs.fillOpacity) style.fillOpacity=Number(inputs.fillOpacity.value);
    if(inputs.labelColor) style.labelColor=inputs.labelColor.value;
    if(inputs.labelSize) style.labelSize=Number(inputs.labelSize.value);
    applyStyleToFeatures(targets, style);
    panel.remove();
  });
  closeBtn.addEventListener('click',()=>panel.remove());
}

function startGroupNameEdit(meta,nameSpan){
  if(!meta || !nameSpan) return;
  const original=meta.name||'';
  const input=document.createElement('input');
  input.type='text';
  input.className='labelInlineInput';
  input.value=original;
  nameSpan.replaceWith(input);
  input.focus();
  input.select();
  const finish=(apply)=>{
    if(apply){
      const val=input.value.trim();
      meta.name=val || nextGroupName();
      syncUserFeatures({refreshList:false});
    }else{
      meta.name=original;
    }
    if(input.parentElement) input.replaceWith(nameSpan);
    const display=meta.name || '„Ç∞„É´„Éº„Éó';
    nameSpan.textContent=display;
    nameSpan.classList.toggle('empty', !meta.name);
  };
  input.addEventListener('blur',()=>finish(true));
  input.addEventListener('keydown',e=>{
    if(e.key==='Enter'){ e.preventDefault(); finish(true); }
    else if(e.key==='Escape'){ e.preventDefault(); finish(false); }
  });
}

function syncObjIconStyle(icon,feature){
  if(!icon) return;
  icon.style.removeProperty('--icon-line-color');
  icon.style.removeProperty('--icon-fill-color');
  icon.style.removeProperty('--icon-stroke-color');
  const typ=feature?.properties?._type||'point';
  icon.className='objType type-'+typ;
  const props=feature?.properties||{};
  if(typ==='point'){
    icon.style.setProperty('--icon-line-color', props.labelColor||STYLE_DEFAULTS.point.labelColor||'#1976d2');
  }else if(typ==='line'){
    icon.style.setProperty('--icon-line-color', props.lineColor||STYLE_DEFAULTS.line.lineColor||'#e53935');
  }else if(typ==='polygon'){
    icon.style.setProperty('--icon-fill-color', props.fillColor||STYLE_DEFAULTS.polygon.fillColor||'#43a047');
    icon.style.setProperty('--icon-stroke-color', props.lineColor||STYLE_DEFAULTS.polygon.lineColor||'#2e7d32');
  }else if(typ==='circle'){
    icon.style.setProperty('--icon-fill-color', props.fillColor||STYLE_DEFAULTS.circle.fillColor||'#6d4c41');
    icon.style.setProperty('--icon-stroke-color', props.lineColor||STYLE_DEFAULTS.circle.lineColor||'#4e342e');
  }
}

function makeObjItem(f){
  ensureDefaultStyle(f);
  const el=document.createElement('div');
  el.className='objItem';
  el.draggable=true;
  el.dataset.fid=getId(f);
  const icon=document.createElement('div');
  syncObjIconStyle(icon,f);
  const labelWrap=document.createElement('div');
  labelWrap.className='objLabelWrap';
  const labelSpan=document.createElement('span');
  labelSpan.className='objLabelText';
  const text=getFeatureLabelText(f);
  labelSpan.textContent=text || '(ÁÑ°È°å)';
  labelSpan.classList.toggle('empty', !text);
  labelSpan.title='„ÉÄ„Éñ„É´„ÇØ„É™„ÉÉ„ÇØ„Åß„É©„Éô„É´Á∑®ÈõÜ';
  labelSpan.addEventListener('dblclick',()=>{
    if(f.properties?._type==='polygon') startPolygonInlineEdit(f,labelWrap,labelSpan);
    else startSimpleLabelInlineEdit(f,labelSpan);
  });
  labelWrap.appendChild(labelSpan);

  const actions=document.createElement('div');
  actions.className='objActions';
  const paletteBtn=document.createElement('button');
  paletteBtn.className='iconBtn';
  paletteBtn.title='Ëâ≤„ÇÑÂ§ß„Åç„Åï„ÇíÂ§âÊõ¥';
  paletteBtn.textContent='üé®';
  paletteBtn.addEventListener('click',e=>{
    e.stopPropagation();
    openStyleEditor([f],{title:'„Çπ„Çø„Ç§„É´'});
  });
  const trashBtn=document.createElement('button');
  trashBtn.className='iconBtn danger';
  trashBtn.title='ÂâäÈô§';
  trashBtn.textContent='üóëÔ∏è';
  trashBtn.addEventListener('click',e=>{
    e.stopPropagation();
    if(confirm('ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) removeFeature(f);
  });
  actions.append(paletteBtn,trashBtn);

  el.append(icon,labelWrap,actions);
  addDnD(el,{type:'feature',feature:f});
  return el;
}

function removeFeature(f,{skipSync=false}={}){
  const idx=window.userFC.features.indexOf(f);
  if(idx>-1){
    const prev=f?.properties?._group;
    window.userFC.features.splice(idx,1);
    if(prev) cleanupEmptyGroup(prev);
    if(!skipSync) syncUserFeatures();
  }
}
window.removeFeature=removeFeature;

function refreshObjList(){
  if(!objList) return;
  objList.innerHTML='';
  const groupsMap={};
  window.userFC.features.forEach(f=>{
    ensureDefaultStyle(f);
    const gid=f?.properties?._group;
    if(gid){
      (groupsMap[gid]??={id:gid,items:[]}).items.push(f);
    }else{
      objList.appendChild(makeObjItem(f));
    }
  });
  Object.values(groupsMap).forEach(group=>{
    const gid=group.id;
    const meta=getGroupMeta(gid);
    const box=document.createElement('div');
    box.className='grpItem';
    box.draggable=true;
    box.dataset.gid=gid;

    const header=document.createElement('div');
    header.className='grpHeader';
    const icon=document.createElement('div');
    icon.className='objType type-group';
    const nameWrap=document.createElement('div');
    nameWrap.className='objLabelWrap';
    const nameSpan=document.createElement('span');
    nameSpan.className='objLabelText';
    const display=meta.name || '„Ç∞„É´„Éº„Éó';
    nameSpan.textContent=display;
    nameSpan.classList.toggle('empty', !meta.name);
    nameSpan.title='„ÉÄ„Éñ„É´„ÇØ„É™„ÉÉ„ÇØ„Åß„Ç∞„É´„Éº„ÉóÂêç„ÇíÁ∑®ÈõÜ';
    nameSpan.addEventListener('dblclick',()=>startGroupNameEdit(meta,nameSpan));
    nameWrap.appendChild(nameSpan);
    const actions=document.createElement('div');
    actions.className='objActions';
    const paletteBtn=document.createElement('button');
    paletteBtn.className='iconBtn';
    paletteBtn.title='„Ç∞„É´„Éº„ÉóÂÜÖ„ÅÆËâ≤„ÇÑÂ§ß„Åç„Åï„ÇíÂ§âÊõ¥';
    paletteBtn.textContent='üé®';
    paletteBtn.addEventListener('click',e=>{
      e.stopPropagation();
      openStyleEditor(group.items,{title:`${meta.name||'„Ç∞„É´„Éº„Éó'}„ÅÆ„Çπ„Çø„Ç§„É´`});
    });
    const trashBtn=document.createElement('button');
    trashBtn.className='iconBtn danger';
    trashBtn.title='„Ç∞„É´„Éº„Éó„ÇíÂâäÈô§';
    trashBtn.textContent='üóëÔ∏è';
    trashBtn.addEventListener('click',e=>{
      e.stopPropagation();
      if(confirm('„Ç∞„É´„Éº„Éó„Çí‰∏∏„Åî„Å®ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')){
        for(let i=window.userFC.features.length-1;i>=0;i--){
          if(window.userFC.features[i]?.properties?._group===gid){
            window.userFC.features.splice(i,1);
          }
        }
        cleanupEmptyGroup(gid);
        syncUserFeatures();
      }
    });
    actions.append(paletteBtn,trashBtn);

    header.append(icon,nameWrap,actions);

    const wrap=document.createElement('div');
    wrap.className='grpChildren';
    group.items.forEach(item=>wrap.appendChild(makeObjItem(item)));

    box.append(header,wrap);
    addDnD(box,{type:'group',groupId:gid});
    objList.appendChild(box);
  });
}

function updateObjListItems(){
  if(!objList) return;
  document.querySelectorAll('.objItem').forEach(el=>{
    const fid=el.dataset.fid;
    if(!fid) return;
    const feature=findFeatureById(fid);
    if(!feature) return;
    ensureDefaultStyle(feature);
    const icon=el.querySelector('.objType');
    if(icon) syncObjIconStyle(icon,feature);
    const labelSpan=el.querySelector('.objLabelText');
    if(labelSpan){
      const text=getFeatureLabelText(feature);
      labelSpan.textContent=text || '(ÁÑ°È°å)';
      labelSpan.classList.toggle('empty', !text);
    }
  });
}

objListPaletteBtn?.addEventListener('click',()=>{
  const feats=[...(window.userFC?.features||[])];
  if(!feats.length) return;
  openStyleEditor(feats,{title:'ÂÖ®‰Ωì„ÅÆ„Çπ„Çø„Ç§„É´'});
});
objListTrashBtn?.addEventListener('click',()=>{
  if(!window.userFC.features.length) return;
  if(confirm('„Åô„Åπ„Å¶„ÅÆ„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')){
    window.userFC.features.length=0;
    window.userFC.groups={};
    syncUserFeatures();
  }
});

if(objList){
  objList.addEventListener('dragover',e=>{
    if(!dragState.type) return;
    if(e.target!==objList) return;
    e.preventDefault();
    objList.classList.add('dropHint');
  });
  objList.addEventListener('dragleave',e=>{
    if(e.target===objList) objList.classList.remove('dropHint');
  });
  objList.addEventListener('drop',e=>{
    if(e.target!==objList) return;
    if(!dragState.type) return;
    e.preventDefault();
    objList.classList.remove('dropHint');
    if(dragState.type==='feature'){
      const feature=findFeatureById(dragState.featureId);
      if(feature){
        ungroupFeature(feature);
        syncUserFeatures();
      }
    }else if(dragState.type==='group' && dragState.groupId){
      ungroupGroup(dragState.groupId);
      syncUserFeatures();
    }
    clearDragState();
  });
}

refreshObjList();
</script>
<script>
  // ‚òÖ„Åì„Åì„Å´„ÅÇ„Å™„Åü„ÅÆË®≠ÂÆö„ÇíÂÖ•„Çå„Å¶„Åè„Å†„Åï„ÅÑÔºà‰∏äÈÉ®„Çπ„ÇØ„É™„Éó„Éà„ÅÆ window.__supa „ÇíÂà©Áî® / Êú™Ë®≠ÂÆöÊôÇ„ÅØ‰ª•‰∏ã„Çí‰ΩøÁî®Ôºâ
  const SUPABASE_FALLBACK_URL = '';        // ‰æã: 'https://xxxxx.supabase.co'
  const SUPABASE_FALLBACK_ANON_KEY = '';   // anon public key
  let sb = null, sbUser = null;

  (async function initAuth(){
    if(window.__supa && typeof window.__supa.auth?.getUser === 'function'){
      sb = window.__supa;
    }else if(SUPABASE_FALLBACK_URL && SUPABASE_FALLBACK_ANON_KEY && window.supabase){
      sb = window.supabase.createClient(SUPABASE_FALLBACK_URL, SUPABASE_FALLBACK_ANON_KEY);
      window.__supa = sb;
    }else{
      updateSignUI();
      return; // Supabase Êú™Ë®≠ÂÆö
    }

    try{
      const { data:{ user } = {} } = await sb.auth.getUser();
      sbUser = user || null;
    }catch(e){
      console.warn('initAuth', e);
      sbUser = null;
    }
    updateSignUI();
    if(sbUser && sb.from) await loadUserData();
  })();

  function updateSignUI(){
    if(!sb) return;
    $('btnSignIn').style.display = sbUser ? 'none' : '';
    $('signinState').style.display = sbUser ? '' : 'none';
    $('btnShare').style.display = sbUser ? '' : 'none';
  }

  $('btnSignIn')?.addEventListener('click', async ()=>{
    const email = prompt('„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
    if(!email || !sb?.auth?.signInWithOtp) return;
    const { error } = await sb.auth.signInWithOtp({ email, options:{ emailRedirectTo: location.href }});
    if(error) alert('ÈÄÅ‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: '+error.message);
    else alert('„É°„Éº„É´„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„Åü„ÄÇÂ±ä„ÅÑ„Åü„É™„É≥„ÇØ„Åã„ÇâÈñã„ÅÑ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
  });

  $('btnShare')?.addEventListener('click', async ()=>{
    if(!sbUser) return;
    // „Ç∑„É≥„Éó„É´„Å´„Äå„É¶„Éº„Ç∂„ÉºÂõ∫ÊúâURL„Äç„ÇíÂÖ±ÊúâÔºà?uid=Ôºâ
    const url = new URL(location.href);
    url.searchParams.set('uid', sbUser.id);
    await navigator.clipboard.writeText(url.toString());
    alert('ÂÖ±Êúâ„É™„É≥„ÇØ„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü');
  });

  async function loadUserData(){
    try{
      const uid = new URL(location.href).searchParams.get('uid') || sbUser?.id;
      if(!uid) return;
      if(!sb?.from) return;
      const { data, error } = await sb.from('user_maps').select('data').eq('user_id', uid).single();
      if(error || !data) return;
      if(data.data?.features){
        window.userFC = data.data;
        window.userFC.features.forEach(f=>{ try{ ensureDefaultStyle(f); }catch(_){} });
        window.userLabelFC = buildUserLabelCollection(window.userFC);
        syncUserFeatures();
      }
    }catch(e){ console.warn('loadUserData', e); }
  }

  // Â§âÊõ¥„ÅÆ„Åü„Å≥Ëá™Âãï‰øùÂ≠ò
  async function autoSave(){
    if(!sb || !sbUser || !sb.from) return;
    try{
      const rec = { user_id: sbUser.id, data: window.userFC, updated_at: new Date().toISOString() };
      await sb.from('user_maps').upsert(rec, { onConflict:'user_id' });
    }catch(e){ console.warn('autosave', e); }
  }
  // Êó¢Â≠ò„ÅÆ pushFeature / removeFeature „Å™„Å©„ÅÆÊú´Â∞æ„Åß autoSave() „ÇíÂëº„Å≥„Åæ„Åô
  const _push = window.pushFeature;
  window.pushFeature = (f)=>{ _push(f); };
  const _rm = window.removeFeature;
  window.removeFeature = (f,opts)=>{ _rm(f,opts); };
initFGB()                 // ÈÅøÈõ£ÊñΩË®≠„É¨„Ç§„É§„ÅÆÂàùÊúüÂåñ
  .then(()=>updateLayerVisibility())
  .catch(e=>console.warn('initFGB failed', e));
  <script type="module">
/* ===== app main (module) ===== */
(async () => {
  // ==== globals (must be first) ====
const $ = (id) => document.getElementById(id);
// Âè≥ÂÅ¥„Éë„Éç„É´„ÇÑ„ÉÑ„Éº„É´„Éê„Éº„ÅÆ„É¨„Ç§„Ç¢„Ç¶„ÉàÂà§ÂÆö„Å´‰Ωø„ÅÜ„É°„Éá„Ç£„Ç¢„ÇØ„Ç®„É™
const mobilePanelQuery = window.matchMedia('(max-width: 880px)');

// ÂåªÁôÇÊ©üÈñ¢„Éó„É≠„Ç≠„Ç∑„ÅÆURLÔºà„ÅÇ„Å™„Åü„ÅÆ SupabaseÔºâ
const MEDICAL_PROXY_URL = 'https://tdoxxwhkvdguyfrofnaw.supabase.co/functions/v1/medical-proxy';

/* === Medical layer: Áµ±‰∏ÄÁâà === */
const MEDICAL_SOURCE_ID = 'medical';
const MEDICAL_LAYER_POINT = 'medical-pt';
const MEDICAL_LAYER_LABEL = 'medical-label';

function ensureMedicalLayers(){
  if(!map.getSource(MEDICAL_SOURCE_ID)){
    map.addSource(MEDICAL_SOURCE_ID,{ type:'geojson', data:{type:'FeatureCollection',features:[]} });
  }
  if(!map.getLayer(MEDICAL_LAYER_POINT)){
    map.addLayer({
      id: MEDICAL_LAYER_POINT,
      type: 'circle',
      source: MEDICAL_SOURCE_ID,
      layout:{ visibility:'none' },
      paint:{
        'circle-radius': 5,
        // P04_001ÔºàÁ®ÆÂà•„Ç≥„Éº„ÉâÔºâ„ÅÆÂÄ§„ÅßËâ≤ÂàÜ„ÅëÔºà‰æãÔºâ
        'circle-color': [
          'match', ['get','P04_001'],
          1, '#ef4444',    /* ÁóÖÈô¢ */
          2, '#3b82f6',    /* Ë®∫ÁôÇÊâÄ */
          3, '#10b981',    /* Ê≠ØÁßë */
          /* default */ '#6b7280'
        ],
        'circle-stroke-color':'#fff',
        'circle-stroke-width':1
      }
    });
  }
  if(!map.getLayer(MEDICAL_LAYER_LABEL)){
    map.addLayer({
      id: MEDICAL_LAYER_LABEL,
      type: 'symbol',
      source: MEDICAL_SOURCE_ID,
      layout:{
        visibility:'none',
        'text-field': ['coalesce',['get','P04_002_ja'],''], // „Éá„Éï„Ç©„É´„Éà„ÅÆ„É©„Éô„É´
        'text-size': 12,
        'text-offset':[0,1.1],
        'text-anchor':'top',
        'text-allow-overlap': true
      },
      paint:{
        'text-color':'#111827',
        'text-halo-color':'#fff',
        'text-halo-width':1.6
      }
    });
  }
}

function removeMedicalFromMap(){
  try{
    if(map.getLayer(MEDICAL_LAYER_LABEL)) map.removeLayer(MEDICAL_LAYER_LABEL);
    if(map.getLayer(MEDICAL_LAYER_POINT)) map.removeLayer(MEDICAL_LAYER_POINT);
    if(map.getSource(MEDICAL_SOURCE_ID))  map.removeSource(MEDICAL_SOURCE_ID);
  }catch(_){}
}

function setMedicalStatus(text, isErr=false){
  const s = document.getElementById('medicalStatus');
  if(!s) return;
  if(!text){ s.style.display='none'; return; }
  s.style.display='block';
  s.textContent = text;
  s.style.color = isErr ? '#b91c1c' : '#64748b';
}

// Supabase Edge Function ÁµåÁî±„ÅßÂåªÁôÇÊ©üÈñ¢„ÇíÂèñÂæó
async function refreshMedicalLayer(){
  const chk = document.getElementById('chkMedical');
  if(!chk || !chk.checked) return;
  setMedicalStatus('ÂåªÁôÇÊ©üÈñ¢„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠‚Ä¶');

  try{
    const b = map.getBounds();
    const payload = {
      bbox: [b.getWest(), b.getSouth(), b.getEast(), b.getNorth()].map(v=>+v.toFixed(6)),
      z: Math.round(map.getZoom())
    };
    if(!window.__supa?.functions?.invoke) throw new Error('Supabase client not ready');

    const { data, error } = await window.__supa.functions.invoke('medical-proxy', { body: payload });
    if(error) throw error;
    if(!data || data.type!=='FeatureCollection' || !Array.isArray(data.features)){
      throw new Error('invalid response');
    }

    ensureMedicalLayers();
    map.getSource(MEDICAL_SOURCE_ID).setData(data);

    const vis = chk.checked ? 'visible' : 'none';
    if(map.getLayer(MEDICAL_LAYER_POINT)) map.setLayoutProperty(MEDICAL_LAYER_POINT,'visibility',vis);
    if(map.getLayer(MEDICAL_LAYER_LABEL)) map.setLayoutProperty(MEDICAL_LAYER_LABEL,'visibility',vis);

    setMedicalStatus(`Ë°®Á§∫‰ª∂Êï∞: ${data.features.length.toLocaleString()}‰ª∂`);
  }catch(e){
    console.error('[medical] fetch error', e);
    setMedicalStatus('Ë™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + (e.message||e), true);
    removeMedicalFromMap();
  }
}

// „ÉÅ„Çß„ÉÉ„ÇØ„ÅÆON/OFF„ÅßË°®Á§∫ÂàáÊõø
document.getElementById('chkMedical')?.addEventListener('change', (ev)=>{
  if(ev.target.checked) refreshMedicalLayer();
  else removeMedicalFromMap();
});

// Âú∞Âõ≥Êìç‰ΩúÂæå„Å´ÂÜçÂèñÂæóÔºàË≤†Ëç∑„Çí‰∏ã„Åí„Çã„Åü„ÇÅ„Éá„Éê„Ç¶„É≥„ÇπÔºâ
let _medTimer=null;
['moveend','zoomend','dragend'].forEach(ev=>{
  map.on(ev, ()=>{
    if(!document.getElementById('chkMedical')?.checked) return;
    clearTimeout(_medTimer);
    _medTimer = setTimeout(refreshMedicalLayer, 500);
  });
});
/* === /Medical layer === */
})();  // end of IIFE
</script>

</script>

</body>
</html>
